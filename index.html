<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tweeyer - P2P Messenger</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        :root {
            /* Light Theme (Twitter-ish) */
            --bg-primary: #ffffff;
            --bg-secondary: #f7f9f9;
            --text-primary: #0f1419;
            --text-secondary: #536471;
            --accent-color: #1DA1F2;
            --accent-hover: #1a91da;
            --border-color: #eff3f4;
            --msg-me-bg: #1DA1F2;
            --msg-me-text: #ffffff;
            --msg-friend-bg: #eff3f4;
            --msg-friend-text: #0f1419;
            --shadow: 0 2px 10px rgba(0,0,0,0.05);
            --status-online: #00ba7c;
            --status-offline: #f4212e;
            --status-connecting: #ffd400;
        }

        .dark-theme {
            /* Dark Theme (Deep Black/High Contrast) */
            --bg-primary: #000000;
            --bg-secondary: #16181c;
            --text-primary: #e7e9ea;
            --text-secondary: #71767b;
            --accent-color: #1d9bf0;
            --accent-hover: #1a8cd8;
            --border-color: #2f3336;
            --msg-me-bg: #1d9bf0;
            --msg-me-text: #ffffff;
            --msg-friend-bg: #2f3336;
            --msg-friend-text: #e7e9ea;
            --shadow: 0 2px 10px rgba(255,255,255,0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            height: 100vh;
            overflow: hidden;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            z-index: 10;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .icon-btn:hover {
            color: var(--accent-color);
        }

        /* --- Connection Panel --- */
        .connection-panel {
            background-color: var(--bg-secondary);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            justify-content: space-between;
        }

        .id-display {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .id-display label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
        }

        .id-box {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: monospace;
            font-size: 1.1rem;
            background: var(--bg-primary);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .copy-btn {
            color: var(--accent-color);
            cursor: pointer;
        }

        .connect-form {
            display: flex;
            gap: 10px;
            flex-grow: 1;
            max-width: 500px;
        }

        input[type="text"] {
            flex-grow: 1;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            outline: none;
        }

        input[type="text"]:focus {
            border-color: var(--accent-color);
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--accent-hover);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        /* --- Chat Area --- */
        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: var(--bg-primary);
        }

        .message-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 70%;
        }

        .message-wrapper.me {
            align-self: flex-end;
            align-items: flex-end;
        }

        .message-wrapper.friend {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 1rem;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
            box-shadow: var(--shadow);
        }

        .me .message-bubble {
            background-color: var(--msg-me-bg);
            color: var(--msg-me-text);
            border-bottom-right-radius: 4px;
        }

        .friend .message-bubble {
            background-color: var(--msg-friend-bg);
            color: var(--msg-friend-text);
            border-bottom-left-radius: 4px;
        }

        .timestamp {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 4px;
            padding: 0 5px;
        }

        .empty-state {
            text-align: center;
            color: var(--text-secondary);
            margin-top: 50px;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* --- Footer / Input --- */
        footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            .connection-panel {
                flex-direction: column;
                align-items: stretch;
            }
            .connect-form {
                max-width: 100%;
            }
            .message-wrapper {
                max-width: 85%;
            }
        }
        
        /* Notifications/Alerts */
        .toast {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--accent-color);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 100;
        }
        .toast.show {
            opacity: 1;
        }
    </style>
</head>
<body>

<div id="app" :class="theme === 'dark' ? 'dark-theme' : ''">
    
    <!-- Notification Toast -->
    <div class="toast" :class="{ show: toast.visible }">
        {{ toast.message }}
    </div>

    <!-- Header -->
    <header>
        <div class="logo">
            <i class="fa-brands fa-twitter"></i> Tweeyer
        </div>
        <div class="controls">
            <button class="icon-btn" @click="toggleLang" :title="t[lang].toggleLang">
                <span style="font-size: 0.9rem; font-weight: bold;">{{ lang.toUpperCase() }}</span>
            </button>
            <button class="icon-btn" @click="toggleTheme" :title="t[lang].toggleTheme">
                <i :class="theme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon'"></i>
            </button>
            <button class="icon-btn" @click="clearHistory" :title="t[lang].clearChat">
                <i class="fa-solid fa-trash"></i>
            </button>
        </div>
    </header>

    <!-- Connection Panel -->
    <div class="connection-panel">
        <div class="id-display">
            <label>{{ t[lang].myIdLabel }}</label>
            <div class="id-box">
                <span>{{ myId || t[lang].initializing }}</span>
                <i class="fa-regular fa-copy copy-btn" v-if="myId" @click="copyId" :title="t[lang].copy"></i>
            </div>
        </div>

        <div class="connect-form">
            <input type="text" v-model="targetId" :placeholder="t[lang].connectPlaceholder">
            <button class="btn-primary" @click="connectToPeer" :disabled="!myId || isConnected || !targetId">
                <i class="fa-solid fa-link" v-if="!isConnected"></i>
                {{ isConnected ? t[lang].connected : t[lang].connectBtn }}
            </button>
        </div>
        
        <div class="status-display">
            <span class="status-dot" :style="{ backgroundColor: statusColor }"></span>
            <small>{{ connectionStatusText }}</small>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="chat-container" ref="chatContainer">
        <div v-if="messages.length === 0" class="empty-state">
            <i class="fa-regular fa-comments"></i>
            <p>{{ t[lang].emptyChat }}</p>
        </div>

        <div v-for="(msg, index) in messages" :key="index" class="message-wrapper" :class="msg.sender === 'me' ? 'me' : 'friend'">
            <div class="message-bubble">
                {{ msg.text }}
            </div>
            <div class="timestamp">
                {{ msg.time }}
            </div>
        </div>
    </div>

    <!-- Footer Input -->
    <footer>
        <input 
            type="text" 
            v-model="newMessage" 
            @keyup.enter="sendMessage" 
            :placeholder="isConnected ? t[lang].typeMessage : t[lang].connectFirst"
            :disabled="!isConnected"
        >
        <button class="icon-btn" @click="sendMessage" :disabled="!isConnected || !newMessage.trim()" style="color: var(--accent-color)">
            <i class="fa-solid fa-paper-plane"></i>
        </button>
    </footer>

</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

    createApp({
        setup() {
            // --- State ---
            const myId = ref(null);
            const targetId = ref('');
            const peer = ref(null);
            const conn = ref(null);
            const messages = ref([]);
            const newMessage = ref('');
            const theme = ref('dark'); // 'dark' or 'light'
            const lang = ref('en'); // 'en' or 'ru'
            const connectionStatus = ref('offline'); // offline, connecting, connected
            const chatContainer = ref(null);
            
            // Toast Notification
            const toast = ref({ visible: false, message: '' });

            // --- Translations ---
            const t = {
                en: {
                    myIdLabel: 'My User ID',
                    initializing: 'Generating...',
                    copy: 'Copy to Clipboard',
                    connectPlaceholder: 'Enter Friend ID',
                    connectBtn: 'Connect',
                    connected: 'Chatting',
                    typeMessage: 'Start a new message',
                    connectFirst: 'Connect to a friend to chat',
                    emptyChat: 'No messages yet. Connect and say Hello!',
                    toggleTheme: 'Toggle Theme',
                    toggleLang: 'Switch Language',
                    clearChat: 'Clear History',
                    status_offline: 'Offline',
                    status_connecting: 'Connecting...',
                    status_connected: 'Online',
                    err_peer: 'Connection Error. ID might be invalid.',
                    copied: 'ID Copied!',
                    peer_connected: 'Friend connected!'
                },
                ru: {
                    myIdLabel: 'Мой ID',
                    initializing: 'Генерация...',
                    copy: 'Скопировать',
                    connectPlaceholder: 'Введите ID друга',
                    connectBtn: 'Подкл.',
                    connected: 'В чате',
                    typeMessage: 'Введите сообщение...',
                    connectFirst: 'Подключитесь к другу для общения',
                    emptyChat: 'Сообщений нет. Скажите Привет!',
                    toggleTheme: 'Сменить тему',
                    toggleLang: 'Сменить язык',
                    clearChat: 'Очистить историю',
                    status_offline: 'Оффлайн',
                    status_connecting: 'Подключение...',
                    status_connected: 'Онлайн',
                    err_peer: 'Ошибка. Неверный ID.',
                    copied: 'ID скопирован!',
                    peer_connected: 'Друг подключился!'
                }
            };

            // --- Computed Properties ---
            const isConnected = computed(() => connectionStatus.value === 'connected');
            
            const statusColor = computed(() => {
                if (connectionStatus.value === 'connected') return 'var(--status-online)';
                if (connectionStatus.value === 'connecting') return 'var(--status-connecting)';
                return 'var(--status-offline)';
            });

            const connectionStatusText = computed(() => {
                if (connectionStatus.value === 'connected') return t[lang.value].status_connected;
                if (connectionStatus.value === 'connecting') return t[lang.value].status_connecting;
                return t[lang.value].status_offline;
            });

            // --- Actions ---

            const showToast = (msg) => {
                toast.value.message = msg;
                toast.value.visible = true;
                setTimeout(() => { toast.value.visible = false; }, 3000);
            };

            const toggleTheme = () => {
                theme.value = theme.value === 'dark' ? 'light' : 'dark';
            };

            const toggleLang = () => {
                lang.value = lang.value === 'en' ? 'ru' : 'en';
            };

            const copyId = () => {
                if (myId.value) {
                    navigator.clipboard.writeText(myId.value);
                    showToast(t[lang.value].copied);
                }
            };

            const clearHistory = () => {
                if(confirm('Delete all messages?')) {
                    messages.value = [];
                    saveData();
                }
            };

            const scrollToBottom = async () => {
                await nextTick();
                if (chatContainer.value) {
                    chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
                }
            };

            // --- PeerJS Logic ---

            const initPeer = () => {
                // Initialize Peer with no arguments (Serverless/Public Cloud)
                peer.value = new Peer();

                peer.value.on('open', (id) => {
                    myId.value = id;
                });

                // Handle incoming connection
                peer.value.on('connection', (connection) => {
                    setupConnection(connection);
                    showToast(t[lang.value].peer_connected);
                });

                peer.value.on('error', (err) => {
                    console.error(err);
                    showToast(t[lang.value].err_peer);
                    connectionStatus.value = 'offline';
                });
            };

            const connectToPeer = () => {
                if (!targetId.value) return;
                connectionStatus.value = 'connecting';
                const connection = peer.value.connect(targetId.value);
                
                // We need to wait for open to ensure connection is valid
                connection.on('open', () => {
                    setupConnection(connection);
                });

                connection.on('error', (err) => {
                    showToast(t[lang.value].err_peer);
                    connectionStatus.value = 'offline';
                });
            };

            const setupConnection = (connection) => {
                // Close existing if any
                if (conn.value) {
                    conn.value.close();
                }

                conn.value = connection;
                connectionStatus.value = 'connected';
                targetId.value = connection.peer; // Sync input with connected peer

                // Receive Data
                conn.value.on('data', (data) => {
                    messages.value.push({
                        text: data.text,
                        time: data.time,
                        sender: 'friend'
                    });
                    scrollToBottom();
                    saveData();
                });

                conn.value.on('close', () => {
                    connectionStatus.value = 'offline';
                    conn.value = null;
                });
            };

            const sendMessage = () => {
                if (!isConnected.value || !newMessage.value.trim()) return;

                const msgData = {
                    text: newMessage.value.trim(),
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };

                // Send via PeerJS
                conn.value.send(msgData);

                // Add to local UI
                messages.value.push({
                    ...msgData,
                    sender: 'me'
                });

                newMessage.value = '';
                scrollToBottom();
                saveData();
            };

            // --- Persistence ---
            const saveData = () => {
                localStorage.setItem('tweeyer_theme', theme.value);
                localStorage.setItem('tweeyer_lang', lang.value);
                localStorage.setItem('tweeyer_msgs', JSON.stringify(messages.value));
            };

            const loadData = () => {
                const sTheme = localStorage.getItem('tweeyer_theme');
                const sLang = localStorage.getItem('tweeyer_lang');
                const sMsgs = localStorage.getItem('tweeyer_msgs');

                if (sTheme) theme.value = sTheme;
                if (sLang) lang.value = sLang;
                if (sMsgs) messages.value = JSON.parse(sMsgs);
            };

            // --- Lifecycle ---
            watch([theme, lang], () => {
                saveData();
            });

            onMounted(() => {
                loadData();
                initPeer();
                scrollToBottom();
            });

            return {
                myId,
                targetId,
                messages,
                newMessage,
                theme,
                lang,
                t,
                isConnected,
                statusColor,
                connectionStatusText,
                chatContainer,
                toast,
                // Actions
                toggleTheme,
                toggleLang,
                copyId,
                connectToPeer,
                sendMessage,
                clearHistory
            };
        }
    }).mount('#app');
</script>

</body>
</html>
