<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Дурак Онлайн (PRO)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            /* БОЛЬШИЕ РАЗМЕРЫ */
            --card-w: 110px;
            --card-h: 160px;
            --radius: 5px; /* Минимальное скругление */
            --bg-color: #263238;
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            /* Текстура сукна */
            background-image: 
                linear-gradient(rgba(0,0,0,0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.3) 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            height: 100vh;
            color: white;
            display: flex; flex-direction: column;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- UI ЛОББИ --- */
        #lobby {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .panel {
            background: #eceff1; color: #263238;
            padding: 30px; width: 90%; max-width: 380px;
            border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.7);
        }
        .inp {
            width: 100%; padding: 15px; border: 2px solid #b0bec5;
            margin: 10px 0; font-size: 18px; border-radius: 4px;
            box-sizing: border-box; background: #fff;
        }
        .btn {
            width: 100%; padding: 15px; border: none;
            font-size: 18px; font-weight: bold; color: white;
            cursor: pointer; border-radius: 4px; margin-top: 10px;
            text-transform: uppercase; letter-spacing: 1px;
            transition: 0.1s;
        }
        .btn-host { background: #2e7d32; border-bottom: 4px solid #1b5e20; }
        .btn-host:active { transform: translateY(2px); border-bottom: 2px solid #1b5e20; }
        
        .btn-join { background: #1565c0; border-bottom: 4px solid #0d47a1; }
        .btn-join:active { transform: translateY(2px); border-bottom: 2px solid #0d47a1; }

        /* --- ИГРА --- */
        #game { display: none; flex-direction: column; height: 100%; position: relative; }

        /* Зона соперника */
        .top-zone {
            height: 140px; display: flex; align-items: center; padding: 10px 20px;
            background: rgba(0,0,0,0.2);
        }
        .avatar-box {
            width: 70px; display: flex; flex-direction: column; align-items: center;
        }
        .avatar {
            width: 60px; height: 60px; background: #555;
            border: 2px solid #fff; border-radius: 6px; /* Квадратнее */
            overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .p-name { font-size: 13px; font-weight: bold; margin-top: 4px; text-shadow: 1px 1px 2px black; }
        
        /* Карты соперника */
        #opp-hand { display: flex; margin-left: 30px; height: 100%; align-items: center; }
        .card-mini {
            width: 50px; height: 75px; background: white;
            border-radius: 3px; border: 1px solid #ccc;
            margin-left: -25px; /* Сгущаем */
            background-image: url('https://deckofcardsapi.com/static/img/back.png');
            background-size: cover;
            box-shadow: -2px 0 5px rgba(0,0,0,0.4);
        }

        /* Стол (Центр) */
        .mid-zone {
            flex: 1; position: relative;
            display: flex; justify-content: center; align-items: center;
        }
        
        /* КОЛОДА */
        .deck-pos {
            position: absolute; left: 20px; top: 50%; transform: translateY(-50%);
            width: var(--card-w); height: var(--card-h);
        }
        .deck-count-badge {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); padding: 4px 10px; border-radius: 4px;
            font-weight: bold; border: 1px solid #777;
        }

        /* СЛОТЫ */
        .slots-area {
            display: flex; gap: 10px;
            padding: 0 10px;
            /* Чтобы при переполнении скроллилось, если карт много */
            max-width: 100%; overflow-x: auto; 
            min-height: var(--card-h);
            align-items: center;
        }
        .slot {
            width: var(--card-w); height: var(--card-h);
            position: relative; flex-shrink: 0;
        }
        
        /* КАРТЫ (Стиль) */
        .card {
            width: var(--card-w); height: var(--card-h);
            border-radius: var(--radius);
            background-color: #fff;
            background-size: 100% 100%;
            background-repeat: no-repeat;
            position: relative;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.5);
            transition: transform 0.15s;
        }
        .card-back { background-image: url('https://deckofcardsapi.com/static/img/back.png'); }

        .card-att { position: absolute; top: 0; left: 0; z-index: 10; }
        .card-def { position: absolute; top: 20px; left: 15px; z-index: 20; transform: rotate(10deg); }

        /* Зона Игрока (Низ) */
        .bot-zone {
            height: 200px; display: flex; align-items: flex-end; justify-content: center;
            padding-bottom: 20px; position: relative;
        }
        
        /* Рука Игрока */
        #my-hand { display: flex; align-items: flex-end; }
        .my-card-wrap {
            width: 50px; /* Ширина "полоски" карты */
            height: var(--card-h);
            position: relative;
            transition: 0.2s;
            cursor: pointer;
        }
        .my-card-wrap:last-child { width: var(--card-w); } /* Последняя видна целиком */
        
        .my-card-wrap .card {
            position: absolute; bottom: 0; left: 0;
            transition: transform 0.2s;
        }
        /* Ховер эффект: карта выезжает вверх */
        .my-card-wrap:hover .card { transform: translateY(-20px); z-index: 100; }
        .my-card-wrap.selected .card { 
            transform: translateY(-40px); 
            box-shadow: 0 0 0 4px #ffeb3b; /* Желтая обводка */
            z-index: 101; 
        }

        /* --- КНОПКИ ДЕЙСТВИЙ (Переделанные) --- */
        .controls {
            position: absolute; right: 20px; bottom: 220px;
            display: flex; flex-direction: column; gap: 15px; align-items: flex-end;
        }
        .status-box {
            background: #37474f; color: #fff; padding: 10px 20px;
            border-radius: 4px; border-left: 5px solid #ccc;
            font-size: 16px; margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .act-btn {
            border: none; color: white; font-weight: bold;
            font-size: 20px; padding: 15px 40px;
            border-radius: 6px; /* ПРЯМОУГОЛЬНЫЕ */
            cursor: pointer; text-transform: uppercase;
            box-shadow: 0 6px 0 rgba(0,0,0,0.3);
            transition: transform 0.1s, box-shadow 0.1s;
            display: none; width: 180px; text-align: center;
        }
        .act-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.3); }
        
        .btn-take { background: #ef6c00; border-bottom: 4px solid #e65100; } /* Оранжевый */
        .btn-bito { background: #c62828; border-bottom: 4px solid #b71c1c; } /* Красный */

        /* --- ЧАТ --- */
        #chat-panel {
            position: absolute; top: 10px; right: 10px;
            width: 320px; height: 250px;
            display: flex; flex-direction: column;
            pointer-events: none; /* Пропускать клики, если мимо текста */
        }
        #chat-msgs {
            flex: 1; overflow-y: auto; display: flex; flex-direction: column; justify-content: flex-end;
            margin-bottom: 5px; padding-right: 5px;
            text-shadow: 1px 1px 2px black;
        }
        .msg {
            background: rgba(0,0,0,0.6); padding: 5px 10px; margin-bottom: 4px;
            border-radius: 4px; color: white; font-size: 14px;
            align-self: flex-start; pointer-events: auto;
            border-left: 3px solid #ccc;
            max-width: 90%; word-wrap: break-word;
        }
        .msg.me { align-self: flex-end; border-left: none; border-right: 3px solid #ffd54f; text-align: right; }
        .msg b { color: #ffd54f; }
        .msg.opp b { color: #ef5350; }

        #chat-input-area {
            display: flex; pointer-events: auto; background: #37474f;
            border-radius: 4px; padding: 2px;
            border: 1px solid #546e7a;
        }
        #chat-in {
            flex: 1; background: transparent; border: none; color: white;
            padding: 10px; font-size: 14px; outline: none;
        }
        #chat-send {
            background: #2e7d32; border: none; color: white; width: 50px;
            cursor: pointer; font-weight: bold; border-radius: 2px;
        }

        /* --- RUSSIAN PATCH (Текстура букв) --- */
        .rus-char {
            position: absolute; width: 20px; height: 25px;
            background: #fff; /* Белая бумага */
            font-family: 'Times New Roman', serif; font-weight: bold; font-size: 20px;
            text-align: center; line-height: 25px;
        }
        .tl { top: 4px; left: 4px; }
        .br { bottom: 4px; right: 4px; transform: rotate(180deg); }
        .c-red { color: #d32f2f; }
        .c-black { color: #000; }

        /* Адаптив (Mobile) */
        @media (max-width: 650px) {
            :root { --card-w: 85px; --card-h: 120px; }
            .top-zone { height: 100px; padding: 5px; }
            .bot-zone { height: 140px; }
            .controls { bottom: 150px; right: 10px; gap: 10px; }
            .act-btn { width: 140px; font-size: 16px; padding: 12px 20px; }
            #chat-panel { width: 220px; height: 160px; top: 5px; right: 5px; }
            .msg { font-size: 12px; }
            .deck-pos { left: 10px; }
            #opp-hand { margin-left: 10px; }
            .card-mini { width: 35px; height: 50px; margin-left: -18px; }
            /* Увеличим карты в руке для тача */
            .my-card-wrap { width: 40px; }
        }
    </style>
</head>
<body>

    <!-- ЛОББИ -->
    <div id="lobby">
        <div class="panel" id="p-start">
            <h2 style="margin-top:0;">DURAK ONLINE</h2>
            <input type="text" id="my-name" class="inp" placeholder="Твой никнейм" value="Игрок">
            <button class="btn btn-host" onclick="App.create()">Создать игру</button>
            <div style="text-align:center; margin:10px; color:#78909c;">— ИЛИ —</div>
            <input type="text" id="join-id" class="inp" placeholder="ID Комнаты">
            <button class="btn btn-join" onclick="App.join()">Войти</button>
        </div>
        
        <div class="panel" id="p-wait" style="display:none; text-align:center;">
            <h3>Ждем соперника...</h3>
            <p>Скинь этот ID другу:</p>
            <input type="text" id="host-id-out" class="inp" style="text-align:center; font-weight:bold; background:#eee;" readonly onclick="this.select()">
            <div style="font-size:30px; margin-top:10px; animation: spin 2s infinite;">⌛</div>
        </div>
    </div>

    <!-- ИГРОВОЕ ПОЛЕ -->
    <div id="game">
        <!-- Чат -->
        <div id="chat-panel">
            <div id="chat-msgs"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-in" placeholder="Написать..." autocomplete="off">
                <button id="chat-send" onclick="App.sendChat()">➤</button>
            </div>
        </div>

        <!-- Верхняя панель (Враг) -->
        <div class="top-zone">
            <div class="avatar-box">
                <div class="avatar"><img id="opp-ava" src=""></div>
                <div class="p-name" id="opp-name">Враг</div>
            </div>
            <div id="opp-hand"></div>
        </div>

        <!-- Стол -->
        <div class="mid-zone">
            <!-- Колода -->
            <div class="deck-pos">
                <div class="deck-count-badge" id="deck-cnt">36</div>
                <div id="trump-slot"></div> <!-- Козырь -->
                <div id="deck-slot" class="card card-back" style="position:absolute; top:0; left:0; z-index:2;"></div>
            </div>

            <!-- Карты в игре -->
            <div class="slots-area" id="table"></div>

            <!-- Управление -->
            <div class="controls">
                <div id="status" class="status-box">Загрузка...</div>
                <button id="btn-bito" class="act-btn btn-bito" onclick="App.act('BITO')">БИТО</button>
                <button id="btn-take" class="act-btn btn-take" onclick="App.act('TAKE')">ВЗЯТЬ</button>
            </div>
        </div>

        <!-- Нижняя панель (Я) -->
        <div class="bot-zone">
            <div id="my-hand"></div>
            
            <div class="avatar-box" style="position:absolute; bottom:10px; left:10px;">
                <div class="avatar"><img id="my-ava" src=""></div>
                <div class="p-name">Ты</div>
            </div>
        </div>
    </div>

    <script>
        // --- КОНСТАНТЫ ---
        const SUITS = ['S', 'C', 'H', 'D']; 
        const RANKS = ['6', '7', '8', '9', '0', 'J', 'Q', 'K', 'A']; // 0 = 10
        const R_MAP = {'6':'6', '7':'7', '8':'8', '9':'9', '0':'10', 'J':'В', 'Q':'Д', 'K':'К', 'A':'Т'};
        
        // API (карты)
        const getUrl = (r, s) => `https://deckofcardsapi.com/static/img/${r}${s}.png`;
        const isRed = s => (s==='H'||s==='D');

        // --- ДВИЖОК (Logic) ---
        class Engine {
            constructor() {
                this.deck = [];
                this.trump = null;
                this.hands = { h: [], c: [] };
                this.field = [];
                this.turn = 'h'; // h=Host, c=Client
                this.state = 'lobby';
                this.meta = { h: {}, c: {} };
            }

            start(hData, cData) {
                this.meta.h = hData; this.meta.c = cData;
                this.deck = [];
                SUITS.forEach(s => RANKS.forEach(r => this.deck.push({r, s})));
                this.deck.sort(()=>Math.random()-0.5);

                this.hands.h = this.deck.splice(0,6);
                this.hands.c = this.deck.splice(0,6);
                
                this.trump = this.deck.pop();
                this.deck.unshift(this.trump);

                // Кто первый?
                let minH=100, minC=100;
                const val = c => RANKS.indexOf(c.r);
                this.hands.h.forEach(c => {if(c.s===this.trump.s && val(c)<minH) minH=val(c)});
                this.hands.c.forEach(c => {if(c.s===this.trump.s && val(c)<minC) minC=val(c)});
                
                this.turn = (minC < minH && minC !== 100) ? 'c' : 'h';
                this.state = 'game';
            }

            beat(att, def) {
                if(att.s === def.s) return RANKS.indexOf(def.r) > RANKS.indexOf(att.r);
                return def.s === this.trump.s;
            }

            move(role, type, data) { // role: 'h' or 'c'
                if(this.state !== 'game') return false;

                if(type === 'ATT') {
                    if(role !== this.turn) return false;
                    const c = this.hands[role][data.i];
                    
                    // Проверка подкидывания
                    if(this.field.length > 0) {
                        const ranks = new Set();
                        this.field.forEach(p => { ranks.add(p.att.r); if(p.def) ranks.add(p.def.r); });
                        if(!ranks.has(c.r)) return false;
                    }
                    // Лимит
                    const defRole = role==='h'?'c':'h';
                    const unbeat = this.field.filter(p=>!p.def).length;
                    if(unbeat >= this.hands[defRole].length) return false;
                    if(this.field.length >= 6) return false;

                    this.hands[role].splice(data.i, 1);
                    this.field.push({ att: c, def: null });
                    return true;
                }

                if(type === 'DEF') {
                    if(role === this.turn) return false;
                    const slot = this.field[data.slot];
                    if(!slot || slot.def) return false;
                    const c = this.hands[role][data.i];
                    
                    if(this.beat(slot.att, c)) {
                        this.hands[role].splice(data.i, 1);
                        slot.def = c;
                        return true;
                    }
                    return false;
                }

                if(type === 'BITO') {
                    if(role !== this.turn) return false;
                    if(this.field.length===0 || this.field.some(p=>!p.def)) return false;
                    this.field = [];
                    this.draw();
                    this.turn = role==='h'?'c':'h';
                    return true;
                }

                if(type === 'TAKE') {
                    if(role === this.turn) return false;
                    this.field.forEach(p => {
                        this.hands[role].push(p.att);
                        if(p.def) this.hands[role].push(p.def);
                    });
                    this.field = [];
                    this.draw(true); // Пропускаем добор защищающегося
                    // Ход остается у того же атакующего
                    return true;
                }
                return false;
            }

            draw(skipDef=false) {
                const att = this.turn;
                const def = att==='h'?'c':'h';
                const fill = p => {
                    while(this.hands[p].length<6 && this.deck.length>0) this.hands[p].push(this.deck.pop());
                };
                fill(att);
                if(!skipDef) fill(def);
                
                if(this.deck.length===0) {
                    if(this.hands.h.length===0) this.state='win_h';
                    else if(this.hands.c.length===0) this.state='win_c';
                }
            }

            getDump() {
                return {
                    d: this.deck.length,
                    t: this.turn,
                    tr: this.trump,
                    f: this.field,
                    h: { h: this.hands.h.length, c: this.hands.c.length },
                    s: this.state,
                    m: this.meta
                };
            }
        }

        // --- ПРИЛОЖЕНИЕ (Client) ---
        const App = {
            role: null, // 'h' or 'c'
            conn: null,
            eng: null, // Only host
            
            me: { name: '', ava: Math.floor(Math.random()*15)+1 },
            lastS: null,
            hand: [],
            sel: null,

            init() {
                const u = new URLSearchParams(location.search);
                if(u.has('game')) {
                    document.getElementById('join-id').value = u.get('game');
                    document.getElementById('p-start').querySelector('h2').innerText = "ВХОД В ИГРУ";
                }
                // Чат Enter
                document.getElementById('chat-in').addEventListener('keypress', e => {
                    if(e.key === 'Enter') App.sendChat();
                });
            },

            create() {
                this.me.name = document.getElementById('my-name').value || 'Host';
                this.role = 'h';
                this.eng = new Engine();
                
                const p = new Peer();
                p.on('open', id => {
                    document.getElementById('p-start').style.display = 'none';
                    document.getElementById('p-wait').style.display = 'block';
                    document.getElementById('host-id-out').value = id;
                });
                p.on('connection', c => {
                    this.conn = c;
                    this.setup();
                });
            },

            join() {
                const id = document.getElementById('join-id').value;
                if(!id) return alert('Введи ID!');
                this.me.name = document.getElementById('my-name').value || 'Guest';
                this.role = 'c';
                
                const p = new Peer();
                p.on('open', () => {
                    this.conn = p.connect(id);
                    this.setup();
                });
            },

            setup() {
                this.conn.on('open', () => {
                    // 1. Отправляем привет
                    this.conn.send({ type: 'HI', d: this.me });
                });

                this.conn.on('data', msg => {
                    // Обработка
                    if(msg.type === 'HI' && this.role === 'h') {
                        this.eng.start(this.me, msg.d);
                        this.sync();
                        UI.initGame();
                    }
                    if(msg.type === 'SYNC') {
                        this.lastS = msg.s;
                        this.hand = msg.h;
                        if(document.getElementById('game').style.display !== 'flex') UI.initGame();
                        UI.draw();
                    }
                    if(msg.type === 'ACT' && this.role === 'h') {
                        if(this.eng.move('c', msg.act, msg.pl)) this.sync();
                    }
                    if(msg.type === 'CHAT') {
                        UI.logChat(msg.n, msg.t, false);
                    }
                });
                
                this.conn.on('close', () => alert('Соединение потеряно'));
            },

            sync() {
                if(this.role !== 'h') return;
                const d = this.eng.getDump();
                // Себе
                this.lastS = d;
                this.hand = this.eng.hands.h;
                UI.draw();
                // Ему
                this.conn.send({ type: 'SYNC', s: d, h: this.eng.hands.c });
            },

            act(type, pl={}) {
                if(this.role === 'h') {
                    if(this.eng.move('h', type, pl)) this.sync();
                } else {
                    this.conn.send({ type: 'ACT', act: type, pl: pl });
                }
            },

            sendChat() {
                const el = document.getElementById('chat-in');
                const txt = el.value.trim();
                if(!txt || !this.conn) return;
                
                // Шлем
                this.conn.send({ type: 'CHAT', n: this.me.name, t: txt });
                // Рисуем
                UI.logChat(this.me.name, txt, true);
                el.value = '';
            }
        };

        // --- UI ---
        const UI = {
            initGame() {
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('game').style.display = 'flex';
                // Аватарки
                const meta = App.lastS.m;
                const oppR = App.role==='h'?'c':'h';
                const meR = App.role;
                
                document.getElementById('my-ava').src = `https://robohash.org/${meta[meR].ava}.png?set=set1`;
                document.getElementById('opp-ava').src = `https://robohash.org/${meta[oppR].ava}.png?set=set1`;
                document.getElementById('opp-name').innerText = meta[oppR].name;
            },

            draw() {
                const s = App.lastS;
                if(!s) return;

                // Победа?
                if(s.s.includes('win')) {
                    const winR = s.s.split('_')[1];
                    alert(winR === App.role ? "ТЫ ПОБЕДИЛ!" : "ТЫ ПРОИГРАЛ!");
                    location.href = location.pathname;
                    return;
                }

                // 1. Враг
                const oppR = App.role==='h'?'c':'h';
                const oppC = s.h[oppR];
                const oh = document.getElementById('opp-hand');
                oh.innerHTML = '';
                for(let i=0; i<oppC; i++) {
                    const d = document.createElement('div');
                    d.className = 'card-mini';
                    oh.appendChild(d);
                }

                // 2. Колода
                const dCnt = document.getElementById('deck-cnt');
                const dSlot = document.getElementById('deck-slot');
                const tSlot = document.getElementById('trump-slot');
                dCnt.innerText = s.d;
                tSlot.innerHTML = '';
                
                if(s.d > 0) {
                    const tr = this.mkCard(s.tr);
                    tr.style.position = 'absolute';
                    tr.style.transform = 'rotate(90deg) translateX(30px)';
                    tr.style.zIndex = 1;
                    tSlot.appendChild(tr);
                    dSlot.style.display = s.d > 1 ? 'block' : 'none';
                } else {
                    dSlot.style.display = 'none';
                    // Козырь пропадает визуально, но масть помним. Можно оставить иконку.
                }

                // 3. Стол
                const tbl = document.getElementById('table');
                tbl.innerHTML = '';
                s.f.forEach((p, idx) => {
                    const slot = document.createElement('div');
                    slot.className = 'slot';
                    
                    const c1 = this.mkCard(p.att);
                    c1.classList.add('card-att');
                    slot.appendChild(c1);

                    if(p.def) {
                        const c2 = this.mkCard(p.def);
                        c2.classList.add('card-def');
                        slot.appendChild(c2);
                    } else {
                        // Зона клика для защиты
                        if(App.role !== s.t && App.sel !== null) {
                            slot.style.border = "2px dashed #f1c40f";
                            slot.style.borderRadius = "5px";
                            slot.style.cursor = "pointer";
                            slot.onclick = () => {
                                App.act('DEF', { i: App.sel, slot: idx });
                                App.sel = null;
                            };
                        }
                    }
                    tbl.appendChild(slot);
                });

                // 4. Моя рука
                const mh = document.getElementById('my-hand');
                mh.innerHTML = '';
                App.hand.forEach((c, i) => {
                    const wrap = document.createElement('div');
                    wrap.className = 'my-card-wrap';
                    if(App.sel === i) wrap.classList.add('selected');
                    
                    const el = this.mkCard(c);
                    el.onclick = (e) => {
                        e.stopPropagation(); // чтобы не триггерить wrap
                        // Атака
                        if(App.role === s.t) {
                            App.act('ATT', { i });
                        } else {
                            // Выбор для защиты
                            App.sel = (App.sel === i) ? null : i;
                            this.draw();
                        }
                    };
                    wrap.appendChild(el);
                    wrap.onclick = el.onclick; // Клик по полоске тоже работает
                    mh.appendChild(wrap);
                });

                // 5. Статус и Кнопки
                const st = document.getElementById('status');
                const bBito = document.getElementById('btn-bito');
                const bTake = document.getElementById('btn-take');
                bBito.style.display = 'none'; bTake.style.display = 'none';

                const isMyTurn = (App.role === s.t);
                
                if(isMyTurn) {
                    st.innerText = "ТВОЙ ХОД (АТАКА)";
                    st.style.borderLeftColor = "#66bb6a";
                    const allBeat = s.f.length>0 && s.f.every(x=>x.def);
                    if(allBeat) bBito.style.display = 'block';
                } else {
                    st.innerText = "ОТБИВАЙСЯ";
                    st.style.borderLeftColor = "#ef5350";
                    if(s.f.some(x=>!x.def)) bTake.style.display = 'block';
                }
            },

            mkCard(c) {
                const el = document.createElement('div');
                el.className = 'card';
                el.style.backgroundImage = `url('${getUrl(c.r, c.s)}')`;
                
                // Патч для русских букв
                if(['J','Q','K','A'].includes(c.r)) {
                    const txt = R_MAP[c.r];
                    const col = isRed(c.s) ? 'c-red' : 'c-black';
                    el.innerHTML = `
                        <div class="rus-char tl ${col}">${txt}</div>
                        <div class="rus-char br ${col}">${txt}</div>
                    `;
                }
                return el;
            },

            logChat(n, t, isMe) {
                const box = document.getElementById('chat-msgs');
                const d = document.createElement('div');
                d.className = 'msg ' + (isMe?'me':'opp');
                d.innerHTML = `<b>${n}:</b> ${t}`;
                box.appendChild(d);
                box.scrollTop = box.scrollHeight;
            }
        };
        
        App.init();
    </script>
</body>
</html>
