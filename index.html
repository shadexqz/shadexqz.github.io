<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tweeyer V5 Ultra (Fixed)</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        tg: {
                            bg: '#17212b',
                            sidebar: '#17212b',
                            panel: '#242f3d',
                            hover: '#2b5278',
                            active: '#232e3c',
                            self: '#766ac8',
                            text: '#eef3f7',
                            hint: '#7f91a4',
                            blue: '#3390ec',
                            red: '#ef5b5b'
                        }
                    },
                    animation: {
                        'like-bounce': 'likeBounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        likeBounce: {
                            '0%': { transform: 'scale(0)' },
                            '50%': { transform: 'scale(1.5)' },
                            '100%': { transform: 'scale(1)' }
                        }
                    }
                }
            }
        };
    </script>

    <style>
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }

        /* Wallpaper */
        .chat-bg-dark {
            background-color: #0f0f0f;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231d2a39' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .chat-bg-light {
            background-color: #f0f2f5;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d1d5db' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* Animations & Utils */
        .pop-enter-active, .pop-leave-active { transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .pop-enter-from, .pop-leave-to { opacity: 0; transform: scale(0.9); }
        
        .msg-enter-active { transition: all 0.3s ease-out; }
        .msg-enter-from { opacity: 0; transform: translateY(20px); }

        emoji-picker { width: 100%; height: 320px; --background: transparent; --border-color: transparent; }
        .dark emoji-picker { --color: #fff; --indicator-color: #3390ec; }
        
        /* Prevent iOS Zoom */
        @supports (-webkit-touch-callout: none) { body { -webkit-text-size-adjust: none; } }
    </style>
</head>
<body class="bg-white dark:bg-[#0f0f0f] text-gray-900 dark:text-tg-text h-[100dvh] w-screen overflow-hidden text-[15px] select-none font-sans" @contextmenu.prevent>

<div id="app" class="h-full flex relative" @click="handleGlobalClick" @keydown.esc="closeOverlays">

    <!-- ================= SETUP / LOGIN ================= -->
    <div v-if="!user.setupComplete" class="absolute inset-0 z-[60] bg-white dark:bg-[#0f0f0f] flex items-center justify-center p-4">
        <div class="max-w-sm w-full text-center">
            <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-tr from-blue-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/30">
                <i class="fa-solid fa-paper-plane text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2 dark:text-white">Tweeyer V5</h1>
            <p class="text-gray-500 mb-8">Ultra P2P Messaging (Fixed Edition)</p>
            <div class="space-y-4">
                <div class="relative w-28 h-28 mx-auto group cursor-pointer" @click="$refs.avaInput.click()">
                    <img :src="tempAvatar || defaultAvatar" class="w-full h-full rounded-full object-cover border-4 border-gray-100 dark:border-[#242f3d]">
                    <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-white"><i class="fa-solid fa-camera"></i></div>
                </div>
                <input type="file" ref="avaInput" class="hidden" accept="image/*" @change="onAvatarChange">
                <input v-model="tempName" placeholder="Your Name" class="w-full bg-gray-100 dark:bg-[#17212b] px-5 py-3 rounded-xl outline-none text-center dark:text-white focus:ring-2 focus:ring-tg-blue transition">
                <button @click="finishSetup" :disabled="!tempName" class="w-full bg-tg-blue text-white py-3 rounded-xl font-bold hover:bg-blue-600 transition disabled:opacity-50">Start</button>
            </div>
        </div>
    </div>

    <!-- ================= SIDEBAR ================= -->
    <aside class="w-full md:w-[360px] bg-white dark:bg-tg-sidebar border-r border-gray-200 dark:border-black/20 flex flex-col z-20 absolute md:relative h-full transition-transform duration-300"
           :class="mobileView === 'chat' ? '-translate-x-full md:translate-x-0' : 'translate-x-0'">
        
        <!-- Header -->
        <div class="h-[64px] px-4 flex items-center gap-3 shrink-0">
            <button @click="ui.showDrawer = true" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-white/5 flex items-center justify-center text-gray-500 dark:text-gray-300">
                <i class="fa-solid fa-bars"></i>
            </button>
            <div class="flex-1 relative">
                <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input v-model="searchQuery" placeholder="Search..." class="w-full bg-gray-100 dark:bg-[#0f161e] rounded-full h-9 pl-9 pr-4 text-sm outline-none dark:text-white border border-transparent focus:border-tg-blue focus:bg-white dark:focus:bg-[#17212b] transition">
            </div>
        </div>

        <!-- Connection Panel -->
        <div class="px-3 pb-2">
            <div class="bg-gray-50 dark:bg-tg-panel rounded-xl p-3 border border-gray-100 dark:border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] font-bold text-tg-blue uppercase tracking-widest">My ID</span>
                    <button @click="copyId" class="text-tg-blue text-[10px] font-bold hover:underline">COPY</button>
                </div>
                <div class="text-xs font-mono text-gray-600 dark:text-gray-300 break-all select-all mb-3 bg-black/5 dark:bg-black/20 p-1.5 rounded">{{ myPeerId || 'Connecting...' }}</div>
                <div class="flex gap-2">
                    <input v-model="targetId" placeholder="Paste Partner ID" class="flex-1 bg-white dark:bg-[#17212b] rounded-lg px-2 py-1.5 text-sm outline-none dark:text-white border border-gray-200 dark:border-black/20 focus:border-tg-blue">
                    <button @click="connect" :disabled="!isNetReady" class="bg-tg-blue text-white w-9 rounded-lg flex items-center justify-center hover:bg-blue-600 disabled:opacity-50"><i class="fa-solid fa-link"></i></button>
                </div>
            </div>
        </div>

        <!-- Chat List -->
        <div class="flex-1 overflow-y-auto">
            <div v-if="isConnected || messages.length > 0" @click="openChat" 
                 class="mx-2 p-2.5 rounded-xl hover:bg-gray-100 dark:hover:bg-tg-active cursor-pointer flex gap-3 transition group"
                 :class="{'bg-tg-blue dark:bg-tg-blue text-white hover:!bg-blue-600': isConnected && mobileView === 'chat'}">
                <div class="relative shrink-0">
                    <img :src="partner.avatar || defaultAvatar" class="w-12 h-12 rounded-full object-cover bg-gray-200 dark:bg-gray-700">
                    <div v-if="partner.online" class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-tg-sidebar rounded-full"></div>
                </div>
                <div class="flex-1 min-w-0 flex flex-col justify-center">
                    <div class="flex justify-between items-center mb-0.5">
                        <h3 class="font-semibold truncate text-[15px]">{{ partner.name || 'Unknown' }}</h3>
                        <span class="text-xs opacity-70">{{ lastMsgTime }}</span>
                    </div>
                    <p class="text-[14px] opacity-70 truncate" :class="{'text-red-300': partner.isDeleted}">
                        <span v-if="partner.isDeleted">Account Deleted</span>
                        <span v-else>
                            <span v-if="lastMsg?.sender === 'me'" class="mr-1">
                                <i v-if="lastMsg.status === 'read'" class="fa-solid fa-check-double text-[10px]"></i>
                                <i v-else class="fa-solid fa-check text-[10px]"></i>
                            </span>
                            {{ lastMsgPreview }}
                        </span>
                    </p>
                </div>
            </div>
            <div v-else class="text-center mt-20 text-gray-400 text-sm p-4">
                Share your ID to start messaging.
            </div>
        </div>
    </aside>

    <!-- ================= SETTINGS DRAWER ================= -->
    <transition name="slide">
        <div v-if="ui.showDrawer" class="absolute inset-y-0 left-0 w-72 bg-white dark:bg-tg-sidebar z-50 shadow-2xl flex flex-col border-r border-gray-200 dark:border-black/20">
            <div class="h-32 bg-tg-blue p-5 flex items-end">
                <div class="flex items-center gap-3 text-white">
                    <div class="relative group cursor-pointer" @click="$refs.editAva.click()">
                        <img :src="user.avatar || defaultAvatar" class="w-14 h-14 rounded-full object-cover border-2 border-white">
                        <div class="absolute inset-0 bg-black/30 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-pen"></i></div>
                    </div>
                    <div>
                        <div class="font-bold">{{ user.name }}</div>
                        <div class="text-xs opacity-80">Online</div>
                    </div>
                </div>
                <input type="file" ref="editAva" class="hidden" accept="image/*" @change="onAvatarChange">
            </div>
            <div class="p-2 space-y-1 mt-2">
                <button @click="ui.showDrawer=false" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 dark:text-white flex items-center gap-4 transition">
                    <i class="fa-solid fa-arrow-left w-6 text-center text-gray-400"></i> Back
                </button>
                <button @click="toggleTheme" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 dark:text-white flex items-center gap-4 transition">
                    <i class="fa-solid w-6 text-center text-gray-400" :class="theme==='dark'?'fa-sun':'fa-moon'"></i> 
                    {{ theme==='dark'?'Light Mode':'Dark Mode' }}
                </button>
                <div class="h-px bg-gray-200 dark:bg-white/5 my-2 mx-3"></div>
                <button @click="logout" class="w-full text-left p-3 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/10 text-red-500 flex items-center gap-4 transition">
                    <i class="fa-solid fa-power-off w-6 text-center"></i> Reset & Logout
                </button>
            </div>
        </div>
    </transition>

    <!-- ================= CHAT AREA ================= -->
    <main class="flex-1 flex flex-col h-full relative transition-colors duration-300"
          :class="theme === 'dark' ? 'chat-bg-dark' : 'chat-bg-light', mobileView === 'sidebar' ? 'translate-x-full md:translate-x-0 hidden md:flex' : 'translate-x-0'">
        
        <!-- Chat Header -->
        <header class="h-[64px] bg-white/95 dark:bg-tg-sidebar/95 backdrop-blur flex items-center justify-between px-4 shrink-0 border-b border-gray-100 dark:border-black/20 z-10 cursor-pointer" @click="ui.viewProfile = true">
            <div class="flex items-center gap-3">
                <button @click.stop="mobileView = 'sidebar'" class="md:hidden w-8 h-8 flex items-center justify-center text-gray-500 dark:text-gray-300"><i class="fa-solid fa-arrow-left"></i></button>
                <img :src="partner.avatar || defaultAvatar" class="w-10 h-10 rounded-full object-cover bg-gray-300">
                <div>
                    <h3 class="font-bold text-[16px] dark:text-white leading-tight">
                        {{ partner.name || 'Chat' }}
                        <i v-if="partner.isDeleted" class="fa-solid fa-ban text-red-500 text-xs ml-1"></i>
                    </h3>
                    <p class="text-xs text-tg-blue" v-if="!partner.isDeleted && partner.online">online</p>
                    <p class="text-xs text-gray-400" v-else-if="!partner.isDeleted">last seen recently</p>
                    <p class="text-xs text-red-400" v-else>Deleted Account</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button v-if="isConnected && !partner.isDeleted" @click.stop="startCall" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-white/5 text-tg-blue flex items-center justify-center transition"><i class="fa-solid fa-phone"></i></button>
                <button class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-white/5 text-gray-400 flex items-center justify-center transition"><i class="fa-solid fa-ellipsis-vertical"></i></button>
            </div>
        </header>

        <!-- Messages List -->
        <div id="chatContainer" class="flex-1 overflow-y-auto p-2 md:p-4 flex flex-col gap-1 scroll-smooth" @scroll="onScroll">
            <!-- Empty State -->
            <div v-if="messages.length === 0" class="flex-1 flex flex-col items-center justify-center opacity-40">
                <div class="bg-gray-200 dark:bg-white/5 p-5 rounded-full mb-3"><i class="fa-regular fa-paper-plane text-3xl dark:text-white"></i></div>
                <p class="dark:text-white text-sm">No messages yet...</p>
            </div>

            <template v-for="(item, index) in groupedMessages" :key="item.id || 'date-'+index">
                
                <!-- Date Separator -->
                <div v-if="item.type === 'date_separator'" class="flex justify-center my-4 sticky top-2 z-10">
                    <span class="bg-black/20 dark:bg-black/40 text-white text-xs px-3 py-1 rounded-full backdrop-blur-sm shadow-sm font-medium">
                        {{ item.content }}
                    </span>
                </div>

                <!-- System Message (Call logs etc) -->
                <div v-else-if="item.type === 'system'" class="flex justify-center my-2">
                     <span class="text-gray-500 text-xs bg-gray-100 dark:bg-white/5 px-3 py-1 rounded-full">
                        {{ item.content }}
                     </span>
                </div>

                <!-- Message Bubble -->
                <div v-else :id="'msg-'+item.id" 
                     class="group flex flex-col max-w-[85%] md:max-w-[65%] relative transition-all duration-200" 
                     :class="item.sender === 'me' ? 'self-end items-end' : 'self-start items-start'">
                    
                    <!-- Context Menu Trigger Area -->
                    <div class="relative shadow-sm text-[15px] leading-snug cursor-pointer select-none"
                         :class="getMessageClass(item)"
                         @dblclick="toggleLike(item)"
                         @contextmenu.prevent="showContext($event, item)">

                        <!-- Reply Preview -->
                        <div v-if="item.replyTo" class="mb-1 pl-2 border-l-2 border-tg-blue/50 text-xs opacity-70 truncate cursor-pointer" @click="jumpToMessage(item.replyTo.id)">
                            <span class="font-bold text-tg-blue">{{ item.replyTo.sender === 'me' ? 'You' : partner.name }}</span><br>
                            {{ item.replyTo.preview }}
                        </div>

                        <!-- Content Types -->
                        <div v-if="item.type === 'image'" class="rounded-lg overflow-hidden mb-1"><img :src="item.content" class="max-w-full max-h-[300px] object-cover" @click="zoomImg=item.content"></div>
                        
                        <div v-if="item.type === 'video'" class="rounded-lg overflow-hidden mb-1 relative bg-black">
                            <video :src="item.content" controls class="max-w-full max-h-[300px]"></video>
                        </div>
                        
                        <div v-if="item.type === 'voice'" class="flex items-center gap-3 pr-2 py-1 min-w-[200px]">
                            <button @click="playVoice(item.id)" class="w-9 h-9 rounded-full bg-white dark:bg-black/20 flex items-center justify-center shrink-0">
                                <i class="fa-solid text-xs" :class="playingVoice===item.id?'fa-pause':'fa-play'"></i>
                            </button>
                            <div class="flex-1 h-1 bg-gray-300 dark:bg-white/20 rounded-full overflow-hidden">
                                <div class="h-full bg-tg-blue transition-all duration-300" :style="{width: (playingVoice===item.id ? '100%' : '0%')}"></div>
                            </div>
                        </div>

                        <div v-if="item.type === 'text' || item.type === 'edit_text'" class="whitespace-pre-wrap break-words px-3 py-1.5 min-w-[40px]">
                            {{ item.content }}
                        </div>

                        <!-- Metadata -->
                        <div class="flex justify-end items-center gap-1 px-2 pb-1 text-[10px] opacity-60 select-none">
                            <span v-if="item.edited">(edited)</span>
                            <span>{{ formatTime(item.timestamp) }}</span>
                            <span v-if="item.sender === 'me'">
                                <i v-if="item.status === 'read'" class="fa-solid fa-check-double text-[#4ade80] dark:text-[#64d2ff]"></i>
                                <i v-else class="fa-solid fa-check"></i>
                            </span>
                        </div>

                        <!-- Reactions -->
                        <div v-if="item.liked" class="absolute -bottom-2 -right-1 w-6 h-6 bg-white dark:bg-tg-panel rounded-full border border-gray-200 dark:border-black/20 flex items-center justify-center shadow-sm animate-like-bounce z-10">
                            <span class="text-xs">❤️</span>
                        </div>
                    </div>
                </div>
            </template>
            <div id="bottomAnchor" class="h-1"></div>
        </div>

        <!-- Reply / Edit Banner -->
        <div v-if="replyingTo || editingMsg" class="px-4 py-2 bg-gray-50 dark:bg-[#17212b] border-t border-tg-blue/30 flex justify-between items-center animate-pop">
            <div class="flex items-center gap-3 overflow-hidden">
                <i class="fa-solid text-tg-blue" :class="editingMsg ? 'fa-pen' : 'fa-reply'"></i>
                <div class="flex flex-col text-sm border-l-2 border-tg-blue pl-2">
                    <span class="text-tg-blue font-bold">{{ editingMsg ? 'Editing Message' : (replyingTo.sender === 'me' ? 'Reply to You' : 'Reply to ' + partner.name) }}</span>
                    <span class="text-gray-500 truncate dark:text-gray-400 text-xs">{{ editingMsg ? editingMsg.content : replyingTo.content }}</span>
                </div>
            </div>
            <button @click="cancelAction" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
        </div>

        <!-- Input Area -->
        <footer v-if="!partner.isDeleted" class="bg-white dark:bg-tg-sidebar p-2 flex items-end gap-2 shrink-0 z-20 shadow-[0_-1px_5px_rgba(0,0,0,0.05)]">
            <button @click="ui.showAttach = !ui.showAttach" class="w-10 h-10 shrink-0 text-gray-400 hover:text-tg-blue transition rounded-full hover:bg-gray-100 dark:hover:bg-white/5"><i class="fa-solid fa-paperclip text-lg"></i></button>
            
            <!-- Attach Menu -->
            <transition name="pop">
                <div v-if="ui.showAttach" class="absolute bottom-16 left-2 bg-white dark:bg-tg-panel shadow-xl rounded-xl p-1 z-30 border dark:border-white/10">
                    <button @click="$refs.fileInput.click(); ui.showAttach=false" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-100 dark:hover:bg-white/5 w-full text-left rounded-lg text-sm dark:text-white">
                        <i class="fa-regular fa-image text-blue-500"></i> Photo/Video
                    </button>
                </div>
            </transition>
            <input type="file" ref="fileInput" class="hidden" accept="image/*,video/*" @change="handleFile">

            <div class="flex-1 bg-gray-100 dark:bg-[#17212b] rounded-2xl flex items-center relative transition-colors focus-within:bg-white dark:focus-within:bg-[#0f161e] border border-transparent focus-within:border-tg-blue">
                <textarea ref="msgInput" v-model="inputMsg" @keydown.enter.prevent="sendMsg" rows="1" placeholder="Message" class="w-full bg-transparent max-h-32 py-2.5 pl-3 pr-10 outline-none resize-none dark:text-white text-sm custom-scrollbar" style="min-height:42px"></textarea>
                <button @click="ui.showEmoji = !ui.showEmoji" class="absolute right-2 text-gray-400 hover:text-tg-blue"><i class="fa-regular fa-face-smile text-lg"></i></button>
            </div>

            <!-- Send/Rec Button -->
            <button v-if="inputMsg.trim()" @click="sendMsg" class="w-10 h-10 shrink-0 bg-tg-blue text-white rounded-full shadow-lg shadow-blue-500/30 hover:scale-105 active:scale-95 transition flex items-center justify-center">
                <i class="fa-solid" :class="editingMsg ? 'fa-check' : 'fa-paper-plane'"></i>
            </button>
            <button v-else @mousedown="startRec" @mouseup="stopRec" @touchstart.prevent="startRec" @touchend.prevent="stopRec" class="w-10 h-10 shrink-0 bg-gray-100 dark:bg-white/5 text-gray-500 dark:text-gray-300 rounded-full hover:bg-gray-200 dark:hover:bg-white/10 transition flex items-center justify-center" :class="{'bg-red-500 !text-white animate-pulse': isRecording}">
                <i class="fa-solid" :class="isRecording ? 'fa-stop' : 'fa-microphone'"></i>
            </button>
        </footer>

        <!-- Deleted Account Footer -->
        <div v-else class="p-4 bg-gray-50 dark:bg-[#17212b] border-t border-gray-200 dark:border-black/10 text-center text-sm text-gray-500 font-medium">
            <i class="fa-solid fa-ban mr-2"></i> Chat disabled.
        </div>

        <!-- Emoji Picker -->
        <transition name="pop">
            <div v-if="ui.showEmoji" class="absolute bottom-16 right-4 z-40 bg-white dark:bg-tg-panel shadow-2xl rounded-xl border dark:border-white/10 overflow-hidden w-80">
                <emoji-picker @emoji-click="addEmoji" class="dark:dark"></emoji-picker>
            </div>
        </transition>

        <!-- Context Menu -->
        <transition name="pop">
            <div v-if="ctxMenu.show" class="fixed z-[100] bg-white dark:bg-tg-panel shadow-2xl rounded-xl py-1 w-48 border dark:border-white/10 overflow-hidden backdrop-blur-md"
                 :style="{ top: ctxMenu.y + 'px', left: ctxMenu.x + 'px' }">
                <button @click="handleCtx('reply')" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-white/5 flex items-center gap-3 text-sm dark:text-white">
                    <i class="fa-solid fa-reply text-gray-400"></i> Reply
                </button>
                <button @click="handleCtx('copy')" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-white/5 flex items-center gap-3 text-sm dark:text-white">
                    <i class="fa-regular fa-copy text-gray-400"></i> Copy Text
                </button>
                <div v-if="ctxMenu.msg.sender === 'me'" class="h-px bg-gray-100 dark:bg-white/5 my-1"></div>
                <button v-if="ctxMenu.msg.sender === 'me' && ctxMenu.msg.type === 'text'" @click="handleCtx('edit')" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-white/5 flex items-center gap-3 text-sm dark:text-white">
                    <i class="fa-solid fa-pen text-gray-400"></i> Edit
                </button>
                <button @click="handleCtx('delete')" class="w-full text-left px-4 py-2 hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 flex items-center gap-3 text-sm">
                    <i class="fa-regular fa-trash-can"></i> Delete
                </button>
            </div>
        </transition>
    </main>

    <!-- ================= MODALS & OVERLAYS ================= -->
    
    <!-- Incoming Call -->
    <div v-if="call.incoming" class="fixed inset-0 z-[200] bg-black/80 backdrop-blur-md flex flex-col items-center justify-center text-white">
        <div class="relative mb-8">
            <div class="absolute inset-0 bg-green-500 rounded-full animate-ping opacity-50"></div>
            <img :src="partner.avatar" class="w-32 h-32 rounded-full relative z-10 border-4 border-white/20">
        </div>
        <h2 class="text-2xl font-bold mb-1">{{ partner.name }}</h2>
        <p class="text-gray-300 mb-10">Incoming Audio Call...</p>
        <div class="flex gap-16">
            <button @click="answerCall" class="w-16 h-16 rounded-full bg-green-500 flex items-center justify-center text-2xl hover:scale-110 transition"><i class="fa-solid fa-phone"></i></button>
            <button @click="rejectCall" class="w-16 h-16 rounded-full bg-red-500 flex items-center justify-center text-2xl hover:scale-110 transition"><i class="fa-solid fa-phone-slash"></i></button>
        </div>
    </div>

    <!-- Active Call -->
    <div v-if="call.active" class="fixed inset-0 z-[200] bg-[#1a2025] flex flex-col items-center justify-center text-white">
         <div class="absolute top-10 left-10 text-white/50"><i class="fa-solid fa-shield-halved"></i> End-to-End Encrypted</div>
         <img :src="partner.avatar" class="w-40 h-40 rounded-full mb-6 border-4 border-green-500/30 animate-pulse">
         <h2 class="text-3xl font-bold">{{ partner.name }}</h2>
         <p class="text-green-400 font-mono text-xl mt-2 mb-12">{{ call.duration }}</p>
         <div class="flex gap-8">
             <button class="w-14 h-14 rounded-full bg-white/10 hover:bg-white/20 transition flex items-center justify-center"><i class="fa-solid fa-microphone"></i></button>
             <button @click="endCall" class="w-16 h-16 rounded-full bg-red-500 hover:bg-red-600 shadow-xl shadow-red-500/30 transition flex items-center justify-center text-2xl"><i class="fa-solid fa-phone-slash"></i></button>
             <button class="w-14 h-14 rounded-full bg-white/10 hover:bg-white/20 transition flex items-center justify-center"><i class="fa-solid fa-volume-high"></i></button>
         </div>
    </div>

    <!-- Image Zoom -->
    <div v-if="zoomImg" class="fixed inset-0 z-[200] bg-black/95 flex items-center justify-center cursor-zoom-out" @click="zoomImg=null">
        <img :src="zoomImg" class="max-w-full max-h-full p-2 object-contain animate-pop">
    </div>

    <!-- Hidden Audio Elements -->
    <audio ref="remoteAudio" autoplay class="hidden"></audio>

</div>

<script>
    const { createApp, ref, reactive, onMounted, computed, watch, nextTick } = Vue;

    createApp({
        setup() {
            // STATE
            const ui = reactive({ showDrawer: false, showAttach: false, showEmoji: false, viewProfile: false });
            const ctxMenu = reactive({ show: false, x: 0, y: 0, msg: null });
            const user = reactive({ name: '', avatar: '', setupComplete: false });
            const partner = reactive({ name: '', avatar: '', online: false, isDeleted: false });
            const myPeerId = ref('');
            const targetId = ref('');
            const isNetReady = ref(false);
            const isConnected = ref(false);
            const mobileView = ref('sidebar');
            const messages = ref([]);
            const searchQuery = ref('');
            const inputMsg = ref('');
            const msgInput = ref(null);
            const theme = ref('dark');
            
            // Edit & Reply
            const replyingTo = ref(null);
            const editingMsg = ref(null);

            // Media
            const isRecording = ref(false);
            const playingVoice = ref(null);
            const zoomImg = ref(null);
            
            // Calls
            const call = reactive({ incoming: false, active: false, duration: '00:00', timer: null });
            
            // Internals
            let peer = null, conn = null, mediaRecorder = null, chunks = [], callObj = null, localStream = null;
            const tempName = ref(''), tempAvatar = ref(''), defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
            let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            // SOUNDS
            const playSound = (type) => {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                const t = audioCtx.currentTime;
                
                if(type === 'sent') {
                    osc.frequency.setValueAtTime(800, t); osc.frequency.exponentialRampToValueAtTime(1200, t+0.1);
                    gain.gain.setValueAtTime(0.05, t); gain.gain.exponentialRampToValueAtTime(0.001, t+0.1);
                    osc.start(t); osc.stop(t+0.1);
                } else if(type === 'in') {
                    osc.frequency.setValueAtTime(500, t); osc.frequency.linearRampToValueAtTime(800, t+0.1);
                    gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.1, t+0.05); gain.gain.linearRampToValueAtTime(0, t+0.3);
                    osc.start(t); osc.stop(t+0.3);
                } else if(type === 'ring') {
                    // Loop sound logic would be here, simplifying for snippet
                }
            };

            // LIFECYCLE
            onMounted(() => {
                const u = localStorage.getItem('tw_user');
                if(u) Object.assign(user, JSON.parse(u));
                const msgs = localStorage.getItem('tw_msgs');
                if(msgs) messages.value = JSON.parse(msgs);
                if(localStorage.getItem('tw_theme')) theme.value = localStorage.getItem('tw_theme');
                applyTheme();
                
                if(user.setupComplete) initPeer();
                
                // Cleanup deletions that might have synced
                messages.value = messages.value.filter(m => !m.deletedLocal);
            });

            watch(messages, (val) => {
                localStorage.setItem('tw_msgs', JSON.stringify(val));
            }, { deep: true });

            // NETWORKING
            const initPeer = () => {
                peer = new Peer(null, { config: { iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] } });
                peer.on('open', id => { myPeerId.value = id; isNetReady.value = true; });
                peer.on('connection', c => setupConn(c));
                peer.on('call', c => {
                    call.incoming = true;
                    callObj = c;
                    playSound('in'); // Ringing sound
                });
            };

            const connect = () => {
                if(!targetId.value) return;
                const c = peer.connect(targetId.value.trim());
                setupConn(c);
            };

            const setupConn = (c) => {
                if(conn) conn.close();
                conn = c;
                conn.on('open', () => {
                    isConnected.value = true;
                    partner.isDeleted = false; partner.online = true;
                    mobileView.value = 'chat';
                    conn.send({ type: 'handshake', payload: user });
                    messages.value.forEach(m => { if(m.status === 'sent') m.status = 'read'; });
                });
                conn.on('data', data => handleData(data));
                conn.on('close', () => { 
                    isConnected.value = false; partner.online = false; 
                    if(call.active || call.incoming) endCall(); // Sync call drop
                });
            };

            const handleData = (data) => {
                partner.online = true;
                if(data.type === 'handshake') {
                    Object.assign(partner, data.payload);
                } else if(data.type === 'status' && data.status === 'deleted') {
                    partner.isDeleted = true; partner.online = false;
                } else if(data.type === 'read_ack') {
                    messages.value.forEach(m => { if(m.sender==='me') m.status = 'read'; });
                } else if(data.type === 'reaction') {
                    const m = messages.value.find(x => x.id === data.msgId);
                    if(m) m.liked = !m.liked;
                } else if(data.type === 'edit') {
                    const m = messages.value.find(x => x.id === data.msgId);
                    if(m) { m.content = data.content; m.edited = true; }
                } else if(data.type === 'delete') {
                    messages.value = messages.value.filter(m => m.id !== data.msgId);
                } else if(data.type === 'call_signal' && data.signal === 'end') {
                    endCall(true); // Remote hangup
                } else {
                    // Normal Message
                    messages.value.push({ ...data, sender: 'partner', status: 'read', liked: false });
                    playSound('in');
                    if(mobileView.value === 'chat') {
                        conn.send({ type: 'read_ack' });
                        scrollToBottom();
                    }
                }
            };

            // MESSAGING
            const sendMsg = () => {
                if(!inputMsg.value.trim()) return;

                if(editingMsg.value) {
                    // Handle Edit
                    const m = messages.value.find(x => x.id === editingMsg.value.id);
                    if(m) {
                        m.content = inputMsg.value;
                        m.edited = true;
                        if(isConnected.value) conn.send({ type: 'edit', msgId: m.id, content: m.content });
                    }
                    cancelAction();
                } else {
                    // Handle New
                    const msg = {
                        id: Date.now(),
                        type: 'text',
                        content: inputMsg.value,
                        timestamp: Date.now(),
                        replyTo: replyingTo.value ? { id: replyingTo.value.id, sender: replyingTo.value.sender, preview: replyingTo.value.content } : null,
                        liked: false
                    };
                    if(isConnected.value) conn.send(msg);
                    messages.value.push({ ...msg, sender: 'me', status: isConnected.value?'sent':'queued' });
                    playSound('sent');
                    cancelAction();
                    scrollToBottom();
                }
            };

            const handleFile = (e) => {
                const f = e.target.files[0];
                if(!f) return;
                const r = new FileReader();
                r.onload = ev => {
                    const type = f.type.startsWith('video') ? 'video' : 'image';
                    const msg = { id: Date.now(), type, content: ev.target.result, timestamp: Date.now(), liked: false };
                    if(isConnected.value) conn.send(msg);
                    messages.value.push({ ...msg, sender: 'me', status: 'sent' });
                    scrollToBottom();
                };
                r.readAsDataURL(f);
            };

            // EDITING / ACTIONS
            const showContext = (e, msg) => {
                ctxMenu.msg = msg;
                // Calculations to keep menu on screen
                let x = e.clientX, y = e.clientY;
                if(window.innerWidth - x < 200) x -= 190;
                if(window.innerHeight - y < 200) y -= 190;
                ctxMenu.x = x; ctxMenu.y = y;
                ctxMenu.show = true;
            };

            const handleCtx = (action) => {
                const msg = ctxMenu.msg;
                ctxMenu.show = false;
                if(action === 'reply') {
                    replyingTo.value = msg;
                    nextTick(() => msgInput.value.focus());
                } else if(action === 'copy') {
                    navigator.clipboard.writeText(msg.content);
                } else if(action === 'edit') {
                    inputMsg.value = msg.content;
                    editingMsg.value = msg;
                    nextTick(() => msgInput.value.focus());
                } else if(action === 'delete') {
                    if(confirm("Delete for everyone?")) {
                        if(isConnected.value) conn.send({ type: 'delete', msgId: msg.id });
                        messages.value = messages.value.filter(m => m.id !== msg.id);
                    }
                }
            };

            const toggleLike = (msg) => {
                msg.liked = !msg.liked;
                if(isConnected.value) conn.send({ type: 'reaction', msgId: msg.id });
                playSound('sent'); // Subtle pop
            };

            const cancelAction = () => {
                replyingTo.value = null;
                editingMsg.value = null;
                inputMsg.value = '';
            };

            // CALLS
            const startCall = async () => {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    callObj = peer.call(conn.peer, localStream);
                    handleCallStream(callObj);
                    call.active = true;
                    call.duration = "Calling...";
                } catch(e) { alert("Mic Error"); }
            };

            const answerCall = async () => {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    callObj.answer(localStream);
                    handleCallStream(callObj);
                    call.incoming = false;
                    call.active = true;
                } catch(e) { alert("Mic Error"); }
            };

            const handleCallStream = (c) => {
                c.on('stream', stream => {
                    const aud = document.querySelector('audio');
                    aud.srcObject = stream;
                    aud.play();
                    startTimer();
                });
                c.on('close', () => endCall(true));
                c.on('error', () => endCall(true));
            };

            const rejectCall = () => {
                call.incoming = false;
                if(callObj) {
                    callObj.close();
                    if(conn) conn.send({ type: 'call_signal', signal: 'end' });
                }
            };

            const endCall = (remote = false) => {
                if(!remote && conn && conn.open) conn.send({ type: 'call_signal', signal: 'end' }); // Tell other side
                
                if(callObj) callObj.close();
                if(localStream) localStream.getTracks().forEach(t => t.stop());
                
                // Add system msg
                if(call.active) {
                    messages.value.push({ id: Date.now(), type: 'system', content: `Call ended (${call.duration})`, timestamp: Date.now() });
                }

                call.active = false;
                call.incoming = false;
                clearInterval(call.timer);
                call.duration = '00:00';
            };

            const startTimer = () => {
                let sec = 0;
                call.timer = setInterval(() => {
                    sec++;
                    const m = Math.floor(sec/60).toString().padStart(2,'0');
                    const s = (sec%60).toString().padStart(2,'0');
                    call.duration = `${m}:${s}`;
                }, 1000);
            };

            // RECORDING
            const startRec = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    chunks = [];
                    isRecording.value = true;
                    mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        const r = new FileReader();
                        r.readAsDataURL(blob);
                        r.onloadend = () => {
                            const msg = { id: Date.now(), type: 'voice', content: r.result, timestamp: Date.now(), liked: false };
                            if(isConnected.value) conn.send(msg);
                            messages.value.push({ ...msg, sender: 'me', status: 'sent' });
                            scrollToBottom();
                        };
                        stream.getTracks().forEach(t => t.stop());
                    };
                    mediaRecorder.start();
                } catch(e) { console.error(e); }
            };
            const stopRec = () => { if(mediaRecorder && isRecording.value) { mediaRecorder.stop(); isRecording.value = false; } };

            const playVoice = (id) => {
                const aud = new Audio(messages.value.find(m => m.id === id).content);
                if(playingVoice.value === id) { playingVoice.value = null; return; }
                playingVoice.value = id;
                aud.play();
                aud.onended = () => playingVoice.value = null;
            };

            // UTILS & COMPUTED
            const groupedMessages = computed(() => {
                const res = [];
                let lastDate = '';
                const sorted = [...messages.value].sort((a,b) => a.timestamp - b.timestamp);

                sorted.forEach(msg => {
                    const d = new Date(msg.timestamp);
                    const dateStr = d.toLocaleDateString();
                    
                    if(dateStr !== lastDate) {
                        let label = dateStr;
                        const today = new Date().toLocaleDateString();
                        const yest = new Date(Date.now() - 864e5).toLocaleDateString();
                        if(dateStr === today) label = "Today";
                        else if(dateStr === yest) label = "Yesterday";
                        
                        res.push({ type: 'date_separator', content: label });
                        lastDate = dateStr;
                    }
                    res.push(msg);
                });
                return res;
            });

            const finishSetup = () => {
                user.name = tempName.value; user.avatar = tempAvatar.value; user.setupComplete = true;
                localStorage.setItem('tw_user', JSON.stringify(user));
                initPeer();
            };
            const onAvatarChange = (e) => {
                const f = e.target.files[0];
                if(!f) return;
                const r = new FileReader();
                r.onload = ev => {
                    if(!user.setupComplete) tempAvatar.value = ev.target.result;
                    else {
                        user.avatar = ev.target.result;
                        localStorage.setItem('tw_user', JSON.stringify(user));
                        if(isConnected.value) conn.send({ type: 'handshake', payload: user });
                    }
                };
                r.readAsDataURL(f);
            };
            const logout = () => {
                if(conn) conn.send({ type: 'status', status: 'deleted' });
                localStorage.clear();
                location.reload();
            };

            const toggleTheme = () => {
                theme.value = theme.value === 'dark' ? 'light' : 'dark';
                localStorage.setItem('tw_theme', theme.value);
                applyTheme();
            };
            const applyTheme = () => {
                if(theme.value === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            };

            const getMessageClass = (item) => {
                const base = "px-3 py-2 rounded-2xl ";
                if(theme.value === 'dark') {
                    return base + (item.sender === 'me' ? 'bg-tg-self text-white rounded-br-none' : 'bg-tg-panel text-white rounded-bl-none');
                } else {
                    return base + (item.sender === 'me' ? 'bg-[#eeffde] text-black rounded-br-none shadow' : 'bg-white text-black rounded-bl-none shadow');
                }
            };
            
            const scrollToBottom = () => nextTick(() => { const el = document.getElementById('chatContainer'); if(el) el.scrollTop = el.scrollHeight + 100; });
            const formatTime = (ts) => new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const copyId = () => navigator.clipboard.writeText(myPeerId.value);
            const addEmoji = (e) => inputMsg.value += e.detail.unicode;
            const handleGlobalClick = () => { 
                ctxMenu.show = false; 
                ui.showAttach = false;
                if(audioCtx.state === 'suspended') audioCtx.resume();
            };
            const closeOverlays = () => { ui.viewProfile = false; ui.showDrawer = false; };
            const jumpToMessage = (id) => {
                const el = document.getElementById('msg-'+id);
                if(el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    el.classList.add('ring-2', 'ring-tg-blue');
                    setTimeout(() => el.classList.remove('ring-2', 'ring-tg-blue'), 1000);
                }
            };

            // Computed Helpers
            const lastMsg = computed(() => messages.value[messages.value.length-1]);
            const lastMsgTime = computed(() => lastMsg.value ? formatTime(lastMsg.value.timestamp) : '');
            const lastMsgPreview = computed(() => {
                if(!lastMsg.value) return '';
                if(lastMsg.value.type === 'image') return 'Photo';
                if(lastMsg.value.type === 'voice') return 'Voice';
                if(lastMsg.value.type === 'system') return 'System';
                return lastMsg.value.content;
            });

            return {
                ui, user, partner, messages, inputMsg, mobileView, theme, isConnected, myPeerId, targetId, isNetReady,
                tempName, tempAvatar, defaultAvatar, msgInput, isRecording, call, zoomImg, ctxMenu, editingMsg, replyingTo, playingVoice,
                groupedMessages, lastMsg, lastMsgTime, lastMsgPreview, searchQuery,
                connect, sendMsg, handleFile, startRec, stopRec, playVoice, startCall, answerCall, rejectCall, endCall,
                finishSetup, onAvatarChange, logout, toggleTheme, getMessageClass, formatTime, copyId, addEmoji,
                handleGlobalClick, showContext, handleCtx, toggleLike, cancelAction, jumpToMessage, closeOverlays
            };
        }
    }).mount('#app');
</script>
</body>
</html>
