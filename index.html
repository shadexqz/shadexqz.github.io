<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–®–ê–ö–ê–õ–ò–ó–ê–¢–û–† 3000 v2.0</title>
    <style>
        body {
            background-color: #008080;
            font-family: "MS Sans Serif", "Tahoma", sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .win98-window {
            width: 700px;
            background: #c0c0c0;
            border: 2px solid;
            border-color: #dfdfdf #0a0a0a #0a0a0a #dfdfdf;
            padding: 2px;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
        }

        .title-bar {
            background: linear-gradient(90deg, #000080, #1084d0);
            padding: 3px 5px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
        }

        .window-body {
            padding: 15px;
        }

        .clippy {
            position: absolute;
            right: 20px;
            bottom: 20px;
            width: 150px;
            cursor: pointer;
            z-index: 100;
        }

        .speech-bubble {
            position: absolute;
            right: 150px;
            bottom: 120px;
            background: #ffffe1;
            border: 1px solid black;
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            width: 180px;
            display: none;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
        }

        .fieldset {
            border: 2px solid;
            border-color: #808080 #dfdfdf #dfdfdf #808080;
            padding: 15px;
            margin-bottom: 15px;
        }

        label { display: block; margin-bottom: 10px; font-size: 12px; }

        input[type="range"] {
            width: 100%;
            margin-bottom: 15px;
        }

        .btn {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #dfdfdf #0a0a0a #0a0a0a #dfdfdf;
            padding: 10px 20px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
        }

        .btn:active {
            border-color: #0a0a0a #dfdfdf #dfdfdf #0a0a0a;
        }

        .status-bar {
            border: 2px solid;
            border-color: #808080 #dfdfdf #dfdfdf #808080;
            background: #c0c0c0;
            padding: 3px;
            margin-top: 10px;
            font-size: 11px;
            height: 20px;
        }

        #result {
            margin-top: 15px;
            display: none;
            text-align: center;
        }

        video {
            width: 100%;
            max-height: 400px;
            background: #000;
            border: 2px inset #fff;
        }

        .marquee {
            background: #000;
            color: #0f0;
            padding: 2px;
            font-size: 12px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <div class="win98-window">
        <div class="title-bar">
            <span>üíæ –®–ê–ö–ê–õ–ò–ó–ê–¢–û–† 3000 ‚Äî [3GP_COMPRESSOR]</span>
            <div style="font-size: 16px;"> _ ‚ùê ‚òí </div>
        </div>
        
        <div class="window-body">
            <div class="marquee"><marquee scrollamount="5">–í–ù–ò–ú–ê–ù–ò–ï: –°–õ–ò–®–ö–û–ú –ú–ù–û–ì–û –ê–†–¢–ï–§–ê–ö–¢–û–í –ú–û–ì–£–¢ –í–´–ó–í–ê–¢–¨ –ù–û–°–¢–ê–õ–¨–ì–ò–Æ...</marquee></div>

            <div class="fieldset">
                <label>–í–´–ë–ï–†–ò–¢–ï –ò–°–•–û–î–ù–ò–ö (AVI/MP4/MOV):</label>
                <input type="file" id="videoInput" accept="video/*">
                
                <hr>

                <label>–£–†–û–í–ï–ù–¨ –®–ê–ö–ê–õ–ò–ó–ê–¶–ò–ò (–ë–ò–¢–†–ï–ô–¢): <span id="shakalVal">5</span></label>
                <input type="range" id="shakalRange" min="1" max="10" value="5">

                <label>–≠–§–§–ï–ö–¢ –ü–†–ò–ó–†–ê–ö–ê (GHOSTING): <span id="ghostVal">–í—ã–∫–ª</span></label>
                <input type="range" id="ghostRange" min="0" max="90" value="0">

                <label>–ì–†–û–ú–ö–û–°–¢–¨ –ü–ï–†–ï–†–ï–î–´–í–ê–ù–ò–Ø (EARRAPE): <span id="audioVal">1x</span></label>
                <input type="range" id="audioRange" min="1" max="15" value="1" step="0.5">
            </div>

            <button id="startBtn" class="btn">–£–®–ê–¢–ê–¢–¨ –í –•–õ–ê–ú</button>
            
            <div class="status-bar" id="statusBar">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞.</div>

            <div id="result">
                <video id="preview" controls autoplay loop></video>
                <br>
                <a id="downloadBtn" href="#" style="color: blue; font-weight: bold;">–°–∫–∞—á–∞—Ç—å_—à–µ–¥–µ–≤—Ä_2007.mp4</a>
            </div>
        </div>
    </div>

    <!-- –ö–ª–∏–ø–ø–∏ (–ü–∞—Å—Ö–∞–ª–∫–∞) -->
    <div class="speech-bubble" id="bubble">–ö–∞–∂–µ—Ç—Å—è, –≤—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –∏—Å–ø–æ—Ä—Ç–∏—Ç—å —Ö–æ—Ä–æ—à–µ–µ –≤–∏–¥–µ–æ? –ú–æ–≥—É —è –≤–∞–º –ø–æ–º–æ—á—å?</div>
    <img src="https://upload.wikimedia.org/wikipedia/en/thumb/8/83/Clippy-letter.png/150px-Clippy-letter.png" class="clippy" id="clippy">

    <canvas id="offscreen" style="display:none;"></canvas>
    <canvas id="onscreen" width="640" height="480" style="display:none;"></canvas>

    <script>
        const videoInput = document.getElementById('videoInput');
        const shakalRange = document.getElementById('shakalRange');
        const ghostRange = document.getElementById('ghostRange');
        const audioRange = document.getElementById('audioRange');
        const startBtn = document.getElementById('startBtn');
        const preview = document.getElementById('preview');
        const statusBar = document.getElementById('statusBar');
        const downloadBtn = document.getElementById('downloadBtn');

        // –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞–Ω–≤–∞—Å–æ–º
        const offCanvas = document.getElementById('offscreen');
        const onCanvas = document.getElementById('onscreen');
        const offCtx = offCanvas.getContext('2d');
        const onCtx = onCanvas.getContext('2d');

        // –ü–∞—Å—Ö–∞–ª–∫–∞ –ö–ª–∏–ø–ø–∏
        document.getElementById('clippy').onclick = () => {
            const b = document.getElementById('bubble');
            b.style.display = b.style.display === 'block' ? 'none' : 'block';
            setTimeout(() => b.style.display = 'none', 5000);
        };

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–∏—Ñ—Ä
        shakalRange.oninput = () => document.getElementById('shakalVal').innerText = shakalRange.value;
        ghostRange.oninput = () => document.getElementById('ghostVal').innerText = ghostRange.value + '%';
        audioRange.oninput = () => document.getElementById('audioVal').innerText = audioRange.value + 'x';

        startBtn.onclick = async () => {
            const file = videoInput.files[0];
            if (!file) return alert("–§–∞–π–ª –≥–¥–µ?");

            startBtn.disabled = true;
            statusBar.innerText = "–®–ê–ö–ê–õ–ò–ó–ê–¶–ò–Ø: 0% [################----]";

            const videoUrl = URL.createObjectURL(file);
            const v = document.createElement('video');
            v.src = videoUrl;
            v.crossOrigin = "anonymous";
            await v.play();

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ "—Å—Ç–∞—Ä–æ–≥–æ" —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
            const lowResW = 160; 
            const lowResH = 120;
            offCanvas.width = lowResW;
            offCanvas.height = lowResH;

            // –ó–≤—É–∫
            const audioCtx = new AudioContext();
            const source = audioCtx.createMediaElementSource(v);
            const dest = audioCtx.createMediaStreamDestination();
            
            // –¶–µ–ø–æ—á–∫–∞ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è –∑–≤—É–∫–∞
            const distortion = audioCtx.createWaveShaper();
            distortion.curve = makeDistortionCurve(audioRange.value * 100);
            
            const filter = audioCtx.createBiquadFilter();
            filter.type = "lowpass";
            filter.frequency.value = 2500; // –≠—Ñ—Ñ–µ–∫—Ç "–≥–ª—É—Ö–æ–≥–æ" –∑–≤—É–∫–∞

            const gain = audioCtx.createGain();
            gain.gain.value = audioRange.value;

            source.connect(distortion).connect(filter).connect(gain).connect(dest);

            // –°—Ç—Ä–∏–º –∏ —Ä–µ–∫–æ—Ä–¥–µ—Ä
            const outStream = onCanvas.captureStream(12); // –ù–∏–∑–∫–∏–π FPS
            const combined = new MediaStream([outStream.getVideoTracks()[0], dest.stream.getAudioTracks()[0]]);
            
            const recorder = new MediaRecorder(combined, {
                mimeType: 'video/webm;codecs=vp8',
                videoBitsPerSecond: (11 - shakalRange.value) * 8000 // –í–æ—Ç —Ç—É—Ç —Ä–µ–∞–ª—å–Ω–æ–µ —Å–∂–∞—Ç–∏–µ –±–∏—Ç—Ä–µ–π—Ç–∞
            });

            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);
                preview.src = url;
                downloadBtn.href = url;
                document.getElementById('result').style.display = 'block';
                statusBar.innerText = "–ì–û–¢–û–í–û. –í–ò–î–ï–û –£–°–ü–ï–®–ù–û –ò–°–ü–û–†–ß–ï–ù–û.";
                startBtn.disabled = false;
                audioCtx.close();
            };

            recorder.start();

            // –†–µ–Ω–¥–µ—Ä –∫–∞–¥—Ä–∞ —Å "—É–º–Ω—ã–º" —Å–∂–∞—Ç–∏–µ–º
            function process() {
                if (!v.paused && !v.ended) {
                    // 1. –†–∏—Å—É–µ–º –Ω–∞ –º–∞–ª—ã–π –∫–∞–Ω–≤–∞—Å
                    offCtx.drawImage(v, 0, 0, lowResW, lowResH);

                    // 2. –°–ï–ö–†–ï–¢ –®–ê–ö–ê–õ–ê: –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞–¥—Ä –≤ –Ω–∏–∑–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π JPEG –∏ —Ä–∏—Å—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ
                    // –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç —Ç–µ —Å–∞–º—ã–µ "–∑–≤–æ–Ω—ã" –∏ "–≥—Ä—è–∑—å" –∫–æ–¥–µ–∫–∞
                    const quality = (11 - shakalRange.value) / 15; // 0.1 - 0.7
                    const frameData = offCanvas.toDataURL('image/jpeg', quality);
                    
                    const img = new Image();
                    img.onload = () => {
                        // –≠—Ñ—Ñ–µ–∫—Ç Ghosting: –Ω–µ –æ—á–∏—â–∞–µ–º —ç–∫—Ä–∞–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é
                        onCtx.globalAlpha = 1 - (ghostRange.value / 100);
                        onCtx.fillStyle = "black";
                        onCtx.fillRect(0,0,640,480);
                        onCtx.globalAlpha = 1;
                        
                        onCtx.imageSmoothingEnabled = true; // –ú—ã–ª–æ - –Ω–∞—à –¥—Ä—É–≥
                        onCtx.drawImage(img, 0, 0, lowResW, lowResH, 0, 0, 640, 480);
                        
                        requestAnimationFrame(process);
                    };
                    img.src = frameData;
                } else {
                    recorder.stop();
                    v.pause();
                }
            }

            process();
        };

        function makeDistortionCurve(amount) {
            let k = amount, n = 44100, curve = new Float32Array(n), i = 0, x;
            for ( ; i < n; ++i ) {
                x = i * 2 / n - 1;
                curve[i] = (3 + k) * x * 20 * (Math.PI / 180) / (Math.PI + k * Math.abs(x));
            }
            return curve;
        }
    </script>
</body>
</html>
