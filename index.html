<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Дурак Онлайн</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');

        :root {
            --card-w: 110px;
            --card-h: 155px;
            --radius: 4px; /* Убрал сильные скругления */
            --accent: #2c3e50;
            --btn-bg: #34495e;
            --highlight: #f1c40f;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #202c39;
            background-image: radial-gradient(circle at 50% 50%, #2c3e50 0%, #1a1a1a 100%);
            height: 100vh;
            overflow: hidden;
            display: flex; flex-direction: column;
            color: white;
        }

        /* --- UI LAYER --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1000;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* --- LOBBY --- */
        #lobby {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            pointer-events: auto;
        }
        .panel {
            background: #ecf0f1; color: #2c3e50;
            padding: 30px; border-radius: 4px;
            width: 95%; max-width: 400px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .panel h1 { margin: 0 0 20px; font-weight: 900; text-transform: uppercase; }
        
        .inp {
            width: 100%; padding: 12px; margin: 10px 0;
            border: 2px solid #bdc3c7; border-radius: 4px;
            font-size: 16px; font-weight: bold; text-align: center;
            background: #fff;
        }
        .btn {
            width: 100%; padding: 14px; border: none; margin-top: 10px;
            font-size: 16px; font-weight: bold; text-transform: uppercase;
            cursor: pointer; border-radius: 4px; color: white;
            transition: 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        .btn-create { background: #27ae60; }
        .btn-join { background: #2980b9; }

        .avatars { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .ava-opt {
            width: 50px; height: 50px; border: 2px solid #bdc3c7; cursor: pointer;
            background-size: cover; border-radius: 4px;
            background-color: #333;
        }
        .ava-opt.selected { border-color: #2980b9; transform: scale(1.1); box-shadow: 0 0 5px rgba(0,0,0,0.5); }

        /* --- CHAT --- */
        .chat-container {
            position: absolute; bottom: 10px; right: 10px; width: 280px;
            display: flex; flex-direction: column; align-items: flex-end;
            pointer-events: none; z-index: 2000;
        }
        .chat-log {
            max-height: 200px; width: 100%; display: flex; flex-direction: column;
            justify-content: flex-end; margin-bottom: 5px; overflow: hidden; text-align: left;
            background: rgba(0,0,0,0.6); padding: 5px; border-radius: 4px;
            pointer-events: auto;
        }
        .chat-msg {
            padding: 2px 5px; font-size: 13px; color: #ecf0f1;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .chat-inp-row { display: flex; width: 100%; pointer-events: auto; gap: 0; }
        #chat-in { flex: 1; background: rgba(0,0,0,0.8); border: 1px solid #555; color: white; padding: 8px; font-size: 13px; }
        #chat-send { width: 40px; background: #2980b9; color: white; border: none; cursor: pointer; }

        /* --- GAME UI --- */
        #game { display: none; flex-direction: column; height: 100%; position: relative; overflow: hidden; }

        .opponents-row { height: 160px; display: flex; justify-content: center; padding-top: 10px; gap: 20px; z-index: 50; }
        .player-wrap { position: relative; width: 90px; display: flex; flex-direction: column; align-items: center; }
        
        .p-name { 
            font-size: 12px; font-weight: bold; background: rgba(0,0,0,0.7); 
            padding: 2px 8px; border-radius: 2px; margin-bottom: 5px; 
            max-width: 100px; overflow: hidden; text-overflow: ellipsis; z-index: 12; 
        }
        
        .avatar-box { position: relative; width: 60px; height: 60px; z-index: 10; }
        .avatar { 
            width: 100%; height: 100%; background: #2c3e50; border: 2px solid #555; 
            border-radius: 4px; object-fit: cover; 
        }
        /* Убрал зеленый неон, сделал простую рамку хода */
        .avatar.turn { border-color: #fff; } 
        
        .timer-svg { 
            position: absolute; top: -5px; left: -5px; width: 70px; height: 70px; 
            pointer-events: none; z-index: 11; transform: rotate(-90deg);
        }
        .timer-path { 
            fill: none; stroke: #27ae60; stroke-width: 4; 
            stroke-dasharray: 200; stroke-dashoffset: 0; 
            transition: stroke 0.3s linear;
        }

        .p-hand-fan { position: absolute; top: 65px; left: 50%; width: 0; height: 0; z-index: 20; }
        .opp-card { 
            position: absolute; width: 40px; height: 55px; 
            background-image: url('https://deckofcardsapi.com/static/img/back.png'); 
            background-size: cover; border-radius: 2px; border: 1px solid #999; 
            transform-origin: 50% 0%; left: -20px; 
        }

        /* --- TABLE --- */
        .table-area { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; }
        .deck-pos { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); width: var(--card-w); height: var(--card-h); }
        .trump-card { position: absolute; top: 15px; left: 30px; width: 100%; height: 100%; transform: rotate(90deg); z-index: 1; border-radius: var(--radius); box-shadow: 1px 1px 4px rgba(0,0,0,0.5); background-color: #fff; background-size: 100% 100%; }
        .deck-top { position: absolute; top:0; left:0; width: 100%; height: 100%; background: url('https://deckofcardsapi.com/static/img/back.png') center/cover; border-radius: var(--radius); border: 1px solid #ccc; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); z-index: 5; }
        .deck-count { position: absolute; top: -30px; left: 0; width: 100%; text-align: center; font-weight: bold; font-size: 16px; background: rgba(0,0,0,0.5); border-radius: 2px; }

        .slots-wrap { display: flex; gap: 10px; justify-content: center; align-items: center; width: 100%; height: 100%; z-index: 10; }
        .slot { width: var(--card-w); height: var(--card-h); position: relative; }
        .slot.interactive { cursor: pointer; background: rgba(255,255,255,0.05); border-radius: var(--radius); }
        .card-face { width: 100%; height: 100%; position: absolute; border-radius: var(--radius); background-color: #fff; background-size: 100% 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.5); transition: transform 0.2s; }
        .card-att { transform: rotate(-2deg); z-index: 5; }
        .card-def { transform: rotate(10deg) translate(10px, 5px); z-index: 6; }

        /* --- MY ZONE --- */
        .my-zone { height: 240px; position: relative; display: flex; justify-content: center; align-items: flex-end; z-index: 100; padding-bottom: 10px; pointer-events: none; background: linear-gradient(to top, rgba(0,0,0,0.5), transparent); }
        .my-info { position: absolute; bottom: 10px; left: 10px; display: flex; gap: 10px; align-items: center; pointer-events: auto; }
        .my-ava-big { width: 60px; height: 60px; border-radius: 4px; border: 2px solid #ccc; background: #333; object-fit: cover; }
        
        .hand-container { position: relative; width: 100%; max-width: 900px; height: 160px; display: flex; justify-content: center; pointer-events: none; }
        
        .my-card-wrap {
            position: absolute; width: var(--card-w); height: var(--card-h);
            transform-origin: 50% 150%; 
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer; bottom: 0;
            transform: translateX(var(--x)) translateY(var(--y)) rotate(var(--rot));
            pointer-events: auto;
        }
        .my-card-wrap:hover { z-index: 1000 !important; transform: translateX(var(--x)) translateY(-30px) rotate(var(--rot)) scale(1.05); }
        
        /* Строгая золотая обводка для выделения */
        .my-card-wrap.selected { z-index: 999 !important; transform: translateX(var(--x)) translateY(-50px) rotate(var(--rot)); }
        .my-card-wrap.selected .card-face { box-shadow: 0 0 0 3px #f1c40f; }

        /* Анимация ошибки (красное мигание) */
        .error-flash .card-face { animation: errFlash 0.4s ease-in-out; }
        @keyframes errFlash { 0%,100%{box-shadow: 0 0 0 0 red;} 50%{box-shadow: 0 0 10px 4px red;} }

        /* --- CONTROLS --- */
        .controls { position: absolute; right: 20px; bottom: 200px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; z-index: 150; pointer-events: auto; }
        
        .status-badge { 
            background: #2c3e50; color: white; padding: 8px 20px; 
            border-radius: 2px; font-size: 16px; font-weight: bold; 
            border-left: 4px solid #999; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .act-btn { 
            border: none; padding: 12px 30px; font-size: 18px; font-weight: bold; 
            text-transform: uppercase; cursor: pointer; color: white; 
            border-radius: 2px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            display: none; 
        }
        .act-btn:active { transform: translateY(2px); }
        .btn-take { background: #e67e22; }
        .btn-bito { background: #c0392b; }

        @media (max-width: 800px) {
            :root { --card-w: 80px; --card-h: 112px; }
            .opponents-row { height: 130px; gap: 5px; }
            .my-zone { height: 180px; }
            .controls { bottom: 150px; right: 10px; }
            .chat-container { width: 200px; bottom: 50px; }
        }
    </style>
</head>
<body>
    <div id="lobby">
        <div class="panel" id="p-setup">
            <h1>Дурак Онлайн</h1>
            <div class="avatars" id="ava-list"></div>
            <input type="text" id="p-name" class="inp" placeholder="Ваш ник" value="Игрок" maxlength="12">
            <div style="margin: 10px 0; display:flex; justify-content:center; gap:15px;">
                <label><input type="radio" name="mode" value="2" checked> 1x1</label>
                <label><input type="radio" name="mode" value="3"> 3 Игрока</label>
                <label><input type="radio" name="mode" value="4"> 4 Игрока</label>
            </div>
            <div style="margin-bottom:15px;">
                <label><input type="checkbox" id="chk-transfer"> Переводной</label>
            </div>
            <button class="btn btn-create" onclick="Lobby.create()">Создать стол</button>
            <div style="margin:10px; color:#7f8c8d; font-size:14px;">— или —</div>
            <input type="text" id="join-id" class="inp" placeholder="ID комнаты">
            <button class="btn btn-join" onclick="Lobby.join()">Войти</button>
        </div>
        <div class="panel" id="p-wait" style="display:none;">
            <h2>Комната создана</h2>
            <p>ID для друзей:</p>
            <input type="text" id="host-id" class="inp" style="background:#eee; font-family:monospace;" readonly onclick="this.select()">
            <p id="wait-msg" style="color:#27ae60; font-weight:bold; font-size:24px;">1/2</p>
        </div>
    </div>

    <div id="game">
        <div id="ui-layer"><div class="opponents-row" id="opponents-area"></div></div>
        
        <div class="table-area">
            <div class="deck-pos">
                <div class="deck-count" id="deck-n">36</div>
                <div id="trump-slot"></div>
                <div class="deck-top" id="deck-visual"></div>
            </div>
            <div class="slots-wrap" id="slots-area"></div>
            <div class="controls">
                <div class="status-badge" id="status-txt">Подключение...</div>
                <button class="act-btn btn-bito" id="btn-bito" onclick="Game.act('BITO')">БИТО</button>
                <button class="act-btn btn-take" id="btn-take" onclick="Game.act('ВЗЯТЬ')">ВЗЯТЬ</button>
            </div>
        </div>

        <div class="my-zone">
            <div class="my-info">
                <div style="position:relative;">
                    <img id="my-ava" class="my-ava-big" src="">
                    <svg class="timer-svg" viewBox="0 0 80 80">
                        <!-- Ровный круг -->
                        <circle class="timer-path" id="my-timer" cx="40" cy="40" r="36"></circle>
                    </svg>
                </div>
                <div style="text-shadow: 1px 1px 2px black;">
                    <div style="font-weight:bold; font-size:16px;">ВЫ</div>
                    <div style="font-size:12px; opacity:0.8;" id="my-name-display">Игрок</div>
                </div>
            </div>
            <div class="hand-container" id="my-hand"></div>
        </div>
        
        <div class="chat-container">
            <div class="chat-log" id="chat-log"></div>
            <div class="chat-inp-row">
                <input type="text" id="chat-in" placeholder="Чат..." autocomplete="off" maxlength="30">
                <button id="chat-send" onclick="Game.sendChat()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script>
        const IMG_API = (r,s) => `https://deckofcardsapi.com/static/img/${r}${s}.png`;
        const SUITS = ['S','C','H','D'];
        const RANKS = ['6','7','8','9','0','J','Q','K','A'];
        const TURN_TIME = 30000; // 30 секунд на ход

        // Звуки (минималистичные)
        const Snd = {
            play(t) {
                const a = new Audio();
                if(t==='click') a.src='https://cdn.pixabay.com/audio/2022/03/15/audio_2c416e3427.mp3'; // Тихий клик
                if(t==='err') a.src='https://cdn.pixabay.com/audio/2021/08/04/audio_0625c1539c.mp3'; // Ошибка
                a.volume = 0.5;
                a.play().catch(()=>{});
            }
        };

        class Engine {
            constructor(hName, hAva, mode, transfer) {
                this.mode = parseInt(mode);
                this.transfer = transfer;
                this.players = [{id:'host', name:hName, ava:hAva, hand:[]}];
                this.deck = [];
                this.trump = null;
                this.field = [];
                this.turn = 0;
                this.turnStart = 0; // Время начала хода
                this.state = 'lobby';
                this.win = null;
            }
            
            initDeck() {
                this.deck = [];
                SUITS.forEach(s => RANKS.forEach(r => this.deck.push({r, s})));
                this.deck.sort(() => Math.random() - 0.5);
                this.players.forEach(p => p.hand = this.deck.splice(0,6));
                this.trump = this.deck.pop();
                this.deck.unshift(this.trump);
                
                // Кто первый (младший козырь)
                let min=100, fp=0;
                this.players.forEach((p,i) => {
                    p.hand.forEach(c => {
                        if(c.s===this.trump.s && RANKS.indexOf(c.r)<min) { min = RANKS.indexOf(c.r); fp=i; }
                    });
                });
                this.changeTurn(fp);
                this.state = 'game';
            }

            changeTurn(idx) { 
                this.turn = idx; 
                this.turnStart = Date.now(); 
            }
            
            next(off=1) { return (this.turn + off) % this.players.length; }
            
            beat(a, d) {
                if(a.s===d.s) return RANKS.indexOf(d.r) > RANKS.indexOf(a.r);
                return d.s === this.trump.s;
            }

            // Бот: проверяет время и ходит сам
            checkTimer() {
                if(this.state !== 'game' || this.win) return;
                if(Date.now() - this.turnStart > TURN_TIME) {
                    this.autoMove();
                }
            }

            autoMove() {
                const attacker = this.turn;
                const defender = this.next();
                
                // Если стол пустой - бот должен атаковать
                if(this.field.length === 0) {
                    this.move(attacker, 'ATTACK', {i: 0}); // Кидает первую карту
                    return;
                }

                // Если нужно отбиваться
                const undefended = this.field.some(x => !x.def);
                if(undefended) {
                    // Если время вышло у того, кто должен бить (защитника)
                    // (Упрощение: считаем, что таймер общий на действие)
                    this.move(defender, 'TAKE');
                } else {
                    // Все отбито, атакующий тупит -> БИТО
                    this.move(attacker, 'BITO');
                }
            }

            move(pidx, type, d) {
                if(this.state !== 'game') return {success: false};
                const p = this.players[pidx];

                if(type === 'ATTACK') {
                    const isAtt = (pidx === this.turn);
                    const isTrans = (this.transfer && pidx === this.next() && this.field.length > 0 && this.field.every(s => !s.def));
                    if(!isAtt && !isTrans) return {success: false};
                    
                    const card = p.hand[d.i];
                    if(this.field.length > 0) {
                        const ranks = new Set(this.field.flatMap(x => [x.att.r, x.def?.r].filter(Boolean)));
                        if(!ranks.has(card.r)) return {success: false, reason: 'badCard'};
                    }

                    const defIdx = isTrans ? (pidx + 1) % this.players.length : this.next();
                    const defP = this.players[defIdx];
                    if(this.field.filter(x=>!x.def).length + 1 > defP.hand.length) return {success: false};
                    if(this.field.length >= 6) return {success: false};

                    p.hand.splice(d.i, 1);
                    this.field.push({att: card, def: null});
                    if(isTrans) { this.changeTurn(pidx); } 
                    else { this.turnStart = Date.now(); } // Сброс таймера при ходе
                    return {success: true};
                }
                if(type === 'DEFEND') {
                    if(pidx !== this.next()) return {success: false};
                    const slot = this.field[d.s];
                    if(!slot || slot.def) return {success: false};
                    const card = p.hand[d.i];
                    if(!this.beat(slot.att, card)) return {success: false, reason: 'badCard'};
                    p.hand.splice(d.i, 1);
                    slot.def = card;
                    this.turnStart = Date.now(); // Сброс таймера
                    return {success: true};
                }
                if(type === 'BITO') {
                    if(pidx !== this.turn) return {success: false};
                    if(this.field.some(x=>!x.def)) return {success: false};
                    this.field = [];
                    this.refill();
                    this.changeTurn(this.next());
                    return {success: true};
                }
                if(type === 'TAKE') {
                    if(pidx !== this.next()) return {success: false};
                    this.field.forEach(x => { p.hand.push(x.att); if(x.def) p.hand.push(x.def); });
                    this.field = [];
                    this.refill(true);
                    let n = this.next(2);
                    if(this.players.length===2) n = this.next(1);
                    this.changeTurn(n);
                    return {success: true};
                }
                return {success: false};
            }
            refill(skipDef=false) {
                const q = [];
                for(let i=0; i<this.players.length; i++) q.push((this.turn + i)%this.players.length);
                q.forEach(idx => {
                    if(skipDef && idx === this.next()) return;
                    const p = this.players[idx];
                    while(p.hand.length < 6 && this.deck.length > 0) p.hand.push(this.deck.pop());
                });
                this.players.forEach(p => { if(p.hand.length===0 && this.deck.length===0 && !this.win) this.win = p.name; });
            }
            dump() {
                return {
                    d: this.deck.length, tr: this.trump, f: this.field, t: this.turn, ts: this.turnStart,
                    ps: this.players.map(p => ({id:p.id, name:p.name, ava:p.ava, cnt:p.hand.length})),
                    win: this.win
                };
            }
        }

        const Lobby = {
            ava: 1,
            init() {
                const el = document.getElementById('ava-list');
                [1,2,3,4,5].forEach(i => {
                    const d = document.createElement('div');
                    d.className = 'ava-opt' + (i===1?' selected':'');
                    d.style.backgroundImage = `url('https://robohash.org/${i}.png?set=set3')`;
                    d.onclick = () => { this.ava=i; Snd.play('click'); document.querySelectorAll('.ava-opt').forEach(x=>x.classList.remove('selected')); d.classList.add('selected'); };
                    el.appendChild(d);
                });
            },
            create() {
                const n = document.getElementById('p-name').value || 'Игрок';
                const m = document.querySelector('input[name="mode"]:checked').value;
                const tr = document.getElementById('chk-transfer').checked;
                Game.initHost(n, this.ava, m, tr);
            },
            join() {
                const n = document.getElementById('p-name').value || 'Игрок';
                const id = document.getElementById('join-id').value;
                if(!id) return alert('Введите ID');
                Game.initClient(n, this.ava, id);
            }
        };

        const Game = {
            role: null, eng: null, peer: null, conns: [], conn: null, myId: null, st: null, hand: [], sel: null,
            
            initHost(n, a, m, t) {
                this.role = 'host';
                this.eng = new Engine(n, a, m, t);
                this.peer = new Peer();
                this.peer.on('open', id => {
                    document.getElementById('p-setup').style.display = 'none';
                    document.getElementById('p-wait').style.display = 'block';
                    document.getElementById('host-id').value = id;
                    
                    // Запуск цикла проверки таймера
                    setInterval(() => {
                        this.eng.checkTimer();
                        this.sync();
                    }, 1000);
                });
                this.peer.on('connection', c => {
                    c.on('open', () => { this.conns.push(c); this.bc({t:'C', n:'INFO', m:'Подключение...'}); });
                    c.on('data', d => this.handleData(c, d));
                });
            },
            initClient(n, a, id) {
                this.role = 'client';
                this.peer = new Peer();
                this.peer.on('open', () => {
                    this.conn = this.peer.connect(id);
                    this.conn.on('open', () => {
                        this.conn.send({t:'J', n, a});
                        document.getElementById('p-setup').style.display = 'none';
                    });
                    this.conn.on('data', d => this.handleData(null, d));
                });
            },
            handleData(c, d) {
                if(d.t==='J' && this.role==='host') {
                    if(this.eng.players.length < this.eng.mode) {
                        this.eng.players.push({id:c.peer, name:d.n, ava:d.a, hand:[]});
                        document.getElementById('wait-msg').innerText = `${this.eng.players.length}/${this.eng.mode}`;
                        this.bc({t:'C', n:'INFO', m:`${d.n} вошел`});
                        if(this.eng.players.length == this.eng.mode) {
                            this.eng.initDeck();
                            this.sync();
                            this.startGameUI();
                        }
                    }
                }
                if(d.t==='A' && this.role==='host') {
                    const pIdx = this.eng.players.findIndex(p=>p.id===c.peer);
                    if(pIdx!==-1) {
                        const res = this.eng.move(pIdx, d.a, d.d);
                        if(res.success) this.sync();
                        else if(res.reason==='badCard') c.send({t:'ERR_CARD', i:d.d.i});
                    }
                }
                if(d.t==='C') {
                    if(this.role === 'host') this.bc(d, c ? c.peer : null);
                    this.addChat(d);
                }
                if(d.t==='S') {
                    this.startGameUI();
                    this.st = d.s; this.hand = d.h; this.myId = d.mid;
                    this.draw();
                }
                if(d.t==='ERR_CARD') this.flashCard(d.i);
            },
            startGameUI() {
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('game').style.display = 'flex';
            },
            bc(d) { this.conns.forEach(c=>c.send(d)); },
            sync() {
                if(this.role!=='host') return;
                const s = this.eng.dump();
                this.st = s; this.hand = this.eng.players[0].hand; this.myId = 'host';
                this.draw();
                this.conns.forEach(c => {
                    const p = this.eng.players.find(x=>x.id===c.peer);
                    c.send({t:'S', s, h:p?p.hand:[], mid:c.peer});
                });
            },
            act(type, d={}) {
                if(this.role==='host') {
                    const res = this.eng.move(0, type, d);
                    if(res.success) this.sync();
                    else if(res.reason==='badCard') this.flashCard(d.i);
                } else {
                    this.conn.send({t:'A', a:type, d});
                }
                this.sel = null;
            },
            flashCard(idx) {
                Snd.play('err');
                const el = document.querySelectorAll('.my-card-wrap')[idx];
                if(el) { el.classList.remove('error-flash'); void el.offsetWidth; el.classList.add('error-flash'); }
            },
            draw() {
                const s = this.st;
                if(!s) return;
                const myIdx = s.ps.findIndex(p=>p.id===this.myId) > -1 ? s.ps.findIndex(p=>p.id===this.myId) : 0;
                document.getElementById('my-ava').src = `https://robohash.org/${s.ps[myIdx].ava}.png?set=set3`;
                document.getElementById('my-name-display').innerText = s.ps[myIdx].name;
                
                // --- ЛОГИКА ТАЙМЕРА (SVG) ---
                const myTimer = document.getElementById('my-timer');
                const circLen = 226; // 2 * PI * 36
                myTimer.style.strokeDasharray = circLen;
                
                if(s.t === myIdx) { 
                    const passed = Date.now() - s.ts;
                    const left = Math.max(0, TURN_TIME - passed);
                    const offset = circLen * (1 - (left / TURN_TIME));
                    myTimer.style.strokeDashoffset = offset;
                    
                    // Меняем цвет от зеленого к красному
                    myTimer.style.stroke = left < 5000 ? '#e74c3c' : '#27ae60';
                    myTimer.parentElement.style.opacity = 1;
                    
                    if(left > 0) requestAnimationFrame(()=>this.draw()); // Анимация
                } else {
                    myTimer.parentElement.style.opacity = 0;
                }

                const oppDiv = document.getElementById('opponents-area');
                oppDiv.innerHTML = '';
                for(let i=1; i<s.ps.length; i++) {
                    const idx = (myIdx + i) % s.ps.length;
                    const p = s.ps[idx];
                    const isTurn = (s.t === idx);
                    
                    // Колода противника без цифр
                    let fanHTML = '';
                    if(p.cnt > 0) fanHTML = `<div class="opp-card"></div>`;
                    if(p.cnt > 3) fanHTML += `<div class="opp-card" style="transform: rotate(5deg);"></div>`;

                    // Таймер противника
                    let timerSVG = '';
                    if(isTurn) {
                        const passed = Date.now() - s.ts;
                        const left = Math.max(0, TURN_TIME - passed);
                        const offset = 200 * (1 - (left / TURN_TIME));
                        const color = left < 5000 ? '#e74c3c' : '#27ae60';
                        timerSVG = `<svg class="timer-svg" viewBox="0 0 80 80"><circle class="timer-path" cx="40" cy="40" r="32" style="stroke-dashoffset:${offset}; stroke:${color};"></circle></svg>`;
                    }

                    oppDiv.innerHTML += `
                        <div class="player-wrap">
                            <div class="p-name">${p.name}</div>
                            <div class="avatar-box">
                                <img src="https://robohash.org/${p.ava}.png?set=set3" class="avatar ${isTurn?'turn':''}">
                                ${timerSVG}
                            </div>
                            <div class="p-hand-fan" style="top:70px;">${fanHTML}</div>
                        </div>
                    `;
                }

                document.getElementById('deck-n').innerText = s.d > 0 ? s.d : '';
                document.getElementById('deck-visual').style.display = s.d > 0 ? 'block' : 'none';
                const tSlot = document.getElementById('trump-slot');
                tSlot.innerHTML = '';
                if(s.tr && s.d > 0) {
                    const img = document.createElement('div');
                    img.className = 'trump-card';
                    img.style.backgroundImage = `url('${IMG_API(s.tr.r, s.tr.s)}')`;
                    tSlot.appendChild(img);
                }

                const slDiv = document.getElementById('slots-area');
                slDiv.innerHTML = '';
                s.f.forEach((slot, si) => {
                    const d = document.createElement('div');
                    d.className = 'slot';
                    const ac = document.createElement('div');
                    ac.className = 'card-face card-att';
                    ac.style.backgroundImage = `url('${IMG_API(slot.att.r, slot.att.s)}')`;
                    d.appendChild(ac);
                    if(slot.def) {
                        const dc = document.createElement('div');
                        dc.className = 'card-face card-def';
                        dc.style.backgroundImage = `url('${IMG_API(slot.def.r, slot.def.s)}')`;
                        d.appendChild(dc);
                    } else if(s.t !== myIdx) {
                        const defIdx = (s.t+1)%s.ps.length;
                        if(myIdx === defIdx) {
                            d.classList.add('interactive');
                            d.onclick = () => this.act('DEFEND', {i:this.sel, s:si});
                        }
                    }
                    slDiv.appendChild(d);
                });

                const hDiv = document.getElementById('my-hand');
                hDiv.innerHTML = '';
                this.hand.forEach((c, i) => {
                    const w = document.createElement('div');
                    w.className = 'my-card-wrap' + (this.sel===i ? ' selected' : '');
                    const rot = (i - (this.hand.length-1)/2) * 5;
                    const xOff = (i - (this.hand.length-1)/2) * 30;
                    w.style.setProperty('--rot', rot+'deg');
                    w.style.setProperty('--x', xOff+'px');
                    w.style.zIndex = i+10;
                    
                    const f = document.createElement('div');
                    f.className = 'card-face';
                    f.style.backgroundImage = `url('${IMG_API(c.r,c.s)}')`;
                    w.appendChild(f);

                    w.onclick = (e) => {
                        e.stopPropagation();
                        Snd.play('click');
                        const isMyTurn = (s.t === myIdx);
                        const isTransfer = (this.eng?.transfer && myIdx===(s.t+1)%s.ps.length && s.f.length>0 && s.f.every(x=>!x.def));
                        
                        if(isMyTurn || isTransfer) {
                            this.sel = i;
                            this.act('ATTACK', {i});
                        } else {
                            this.sel = (this.sel===i) ? null : i;
                            this.draw();
                        }
                    };
                    hDiv.appendChild(w);
                });

                const bB = document.getElementById('btn-bito');
                const bT = document.getElementById('btn-take');
                const st = document.getElementById('status-txt');
                bB.style.display = 'none'; bT.style.display = 'none';

                if(s.win) {
                    st.innerText = `${s.win} ВЫИГРАЛ`;
                    st.style.borderLeftColor = "#f1c40f";
                } else if (s.t === myIdx) {
                    st.innerText = "ВАШ ХОД";
                    st.style.borderLeftColor = "#27ae60";
                    if(s.f.length>0 && s.f.every(x=>x.def)) bB.style.display = 'block';
                } else {
                    const defIdx = (s.t+1)%s.ps.length;
                    if(myIdx === defIdx) {
                        st.innerText = "ЗАЩИЩАЙТЕСЬ";
                        st.style.borderLeftColor = "#e67e22";
                        if(s.f.some(x=>!x.def)) bT.style.display = 'block';
                    } else {
                        st.innerText = `ХОДИТ: ${s.ps[s.t].name}`;
                        st.style.borderLeftColor = "#999";
                    }
                }
            },
            sendChat() {
                const inp = document.getElementById('chat-in');
                const m = inp.value.trim();
                if(!m) return;
                let n = this.role==='host' ? this.eng.players[0].name : 'Я';
                if(this.role === 'host') { const msg = {t:'C', n, m}; this.addChat(msg); this.bc(msg); } 
                else { this.conn.send({t:'C', m}); }
                inp.value = '';
            },
            addChat(d) {
                const log = document.getElementById('chat-log');
                const el = document.createElement('div');
                el.className = 'chat-msg';
                el.innerText = `${d.n}: ${d.m}`;
                log.appendChild(el);
                log.scrollTop = log.scrollHeight;
            }
        };

        document.getElementById('chat-in').addEventListener('keydown', e=>{if(e.key==='Enter') Game.sendChat()});
        Lobby.init();
    </script>
</body>
</html>
