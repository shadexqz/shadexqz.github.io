<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–®–ê–ö–ê–õ–ò–ó–ê–¢–û–† 3000: ULTIMATE EDITION</title>
    <style>
        /* Retro Windows 98 Style */
        body {
            background-color: #008080; /* –¢–æ—Ç —Å–∞–º—ã–π —Å–∏–Ω–µ-–∑–µ–ª–µ–Ω—ã–π */
            margin: 0;
            padding: 20px;
            font-family: "MS Sans Serif", "Tahoma", sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .window {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #808080 #808080 #ffffff;
            width: 100%;
            max-width: 700px;
            box-shadow: 4px 4px 0 #000;
        }

        .title-bar {
            background: linear-gradient(90deg, #000080, #1084d0);
            padding: 3px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-weight: bold;
        }

        .title-bar-text { font-size: 14px; cursor: help; }
        .title-bar-text:active::after { content: " (–¢–´ –ß–Å –ñ–ú–Å–®–¨?)"; color: yellow; }

        .window-body {
            padding: 15px;
        }

        .fieldset {
            border: 2px solid;
            border-color: #808080 #ffffff #ffffff #808080;
            padding: 15px;
            margin-bottom: 15px;
            background: #d6d6d6;
        }

        legend { background: #c0c0c0; padding: 0 5px; font-weight: bold; }

        .control-row {
            margin-bottom: 15px;
        }

        label { display: block; margin-bottom: 5px; font-size: 13px; }

        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–∑—É–Ω–∫–æ–≤ –ø–æ–¥ Win98 */
        input[type="range"] {
            width: 100%;
            height: 4px;
            cursor: pointer;
        }

        .btn {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000 #000 #ffffff;
            padding: 8px 20px;
            font-family: inherit;
            cursor: pointer;
            outline: none;
            font-weight: bold;
        }

        .btn:active {
            border-color: #000 #ffffff #ffffff #000;
            padding: 9px 19px 7px 21px;
        }

        .btn-big {
            width: 100%;
            font-size: 18px;
            margin-top: 10px;
        }

        .error-icon {
            float: left;
            margin-right: 15px;
            cursor: pointer;
        }

        #status {
            background: #fff;
            border: 1px inset #808080;
            padding: 4px;
            margin-top: 10px;
            font-size: 12px;
            color: #000;
        }

        #preview-container {
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        video {
            width: 100%;
            background: #000;
            border: 2px inset #fff;
            image-rendering: pixelated;
        }

        .easter-egg {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="window">
        <div class="title-bar">
            <div class="title-bar-text" title="–ù–∞–∂–º–∏ –º–µ–Ω—è!">üöÄ –®–ê–ö–ê–õ–ò–ó–ê–¢–û–† 3000 v.1.4.8.8</div>
            <div style="font-size: 12px;">[ ? ] [ X ]</div>
        </div>
        
        <div class="window-body">
            <img src="https://win98icons.alexmeub.com/icons/png/msg_error-2.png" class="error-icon" id="errorIcon" title="–£–î–û–õ–ò">
            
            <p style="margin-top: 0;"><b>–í–ù–ò–ú–ê–ù–ò–ï:</b> –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —Å–æ–≤–µ—Ä—à–∏—Ç—å –∞–∫—Ç –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?</p>

            <div class="fieldset">
                <div class="control-row">
                    <label>–ò–°–•–û–î–ù–´–ô –§–ê–ô–õ:</label>
                    <input type="file" id="videoInput" accept="video/*" style="width: 100%;">
                </div>

                <div class="control-row">
                    <label>–°–¢–ï–ü–ï–ù–¨ –®–ê–ö–ê–õ–¨–ù–û–°–¢–ò: <span id="shakalVal">1x</span></label>
                    <input type="range" id="shakalRange" min="1" max="60" value="1">
                </div>

                <div class="control-row">
                    <label>–£–†–û–í–ï–ù–¨ EARRAPE: <span id="audioVal">–ù–û–†–ú–ê</span></label>
                    <input type="range" id="earrapeRange" min="1" max="40" value="1" step="0.5">
                </div>
            </div>

            <button id="startBtn" class="btn btn-big">–£–®–ê–¢–ê–¢–¨ –í –ö–ê–®–£</button>
            
            <div id="status">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—é.</div>

            <div id="preview-container">
                <label><b>–†–ï–ó–£–õ–¨–¢–ê–¢ –û–ë–†–ê–ë–û–¢–ö–ò:</b></label>
                <video id="preview" controls></video>
                <br>
                <a id="downloadBtn" href="#" style="color: blue;">–°–∫–∞—á–∞—Ç—å_—à–µ–¥–µ–≤—Ä_–±–µ–∑_—Å–º—Å.mp4</a>
            </div>
        </div>
    </div>

    <!-- –ü–∞—Å—Ö–∞–ª–∫–∞ 1 -->
    <div id="dancingMeme" class="easter-egg">
        <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHJtczF6NWFwaXJ0M2pxZzR4ZWt6Mnp4ZWt6Mnp4ZWt6Mnp4ZWt6JmVwPXYxX2ludGVybmFsX2dpZl9ieV9pZCZjdD1n/11BAxHG7paxJqE/giphy.gif" width="200">
    </div>

    <canvas id="offscreen" style="display:none;"></canvas>
    <canvas id="onscreen" width="1280" height="720" style="display:none;"></canvas>

    <script>
        const videoInput = document.getElementById('videoInput');
        const shakalRange = document.getElementById('shakalRange');
        const earrapeRange = document.getElementById('earrapeRange');
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const preview = document.getElementById('preview');
        const downloadBtn = document.getElementById('downloadBtn');
        const previewContainer = document.getElementById('preview-container');

        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
        shakalRange.oninput = () => {
            const v = shakalRange.value;
            document.getElementById('shakalVal').innerText = v + 'x';
            if(v > 50) document.getElementById('shakalVal').innerText += " (–ê–î–°–ö–ò–ô –®–ê–ö–ê–õ)";
        };
        
        earrapeRange.oninput = () => {
            const v = earrapeRange.value;
            document.getElementById('audioVal').innerText = v == 1 ? "–ù–û–†–ú–ê" : (v > 30 ? "–°–ú–ï–†–¢–¨ –£–®–ê–ú" : "–ì–†–û–ú–ö–û");
        };

        // –ü–∞—Å—Ö–∞–ª–∫–∞ –Ω–∞ –∏–∫–æ–Ω–∫—É
        document.getElementById('errorIcon').onclick = () => {
            const meme = document.getElementById('dancingMeme');
            meme.style.display = 'block';
            setTimeout(() => meme.style.display = 'none', 2000);
        };

        startBtn.onclick = async () => {
            const file = videoInput.files[0];
            if (!file) return alert("–ì–î–ï –í–ò–î–ï–û, –õ–ï–ë–û–í–°–ö–ò?");

            startBtn.disabled = true;
            status.innerText = "–®–ê–ö–ê–õ–ò–ó–ê–¶–ò–Ø –ó–ê–ü–£–©–ï–ù–ê... –ù–ï –¢–†–û–ì–ê–ô –ù–ò–ß–ï–ì–û.";

            const videoUrl = URL.createObjectURL(file);
            const v = document.createElement('video');
            v.src = videoUrl;
            v.muted = false;
            v.crossOrigin = "anonymous";
            
            await v.play();

            const offCanvas = document.getElementById('offscreen');
            const onCanvas = document.getElementById('onscreen');
            const offCtx = offCanvas.getContext('2d');
            const onCtx = onCanvas.getContext('2d');

            const factor = parseFloat(shakalRange.value);
            const lowW = Math.max(1, Math.floor(1280 / factor));
            const lowH = Math.max(1, Math.floor(720 / factor));
            offCanvas.width = lowW;
            offCanvas.height = lowH;

            // –ê—É–¥–∏–æ
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioCtx.createMediaElementSource(v);
            const dest = audioCtx.createMediaStreamDestination();
            let lastNode = source;

            if (parseFloat(earrapeRange.value) > 1) {
                const distortion = audioCtx.createWaveShaper();
                distortion.curve = (function(k) {
                    let n = 44100, curve = new Float32Array(n), i = 0, x;
                    for ( ; i < n; ++i ) {
                        x = i * 2 / n - 1;
                        curve[i] = (3 + k) * x * 20 * (Math.PI / 180) / (Math.PI + k * Math.abs(x));
                    }
                    return curve;
                })(parseFloat(earrapeRange.value) * 100);
                
                const gain = audioCtx.createGain();
                gain.gain.value = parseFloat(earrapeRange.value);

                source.connect(distortion);
                distortion.connect(gain);
                lastNode = gain;
            }
            lastNode.connect(dest);

            // –†–µ–∫–æ—Ä–¥–µ—Ä
            let mime = 'video/mp4;codecs=avc1';
            if (!MediaRecorder.isTypeSupported(mime)) mime = 'video/webm;codecs=vp8';

            const stream = new MediaStream([
                onCanvas.captureStream(24).getVideoTracks()[0],
                dest.stream.getAudioTracks()[0]
            ]);

            const recorder = new MediaRecorder(stream, {
                mimeType: mime,
                videoBitsPerSecond: factor > 10 ? 50000 : 2500000, // –í–æ—Ç —Ç—É—Ç –≥–ª–∞–≤–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
                audioBitsPerSecond: 8000
            });

            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: mime });
                preview.src = URL.createObjectURL(blob);
                downloadBtn.href = preview.src;
                previewContainer.style.display = 'block';
                status.innerText = "–®–ê–ö–ê–õ–ò–ó–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê. –ü–û–ö–ê–ô–¢–ï–°–¨.";
                startBtn.disabled = false;
                audioCtx.close();
            };

            recorder.start();

            function renderFrame() {
                if (!v.paused && !v.ended) {
                    // –†–∏—Å—É–µ–º –º–∞–ª–µ–Ω—å–∫—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
                    offCtx.drawImage(v, 0, 0, lowW, lowH);
                    
                    // –≠—Ñ—Ñ–µ–∫—Ç "–ì—Ä—è–∑–Ω–æ–≥–æ —Å–∂–∞—Ç–∏—è" —á–µ—Ä–µ–∑ –Ω–∞–ª–æ–∂–µ–Ω–∏–µ —à—É–º–∞ (–µ—Å–ª–∏ —à–∞–∫–∞–ª–∏–º)
                    if(factor > 10) {
                        offCtx.fillStyle = `rgba(255,255,255,${Math.random() * 0.05})`;
                        offCtx.fillRect(0, 0, lowW, lowH);
                    }

                    // –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
                    onCtx.imageSmoothingEnabled = false;
                    
                    // –•—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–±–µ—Ä—Ä–∞—Ü–∏—è (—Å–¥–≤–∏–≥ –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –º–µ–º–Ω–æ—Å—Ç–∏)
                    if (factor > 20) {
                        onCtx.globalAlpha = 0.5;
                        onCtx.drawImage(offCanvas, -2, 0, lowW, lowH, 0, 0, 1280, 720);
                        onCtx.drawImage(offCanvas, 2, 0, lowW, lowH, 0, 0, 1280, 720);
                        onCtx.globalAlpha = 1.0;
                    } else {
                        onCtx.drawImage(offCanvas, 0, 0, lowW, lowH, 0, 0, 1280, 720);
                    }
                    
                    requestAnimationFrame(renderFrame);
                } else if (v.ended) {
                    recorder.stop();
                }
            }
            renderFrame();
        };
    </script>
</body>
</html>
