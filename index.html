<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tweeyer Web</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        tg: {
                            bg: '#17212b', sidebar: '#17212b', panel: '#242f3d',
                            hover: '#2b5278', active: '#232e3c', self: '#766ac8',
                            text: '#eef3f7', hint: '#7f91a4', blue: '#3390ec', red: '#ef5b5b'
                        }
                    }
                }
            }
        };
    </script>

    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
        .chat-bg-dark { background-color: #0f0f0f; background-image: radial-gradient(#1d2a39 1px, transparent 1px); background-size: 20px 20px; }
        .chat-bg-light { background-color: #f0f2f5; background-image: radial-gradient(#d1d5db 1px, transparent 1px); background-size: 20px 20px; }
        .msg-pop { animation: msgPop 0.2s ease-out; }
        @keyframes msgPop { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        emoji-picker { width: 100%; height: 320px; }
        .reaction-anim { animation: heartPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes heartPop { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        .wave-bar { animation: wave 1s infinite ease-in-out; }
        @keyframes wave { 0%, 100% { height: 30%; } 50% { height: 100%; } }
    </style>
</head>
<body class="bg-white dark:bg-[#0f0f0f] text-gray-900 dark:text-tg-text h-[100dvh] w-screen overflow-hidden text-[15px] select-none">

<div id="app" class="h-full flex relative" @paste="handlePaste" @click="unlockAudio">

    <!-- ================= БАН ЭКРАН ================= -->
    <div v-if="isBanned" class="absolute inset-0 z-[500] bg-white dark:bg-[#0f0f0f] flex flex-col items-center justify-center p-8 text-center">
        <div class="w-24 h-24 bg-red-500 rounded-full flex items-center justify-center mb-6 shadow-xl shadow-red-500/20">
            <i class="fa-solid fa-ban text-4xl text-white"></i>
        </div>
        <h1 class="text-3xl font-bold mb-4 dark:text-white">Доступ ограничен</h1>
        <div class="max-w-md bg-gray-100 dark:bg-tg-panel p-6 rounded-2xl border dark:border-white/5 text-left mb-8 shadow-inner">
            <p class="text-gray-600 dark:text-gray-300 leading-relaxed">
                Здравствуйте, <span class="font-bold text-tg-blue">{{ user.name }}</span>.
                Ваш аккаунт (ID: {{ myPeerId }}) деактивирован за нарушение правил платформы.
            </p>
        </div>
        <button @click="appeal" class="px-8 py-3 bg-tg-blue text-white rounded-xl font-bold uppercase tracking-widest text-xs hover:bg-blue-600 transition">
            {{ appealSent ? 'Апелляция на рассмотрении' : 'Подать апелляцию' }}
        </button>
    </div>

    <!-- ================= РЕГИСТРАЦИЯ ================= -->
    <div v-if="!user.setupComplete && !isBanned" class="absolute inset-0 z-[400] bg-white dark:bg-[#0f0f0f] flex items-center justify-center p-4">
        <div class="w-full max-w-sm text-center">
            <div class="w-20 h-20 mx-auto mb-6 bg-tg-blue rounded-3xl flex items-center justify-center shadow-2xl rotate-3">
                <i class="fa-brands fa-telegram text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold mb-8 dark:text-white">Tweeyer Web</h1>
            <div class="space-y-4">
                <div class="relative w-24 h-24 mx-auto mb-6" @click="$refs.avaInput.click()">
                    <img :src="tempAvatar || defaultAvatar" class="w-full h-full rounded-full object-cover border-4 border-white dark:border-tg-panel shadow-lg">
                    <div class="absolute inset-0 bg-black/20 rounded-full flex items-center justify-center text-white opacity-0 hover:opacity-100 transition cursor-pointer"><i class="fa-solid fa-camera"></i></div>
                </div>
                <input type="file" ref="avaInput" class="hidden" @change="onAvatarChange">
                <input v-model="tempName" placeholder="Ваше имя" class="w-full bg-gray-100 dark:bg-tg-panel p-4 rounded-xl outline-none dark:text-white border-2 border-transparent focus:border-tg-blue transition text-center font-bold">
                <button @click="finishSetup" :disabled="!tempName" class="w-full bg-tg-blue text-white py-4 rounded-xl font-bold shadow-xl disabled:opacity-50">Войти</button>
            </div>
        </div>
    </div>

    <!-- ================= БОКОВАЯ ПАНЕЛЬ ================= -->
    <aside class="w-full md:w-[380px] bg-white dark:bg-tg-sidebar border-r border-gray-200 dark:border-black/20 flex flex-col z-20 absolute md:relative h-full transition-transform duration-300"
           :class="mobileView === 'chat' ? '-translate-x-full md:translate-x-0' : 'translate-x-0'">
        
        <div class="h-[70px] px-4 flex items-center gap-3">
            <button @click="ui.showDrawer = true" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-white/5 flex items-center justify-center text-gray-500"><i class="fa-solid fa-bars"></i></button>
            <input v-model="searchQuery" placeholder="Поиск" class="flex-1 bg-gray-100 dark:bg-[#0f161e] rounded-full h-10 px-4 outline-none dark:text-white focus:ring-1 ring-tg-blue">
        </div>

        <div class="px-4 pb-4">
            <div class="bg-gray-50 dark:bg-tg-panel p-4 rounded-2xl border dark:border-white/5">
                <div class="flex justify-between text-[10px] font-bold text-gray-400 mb-2"><span>ВАШ ID</span><button @click="copyId" class="text-tg-blue hover:underline">КОПИРОВАТЬ</button></div>
                <div class="text-xs font-mono dark:text-white truncate mb-4">{{ myPeerId }}</div>
                <div class="flex gap-2">
                    <input v-model="targetId" placeholder="ID партнера" class="flex-1 bg-white dark:bg-[#17212b] rounded-lg px-3 py-2 text-sm outline-none dark:text-white border dark:border-black/20">
                    <button @click="connect" class="bg-tg-blue text-white w-9 rounded-lg flex items-center justify-center shadow-lg"><i class="fa-solid fa-arrow-right"></i></button>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto">
            <!-- СИСТЕМНЫЙ ЧАТ -->
            <div @click="activeChat = 'SYSTEM'; mobileView = 'chat'" class="mx-2 p-3 rounded-2xl cursor-pointer flex gap-3 transition" :class="activeChat === 'SYSTEM' ? 'bg-tg-blue text-white' : 'hover:bg-gray-100 dark:hover:bg-tg-active'">
                <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-blue-500 to-cyan-400 flex items-center justify-center text-white text-xl relative shadow-lg">
                    <i class="fa-brands fa-telegram"></i>
                    <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-blue-600 border-2 border-white dark:border-tg-sidebar rounded-full flex items-center justify-center text-[8px] text-white"><i class="fa-solid fa-check"></i></div>
                </div>
                <div class="flex-1 min-w-0 flex flex-col justify-center">
                    <div class="flex justify-between items-center"><h3 class="font-bold flex items-center gap-1">Tweeyer <i class="fa-solid fa-certificate text-[10px] text-blue-500" :class="activeChat==='SYSTEM'?'text-white':''"></i></h3><span class="text-[10px] opacity-70">Служба</span></div>
                    <p class="text-sm opacity-80 truncate">{{ systemLastMsg }}</p>
                </div>
            </div>

            <!-- ЛИЧНЫЙ ЧАТ -->
            <div v-if="isConnected || hasP2P" @click="activeChat = 'P2P'; mobileView = 'chat'" class="mx-2 p-3 rounded-2xl cursor-pointer flex gap-3 transition mt-1" :class="activeChat === 'P2P' ? 'bg-tg-blue text-white' : 'hover:bg-gray-100 dark:hover:bg-tg-active'">
                <div class="relative shrink-0">
                    <img :src="partner.avatar || defaultAvatar" class="w-12 h-12 rounded-full object-cover bg-gray-200">
                    <div v-if="partner.isDeleted" class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center text-white text-[10px]"><i class="fa-solid fa-ban"></i></div>
                    <div v-else-if="isConnected" class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-tg-sidebar rounded-full"></div>
                </div>
                <div class="flex-1 min-w-0 flex flex-col justify-center">
                    <div class="flex justify-between items-center"><h3 class="font-bold truncate" :class="partner.isDeleted?'text-red-400':''">{{ partner.name || 'Собеседник' }}</h3><span class="text-[10px] opacity-70">{{ p2pLastMsgTime }}</span></div>
                    <p class="text-sm opacity-80 truncate">{{ p2pLastMsgPreview }}</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- ================= ОКНО ЧАТА ================= -->
    <main class="flex-1 flex flex-col h-full relative" :class="theme === 'dark' ? 'chat-bg-dark' : 'chat-bg-light', mobileView === 'sidebar' ? 'hidden md:flex' : 'flex'">
        
        <header class="h-[70px] bg-white/90 dark:bg-tg-sidebar/95 backdrop-blur-md flex items-center justify-between px-4 z-10 border-b dark:border-black/20">
            <div class="flex items-center gap-3">
                <button @click="mobileView = 'sidebar'" class="md:hidden w-8 h-8 flex items-center justify-center dark:text-white"><i class="fa-solid fa-arrow-left"></i></button>
                <div class="flex items-center gap-3" @click="viewProfile">
                    <img :src="activeChat==='SYSTEM' ? 'https://cdn-icons-png.flaticon.com/512/2111/2111646.png' : (partner.avatar || defaultAvatar)" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <h3 class="font-bold dark:text-white flex items-center gap-1">{{ activeChat === 'SYSTEM' ? 'Tweeyer' : partner.name }} <i v-if="activeChat==='SYSTEM'" class="fa-solid fa-certificate text-blue-500 text-[10px]"></i></h3>
                        <p class="text-xs text-tg-blue">{{ activeChat === 'SYSTEM' ? 'Официальный аккаунт' : (partner.online ? 'в сети' : 'был недавно') }}</p>
                    </div>
                </div>
            </div>
            <div v-if="activeChat !== 'SYSTEM' && isConnected" class="flex gap-4 text-gray-400"><button @click="startCall"><i class="fa-solid fa-phone"></i></button></div>
        </header>

        <div id="chatContainer" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2">
            <div v-for="msg in filteredMessages" :key="msg.id" :id="'msg-'+msg.id" class="flex flex-col msg-pop" :class="msg.sender === 'me' ? 'items-end' : 'items-start'">
                <!-- Сообщение -->
                <div class="max-w-[85%] md:max-w-[70%] relative group" @dblclick="react(msg)" :class="getMessageClass(msg)">
                    <!-- Reply -->
                    <div v-if="msg.replyTo" class="mb-1 pl-2 border-l-2 border-tg-blue opacity-70 text-xs cursor-pointer" @click="jumpTo(msg.replyTo.id)">
                        <div class="font-bold text-tg-blue">{{ msg.replyTo.sender === 'me' ? 'Вы' : partner.name }}</div>
                        <div class="truncate">{{ msg.replyTo.content }}</div>
                    </div>
                    <!-- Content -->
                    <div v-if="msg.type === 'image'" @click="zoomImg = msg.content" class="cursor-zoom-in mb-1"><img :src="msg.content" class="rounded-lg max-h-60"></div>
                    <div v-if="msg.type === 'video'" class="bg-black rounded-lg mb-1"><video :src="msg.content" controls class="max-h-60 rounded-lg"></video></div>
                    <div v-if="msg.type === 'voice'" class="flex items-center gap-2 py-1"><button @click="playVoice(msg.id)"><i class="fa-solid" :class="playingVoice===msg.id?'fa-pause':'fa-play'"></i></button><span class="text-[10px] font-mono">Voice Message</span></div>
                    <div v-if="msg.type === 'text'" class="whitespace-pre-wrap break-words py-1">{{ msg.content }} <span v-if="msg.edited" class="text-[9px] opacity-50 italic">(изм.)</span></div>
                    <!-- Meta -->
                    <div class="flex items-center justify-end gap-1 mt-1 text-[9px] opacity-60">
                        <span>{{ formatTime(msg.timestamp) }}</span>
                        <i v-if="msg.sender === 'me'" class="fa-solid" :class="msg.status==='read'?'fa-check-double text-blue-400':'fa-check'"></i>
                    </div>
                    <!-- Heart Reaction -->
                    <div v-if="msg.liked" class="absolute -bottom-2 -left-2 bg-white dark:bg-tg-panel rounded-full p-1 shadow-lg border dark:border-white/10 reaction-anim"><i class="fa-solid fa-heart text-red-500 text-[10px]"></i></div>
                    <!-- Actions -->
                    <div v-if="activeChat !== 'SYSTEM'" class="absolute top-0 -right-8 opacity-0 group-hover:opacity-100 transition flex flex-col gap-1">
                        <button @click="startReply(msg)" class="w-6 h-6 rounded-full bg-gray-200 dark:bg-white/10 text-[10px]"><i class="fa-solid fa-reply"></i></button>
                        <button v-if="msg.sender==='me'" @click="startEdit(msg)" class="w-6 h-6 rounded-full bg-gray-200 dark:bg-white/10 text-[10px]"><i class="fa-solid fa-pen"></i></button>
                    </div>
                </div>
            </div>
            <div id="anchor" class="h-1"></div>
        </div>

        <footer v-if="activeChat === 'P2P' && !partner.isDeleted" class="p-2 md:p-4 bg-white dark:bg-tg-sidebar border-t dark:border-black/20">
            <div v-if="replyingTo || editingMsg" class="flex items-center justify-between bg-gray-100 dark:bg-white/5 p-2 px-4 rounded-t-xl border-b dark:border-white/5">
                <div class="flex items-center gap-2 text-xs truncate">
                    <i :class="editingMsg?'fa-solid fa-pen':'fa-solid fa-reply'" class="text-tg-blue"></i>
                    <span class="dark:text-white">{{ editingMsg ? 'Редактирование' : 'Ответ' }}</span>
                </div>
                <button @click="cancelAction"><i class="fa-solid fa-xmark text-gray-400"></i></button>
            </div>
            <div class="flex items-end gap-2">
                <button @click="ui.showAttach = !ui.showAttach" class="w-10 h-10 flex items-center justify-center text-gray-400"><i class="fa-solid fa-paperclip text-xl"></i></button>
                <div class="flex-1 bg-gray-100 dark:bg-[#17212b] rounded-2xl relative">
                    <textarea ref="msgInput" v-model="inputMsg" @keydown.enter.prevent="sendText" rows="1" placeholder="Сообщение" class="w-full bg-transparent p-3 pr-10 outline-none dark:text-white resize-none max-h-40"></textarea>
                    <button @click="ui.showEmoji = !ui.showEmoji" class="absolute right-3 bottom-3 text-gray-400"><i class="fa-regular fa-face-smile text-xl"></i></button>
                </div>
                <button v-if="inputMsg.trim()" @click="sendText" class="w-12 h-12 bg-tg-blue text-white rounded-full flex items-center justify-center shadow-lg"><i :class="editingMsg?'fa-solid fa-check':'fa-solid fa-paper-plane'"></i></button>
                <button v-else @mousedown="startRec" @mouseup="stopRec" class="w-12 h-12 rounded-full flex items-center justify-center transition" :class="isRecording?'bg-red-500 text-white animate-pulse':'text-gray-400'"><i class="fa-solid fa-microphone text-xl"></i></button>
            </div>
            <div v-if="ui.showEmoji" class="mt-2 h-80 rounded-xl overflow-hidden shadow-2xl border dark:border-white/10"><emoji-picker @emoji-click="onEmoji" class="dark:dark"></emoji-picker></div>
        </footer>
        <div v-else class="p-6 text-center text-gray-400 bg-gray-50 dark:bg-tg-sidebar border-t dark:border-black/20">
            <i class="fa-solid fa-lock mr-2"></i> {{ activeChat === 'SYSTEM' ? 'Этот канал работает только в режиме чтения' : 'Аккаунт удален' }}
        </div>
    </main>

    <!-- Drawer, Call, Zoom и тд -->
    <transition name="pop"><div v-if="zoomImg" @click="zoomImg = null" class="fixed inset-0 z-[600] bg-black/90 flex items-center justify-center p-4"><img :src="zoomImg" class="max-w-full max-h-full rounded-lg shadow-2xl"></div></transition>
    <div v-if="call.active || call.incoming" class="fixed inset-0 z-[700] bg-tg-bg flex flex-col items-center justify-center text-white p-6">
        <img :src="partner.avatar || defaultAvatar" class="w-32 h-32 rounded-full mb-6 border-4 border-white/10 shadow-2xl">
        <h2 class="text-3xl font-bold mb-2">{{ partner.name }}</h2>
        <p class="text-tg-blue animate-pulse mb-12">{{ call.statusText }}</p>
        <div class="flex gap-12">
            <button v-if="call.incoming" @click="answerCall" class="w-20 h-20 bg-green-500 rounded-full text-3xl animate-bounce shadow-lg shadow-green-500/20"><i class="fa-solid fa-phone"></i></button>
            <button @click="endCall" class="w-20 h-20 bg-red-500 rounded-full text-3xl shadow-lg shadow-red-500/20"><i class="fa-solid fa-phone-slash"></i></button>
        </div>
    </div>
    <audio ref="remoteAudio" autoplay class="hidden"></audio>
    <input type="file" ref="fileInput" class="hidden" @change="handleFile">

</div>

<script>
const { createApp, ref, reactive, onMounted, computed, watch, nextTick } = Vue;

createApp({
    setup() {
        // IDs
        const SYS_ID = '777000';
        
        // UI
        const ui = reactive({ showDrawer: false, showAttach: false, showEmoji: false, viewProfile: false });
        const mobileView = ref('sidebar');
        const activeChat = ref(SYS_ID);
        const inputMsg = ref('');
        const searchQuery = ref('');
        const theme = ref('dark');
        const zoomImg = ref(null);
        
        // User & Ban
        const myPeerId = ref(localStorage.getItem('tw_static_id') || '');
        const targetId = ref('');
        const isBanned = ref(localStorage.getItem('tw_banned') === 'true');
        const user = reactive({ name: '', avatar: '', setupComplete: false });
        const partner = reactive({ name: '', avatar: '', bio: '', online: false, isDeleted: false });
        const appealSent = ref(false);

        // Core
        const messages = ref([]);
        const isConnected = ref(false);
        const playingVoice = ref(null);
        const isRecording = ref(false);
        const replyingTo = ref(null);
        const editingMsg = ref(null);
        const call = reactive({ incoming: false, active: false, statusText: '' });

        let peer, conn, mediaRecorder, chunks = [], callObj, localStream, hbInt;
        const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        const msgInput = ref(null);
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // METHODS
        const unlockAudio = () => { if(audioCtx.state === 'suspended') audioCtx.resume(); };
        const playSound = (t) => {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination);
            if(t==='in'){ o.frequency.setValueAtTime(600, audioCtx.currentTime); g.gain.setValueAtTime(0.1, audioCtx.currentTime); o.start(); o.stop(audioCtx.currentTime+0.2); }
        };

        const addSystem = (txt) => {
            messages.value.push({ id: Date.now(), chatId: SYS_ID, type: 'text', sender: 'system', content: txt, timestamp: Date.now() });
            scrollToBottom();
        };

        // COMMANDS
        window.snos = (id) => {
            if(!id || id === myPeerId.value) {
                isBanned.value = true; localStorage.setItem('tw_banned', 'true');
                if(conn) conn.send({type:'BAN_EV'});
                location.reload();
            } else if(conn && conn.open && conn.peer === id) {
                conn.send({type:'BAN_EV'});
                addSystem(`Аккаунт ${id} деактивирован.`);
            }
        };

        window.unban = () => {
            localStorage.removeItem('tw_banned');
            localStorage.setItem('tw_show_unban_msg', 'true');
            location.reload();
        };

        window.tweeyer = (txt) => {
            addSystem(txt);
            if(conn && conn.open) conn.send({type:'SYS_BC', txt});
        };

        // PEER
        const initPeer = () => {
            peer = new Peer(myPeerId.value || null, { config: { iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] } });
            peer.on('open', (id) => { myPeerId.value = id; localStorage.setItem('tw_static_id', id); });
            peer.on('connection', setupConn);
            peer.on('call', (c) => { call.incoming=true; callObj=c; call.statusText='Входящий вызов'; playSound('in'); });
        };

        const setupConn = (c) => {
            if(conn) conn.close(); conn = c;
            conn.on('open', () => {
                isConnected.value = true; partner.isDeleted = false; activeChat.value = 'P2P';
                conn.send({type:'handshake', user});
                messages.value.forEach(m => { if(m.sender==='me') m.status='read'; });
                hbInt = setInterval(() => conn.send({type:'hb'}), 5000);
            });
            conn.on('data', (d) => {
                partner.online = true;
                if(d.type === 'BAN_EV') { isBanned.value=true; localStorage.setItem('tw_banned','true'); location.reload(); }
                if(d.type === 'SYS_BC') { addSystem(d.txt); }
                if(d.type === 'handshake') Object.assign(partner, d.user);
                if(d.type === 'msg') { messages.value.push({...d.payload, sender:'partner', chatId:'P2P'}); playSound('in'); scrollToBottom(); conn.send({type:'read'}); }
                if(d.type === 'read') messages.value.forEach(m=> {if(m.sender==='me') m.status='read'});
                if(d.type === 'edit') { const m=messages.value.find(x=>x.id===d.id); if(m){m.content=d.txt; m.edited=true;} }
                if(d.type === 'react') { const m=messages.value.find(x=>x.id===d.id); if(m) m.liked=d.v; }
            });
            conn.on('close', () => { isConnected.value = false; partner.online = false; });
        };

        const connect = () => { if(targetId.value) setupConn(peer.connect(targetId.value.trim())); };

        // MSGS
        const sendText = () => {
            if(!inputMsg.value.trim() || activeChat.value === SYS_ID) return;
            if(editingMsg.value) {
                const m = messages.value.find(x=>x.id===editingMsg.value.id);
                m.content = inputMsg.value; m.edited = true;
                conn.send({type:'edit', id:m.id, txt:m.content});
                cancelAction(); return;
            }
            const p = { id:Date.now(), type:'text', content:inputMsg.value, timestamp:Date.now(), sender:'me', status:'sent', replyTo: replyingTo.value?{id:replyingTo.value.id, sender:replyingTo.value.sender, content:replyingTo.value.content}:null };
            messages.value.push({...p, chatId:'P2P'});
            if(conn) conn.send({type:'msg', payload: p});
            inputMsg.value = ''; cancelAction(); scrollToBottom();
        };

        const finishSetup = () => {
            user.setupComplete = true; localStorage.setItem('tw_web_user', JSON.stringify(user));
            addSystem(`Приветствуем, ${user.name}! Добро пожаловать в Tweeyer Web. Соблюдайте правила общения.`);
            initPeer();
        };

        onMounted(() => {
            if(localStorage.getItem('tw_show_unban_msg')) {
                addSystem(`Здравствуйте, ${user.name}. Ваш аккаунт разблокирован. Соблюдайте правила, при повторном нарушении наказание будет строже.`);
                localStorage.removeItem('tw_show_unban_msg');
            }
            if(user.setupComplete && !isBanned.value) initPeer();
        });

        // Other boilerplate
        const onAvatarChange=(e)=>{const r=new FileReader(); r.onload=v=>tempAvatar.value=v.target.result; r.readAsDataURL(e.target.files[0]);};
        const onEmoji=(e)=>inputMsg.value+=e.detail.unicode;
        const scrollToBottom=()=>nextTick(()=>{const e=document.getElementById('chatContainer'); if(e)e.scrollTop=e.scrollHeight;});
        const formatTime=(ts)=>new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
        const getMessageClass=(m)=> {
            const b = "p-3 rounded-2xl shadow-sm ";
            if(m.chatId===SYS_ID) return b+"bg-white dark:bg-tg-panel dark:text-white self-center text-center";
            return b + (m.sender==='me' ? 'bg-tg-self text-white rounded-br-none' : 'bg-gray-200 dark:bg-tg-panel dark:text-white rounded-bl-none');
        };
        const cancelAction=()=>{replyingTo.value=null; editingMsg.value=null; inputMsg.value='';};
        const startReply=(m)=>{replyingTo.value=m; editingMsg.value=null; nextTick(()=>msgInput.value.focus());};
        const startEdit=(m)=>{editingMsg.value=m; replyingTo.value=null; inputMsg.value=m.content; nextTick(()=>msgInput.value.focus());};
        const react=(m)=>{if(activeChat.value===SYS_ID)return; m.liked=!m.liked; if(conn)conn.send({type:'react', id:m.id, v:m.liked});};
        const startCall=async()=>{try{localStream=await navigator.mediaDevices.getUserMedia({audio:true}); callObj=peer.call(conn.peer, localStream); setupCall(callObj); call.active=true; call.statusText='Вызов...';}catch(e){}};
        const answerCall=async()=>{localStream=await navigator.mediaDevices.getUserMedia({audio:true}); callObj.answer(localStream); setupCall(callObj); call.active=true; call.incoming=false;};
        const setupCall=(c)=>{c.on('stream',r=>{const a=document.querySelector('audio.hidden');a.srcObject=r;}); c.on('close',endCall);};
        const endCall=()=>{if(callObj)callObj.close(); call.active=false; call.incoming=false;};

        return {
            ui, mobileView, activeChat, inputMsg, searchQuery, theme, zoomImg, myPeerId, targetId, isBanned, user, partner, appealSent, messages, isConnected, playingVoice, isRecording, replyingTo, editingMsg, call, SYS_ID,
            unlockAudio, connect, sendText, finishSetup, onAvatarChange, onEmoji, formatTime, getMessageClass, cancelAction, startReply, startEdit, react, startCall, answerCall, endCall, 
            appeal:()=>{appealSent.value=true;},
            copyId:()=>navigator.clipboard.writeText(myPeerId.value),
            toggleTheme:()=>{theme.value=theme.value==='dark'?'light':'dark'; localStorage.setItem('tw_theme',theme.value); document.documentElement.classList.toggle('dark');},
            filteredMessages: computed(()=>messages.value.filter(m=>m.chatId === activeChat.value)),
            systemLastMsg: computed(()=>{const m=messages.value.filter(x=>x.chatId===SYS_ID); return m.length?m[m.length-1].content:'Нет уведомлений'}),
            p2pLastMsgTime: computed(()=>{const m=messages.value.filter(x=>x.chatId==='P2P'); return m.length?formatTime(m[m.length-1].timestamp):''}),
            p2pLastMsgPreview: computed(()=>{const m=messages.value.filter(x=>x.chatId==='P2P'); return m.length?m[m.length-1].content:''}),
            hasP2P: computed(()=>messages.value.some(m=>m.chatId==='P2P')),
            tempName: ref(''), tempAvatar: ref(''), defaultAvatar, msgInput
        };
    }
}).mount('#app');
</script>
</body>
</html>
