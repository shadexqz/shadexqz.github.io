<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Дурак Онлайн (Realistic)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-table: #2c3e50; /* Темно-синий матовый, как на дорогих столах */
            --card-w: 90px;
            --card-h: 125px;
            --radius: 5px;
        }

        body {
            margin: 0;
            background-color: var(--bg-table);
            /* Текстура ткани */
            background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%2334495e' fill-opacity='0.4' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 6V5zM6 5v1H5z'/%3E%3C/g%3E%3C/svg%3E");
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex; flex-direction: column;
            color: white;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- UI ЛОББИ --- */
        #lobby {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .panel {
            background: #fff; color: #222;
            padding: 30px; width: 90%; max-width: 350px;
            border-radius: 8px; text-align: center;
        }
        .panel h2 { margin-top: 0; text-transform: uppercase; letter-spacing: 1px; }
        .inp {
            width: 100%; padding: 12px; border: 1px solid #ccc;
            margin: 10px 0; font-size: 16px; border-radius: 4px;
            box-sizing: border-box;
        }
        .btn {
            width: 100%; padding: 12px; border: none;
            font-size: 16px; font-weight: bold; color: white;
            cursor: pointer; border-radius: 4px; margin-top: 5px;
            transition: 0.2s;
        }
        .btn-green { background: #27ae60; }
        .btn-green:hover { background: #219150; }
        .btn-blue { background: #2980b9; }
        .btn-blue:hover { background: #2471a3; }
        
        /* --- ИГРОВОЕ ПОЛЕ --- */
        #game {
            display: none; flex-direction: column; height: 100%;
        }

        /* Аватарки */
        .player-info {
            display: flex; flex-direction: column; align-items: center;
            width: 80px; position: relative; z-index: 10;
        }
        .avatar {
            width: 64px; height: 64px; background: #555;
            border-radius: 8px; border: 2px solid rgba(255,255,255,0.5);
            overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .p-name { font-size: 12px; margin-top: 4px; text-shadow: 1px 1px 2px black; font-weight: bold; }

        /* Зоны */
        .top-zone {
            height: 140px; display: flex; align-items: center; padding: 10px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .middle-zone {
            flex: 1; position: relative;
            display: flex; justify-content: center; align-items: center;
        }
        .bottom-zone {
            height: 180px; display: flex; align-items: flex-end; justify-content: center;
            padding-bottom: 20px; position: relative;
        }

        /* --- КАРТЫ (REALISTIC) --- */
        .card {
            width: var(--card-w); height: var(--card-h);
            border-radius: var(--radius);
            position: relative;
            background-size: 100% 100%;
            background-repeat: no-repeat;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.6); /* Реальная тень */
            transition: transform 0.2s, margin 0.2s;
            background-color: white; /* Чтобы не было прозрачности пока грузится */
        }
        
        /* Рубашка */
        .card-back {
            /* Классическая сине-красная рубашка */
            background-image: url('https://deckofcardsapi.com/static/img/back.png');
        }

        /* Логика наложения слоев на столе */
        .slot {
            width: var(--card-w); height: var(--card-h); margin: 0 8px;
            position: relative;
        }
        .slot-card-att { position: absolute; top:0; left:0; z-index: 1; }
        .slot-card-def { 
            position: absolute; top: 15px; left: 10px; z-index: 2; 
            transform: rotate(10deg); /* Легкий поворот */
        }

        /* Выделение в руке */
        .my-hand-card {
            margin-right: -50px; cursor: pointer;
            transform-origin: bottom center;
        }
        .my-hand-card:last-child { margin-right: 0; }
        .my-hand-card:hover { transform: translateY(-15px); z-index: 100; }
        .my-hand-card.selected { 
            transform: translateY(-25px); 
            box-shadow: 0 0 0 2px #f1c40f; /* Желтая рамка, не глоу */
            z-index: 101; 
        }

        /* РУСИФИКАЦИЯ (Patch) */
        /* Накладываем плашку поверх английской буквы */
        .rus-patch {
            position: absolute; top: 3px; left: 3px;
            width: 20px; height: 22px;
            background: white; /* Цвет бумаги карты */
            font-weight: bold; font-size: 19px; line-height: 22px;
            text-align: center; font-family: 'Times New Roman', serif;
        }
        .patch-br {
            top: auto; bottom: 3px; left: auto; right: 3px;
            transform: rotate(180deg);
        }
        .red-text { color: #d00000; }
        .black-text { color: #000; }

        /* Колода */
        .deck-area {
            position: absolute; left: 20px; top: 50%; transform: translateY(-50%);
        }
        .trump-card-img {
            position: absolute; left: 0; top: 0;
            transform: rotate(90deg) translateX(20px);
            z-index: 0;
        }
        .deck-stack { position: relative; z-index: 1; }
        .deck-num {
            position: absolute; top: -25px; left: 10px;
            background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 4px; font-size: 12px;
        }

        /* --- КНОПКИ ДЕЙСТВИЙ --- */
        .actions {
            position: absolute; right: 20px; bottom: 200px;
            display: flex; flex-direction: column; align-items: flex-end; gap: 10px;
        }
        .status-badge {
            background: rgba(0,0,0,0.5); padding: 8px 15px;
            border-radius: 4px; font-size: 14px; color: #fff; border: 1px solid #555;
            margin-bottom: 5px;
        }
        .act-btn {
            padding: 12px 30px; font-size: 16px; font-weight: bold;
            border: none; border-radius: 30px; cursor: pointer;
            box-shadow: 0 4px 5px rgba(0,0,0,0.3);
            display: none; text-transform: uppercase;
        }
        .btn-bito { background: #c0392b; color: white; }
        .btn-take { background: #f39c12; color: black; }

        /* --- ЧАТ (НОВЫЙ ДИЗАЙН) --- */
        #chat-wrap {
            position: absolute; top: 10px; right: 10px;
            width: 300px; height: 220px;
            display: flex; flex-direction: column;
            pointer-events: none;
        }
        #chat-hist {
            flex: 1; overflow-y: auto; 
            display: flex; flex-direction: column; justify-content: flex-end;
            margin-bottom: 5px; padding-right: 5px;
            text-shadow: 1px 1px 1px black;
        }
        .msg-line {
            margin-bottom: 4px; font-size: 13px;
            background: rgba(0,0,0,0.4); padding: 4px 8px; border-radius: 4px;
            align-self: flex-end; max-width: 100%; word-wrap: break-word;
            pointer-events: auto;
        }
        .msg-line.opp { align-self: flex-start; }
        .msg-line.sys { align-self: center; background: transparent; font-style: italic; opacity: 0.8; font-size: 11px; }
        
        /* Имена */
        .nm-me { color: #f1c40f; font-weight: bold; margin-right: 5px; }
        .nm-opp { color: #e74c3c; font-weight: bold; margin-right: 5px; }
        .txt { color: #ecf0f1; }

        #chat-input-row {
            display: flex; pointer-events: auto;
            background: rgba(0,0,0,0.6); border-radius: 20px; padding: 2px;
        }
        #chat-in {
            flex: 1; background: transparent; border: none; color: white;
            padding: 8px 12px; outline: none; font-size: 13px;
        }
        #chat-send {
            background: transparent; border: none; color: #2ecc71;
            font-size: 18px; padding: 0 10px; cursor: pointer; font-weight: bold;
        }

        /* Адаптив */
        @media (max-width: 600px) {
            :root { --card-w: 65px; --card-h: 90px; }
            .top-zone { height: 110px; padding: 5px 10px; }
            .bottom-zone { height: 130px; }
            .actions { bottom: 140px; }
            #chat-wrap { width: 200px; height: 140px; top: 5px; right: 5px; }
            .msg-line { font-size: 11px; }
            .slot { margin: 0 4px; }
        }
    </style>
</head>
<body>

    <!-- ЛОББИ -->
    <div id="lobby">
        <div class="panel" id="panel-start">
            <h2>Durak Classic</h2>
            <input type="text" id="my-name" class="inp" placeholder="Ваш ник" value="Игрок">
            <button class="btn btn-green" onclick="App.create()">Создать игру</button>
            <div style="margin:10px; color:#777;">или</div>
            <input type="text" id="join-id" class="inp" placeholder="ID стола">
            <button class="btn btn-blue" onclick="App.join()">Присоединиться</button>
        </div>
        
        <div class="panel" id="panel-wait" style="display:none;">
            <h3>Ожидание...</h3>
            <p>Код стола:</p>
            <input type="text" id="host-id" class="inp" style="text-align:center; font-weight:bold;" readonly onclick="this.select()">
            <p style="font-size:12px; color:#555;">Отправь этот код другу</p>
        </div>
    </div>

    <!-- ИГРА -->
    <div id="game">
        <!-- Чат -->
        <div id="chat-wrap">
            <div id="chat-hist"></div>
            <div id="chat-input-row">
                <input type="text" id="chat-in" placeholder="Чат..." onkeypress="if(event.key==='Enter') App.sendChat()">
                <button id="chat-send" onclick="App.sendChat()">➤</button>
            </div>
        </div>

        <!-- Верх (Соперник) -->
        <div class="top-zone">
            <div class="player-info">
                <div class="avatar"><img id="opp-ava-img" src="" alt=""></div>
                <div class="p-name" id="opp-name-disp">Соперник</div>
            </div>
            <div id="opp-hand" style="display:flex; margin-left:20px; align-items:center;">
                <!-- Рубашки карт -->
            </div>
        </div>

        <!-- Центр (Стол) -->
        <div class="middle-zone">
            <div class="deck-area">
                <div id="trump-ph"></div> <!-- Козырь -->
                <div id="deck-ph" class="card card-back deck-stack"></div>
                <div id="deck-count" class="deck-num">36</div>
            </div>
            
            <div id="table-slots" style="display:flex; justify-content:center;">
                <!-- Слоты -->
            </div>

            <div class="actions">
                <div id="status-msg" class="status-badge">Ожидание...</div>
                <button id="btn-bito" class="act-btn btn-bito" onclick="App.act('BITO')">Бито</button>
                <button id="btn-take" class="act-btn btn-take" onclick="App.act('TAKE')">Взять</button>
            </div>
        </div>

        <!-- Низ (Я) -->
        <div class="bottom-zone">
            <div id="my-hand" style="display:flex;"></div>
            
            <div class="player-info" style="position:absolute; bottom:10px; left:10px;">
                <div class="avatar"><img id="my-ava-img" src="" alt=""></div>
                <div class="p-name">Вы</div>
            </div>
        </div>
    </div>

    <script>
        // --- LOGIC ---
        const SUITS = ['S', 'C', 'H', 'D']; // Spades, Clubs, Hearts, Diamonds
        const RANKS = ['6', '7', '8', '9', '0', 'J', 'Q', 'K', 'A']; // 0 = 10 for API compatibility
        const RUS_RANK = {'6':'6', '7':'7', '8':'8', '9':'9', '0':'10', 'J':'В', 'Q':'Д', 'K':'К', 'A':'Т'};

        // API для картинок карт: deckofcardsapi.com
        // Формат: https://deckofcardsapi.com/static/img/KH.png (King Hearts)
        const getCardImg = (r, s) => `https://deckofcardsapi.com/static/img/${r}${s}.png`;
        const isRed = (s) => s === 'H' || s === 'D';

        // --- ENGINE ---
        class Durak {
            constructor() {
                this.reset();
            }
            reset() {
                this.deck = [];
                this.trump = null;
                this.hands = { host: [], client: [] };
                this.field = [];
                this.turn = 'host';
                this.state = 'lobby'; // lobby, game, end
                this.names = { host: 'Host', client: 'Client' };
                this.avatars = { host: 1, client: 1 };
            }

            start(hName, hAva, cName, cAva) {
                this.names.host = hName; this.avatars.host = hAva;
                this.names.client = cName; this.avatars.client = cAva;
                
                // Deck gen
                this.deck = [];
                SUITS.forEach(s => RANKS.forEach(r => this.deck.push({r, s})));
                this.deck.sort(() => Math.random() - 0.5);

                // Deal
                this.hands.host = this.deck.splice(0, 6);
                this.hands.client = this.deck.splice(0, 6);

                // Trump
                this.trump = this.deck.pop();
                this.deck.unshift(this.trump);

                // First turn
                let minH = 100, minC = 100;
                const val = c => RANKS.indexOf(c.r);
                this.hands.host.forEach(c => { if(c.s===this.trump.s && val(c)<minH) minH = val(c); });
                this.hands.client.forEach(c => { if(c.s===this.trump.s && val(c)<minC) minC = val(c); });
                this.turn = (minC < minH && minC !== 100) ? 'client' : 'host';
                this.state = 'game';
            }

            canBeat(att, def) {
                if(def.s === att.s) return RANKS.indexOf(def.r) > RANKS.indexOf(att.r);
                return def.s === this.trump.s;
            }

            move(player, type, payload) {
                if(this.state !== 'game') return false;
                
                if(type === 'ATTACK') {
                    if(player !== this.turn) return false;
                    const card = this.hands[player][payload.idx];
                    // Logic check
                    if(this.field.length > 0) {
                        const ranks = new Set();
                        this.field.forEach(p => { ranks.add(p.att.r); if(p.def) ranks.add(p.def.r); });
                        if(!ranks.has(card.r)) return false;
                    }
                    const defP = player==='host'?'client':'host';
                    const unbeat = this.field.filter(p=>!p.def).length;
                    if(unbeat >= this.hands[defP].length) return false;
                    if(this.field.length >= 6) return false;

                    this.hands[player].splice(payload.idx, 1);
                    this.field.push({ att: card, def: null });
                    return true;
                }

                if(type === 'DEFEND') {
                    if(player === this.turn) return false;
                    const slot = this.field[payload.slot];
                    if(!slot || slot.def) return false;
                    const card = this.hands[player][payload.idx];
                    if(this.canBeat(slot.att, card)) {
                        this.hands[player].splice(payload.idx, 1);
                        slot.def = card;
                        return true;
                    }
                    return false;
                }

                if(type === 'BITO') {
                    if(player !== this.turn) return false;
                    if(this.field.length===0 || this.field.some(p=>!p.def)) return false;
                    this.field = [];
                    this.refill();
                    this.turn = player==='host'?'client':'host';
                    return true;
                }

                if(type === 'TAKE') {
                    if(player === this.turn) return false;
                    this.field.forEach(p => {
                        this.hands[player].push(p.att);
                        if(p.def) this.hands[player].push(p.def);
                    });
                    this.field = [];
                    this.refill(true);
                    return true;
                }
                return false;
            }

            refill(skipDef = false) {
                const att = this.turn;
                const def = att==='host'?'client':'host';
                const draw = (p) => {
                    while(this.hands[p].length < 6 && this.deck.length > 0) {
                        this.hands[p].push(this.deck.pop()); // Take form end (top)
                    }
                };
                draw(att);
                if(!skipDef) draw(def);

                // Win check
                if(this.deck.length === 0) {
                    if(this.hands.host.length===0) this.state = 'win_host';
                    if(this.hands.client.length===0) this.state = 'win_client';
                }
            }

            getData() {
                return {
                    trump: this.trump,
                    dCount: this.deck.length,
                    field: this.field,
                    hands: { host: this.hands.host.length, client: this.hands.client.length },
                    turn: this.turn,
                    state: this.state,
                    names: this.names,
                    avatars: this.avatars
                };
            }
        }

        // --- APP ---
        const App = {
            role: null,
            conn: null,
            game: null, // Host only
            myData: { name: '', ava: Math.floor(Math.random()*20)+1 }, // 1-20
            localState: null,
            myHand: [],
            sel: null,

            init() {
                const url = new URLSearchParams(window.location.search);
                if(url.has('game')) {
                    document.getElementById('join-id').value = url.get('game');
                    document.getElementById('panel-start').querySelector('h2').innerText = "Вход в игру";
                }
                // Set my avatar preview
                document.getElementById('my-ava-img').src = `https://robohash.org/${this.myData.ava}?set=set2`;
            },

            create() {
                this.myData.name = document.getElementById('my-name').value || 'Host';
                this.role = 'host';
                this.game = new Durak();
                
                const peer = new Peer();
                peer.on('open', id => {
                    document.getElementById('panel-start').style.display = 'none';
                    document.getElementById('panel-wait').style.display = 'block';
                    document.getElementById('host-id').value = id;
                });
                peer.on('connection', c => {
                    this.conn = c;
                    this.setup();
                });
            },

            join() {
                const id = document.getElementById('join-id').value;
                if(!id) return alert('Нет ID');
                this.myData.name = document.getElementById('my-name').value || 'Client';
                this.role = 'client';
                
                const peer = new Peer();
                peer.on('open', () => {
                    this.conn = peer.connect(id);
                    this.setup();
                });
            },

            setup() {
                this.conn.on('open', () => {
                    // Handshake
                    this.conn.send({ type: 'HI', name: this.myData.name, ava: this.myData.ava });
                });
                
                this.conn.on('data', d => {
                    if(d.type === 'HI' && this.role === 'host') {
                        this.game.start(this.myData.name, this.myData.ava, d.name, d.ava);
                        this.sync();
                        UI.showGame();
                    }
                    if(d.type === 'SYNC') {
                        this.localState = d.state;
                        this.myHand = d.hand;
                        if(document.getElementById('game').style.display !== 'flex') UI.showGame();
                        UI.render();
                    }
                    if(d.type === 'ACT' && this.role === 'host') {
                        this.game.move('client', d.act, d.pl);
                        this.sync();
                    }
                    if(d.type === 'CHAT') {
                        UI.addChat(d.name, d.msg, false);
                    }
                });
            },

            sync() {
                if(this.role !== 'host') return;
                const s = this.game.getData();
                this.localState = s;
                this.myHand = this.game.hands.host;
                UI.render();
                this.conn.send({ type: 'SYNC', state: s, hand: this.game.hands.client });
            },

            act(type, payload={}) {
                if(this.role === 'host') {
                    if(this.game.move('host', type, payload)) this.sync();
                } else {
                    this.conn.send({ type: 'ACT', act: type, pl: payload });
                }
            },

            sendChat() {
                const i = document.getElementById('chat-in');
                const t = i.value.trim();
                if(!t) return;
                UI.addChat(this.myData.name, t, true);
                this.conn.send({ type: 'CHAT', name: this.myData.name, msg: t });
                i.value = '';
            }
        };

        // --- UI ---
        const UI = {
            showGame() {
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('game').style.display = 'flex';
            },

            render() {
                const s = App.localState;
                if(!s) return;

                // Win
                if(s.state.startsWith('win')) {
                    const winner = s.state === 'win_host' ? 'host' : 'client';
                    const wName = s.names[winner];
                    setTimeout(() => alert(`Победил ${wName}!`), 100);
                    App.localState.state = 'end'; // prevent loop
                    return;
                }

                // Info
                const oppKey = App.role==='host'?'client':'host';
                document.getElementById('opp-name-disp').innerText = s.names[oppKey];
                document.getElementById('opp-ava-img').src = `https://robohash.org/${s.avatars[oppKey]}?set=set2`;
                
                // Opp Hand
                const oppDiv = document.getElementById('opp-hand');
                oppDiv.innerHTML = '';
                const oppCount = s.hands[oppKey];
                for(let i=0; i<oppCount; i++) {
                    const c = document.createElement('div');
                    c.className = 'card card-back';
                    c.style.width = '60px'; c.style.height = '84px'; // Маленькие карты у соперника
                    c.style.marginLeft = '-30px';
                    c.style.boxShadow = '-2px 0 5px rgba(0,0,0,0.3)';
                    oppDiv.appendChild(c);
                }

                // Deck
                const trEl = document.getElementById('trump-ph');
                trEl.innerHTML = '';
                if(s.dCount > 0) {
                    trEl.appendChild(this.mkCard(s.trump, 'trump-card-img'));
                    document.getElementById('deck-ph').style.display = s.dCount > 1 ? 'block' : 'none';
                } else {
                    document.getElementById('deck-ph').style.display = 'none';
                }
                document.getElementById('deck-count').innerText = s.dCount;

                // Field
                const tbl = document.getElementById('table-slots');
                tbl.innerHTML = '';
                s.field.forEach((p, i) => {
                    const slot = document.createElement('div');
                    slot.className = 'slot';
                    slot.appendChild(this.mkCard(p.att, 'slot-card-att'));
                    if(p.def) {
                        slot.appendChild(this.mkCard(p.def, 'slot-card-def'));
                    } else if(App.role !== s.turn && App.sel !== null) {
                        // Click zone for defend
                        slot.style.cursor = 'pointer';
                        slot.onclick = () => {
                            App.act('DEFEND', { idx: App.sel, slot: i });
                            App.sel = null;
                        };
                    }
                    tbl.appendChild(slot);
                });

                // My Hand
                const myDiv = document.getElementById('my-hand');
                myDiv.innerHTML = '';
                App.myHand.forEach((c, i) => {
                    const el = this.mkCard(c, 'my-hand-card');
                    if(App.sel === i) el.classList.add('selected');
                    el.onclick = () => {
                        if(App.role === s.turn) {
                            App.act('ATTACK', { idx: i });
                        } else {
                            App.sel = (App.sel === i) ? null : i;
                            UI.render();
                        }
                    };
                    myDiv.appendChild(el);
                });

                // Status & Buttons
                const stat = document.getElementById('status-msg');
                const bBito = document.getElementById('btn-bito');
                const bTake = document.getElementById('btn-take');
                bBito.style.display = 'none'; bTake.style.display = 'none';

                if(App.role === s.turn) {
                    stat.innerText = "Ваш ход (Атака)";
                    stat.style.color = "#81c784";
                    stat.style.borderColor = "#81c784";
                    if(s.field.length>0 && s.field.every(p=>p.def)) bBito.style.display = 'block';
                } else {
                    stat.innerText = "Отбивайтесь!";
                    stat.style.color = "#f39c12";
                    stat.style.borderColor = "#f39c12";
                    if(s.field.some(p=>!p.def)) bTake.style.display = 'block';
                }
            },

            mkCard(c, cls) {
                const el = document.createElement('div');
                el.className = 'card ' + (cls || '');
                el.style.backgroundImage = `url('${getCardImg(c.r, c.s)}')`;
                
                // RUSSIAN PATCH
                if (['J','Q','K','A'].includes(c.r)) {
                    const rTxt = RUS_RANK[c.r];
                    const colClass = isRed(c.s) ? 'red-text' : 'black-text';
                    
                    const patchTL = document.createElement('div');
                    patchTL.className = `rus-patch ${colClass}`;
                    patchTL.innerText = rTxt;
                    el.appendChild(patchTL);

                    const patchBR = document.createElement('div');
                    patchBR.className = `rus-patch patch-br ${colClass}`;
                    patchBR.innerText = rTxt;
                    el.appendChild(patchBR);
                }
                return el;
            },

            addChat(name, msg, isMe) {
                const h = document.getElementById('chat-hist');
                const line = document.createElement('div');
                line.className = 'msg-line ' + (isMe?'me':'opp');
                line.innerHTML = `<span class="${isMe?'nm-me':'nm-opp'}">${name}:</span><span class="txt">${msg}</span>`;
                h.appendChild(line);
                h.scrollTop = h.scrollHeight;
            }
        };

        App.init();
    </script>
</body>
</html>
