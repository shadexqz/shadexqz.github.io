<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tweeyer Web K</title>
    
    <!-- Fonts: Inter + Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <!-- Emoji Picker -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        tg: {
                            bg: '#17212b',         // Main background
                            sidebar: '#17212b',    // Sidebar
                            panel: '#242f3d',      // Elements bg
                            active: '#2b5278',     // Selected chat
                            self: '#766ac8',       // Self bubble (Purple)
                            in: '#182533',         // Incoming bubble
                            text: '#f5f5f5',
                            meta: '#8da2b5',       // Timestamp color
                            blue: '#3390ec',       // Accents
                            green: '#4ade80'       // Online status
                        }
                    }
                }
            }
        };
    </script>

    <style>
        /* Telegram Pattern Background */
        .chat-bg {
            background-color: #0f0f0f;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 20.5V18H0v-2h20v-2H0v-2h20v-2H0V8h20V6H0V4h20V2H0V0h22v20h2V0h2v20h2V0h2v20h2V0h2v20h2V0h2v20h2V0h2v20h2v2H22v-2h-2z' fill='%23151e27' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Animations */
        .msg-enter-active, .msg-leave-active { transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1); }
        .msg-enter-from { opacity: 0; transform: translateY(10px) scale(0.95); }
        
        /* Voice Wave Animation */
        .wave-bar {
            width: 3px;
            background-color: rgba(255,255,255,0.8);
            border-radius: 2px;
            animation: wave 1s infinite ease-in-out;
        }
        @keyframes wave { 
            0%, 100% { height: 10px; } 
            50% { height: 20px; } 
        }
        .paused .wave-bar { animation-play-state: paused; height: 5px; }

        emoji-picker {
            width: 100%;
            height: 320px;
            --background: #242f3d;
            --border-color: #17212b;
            --color: #ffffff;
        }
    </style>
</head>
<body class="bg-[#0f0f0f] text-tg-text h-[100dvh] w-screen overflow-hidden text-[15px] antialiased">

<div id="app" class="h-full flex relative font-sans" @paste="handlePaste" @click="initAudioContext">

    <!-- ================= SETUP MODAL ================= -->
    <div v-if="!user.setupComplete" class="fixed inset-0 z-[999] bg-[#17212b] flex items-center justify-center p-4">
        <div class="w-full max-w-sm text-center">
            <div class="w-28 h-28 mx-auto mb-6 bg-tg-blue rounded-full flex items-center justify-center shadow-[0_10px_30px_rgba(51,144,236,0.4)]">
                <i class="fa-brands fa-telegram text-5xl text-white"></i>
            </div>
            <h1 class="text-2xl font-bold mb-2">Tweeyer Web</h1>
            <p class="text-tg-meta mb-8 text-sm">Create your P2P Identity</p>

            <div class="space-y-4">
                <div class="relative w-24 h-24 mx-auto group cursor-pointer" @click="$refs.avaInput.click()">
                    <img :src="tempAvatar || defaultAvatar" class="w-full h-full rounded-full object-cover border-2 border-tg-blue">
                    <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-white">
                        <i class="fa-solid fa-camera"></i>
                    </div>
                </div>
                <input type="file" ref="avaInput" class="hidden" accept="image/*" @change="onAvatarChange">

                <input v-model="tempName" placeholder="Your Name" class="w-full bg-[#242f3d] px-4 py-3 rounded-xl outline-none focus:ring-1 focus:ring-tg-blue text-center text-white transition placeholder-gray-500">
                
                <button @click="finishSetup" :disabled="!tempName" class="w-full bg-tg-blue text-white py-3 rounded-xl font-bold hover:bg-[#2b83d6] transition disabled:opacity-50">
                    START MESSAGING
                </button>
            </div>
        </div>
    </div>

    <!-- ================= LEFT SIDEBAR ================= -->
    <aside class="w-full md:w-[420px] bg-tg-sidebar border-r border-black/20 flex flex-col z-20 absolute md:relative h-full transition-transform duration-300"
           :class="mobileView === 'chat' ? '-translate-x-full md:translate-x-0' : 'translate-x-0'">
        
        <!-- Header / Search -->
        <div class="h-14 px-3 flex items-center gap-3 shrink-0">
            <button @click="ui.showMenu = true" class="w-10 h-10 rounded-full hover:bg-white/5 flex items-center justify-center text-gray-400 transition">
                <i class="fa-solid fa-bars text-lg"></i>
            </button>
            <div class="flex-1 relative group">
                <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 group-focus-within:text-tg-blue transition">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </div>
                <input placeholder="Search" class="w-full bg-[#242f3d] rounded-full h-10 pl-10 pr-4 text-sm outline-none text-white border border-transparent focus:border-tg-blue focus:bg-[#17212b] transition">
            </div>
        </div>

        <!-- Connection Status & ID -->
        <div class="px-2 pb-2">
            <div class="bg-[#242f3d] rounded-lg p-3 border-l-2 border-tg-blue mb-2 flex items-center justify-between">
                <div>
                    <div class="text-[10px] uppercase text-tg-blue font-bold tracking-wider mb-0.5">My ID</div>
                    <div class="text-xs font-mono text-gray-300 select-all cursor-pointer hover:text-white" @click="copyId">{{ myPeerId || 'Connecting...' }}</div>
                </div>
                <div class="w-2 h-2 rounded-full" :class="isNetReady ? 'bg-green-500 shadow-[0_0_8px_#4ade80]' : 'bg-red-500 animate-pulse'"></div>
            </div>
        </div>

        <!-- Folders / Tabs -->
        <div class="px-2 flex gap-4 text-sm font-medium text-gray-400 border-b border-black/20 pb-2 mb-2 overflow-x-auto hide-scrollbar">
            <button class="whitespace-nowrap pb-1 border-b-2" :class="activeTab === 'all' ? 'text-tg-blue border-tg-blue' : 'border-transparent hover:text-gray-300'" @click="activeTab='all'">All <span class="bg-tg-blue text-white text-[10px] px-1.5 rounded-full ml-1">{{ chats.length }}</span></button>
            <button class="whitespace-nowrap pb-1 border-b-2" :class="activeTab === 'groups' ? 'text-tg-blue border-tg-blue' : 'border-transparent hover:text-gray-300'" @click="activeTab='groups'">Groups</button>
        </div>

        <!-- Chat List -->
        <div class="flex-1 overflow-y-auto">
            <!-- Add New (Btn) -->
            <div class="px-2 mb-2 flex gap-2">
                <button @click="ui.showAddContact = true" class="flex-1 bg-[#242f3d] hover:bg-[#2b3949] py-2 rounded-lg text-xs text-tg-blue font-medium transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-user-plus"></i> Add User
                </button>
                <button @click="ui.showCreateGroup = true" class="flex-1 bg-[#242f3d] hover:bg-[#2b3949] py-2 rounded-lg text-xs text-tg-blue font-medium transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-users"></i> New Group
                </button>
            </div>

            <div v-if="filteredChats.length === 0" class="text-center mt-10 opacity-50 text-sm">
                <i class="fa-regular fa-comments text-3xl mb-2"></i>
                <p>No chats yet.</p>
            </div>

            <div v-for="chat in filteredChats" :key="chat.id" 
                 class="px-3 py-2.5 hover:bg-[#202b36] cursor-pointer flex gap-3 transition group relative"
                 :class="{'bg-tg-active hover:bg-tg-active': activeChatId === chat.id}"
                 @click="openChat(chat.id)">
                
                <div class="relative">
                    <img :src="chat.avatar || defaultAvatar" class="w-12 h-12 rounded-full object-cover bg-[#242f3d]">
                    <div v-if="chat.online" class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-tg-green border-2 border-tg-sidebar rounded-full"></div>
                </div>
                
                <div class="flex-1 min-w-0 border-b border-black/10 pb-2 group-hover:border-transparent">
                    <div class="flex justify-between items-center mb-0.5">
                        <h3 class="font-semibold text-[15px] truncate text-white group-hover:text-white" :class="{'text-white': activeChatId === chat.id}">
                            <i v-if="chat.type === 'group'" class="fa-solid fa-lock text-xs mr-1 opacity-70"></i>
                            {{ chat.name }}
                        </h3>
                        <span class="text-xs text-tg-meta" :class="{'text-gray-300': activeChatId === chat.id}">
                            {{ formatTime(chat.lastTimestamp) }}
                        </span>
                    </div>
                    <p class="text-sm text-tg-meta truncate flex items-center gap-1" :class="{'text-gray-200': activeChatId === chat.id}">
                        <span v-if="chat.lastSender === 'me'" class="text-tg-self">You:</span>
                        {{ chat.lastMessage || 'No messages' }}
                    </p>
                </div>
            </div>
        </div>
    </aside>

    <!-- ================= MAIN CHAT ================= -->
    <main class="flex-1 flex flex-col h-full relative chat-bg transition-transform duration-300"
          :class="mobileView === 'sidebar' ? 'translate-x-full md:translate-x-0 hidden md:flex' : 'translate-x-0'">
        
        <!-- Empty State -->
        <div v-if="!activeChatId" class="absolute inset-0 flex items-center justify-center flex-col text-white opacity-40 select-none">
            <span class="bg-[#242f3d] p-4 rounded-full mb-4 shadow-lg"><i class="fa-solid fa-comments text-4xl"></i></span>
            <p>Select a chat to start messaging</p>
        </div>

        <!-- Chat View -->
        <template v-else>
            <!-- Header -->
            <header class="h-16 bg-tg-sidebar flex items-center justify-between px-5 shrink-0 shadow-sm z-20 cursor-pointer border-b border-black/20" @click="viewProfile">
                <div class="flex items-center gap-4">
                    <button @click.stop="mobileView = 'sidebar'" class="md:hidden text-gray-400"><i class="fa-solid fa-arrow-left"></i></button>
                    <div class="flex items-center gap-3">
                        <img :src="activeChat.avatar || defaultAvatar" class="w-10 h-10 rounded-full object-cover">
                        <div>
                            <h3 class="font-bold text-[16px] text-white leading-tight">{{ activeChat.name }}</h3>
                            <p class="text-[13px] text-tg-blue font-medium">
                                {{ activeChat.type === 'group' ? activeChat.members.length + ' members' : (activeChat.online ? 'Online' : 'Last seen recently') }}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-6 text-gray-400">
                    <button v-if="activeChat.type !== 'group'" @click.stop="startCall" class="hover:text-tg-blue transition"><i class="fa-solid fa-phone text-lg"></i></button>
                    <button class="hover:text-tg-blue transition"><i class="fa-solid fa-ellipsis-vertical text-lg"></i></button>
                </div>
            </header>

            <!-- Messages -->
            <div ref="chatBox" class="flex-1 overflow-y-auto p-2 md:p-4 flex flex-col gap-1.5 scroll-smooth">
                <transition-group name="msg">
                    <div v-for="msg in activeMessages" :key="msg.id" 
                         class="flex flex-col max-w-[85%] md:max-w-[65%]" 
                         :class="msg.sender === 'me' ? 'self-end items-end' : 'self-start items-start', msg.type === 'system' ? 'self-center items-center max-w-full' : ''">
                        
                        <!-- System Message -->
                        <div v-if="msg.type === 'system'" class="bg-[#1c242d]/80 text-white text-xs px-3 py-1 rounded-full my-2 font-medium backdrop-blur-sm border border-white/5 shadow-sm">
                            {{ msg.content }}
                        </div>

                        <!-- Chat Bubble -->
                        <div v-else class="relative px-3 py-1.5 rounded-2xl shadow-[0_1px_2px_rgba(0,0,0,0.3)] text-[15.5px] leading-snug group"
                             :class="msg.sender === 'me' ? 'bg-tg-self text-white rounded-br-none' : 'bg-tg-in text-white rounded-bl-none'">
                            
                            <!-- Sender Name in Group -->
                            <div v-if="activeChat.type === 'group' && msg.sender !== 'me'" class="text-[11px] font-bold text-[#f5c44f] mb-0.5 cursor-pointer">
                                {{ msg.senderName || 'Unknown' }}
                            </div>

                            <!-- Media: Image -->
                            <div v-if="msg.type === 'image'" class="mb-1 rounded-lg overflow-hidden cursor-zoom-in" @click="zoomImg = msg.content">
                                <img :src="msg.content" class="max-w-full max-h-[350px] object-cover">
                            </div>
                            
                            <!-- Media: Video -->
                            <div v-if="msg.type === 'video'" class="mb-1 rounded-lg overflow-hidden">
                                <video :src="msg.content" controls class="max-w-full max-h-[350px]"></video>
                            </div>

                            <!-- Content: Voice -->
                            <div v-if="msg.type === 'voice'" class="flex items-center gap-3 pr-2 py-1 min-w-[220px]">
                                <button @click="playVoice(msg.id)" class="w-10 h-10 rounded-full bg-black/20 flex items-center justify-center flex-shrink-0 hover:bg-black/30 transition">
                                    <i class="fa-solid text-sm" :class="playingVoice === msg.id ? 'fa-pause' : 'fa-play'"></i>
                                </button>
                                <div class="flex flex-col flex-1 gap-1.5" :class="playingVoice === msg.id ? '' : 'paused'">
                                    <div class="flex items-center gap-0.5 h-5 opacity-80">
                                        <div class="wave-bar" style="animation-duration: 0.6s"></div>
                                        <div class="wave-bar" style="animation-duration: 0.8s"></div>
                                        <div class="wave-bar" style="animation-duration: 0.5s"></div>
                                        <div class="wave-bar" style="animation-duration: 0.7s"></div>
                                        <div class="wave-bar" style="animation-duration: 0.9s"></div>
                                        <div class="wave-bar" style="animation-duration: 0.6s"></div>
                                        <div class="wave-bar" style="animation-duration: 0.4s"></div>
                                        <div class="wave-bar" style="animation-duration: 0.8s"></div>
                                    </div>
                                    <span class="text-[11px] opacity-70 font-mono tracking-wide">Voice Message</span>
                                </div>
                                <audio :id="'aud-'+msg.id" :src="msg.content" @ended="playingVoice = null"></audio>
                            </div>

                            <!-- Content: Text -->
                            <div v-if="msg.type === 'text'" class="whitespace-pre-wrap break-words min-w-[20px]">{{ msg.content }}</div>

                            <!-- Meta (Time & Checks) -->
                            <div class="float-right ml-3 mt-1.5 flex items-center gap-1 text-[11px] opacity-60 select-none align-bottom h-full pt-1" :class="{'text-white': msg.sender === 'me'}">
                                <span>{{ formatTime(msg.timestamp) }}</span>
                                <span v-if="msg.sender === 'me'">
                                    <i v-if="msg.status === 'read'" class="fa-solid fa-check-double text-green-300"></i>
                                    <i v-else class="fa-solid fa-check"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </transition-group>
            </div>

            <!-- Footer -->
            <footer class="bg-tg-sidebar px-4 py-2 flex items-end gap-3 shrink-0 z-20 shadow-[0_-1px_10px_rgba(0,0,0,0.2)]">
                <div class="relative group">
                    <button @click="ui.showAttach = !ui.showAttach" class="w-10 h-10 text-gray-500 hover:text-tg-blue transition rounded-full hover:bg-[#242f3d]"><i class="fa-solid fa-paperclip text-xl"></i></button>
                    <!-- Attach Menu -->
                    <div v-if="ui.showAttach" class="absolute bottom-14 left-0 bg-[#242f3d] shadow-2xl rounded-xl p-2 w-52 flex flex-col gap-1 border border-black/20 animate-fade-in-up origin-bottom-left z-50">
                        <button @click="$refs.fileInput.click(); ui.showAttach=false" class="flex items-center gap-3 px-3 py-2.5 hover:bg-[#17212b] rounded-lg text-sm transition text-white">
                            <i class="fa-regular fa-image text-tg-blue w-5 text-lg"></i> Photo / Video
                        </button>
                    </div>
                    <input type="file" ref="fileInput" class="hidden" @change="handleFileSelect">
                </div>

                <div class="flex-1 bg-[#242f3d] rounded-[20px] flex items-end border border-transparent focus-within:border-tg-blue/50 transition relative">
                    <textarea 
                        v-model="inputMsg" 
                        @keydown.enter.prevent="sendMessage"
                        rows="1" 
                        placeholder="Message" 
                        class="w-full bg-transparent text-white text-[15px] px-4 py-2.5 outline-none resize-none max-h-32 placeholder-gray-500"
                    ></textarea>
                    
                    <button class="w-10 h-10 text-gray-500 hover:text-yellow-400 transition" @click="ui.showEmoji = !ui.showEmoji">
                        <i class="fa-regular fa-face-smile text-xl mb-1 block"></i>
                    </button>

                    <!-- Emoji Picker -->
                    <div v-if="ui.showEmoji" class="absolute bottom-12 right-0 z-50 shadow-2xl rounded-xl overflow-hidden border border-black/20 w-80">
                        <emoji-picker @emoji-click="onEmojiSelect" class="dark"></emoji-picker>
                    </div>
                </div>

                <div class="w-12 h-12 flex items-center justify-center">
                    <transition name="msg" mode="out-in">
                        <button v-if="inputMsg.trim()" @click="sendMessage" class="w-12 h-12 rounded-full bg-tg-self text-white hover:bg-[#6458ad] transition shadow-lg flex items-center justify-center transform hover:scale-105 active:scale-95">
                            <i class="fa-solid fa-paper-plane text-lg"></i>
                        </button>
                        <button v-else 
                            @mousedown="startRec" @mouseup="stopRec" @touchstart.prevent="startRec" @touchend.prevent="stopRec"
                            class="w-12 h-12 rounded-full hover:bg-[#242f3d] text-gray-400 hover:text-white transition flex items-center justify-center"
                            :class="{'bg-red-500 text-white animate-pulse hover:bg-red-600': isRecording}">
                            <i class="fa-solid text-xl" :class="isRecording ? 'fa-stop' : 'fa-microphone'"></i>
                        </button>
                    </transition>
                </div>
            </footer>
        </template>

        <!-- Recording Indicator -->
        <div v-if="isRecording" class="absolute bottom-24 left-1/2 -translate-x-1/2 bg-[#242f3d] text-white px-6 py-2 rounded-full shadow-2xl flex items-center gap-3 z-30 border border-white/10">
            <div class="w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse"></div>
            <span class="font-mono text-base font-medium">{{ recTime }}</span>
        </div>

        <!-- Call Overlay -->
        <div v-if="call.active || call.incoming" class="fixed inset-0 z-[100] bg-[#1a2025] flex flex-col items-center justify-center text-white font-sans">
             <!-- Blurry BG -->
            <div class="absolute inset-0 overflow-hidden opacity-30 blur-3xl">
                 <img :src="activeChat?.avatar || defaultAvatar" class="w-full h-full object-cover">
            </div>
            
            <div class="relative z-10 flex flex-col items-center w-full max-w-md">
                <div class="w-36 h-36 rounded-full overflow-hidden mb-6 border-4 border-white/5 shadow-2xl relative">
                     <div v-if="call.incoming" class="absolute inset-0 bg-tg-green opacity-30 animate-ping"></div>
                     <img :src="activeChat?.avatar || defaultAvatar" class="w-full h-full object-cover relative z-10">
                </div>
                <h2 class="text-3xl font-bold mb-2">{{ activeChat?.name }}</h2>
                <p class="text-gray-400 mb-20 text-lg font-medium">{{ call.statusText }}</p>

                <div class="flex gap-12 items-center">
                    <button v-if="call.incoming" @click="answerCall" class="w-20 h-20 bg-tg-green rounded-full flex items-center justify-center text-3xl shadow-lg hover:scale-110 transition">
                        <i class="fa-solid fa-phone"></i>
                    </button>
                    <button @click="endCall" class="w-20 h-20 bg-red-500 rounded-full flex items-center justify-center text-3xl shadow-lg hover:scale-110 transition rotate-[135deg]">
                        <i class="fa-solid fa-phone"></i>
                    </button>
                </div>
            </div>
            <audio ref="remoteAudio" autoplay class="hidden"></audio>
        </div>

        <!-- Add Contact Modal -->
        <div v-if="ui.showAddContact" class="fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4" @click.self="ui.showAddContact = false">
            <div class="bg-[#17212b] rounded-xl w-full max-w-sm p-6 shadow-2xl">
                <h3 class="text-white text-lg font-bold mb-4">Add Contact</h3>
                <input v-model="newContactId" placeholder="Paste User ID here" class="w-full bg-[#242f3d] p-3 rounded-lg text-white outline-none focus:ring-1 focus:ring-tg-blue mb-4 font-mono text-sm">
                <div class="flex justify-end gap-2">
                    <button @click="ui.showAddContact = false" class="text-gray-400 px-4 py-2 hover:text-white">Cancel</button>
                    <button @click="addContact" class="bg-tg-blue text-white px-6 py-2 rounded-lg font-bold hover:bg-[#2b83d6]">Add</button>
                </div>
            </div>
        </div>

        <!-- Create Group Modal -->
        <div v-if="ui.showCreateGroup" class="fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4" @click.self="ui.showCreateGroup = false">
            <div class="bg-[#17212b] rounded-xl w-full max-w-sm p-6 shadow-2xl">
                <h3 class="text-white text-lg font-bold mb-4">Create Group</h3>
                
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 bg-tg-blue rounded-full flex items-center justify-center text-white text-2xl cursor-pointer hover:opacity-80">
                        <i class="fa-solid fa-camera"></i>
                    </div>
                    <input v-model="newGroupName" placeholder="Group Name" class="flex-1 bg-[#242f3d] p-3 rounded-lg text-white outline-none focus:ring-1 focus:ring-tg-blue">
                </div>

                <label class="text-xs text-gray-500 uppercase font-bold mb-2 block">Add Members (IDs comma separated)</label>
                <textarea v-model="newGroupMembers" placeholder="id1, id2, id3..." class="w-full bg-[#242f3d] p-3 rounded-lg text-white outline-none focus:ring-1 focus:ring-tg-blue mb-4 font-mono text-sm h-24 resize-none"></textarea>
                
                <div class="flex justify-end gap-2">
                    <button @click="ui.showCreateGroup = false" class="text-gray-400 px-4 py-2 hover:text-white">Cancel</button>
                    <button @click="createGroup" class="bg-tg-blue text-white px-6 py-2 rounded-lg font-bold hover:bg-[#2b83d6]">Create</button>
                </div>
            </div>
        </div>

    </main>
</div>

<script>
    const { createApp, ref, reactive, onMounted, computed, watch, nextTick } = Vue;

    createApp({
        setup() {
            // --- STATE ---
            const ui = reactive({ showMenu: false, showAttach: false, showEmoji: false, showAddContact: false, showCreateGroup: false, viewProfile: false });
            const myPeerId = ref('');
            const isNetReady = ref(false);
            const mobileView = ref('sidebar');
            const inputMsg = ref('');
            const activeChatId = ref(null);
            const activeTab = ref('all');
            
            // Data Stores
            const chats = ref([]); // [{ id, name, avatar, messages: [], type: 'private'|'group', members: [] }]
            const user = reactive({ name: '', avatar: '', setupComplete: false });
            
            // Inputs
            const tempName = ref('');
            const tempAvatar = ref('');
            const newContactId = ref('');
            const newGroupName = ref('');
            const newGroupMembers = ref('');

            // Media
            const isRecording = ref(false);
            const recTime = ref('00:00');
            const playingVoice = ref(null);
            const call = reactive({ incoming: false, active: false, statusText: '', conn: null });

            // Core
            let peer = null;
            let connections = {}; // Map<peerId, DataConnection>
            let mediaRecorder = null;
            let chunks = [];
            let callObj = null;
            let localStream = null;
            let timerInt = null;

            const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
            const groupAvatar = "https://cdn-icons-png.flaticon.com/512/681/681494.png";

            // --- AUDIO ---
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const initAudioContext = () => { if(audioCtx.state === 'suspended') audioCtx.resume(); };
            
            const playSound = (type) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                
                if (type === 'sent') {
                    osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.05);
                    gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.05);
                } else if (type === 'in') {
                    osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.2);
                    gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.2);
                }
            };

            // --- LIFECYCLE ---
            onMounted(() => {
                const u = localStorage.getItem('tw6_user');
                if(u) Object.assign(user, JSON.parse(u));
                
                const c = localStorage.getItem('tw6_chats');
                if(c) chats.value = JSON.parse(c);
                
                if(user.setupComplete) initPeer();
            });

            watch(chats, (val) => localStorage.setItem('tw6_chats', JSON.stringify(val)), { deep: true });

            // --- PEER JS (UTF-8 FIX) ---
            const initPeer = () => {
                // Use Google STUN for better connectivity
                peer = new Peer(null, { 
                    config: { iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] },
                    debug: 1
                });
                
                peer.on('open', (id) => { myPeerId.value = id; isNetReady.value = true; });
                
                peer.on('connection', (c) => {
                    setupConn(c);
                });
                
                peer.on('call', (c) => handleIncomingCall(c));
            };

            const connectToId = (id) => {
                if(!id || connections[id]) return;
                // Force JSON serialization to fix Emoji encoding issues
                const c = peer.connect(id, { serialization: 'json' });
                setupConn(c);
            };

            const setupConn = (c) => {
                connections[c.peer] = c;
                
                c.on('open', () => {
                    // Send handshake
                    c.send({ type: 'handshake', payload: { name: user.name, avatar: user.avatar } });
                    // If we have a chat for this user, mark online
                    const chat = chats.value.find(ch => ch.id === c.peer);
                    if(chat) chat.online = true;
                });

                c.on('data', (data) => handleData(c.peer, data));
                
                c.on('close', () => {
                    delete connections[c.peer];
                    const chat = chats.value.find(ch => ch.id === c.peer);
                    if(chat) chat.online = false;
                });
            };

            const handleData = (peerId, data) => {
                // 1. Handshake
                if(data.type === 'handshake') {
                    let chat = chats.value.find(c => c.id === peerId);
                    if(!chat) {
                        // If handshake from unknown, create chat entry (Private)
                        chats.value.unshift({
                            id: peerId,
                            name: data.payload.name,
                            avatar: data.payload.avatar,
                            type: 'private',
                            messages: [],
                            online: true,
                            lastTimestamp: Date.now()
                        });
                    } else {
                        chat.online = true;
                        chat.name = data.payload.name;
                        chat.avatar = data.payload.avatar;
                    }
                } 
                // 2. Message
                else if (data.type === 'msg') {
                    // Handle Group logic: If msg has groupId, find that group
                    const targetId = data.groupId || peerId;
                    let chat = chats.value.find(c => c.id === targetId);
                    
                    if(chat) {
                        chat.messages.push({ ...data, sender: 'partner', status: 'read' });
                        chat.lastMessage = getMsgPreview(data);
                        chat.lastTimestamp = Date.now();
                        chat.lastSender = 'partner';
                        if(activeChatId.value === targetId) scrollToBottom();
                        playSound('in');
                    }
                }
                // 3. Call Signaling (Hangup)
                else if (data.type === 'hangup') {
                    endCall(false); // Don't send hangup back
                }
            };

            // --- MESSAGING ---
            const sendMessage = () => {
                if(!inputMsg.value.trim() || !activeChatId.value) return;
                
                const chat = activeChat.value;
                const msg = {
                    id: Date.now(),
                    type: 'text',
                    content: inputMsg.value,
                    timestamp: Date.now(),
                    senderName: user.name // For groups
                };

                dispatch(msg, chat);
                inputMsg.value = '';
                ui.showEmoji = false;
            };

            const dispatch = (msg, chat) => {
                if(chat.type === 'private') {
                    const conn = connections[chat.id];
                    if(conn && conn.open) conn.send({ ...msg, type: 'msg' });
                    else connectToId(chat.id); // Try reconnect
                } else {
                    // Group: Send to all members
                    chat.members.forEach(mid => {
                        const conn = connections[mid];
                        if(conn && conn.open) conn.send({ ...msg, type: 'msg', groupId: chat.id });
                    });
                }

                chat.messages.push({ ...msg, sender: 'me', status: 'sent' });
                chat.lastMessage = getMsgPreview(msg);
                chat.lastTimestamp = Date.now();
                chat.lastSender = 'me';
                playSound('sent');
                scrollToBottom();
            };

            // --- GROUPS & CONTACTS ---
            const addContact = () => {
                if(!newContactId.value) return;
                connectToId(newContactId.value);
                // Create skeleton chat
                if(!chats.value.find(c => c.id === newContactId.value)) {
                    chats.value.unshift({
                        id: newContactId.value,
                        name: 'User ' + newContactId.value.substr(0,4),
                        avatar: defaultAvatar,
                        type: 'private',
                        messages: [],
                        online: false,
                        lastTimestamp: Date.now()
                    });
                }
                ui.showAddContact = false;
                newContactId.value = '';
            };

            const createGroup = () => {
                if(!newGroupName.value) return;
                const groupId = 'group_' + Date.now();
                const members = newGroupMembers.value.split(',').map(s => s.trim()).filter(s => s);
                
                // Connect to all members
                members.forEach(mid => connectToId(mid));

                chats.value.unshift({
                    id: groupId,
                    name: newGroupName.value,
                    avatar: groupAvatar,
                    type: 'group',
                    members: members,
                    messages: [{ id: Date.now(), type: 'system', content: 'Group created' }],
                    lastTimestamp: Date.now()
                });

                ui.showCreateGroup = false;
                newGroupName.value = '';
                newGroupMembers.value = '';
            };

            // --- CALLS (FIXED) ---
            const startCall = async () => {
                if(!activeChatId.value || activeChat.value.type === 'group') return;
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const conn = connections[activeChatId.value];
                    if(!conn) return alert("User offline");
                    
                    callObj = peer.call(activeChatId.value, localStream);
                    call.active = true;
                    call.statusText = 'Calling...';
                    
                    setupCallEvents(callObj);
                } catch(e) { alert("Mic required"); }
            };

            const handleIncomingCall = (c) => {
                call.incoming = true;
                callObj = c;
                call.statusText = 'Incoming Call...';
            };

            const answerCall = async () => {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                callObj.answer(localStream);
                call.incoming = false;
                call.active = true;
                call.statusText = 'Connected';
                setupCallEvents(callObj);
            };

            const setupCallEvents = (c) => {
                c.on('stream', (remoteStream) => {
                    const aud = document.querySelector('audio.hidden');
                    if(aud) { aud.srcObject = remoteStream; aud.play(); }
                });
                c.on('close', () => endCall(false));
                c.on('error', () => endCall(false));
            };

            const endCall = (sendSignal = true) => {
                if(sendSignal && activeChatId.value && connections[activeChatId.value]) {
                    connections[activeChatId.value].send({ type: 'hangup' });
                }
                if(callObj) callObj.close();
                if(localStream) localStream.getTracks().forEach(t => t.stop());
                
                call.active = false;
                call.incoming = false;
                callObj = null;
            };

            // --- UTILS ---
            const handleFileSelect = (e) => {
                const f = e.target.files[0];
                if(!f) return;
                const r = new FileReader();
                r.onload = (ev) => {
                    const type = f.type.startsWith('video') ? 'video' : 'image';
                    dispatch({ id: Date.now(), type, content: ev.target.result, timestamp: Date.now() }, activeChat.value);
                };
                r.readAsDataURL(f);
            };
            
            const startRec = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    chunks = [];
                    isRecording.value = true;
                    let sec = 0;
                    timerInt = setInterval(() => {
                        sec++;
                        recTime.value = new Date(sec * 1000).toISOString().substr(14, 5);
                    }, 1000);
                    mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => dispatch({ id: Date.now(), type: 'voice', content: reader.result, timestamp: Date.now() }, activeChat.value);
                        stream.getTracks().forEach(t => t.stop());
                    };
                    mediaRecorder.start();
                } catch(e) { alert("Mic Error"); }
            };

            const stopRec = () => {
                if(mediaRecorder && isRecording.value) {
                    mediaRecorder.stop();
                    clearInterval(timerInt);
                    isRecording.value = false;
                    recTime.value = '00:00';
                }
            };
            
            const playVoice = (id) => {
                const aud = document.getElementById('aud-'+id);
                if(aud) {
                    if(playingVoice.value === id) { aud.pause(); playingVoice.value = null; }
                    else { 
                        document.querySelectorAll('audio').forEach(a => a.pause());
                        aud.play(); 
                        playingVoice.value = id; 
                    }
                }
            };

            const onEmojiSelect = (e) => inputMsg.value += e.detail.unicode;
            const onAvatarChange = (e) => {
                const f = e.target.files[0];
                if(f) { const r = new FileReader(); r.onload = (ev) => tempAvatar.value = ev.target.result; r.readAsDataURL(f); }
            };
            const finishSetup = () => {
                user.name = tempName.value; user.avatar = tempAvatar.value; user.setupComplete = true;
                localStorage.setItem('tw6_user', JSON.stringify(user));
                initPeer();
            };
            const copyId = () => navigator.clipboard.writeText(myPeerId.value);
            const formatTime = (ts) => new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const getMsgPreview = (m) => {
                if(m.type === 'image') return 'Photo';
                if(m.type === 'video') return 'Video';
                if(m.type === 'voice') return 'Voice Message';
                return m.content;
            };
            const openChat = (id) => { activeChatId.value = id; mobileView.value = 'chat'; scrollToBottom(); };
            const scrollToBottom = () => nextTick(() => { const el = document.querySelector('div[class*="overflow-y-auto"]'); if(el) el.scrollTop = el.scrollHeight; });

            // Computed
            const activeChat = computed(() => chats.value.find(c => c.id === activeChatId.value));
            const activeMessages = computed(() => activeChat.value ? activeChat.value.messages : []);
            const filteredChats = computed(() => {
                if(activeTab.value === 'groups') return chats.value.filter(c => c.type === 'group');
                return chats.value;
            });

            return {
                ui, user, chats, activeChat, activeMessages, filteredChats, activeChatId, activeTab,
                myPeerId, isNetReady, mobileView, inputMsg,
                tempName, tempAvatar, newContactId, newGroupName, newGroupMembers,
                defaultAvatar, groupAvatar,
                isRecording, recTime, playingVoice, call,
                handleFileSelect, startRec, stopRec, playVoice, onEmojiSelect,
                finishSetup, onAvatarChange, copyId, formatTime, openChat, sendMessage,
                addContact, createGroup,
                startCall, answerCall, endCall, initAudioContext
            };
        }
    }).mount('#app');
</script>
</body>
</html>
