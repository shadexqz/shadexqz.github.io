<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHAKAL GENERATOR 720p</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: #ff00ff;
            font-family: 'Impact', sans-serif;
            text-align: center;
            padding: 20px;
        }
        .main-card {
            background: #000;
            border: 5px solid #0f0;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 10px 10px 0px #f00;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
            text-align: left;
            background: #222;
            padding: 15px;
        }
        label { color: #0ff; display: block; margin-bottom: 5px; }
        input[type="range"] { width: 100%; cursor: pointer; }
        
        button {
            background: #f00;
            color: #fff;
            font-size: 24px;
            padding: 15px;
            border: none;
            cursor: pointer;
            width: 100%;
            transition: 0.2s;
        }
        button:hover { transform: scale(1.02); background: #fff; color: #000; }
        button:disabled { background: #555; cursor: wait; }

        video {
            width: 100%;
            max-width: 1280px;
            margin-top: 20px;
            border: 2px solid #fff;
            image-rendering: pixelated; /* Критично для мемного вида */
        }
        .status { color: #ffff00; font-size: 18px; margin: 10px 0; }
    </style>
</head>
<body>

    <div class="main-card">
        <h1>SHAKALIZATOR 3000 (720p Edition)</h1>
        
        <input type="file" id="videoInput" accept="video/*">
        
        <div class="controls">
            <div>
                <label>УРОВЕНЬ ПИКСЕЛИЗАЦИИ (ШАКАЛЬНОСТЬ):</label>
                <input type="range" id="shakalRange" min="5" max="40" value="15">
            </div>
            <div>
                <label>EARRAPE (ПЕРЕГРУЗ ЗВУКА):</label>
                <input type="range" id="earrapeRange" min="1" max="20" value="5" step="0.5">
            </div>
        </div>

        <button id="startBtn">УШАТАТЬ В КАШУ</button>
        <div id="status" class="status">Выбери видео, чтобы начать...</div>

        <div id="resultArea" style="display:none;">
            <h2 style="color: #0f0;">ШЕДЕВР ГОТОВ:</h2>
            <video id="preview" controls></video>
            <br><br>
            <a id="downloadBtn" href="#" download="shakal_meme.mp4" style="color: yellow; font-size: 24px;">СКАЧАТЬ MP4</a>
        </div>
    </div>

    <!-- Невидимые холсты для обработки -->
    <canvas id="offscreen" style="display:none;"></canvas>
    <canvas id="onscreen" width="1280" height="720" style="display:none;"></canvas>

    <script>
        const videoInput = document.getElementById('videoInput');
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const shakalRange = document.getElementById('shakalRange');
        const earrapeRange = document.getElementById('earrapeRange');
        const preview = document.getElementById('preview');
        const resultArea = document.getElementById('resultArea');
        const downloadBtn = document.getElementById('downloadBtn');

        const offCanvas = document.getElementById('offscreen');
        const onCanvas = document.getElementById('onscreen');
        const offCtx = offCanvas.getContext('2d');
        const onCtx = onCanvas.getContext('2d');

        startBtn.onclick = async () => {
            const file = videoInput.files[0];
            if (!file) return alert("Где видос?");

            startBtn.disabled = true;
            status.innerText = "Идет процесс уничтожения... Не закрывай вкладку!";

            const videoUrl = URL.createObjectURL(file);
            const v = document.createElement('video');
            v.src = videoUrl;
            v.crossOrigin = "anonymous";
            await v.play();

            // Настройка размеров: 
            // Мы берем маленькое разрешение и растягиваем его до 720p
            const scaleDown = parseInt(shakalRange.value);
            const lowWidth = Math.floor(1280 / scaleDown);
            const lowHeight = Math.floor(720 / scaleDown);
            offCanvas.width = lowWidth;
            offCanvas.height = lowHeight;

            // Настройка аудио (Earrape)
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioCtx.createMediaElementSource(v);
            
            const distortion = audioCtx.createWaveShaper();
            distortion.curve = (function(amount) {
                let k = amount * 10, n = 44100, curve = new Float32Array(n), i = 0, x;
                for ( ; i < n; ++i ) {
                    x = i * 2 / n - 1;
                    curve[i] = (3 + k) * x * 20 * (Math.PI / 180) / (Math.PI + k * Math.abs(x));
                }
                return curve;
            })(parseFloat(earrapeRange.value));

            const gainNode = audioCtx.createGain();
            gainNode.gain.value = parseFloat(earrapeRange.value);

            const dest = audioCtx.createMediaStreamDestination();
            source.connect(distortion);
            distortion.connect(gainNode);
            gainNode.connect(dest);

            // Подготовка записи
            const vStream = onCanvas.captureStream(15); // 15 FPS для мемности
            const combined = new MediaStream([
                vStream.getVideoTracks()[0],
                dest.stream.getAudioTracks()[0]
            ]);

            // Пытаемся сохранить в mp4, если нет - в webm
            let mimeType = 'video/mp4;codecs=avc1,mp4a.40.2';
            if (!MediaRecorder.isTypeSupported(mimeType)) {
                mimeType = 'video/webm;codecs=vp8,opus';
                downloadBtn.download = "shakal_meme.webm";
                downloadBtn.innerText = "СКАЧАТЬ WEBM (MP4 не поддержан)";
            }

            const recorder = new MediaRecorder(combined, {
                mimeType: mimeType,
                videoBitsPerSecond: 100000, // Очень низкий битрейт для артефактов
                audioBitsPerSecond: 8000
            });

            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: mimeType });
                const url = URL.createObjectURL(blob);
                preview.src = url;
                downloadBtn.href = url;
                resultArea.style.display = 'block';
                status.innerText = "ГОТОВО!";
                startBtn.disabled = false;
                audioCtx.close();
            };

            recorder.start();

            // Цикл рендеринга "Шакалов"
            function draw() {
                if (!v.paused && !v.ended) {
                    // 1. Рисуем в маленьком размере на невидимый холст
                    offCtx.drawImage(v, 0, 0, lowWidth, lowHeight);
                    
                    // 2. Растягиваем до 720p на основной холст (без сглаживания)
                    onCtx.imageSmoothingEnabled = false;
                    onCtx.drawImage(offCanvas, 0, 0, lowWidth, lowHeight, 0, 0, 1280, 720);
                    
                    requestAnimationFrame(draw);
                } else {
                    recorder.stop();
                }
            }
            draw();
        };
    </script>
</body>
</html>
