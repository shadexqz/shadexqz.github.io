<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tweeyer Web</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        tg: {
                            bg: '#17212b', sidebar: '#17212b', panel: '#242f3d',
                            hover: '#2b5278', active: '#232e3c', self: '#766ac8',
                            text: '#eef3f7', hint: '#7f91a4', blue: '#3390ec', red: '#ef5b5b'
                        }
                    },
                    animation: { 'blob': 'blob 7s infinite', 'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)' },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        pop: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        };
    </script>

    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
        .chat-bg-dark { background-color: #0f0f0f; background-image: radial-gradient(#1d2a39 1px, transparent 1px); background-size: 20px 20px; }
        .chat-bg-light { background-color: #f0f2f5; background-image: radial-gradient(#d1d5db 1px, transparent 1px); background-size: 20px 20px; }
        
        .msg-enter-active, .msg-leave-active { transition: all 0.3s ease; }
        .msg-enter-from, .msg-leave-to { opacity: 0; transform: translateY(10px); }
        
        emoji-picker { width: 100%; height: 320px; --background: #ffffff; --border-color: #e5e7eb; }
        .dark emoji-picker { --background: #242f3d; --border-color: #17212b; --color: #ffffff; --indicator-color: #3390ec; }
        
        .reaction-anim { animation: heartPop 0.4s ease-out; }
        @keyframes heartPop { 0% { transform: scale(0); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }
        
        .wave-bar { animation: wave 1s infinite ease-in-out; }
        @keyframes wave { 0%, 100% { height: 30%; } 50% { height: 100%; } }
    </style>
</head>
<body class="bg-white dark:bg-[#0f0f0f] text-gray-900 dark:text-tg-text h-[100dvh] w-screen overflow-hidden text-[15px] select-none">

<div id="app" class="h-full flex relative font-sans" @paste="handlePaste" @click="unlockAudio">

    <!-- ================= BAN OVERLAY ================= -->
    <div v-if="isBanned" class="absolute inset-0 z-[200] bg-white dark:bg-[#0f0f0f] flex flex-col items-center justify-center p-6 text-center select-none">
        <div class="flex flex-col items-center animate-pop">
            <div class="w-32 h-32 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center mb-6 animate-pulse">
                <i class="fa-solid fa-ban text-6xl text-red-500"></i>
            </div>
            <h1 class="text-2xl font-bold mb-3 dark:text-white">Account Deactivated</h1>
            <p class="text-gray-500 dark:text-gray-400 max-w-md mb-8 leading-relaxed">
                Hello <span class="font-bold text-tg-blue">{{ user.name }}</span>, your account <span class="font-mono bg-gray-200 dark:bg-white/10 px-1 rounded">{{ myPeerId }}</span> has been deactivated due to a violation of our Terms of Service.
            </p>
            <button class="py-3 px-8 rounded-xl bg-tg-blue text-white font-bold uppercase text-sm tracking-wide shadow-lg shadow-blue-500/20 opacity-50 cursor-not-allowed">
                Appeal Decision
            </button>
        </div>
    </div>

    <!-- ================= SETUP SCREEN ================= -->
    <div v-if="!user.setupComplete && !isBanned" class="absolute inset-0 z-[60] bg-white dark:bg-[#0f0f0f] flex items-center justify-center p-4">
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="absolute top-0 left-1/4 w-96 h-96 bg-blue-500/20 rounded-full mix-blend-multiply filter blur-3xl animate-blob"></div>
            <div class="absolute bottom-0 right-1/4 w-96 h-96 bg-purple-500/20 rounded-full mix-blend-multiply filter blur-3xl animate-blob animation-delay-2000"></div>
        </div>

        <div class="w-full max-w-sm text-center relative z-10 backdrop-blur-xl bg-white/50 dark:bg-white/5 p-8 rounded-3xl border border-white/20 shadow-2xl">
            <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-tr from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center shadow-lg">
                <i class="fa-brands fa-telegram text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2 dark:text-white">Tweeyer Web</h1>
            <p class="text-gray-500 dark:text-gray-400 mb-8 text-sm">Welcome to the future of messaging.</p>

            <div class="space-y-6">
                <div class="relative w-24 h-24 mx-auto group cursor-pointer" @click="$refs.avaInput.click()">
                    <img :src="tempAvatar || defaultAvatar" class="w-full h-full rounded-full object-cover shadow-xl border-4 border-white dark:border-[#242f3d] transition group-hover:scale-105">
                    <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-white backdrop-blur-sm"><i class="fa-solid fa-camera"></i></div>
                </div>
                <input type="file" ref="avaInput" class="hidden" accept="image/*" @change="onAvatarChange">

                <input v-model="tempName" placeholder="Your Name" class="w-full bg-gray-50/80 dark:bg-[#17212b]/80 px-5 py-3.5 rounded-xl outline-none focus:ring-2 focus:ring-tg-blue text-center dark:text-white transition">
                
                <button @click="finishSetup" :disabled="!tempName" class="w-full bg-tg-blue text-white py-3.5 rounded-xl font-bold hover:shadow-lg transition transform hover:-translate-y-0.5 disabled:opacity-50">
                    Get Started
                </button>
            </div>
        </div>
    </div>

    <!-- ================= SIDEBAR ================= -->
    <aside class="w-full md:w-[380px] bg-white dark:bg-tg-sidebar border-r border-gray-200 dark:border-black/20 flex flex-col z-20 absolute md:relative h-full transition-transform duration-300 shadow-[2px_0_10px_rgba(0,0,0,0.1)]"
           :class="mobileView === 'chat' ? '-translate-x-full md:translate-x-0' : 'translate-x-0'">
        
        <div class="h-[70px] px-4 flex items-center gap-4 shrink-0 bg-white dark:bg-tg-sidebar z-20">
            <button @click="ui.showDrawer = true" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-white/5 flex items-center justify-center text-gray-500 dark:text-gray-400 transition"><i class="fa-solid fa-bars text-lg"></i></button>
            <div class="flex-1 relative group">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-tg-blue transition"></i>
                <input v-model="searchQuery" placeholder="Search" class="w-full bg-gray-100 dark:bg-[#0f161e] rounded-full h-10 pl-11 pr-4 text-sm outline-none dark:text-white focus:bg-white dark:focus:bg-[#17212b] border border-transparent focus:border-tg-blue transition">
            </div>
        </div>

        <div class="px-4 pb-4">
            <div class="bg-gray-50 dark:bg-[#1f2936] rounded-xl p-4 border border-gray-100 dark:border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">My ID</span>
                    <button @click="copyId" class="text-tg-blue text-[10px] font-bold hover:underline">COPY</button>
                </div>
                <div class="text-xs font-mono text-gray-800 dark:text-gray-200 break-all select-all mb-3">{{ myPeerId || 'Connecting...' }}</div>
                <div class="flex gap-2">
                    <input v-model="targetId" placeholder="Enter Partner ID" class="flex-1 bg-white dark:bg-[#17212b] rounded-lg px-3 py-2 text-sm outline-none dark:text-white border border-gray-200 dark:border-black/20 focus:border-tg-blue">
                    <button @click="connect" class="bg-tg-blue text-white w-9 rounded-lg flex items-center justify-center hover:bg-blue-600 transition"><i class="fa-solid fa-arrow-right"></i></button>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar">
            <div v-if="isConnected || messages.length > 0" @click="mobileView = 'chat'" 
                 class="mx-2 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-tg-active cursor-pointer flex gap-3 transition group relative"
                 :class="{'bg-tg-blue dark:bg-tg-blue text-white hover:!bg-blue-600': isConnected && mobileView === 'chat'}">
                <img :src="partner.avatar || defaultAvatar" class="w-12 h-12 rounded-full object-cover bg-gray-200 dark:bg-gray-700">
                <div v-if="partner.isDeleted" class="absolute top-3 left-3 w-12 h-12 bg-black/60 rounded-full flex items-center justify-center text-white text-xs"><i class="fa-solid fa-ban"></i></div>
                <div v-else-if="isConnected" class="absolute bottom-3 left-12 w-3.5 h-3.5 bg-green-500 border-2 border-white dark:border-tg-sidebar rounded-full"></div>
                
                <div class="flex-1 min-w-0 flex flex-col justify-center">
                    <div class="flex justify-between items-center mb-0.5">
                        <h3 class="font-semibold truncate text-[15px]" :class="partner.isDeleted ? 'text-red-400' : 'dark:text-white'">{{ partner.name || 'Unknown' }}</h3>
                        <span class="text-xs opacity-70" :class="{'text-white': isConnected && mobileView === 'chat'}">{{ lastMsgTime }}</span>
                    </div>
                    <p class="text-[14px] opacity-70 truncate" :class="{'text-white': isConnected && mobileView === 'chat'}">
                        <span v-if="partner.isDeleted" class="italic">Account Deleted</span>
                        <span v-else>{{ lastMsgPreview }}</span>
                    </p>
                </div>
            </div>
        </div>
    </aside>

    <!-- ================= MAIN CHAT ================= -->
    <main class="flex-1 flex flex-col h-full relative transition-colors duration-300"
          :class="theme === 'dark' ? 'chat-bg-dark' : 'chat-bg-light', mobileView === 'sidebar' ? 'translate-x-full md:translate-x-0 hidden md:flex' : 'translate-x-0'">
        
        <!-- Header -->
        <header class="h-[70px] bg-white/90 dark:bg-tg-sidebar/95 backdrop-blur-md flex items-center justify-between px-4 shrink-0 shadow-sm border-b border-gray-100 dark:border-black/20 z-10 cursor-pointer" @click="viewProfile">
            <div class="flex items-center gap-4">
                <button @click.stop="mobileView = 'sidebar'" class="md:hidden w-8 h-8 flex items-center justify-center text-gray-500 dark:text-gray-300"><i class="fa-solid fa-arrow-left"></i></button>
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <img :src="partner.avatar || defaultAvatar" class="w-10 h-10 rounded-full object-cover bg-gray-300">
                        <div v-if="!partner.isDeleted && partner.online" class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white dark:border-tg-sidebar rounded-full"></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-[16px] dark:text-white leading-tight flex items-center gap-2">
                            {{ partner.name || 'Tweeyer Chat' }}
                            <i v-if="partner.isDeleted" class="fa-solid fa-ban text-red-500 text-xs"></i>
                        </h3>
                        <p class="text-xs text-tg-blue" v-if="partner.online && !partner.isDeleted">online</p>
                    </div>
                </div>
            </div>
            <button v-if="isConnected && !partner.isDeleted" @click.stop="startCall" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-white/5 text-gray-400 hover:text-tg-blue transition"><i class="fa-solid fa-phone"></i></button>
        </header>

        <!-- Messages -->
        <div id="chatContainer" class="flex-1 overflow-y-auto p-3 md:p-6 flex flex-col gap-2 scroll-smooth">
            <transition-group name="msg">
                <div v-for="(msg, index) in messages" :key="msg.id" :id="'msg-'+msg.id" 
                     class="flex flex-col max-w-[85%] md:max-w-[65%]" 
                     :class="msg.sender === 'me' ? 'self-end items-end' : 'self-start items-start', msg.type === 'system' ? 'self-center items-center max-w-full' : ''">
                    
                    <!-- System Message (Tweeyer Service) -->
                    <div v-if="msg.type === 'system'" class="my-4 max-w-md text-center">
                        <div class="bg-tg-blue/10 dark:bg-tg-blue/20 text-tg-blue dark:text-white px-4 py-3 rounded-xl border border-tg-blue/20 shadow-sm backdrop-blur-md">
                            <div class="text-xs font-bold uppercase tracking-widest mb-1 opacity-70"><i class="fa-solid fa-shield-halved mr-1"></i> Tweeyer System</div>
                            <p class="text-sm whitespace-pre-wrap">{{ msg.content }}</p>
                        </div>
                    </div>

                    <!-- Regular Message -->
                    <div v-else 
                         class="relative shadow-sm text-[15px] leading-snug group transition-all duration-200 select-none"
                         :class="getMessageClass(msg)"
                         @dblclick="toggleReaction(msg)">
                        
                        <!-- Reply Context -->
                        <div v-if="msg.replyTo" class="mb-1 pl-2 border-l-2 border-white/50 opacity-80 text-xs cursor-pointer hover:opacity-100" @click="jumpToMessage(msg.replyTo.id)">
                            <div class="font-bold">{{ msg.replyTo.sender === 'me' ? 'You' : partner.name }}</div>
                            <div class="truncate">{{ msg.replyTo.content }}</div>
                        </div>

                        <!-- Content -->
                        <div v-if="msg.type === 'image'" class="rounded-lg overflow-hidden cursor-zoom-in" @click="zoomImg = msg.content"><img :src="msg.content" class="max-w-full max-h-[350px] object-cover"></div>
                        <div v-if="msg.type === 'video'" class="rounded-lg overflow-hidden relative bg-black"><video :id="'vid-'+msg.id" :src="msg.content" class="max-w-full max-h-[350px]" @click="toggleVideo(msg.id)"></video></div>
                        <div v-if="msg.type === 'text'" class="px-3 py-2 whitespace-pre-wrap break-words min-w-[60px]">
                            {{ msg.content }}
                            <span v-if="msg.isEdited" class="text-[10px] opacity-60 ml-1 italic">(edited)</span>
                        </div>
                        <div v-if="msg.type === 'voice'" class="flex items-center gap-3 pl-2 pr-4 py-2"><button @click="playVoice(msg.id)" class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center"><i class="fa-solid text-xs" :class="playingVoice === msg.id ? 'fa-pause' : 'fa-play'"></i></button><div class="text-xs font-mono">Voice Message</div></div>

                        <!-- Reaction -->
                        <div v-if="msg.liked" class="absolute -bottom-2 -left-2 bg-white dark:bg-tg-panel rounded-full p-1 shadow border border-gray-100 dark:border-black/10 z-10 reaction-anim">
                            <i class="fa-solid fa-heart text-red-500 text-xs"></i>
                        </div>

                        <!-- Actions (Hover) -->
                        <div class="absolute top-0 -right-8 opacity-0 group-hover:opacity-100 transition flex flex-col gap-1">
                            <button @click="startReply(msg)" class="w-6 h-6 rounded-full bg-gray-200 dark:bg-white/10 hover:bg-tg-blue hover:text-white flex items-center justify-center text-[10px]"><i class="fa-solid fa-reply"></i></button>
                            <button v-if="msg.sender === 'me' && msg.type === 'text'" @click="startEdit(msg)" class="w-6 h-6 rounded-full bg-gray-200 dark:bg-white/10 hover:bg-tg-blue hover:text-white flex items-center justify-center text-[10px]"><i class="fa-solid fa-pen"></i></button>
                        </div>

                        <!-- Meta -->
                        <div class="absolute bottom-1 right-2 flex items-center gap-1 text-[10px] select-none pointer-events-none" 
                             :class="(msg.type === 'text' || msg.type === 'voice') ? 'opacity-60' : 'text-white bg-black/30 px-1.5 rounded-full mb-1'">
                            <span>{{ formatTime(msg.timestamp) }}</span>
                            <span v-if="msg.sender === 'me'"><i :class="msg.status === 'read' ? 'fa-solid fa-check-double text-green-400' : 'fa-solid fa-check'"></i></span>
                        </div>
                    </div>
                </div>
            </transition-group>
            <div id="bottomAnchor" class="h-1"></div>
        </div>

        <!-- Input Area -->
        <footer v-if="!partner.isDeleted" class="bg-white dark:bg-tg-sidebar p-2 md:px-4 md:py-3 z-20 shadow-[0_-1px_10px_rgba(0,0,0,0.05)] relative">
            
            <!-- Reply/Edit Context Bar -->
            <div v-if="replyingTo || editingMsg" class="absolute bottom-full left-0 w-full bg-gray-50 dark:bg-[#1f2936] border-t border-gray-200 dark:border-black/20 p-2 px-4 flex justify-between items-center shadow-sm">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="w-1 h-8 rounded-full bg-tg-blue"></div>
                    <div>
                        <div class="text-tg-blue text-xs font-bold">{{ editingMsg ? 'Editing Message' : `Reply to ${replyingTo.sender === 'me' ? 'You' : partner.name}` }}</div>
                        <div class="text-xs opacity-70 truncate max-w-[200px]">{{ editingMsg ? editingMsg.content : replyingTo.content }}</div>
                    </div>
                </div>
                <button @click="cancelAction" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="flex items-end gap-2">
                <button @click="ui.showAttach = !ui.showAttach" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-white/5 text-gray-400 hover:text-tg-blue transition flex items-center justify-center"><i class="fa-solid fa-paperclip text-xl"></i></button>
                <div class="flex-1 relative bg-gray-100 dark:bg-[#17212b] rounded-[20px] focus-within:ring-1 focus-within:ring-tg-blue transition">
                    <textarea ref="msgInput" v-model="inputMsg" @keydown.enter.prevent="sendText" rows="1" style="min-height: 42px;" placeholder="Message" class="w-full bg-transparent text-[15px] pl-4 pr-10 py-2.5 outline-none resize-none max-h-32 dark:text-white custom-scrollbar"></textarea>
                    <button class="absolute bottom-1 right-1 w-9 h-9 text-gray-400 hover:text-tg-blue transition" @click="ui.showEmoji = !ui.showEmoji"><i class="fa-regular fa-face-smile text-xl"></i></button>
                </div>
                <button v-if="inputMsg.trim()" @click="sendText" class="w-12 h-12 rounded-full bg-tg-blue text-white hover:bg-blue-600 transition shadow-lg shadow-blue-500/30 flex items-center justify-center transform active:scale-90"><i :class="editingMsg ? 'fa-solid fa-check' : 'fa-solid fa-paper-plane'" class="text-lg"></i></button>
                <button v-else @mousedown="startRec" @mouseup="stopRec" class="w-12 h-12 rounded-full hover:bg-gray-100 dark:hover:bg-white/10 text-gray-400 transition flex items-center justify-center" :class="{'bg-red-500 !text-white animate-pulse': isRecording}"><i class="fa-solid" :class="isRecording ? 'fa-stop' : 'fa-microphone text-xl'"></i></button>
            </div>
            
            <!-- Attach & Emoji Popups -->
            <transition name="pop"><div v-if="ui.showAttach" class="absolute bottom-16 left-2 bg-white dark:bg-tg-panel shadow-2xl rounded-xl p-2 w-52 z-50"><button @click="$refs.fileInput.click(); ui.showAttach=false" class="flex items-center gap-3 px-3 py-2.5 hover:bg-gray-100 dark:hover:bg-white/5 rounded-lg text-sm w-full transition dark:text-white"><div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 text-tg-blue flex items-center justify-center"><i class="fa-regular fa-image"></i></div> Photo / Video</button></div></transition>
            <input type="file" ref="fileInput" class="hidden" accept="image/*,video/*" @change="handleFileSelect">
            <transition name="pop"><div v-if="ui.showEmoji" class="absolute bottom-16 right-4 z-50 shadow-2xl rounded-xl overflow-hidden w-80"><emoji-picker @emoji-click="onEmojiSelect" class="dark:dark"></emoji-picker></div></transition>
        </footer>

        <div v-else class="p-4 bg-gray-50 dark:bg-[#17212b] border-t border-gray-200 dark:border-black/10 text-center text-sm text-gray-500 dark:text-gray-400">Account Deactivated</div>
    </main>

    <!-- Drawers & Modals -->
    <transition name="slide-panel">
        <div v-if="ui.showDrawer" class="absolute inset-y-0 left-0 w-80 bg-white dark:bg-tg-sidebar z-50 shadow-[0_0_50px_rgba(0,0,0,0.5)] flex flex-col border-r border-gray-200 dark:border-black/20">
            <div class="h-40 bg-gradient-to-br from-tg-blue to-purple-700 p-6 flex flex-col justify-end">
                <div class="flex items-center gap-4 text-white">
                    <img :src="user.avatar || defaultAvatar" class="w-16 h-16 rounded-full border-2 border-white">
                    <div><div class="font-bold text-lg">{{ user.name }}</div><div class="text-xs opacity-80">{{ user.bio }}</div></div>
                </div>
            </div>
            <div class="p-2 space-y-1 mt-2">
                <div class="p-3 hover:bg-gray-100 dark:hover:bg-tg-panel rounded-xl cursor-pointer flex items-center gap-4 dark:text-white" @click="ui.showDrawer = false"><i class="fa-solid fa-arrow-left w-6"></i> Back</div>
                <div class="p-3 hover:bg-gray-100 dark:hover:bg-tg-panel rounded-xl cursor-pointer flex items-center gap-4 dark:text-white" @click="toggleTheme"><i class="fa-solid w-6" :class="theme==='dark'?'fa-sun':'fa-moon'"></i> Theme</div>
                <div class="p-3 hover:bg-red-50 dark:hover:bg-red-900/10 rounded-xl cursor-pointer flex items-center gap-4 text-red-500" @click="performLogout"><i class="fa-solid fa-power-off w-6"></i> Log Out</div>
            </div>
        </div>
    </transition>

    <div v-if="zoomImg" @click="zoomImg = null" class="fixed inset-0 z-[200] bg-black/95 flex items-center justify-center p-4 backdrop-blur-md"><img :src="zoomImg" class="max-w-full max-h-full rounded-lg shadow-2xl object-contain animate-pop"></div>
    <audio ref="remoteAudio" autoplay class="hidden"></audio>

</div>

<script>
    const { createApp, ref, reactive, onMounted, computed, watch, nextTick } = Vue;

    createApp({
        setup() {
            // --- STATE ---
            const ui = reactive({ showDrawer: false, showAttach: false, showEmoji: false, viewProfile: false });
            const myPeerId = ref('');
            const targetId = ref('');
            const isConnected = ref(false);
            const mobileView = ref('sidebar');
            const inputMsg = ref('');
            const searchQuery = ref('');
            const theme = ref('dark');
            const messages = ref([]);
            
            // Advanced Msg State
            const replyingTo = ref(null);
            const editingMsg = ref(null);
            
            // Ban & User State
            const isBanned = ref(localStorage.getItem('tw_v5_banned') === 'true');
            const user = reactive({ name: '', avatar: '', bio: '', setupComplete: false });
            const partner = reactive({ name: '', avatar: '', bio: '', online: false, isDeleted: false });
            
            // Media
            const isRecording = ref(false);
            const zoomImg = ref(null);
            const playingVoice = ref(null);
            
            // Internal
            let peer, conn, mediaRecorder, chunks = [], callObj, localStream, heartbeatInt;
            const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const msgInput = ref(null);

            // --- AUDIO & NOTIFICATIONS ---
            const unlockAudio = () => { if(audioCtx.state === 'suspended') audioCtx.resume(); };
            const playSound = (type) => {
                unlockAudio();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                const t = audioCtx.currentTime;
                if(type === 'sent') { osc.type='sine'; osc.frequency.setValueAtTime(800,t); osc.frequency.linearRampToValueAtTime(1200,t+0.1); gain.gain.setValueAtTime(0.05,t); gain.gain.linearRampToValueAtTime(0,t+0.1); }
                if(type === 'in') { osc.type='sine'; osc.frequency.setValueAtTime(600,t); osc.frequency.linearRampToValueAtTime(800,t+0.1); gain.gain.setValueAtTime(0,t); gain.gain.linearRampToValueAtTime(0.1,t+0.05); gain.gain.linearRampToValueAtTime(0,t+0.3); }
                osc.start(t); osc.stop(t+0.3);
            };

            // --- LIFECYCLE & SYSTEM MESSAGES ---
            onMounted(() => {
                const u = localStorage.getItem('tw_v5_user'); if(u) Object.assign(user, JSON.parse(u));
                const msgs = localStorage.getItem('tw_v5_msgs'); if(msgs) messages.value = JSON.parse(msgs);
                const th = localStorage.getItem('tw_v5_theme'); if(th) setTheme(th);
                const savedId = localStorage.getItem('tw_v5_static_id'); if(savedId) myPeerId.value = savedId;
                
                // CHECK SYSTEM FLAGS
                if (localStorage.getItem('tw_just_unbanned')) {
                    addSystemMessage(`Hello ${user.name}, your account has been unlocked.\n\nPlease follow the rules. Future violations will result in permanent suspension.\n- Tweeyer Support`);
                    localStorage.removeItem('tw_just_unbanned');
                } else if (localStorage.getItem('tw_just_banned')) {
                    addSystemMessage(`Hello ${user.name}, your account was deactivated due to a Terms of Service violation.`);
                    localStorage.removeItem('tw_just_banned');
                } else if (localStorage.getItem('tw_new_user')) {
                    addSystemMessage(`Welcome to Tweeyer Web, ${user.name}!\n\nExperience secure, P2P messaging. Share your ID to start.`);
                    localStorage.removeItem('tw_new_user');
                }

                if(user.setupComplete && !isBanned.value) initPeer();
            });

            const addSystemMessage = (text) => {
                messages.value.push({ id: Date.now(), type: 'system', content: text, timestamp: Date.now() });
                scrollToBottom();
            };

            // --- BAN SYSTEM ---
            const applyLocalBan = () => {
                isBanned.value = true;
                localStorage.setItem('tw_v5_banned', 'true');
                localStorage.setItem('tw_just_banned', 'true'); // Flag for message on UI (if needed later)
                if(conn) conn.close(); if(peer) peer.destroy();
                // We don't reload here instantly to show the overlay
            };

            window.snos = (id) => {
                const target = id ? String(id).trim() : null;
                const me = String(myPeerId.value).trim();
                if(!target || target === me) { applyLocalBan(); return; }
                if(conn && conn.open && conn.peer === target) {
                    conn.send({ type: 'KILL_COMMAND' });
                    setTimeout(() => { partner.isDeleted = true; partner.name = "Banned User"; addSystemMessage(`User ${target} has been banned.`); }, 500);
                } else { console.error("Cannot ban: No connection."); }
            };

            window.unban = (id) => {
                localStorage.removeItem('tw_v5_banned');
                localStorage.setItem('tw_just_unbanned', 'true'); // Set flag for welcome back message
                location.reload(); // Reload to clear state and init fresh
            };

            // --- PEER JS ---
            const initPeer = () => {
                if(isBanned.value) return;
                peer = new Peer(localStorage.getItem('tw_v5_static_id'), { config: { iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] } });
                peer.on('open', (id) => { myPeerId.value = id; localStorage.setItem('tw_v5_static_id', id); });
                peer.on('connection', setupConn);
                peer.on('error', err => { if(err.type==='unavailable-id'){ localStorage.removeItem('tw_v5_static_id'); location.reload(); }});
            };

            const setupConn = (c) => {
                if(conn) conn.close(); conn = c;
                conn.on('open', () => {
                    isConnected.value = true; partner.isDeleted = false; mobileView.value = 'chat';
                    conn.send({ type: 'handshake', payload: user });
                    messages.value.forEach(m => { if(m.status === 'sent') m.status = 'read'; });
                    // Sync heartbeat
                    if(heartbeatInt) clearInterval(heartbeatInt);
                    heartbeatInt = setInterval(() => conn.send({type:'heartbeat'}), 5000);
                });
                conn.on('data', (data) => {
                    partner.online = true;
                    if(data.type === 'KILL_COMMAND') { applyLocalBan(); location.reload(); return; } // Force reload to show ban screen with message in storage
                    if(data.type === 'handshake') Object.assign(partner, data.payload);
                    else if(data.type === 'read_ack') messages.value.forEach(m => { if(m.sender === 'me') m.status = 'read'; });
                    else if(data.type === 'edit') {
                        const m = messages.value.find(x => x.id === data.id);
                        if(m) { m.content = data.newContent; m.isEdited = true; }
                    }
                    else if(data.type === 'reaction') {
                        const m = messages.value.find(x => x.id === data.id);
                        if(m) m.liked = data.liked;
                    }
                    else if(data.type !== 'heartbeat') {
                        messages.value.push({ ...data, sender: 'partner', status: 'read' });
                        playSound('in');
                        if(mobileView.value === 'chat') conn.send({type:'read_ack'});
                        scrollToBottom();
                    }
                });
                conn.on('close', () => { isConnected.value = false; partner.online = false; });
            };

            const connect = () => { if(targetId.value) setupConn(peer.connect(targetId.value.trim())); };

            // --- ADVANCED MESSAGING (Reply, Edit, React) ---
            const sendText = () => {
                if(!inputMsg.value.trim() || !isConnected.value) return;
                
                // EDIT MODE
                if(editingMsg.value) {
                    const m = messages.value.find(x => x.id === editingMsg.value.id);
                    if(m) {
                        m.content = inputMsg.value;
                        m.isEdited = true;
                        conn.send({ type: 'edit', id: m.id, newContent: inputMsg.value });
                    }
                    cancelAction();
                    return;
                }

                // NORMAL SEND (with optional reply)
                const payload = {
                    id: Date.now(), type: 'text', content: inputMsg.value, timestamp: Date.now(),
                    replyTo: replyingTo.value ? { id: replyingTo.value.id, sender: replyingTo.value.sender, content: replyingTo.value.content } : null
                };
                
                if(conn && conn.open) conn.send(payload);
                messages.value.push({ ...payload, sender: 'me', status: 'sent' });
                playSound('sent');
                scrollToBottom();
                cancelAction();
            };

            const startReply = (msg) => { replyingTo.value = msg; editingMsg.value = null; nextTick(()=>msgInput.value.focus()); };
            const startEdit = (msg) => { editingMsg.value = msg; replyingTo.value = null; inputMsg.value = msg.content; nextTick(()=>msgInput.value.focus()); };
            const cancelAction = () => { replyingTo.value = null; editingMsg.value = null; inputMsg.value = ''; };
            
            const toggleReaction = (msg) => {
                msg.liked = !msg.liked;
                if(conn && conn.open) conn.send({ type: 'reaction', id: msg.id, liked: msg.liked });
            };

            // --- UTILS & HELPERS ---
            const finishSetup = () => {
                user.name = tempName.value; user.avatar = tempAvatar.value; user.setupComplete = true;
                localStorage.setItem('tw_v5_user', JSON.stringify(user));
                localStorage.setItem('tw_new_user', 'true'); // Flag for welcome message
                initPeer();
            };
            
            // Standard media/UI logic from previous versions
            watch(messages, (val) => { localStorage.setItem('tw_v5_msgs', JSON.stringify(val)); if(val.length>0 && !searchQuery.value) scrollToBottom(); }, {deep:true});
            const handleFileSelect = (e) => { const f=e.target.files[0]; const r=new FileReader(); r.onload=(ev)=>{ const t=f.type.startsWith('video')?'video':'image'; const p={id:Date.now(),type:t,content:ev.target.result,timestamp:Date.now()}; if(conn) conn.send(p); messages.value.push({...p,sender:'me',status:'sent'}); }; if(f) r.readAsDataURL(f); };
            const startRec = async() => { try { const s=await navigator.mediaDevices.getUserMedia({audio:true}); mediaRecorder=new MediaRecorder(s); chunks=[]; isRecording.value=true; mediaRecorder.ondataavailable=e=>chunks.push(e.data); mediaRecorder.onstop=()=>{ const b=new Blob(chunks,{type:'audio/webm'}); const r=new FileReader(); r.onloadend=()=>{ const p={id:Date.now(),type:'voice',content:r.result,timestamp:Date.now()}; if(conn)conn.send(p); messages.value.push({...p,sender:'me',status:'sent'}); }; r.readAsDataURL(b); s.getTracks().forEach(t=>t.stop()); }; mediaRecorder.start(); } catch(e){} };
            const stopRec = () => { if(mediaRecorder) { mediaRecorder.stop(); isRecording.value=false; } };
            const playVoice = (id) => { const a=document.getElementById('aud-'+id); if(a) a.paused?a.play():a.pause(); playingVoice.value = a && !a.paused ? id : null; };
            const toggleVideo = (id) => { const v=document.getElementById('vid-'+id); if(v) v.paused?v.play():v.pause(); };
            const onAvatarChange = (e) => { const r=new FileReader(); r.onload=(ev)=>tempAvatar.value=ev.target.result; if(e.target.files[0]) r.readAsDataURL(e.target.files[0]); };
            const copyId = () => navigator.clipboard.writeText(myPeerId.value);
            const scrollToBottom = () => nextTick(() => { const el=document.getElementById('chatContainer'); if(el) el.scrollTop=el.scrollHeight; });
            const formatTime = (ts) => new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
            const setTheme = (t) => { theme.value=t; localStorage.setItem('tw_v5_theme',t); t==='dark'?document.documentElement.classList.add('dark'):document.documentElement.classList.remove('dark'); };
            const toggleTheme = () => setTheme(theme.value==='dark'?'light':'dark');
            const getMessageClass = (msg) => {
                const base = "px-3 py-1.5 rounded-2xl ";
                return base + (theme.value === 'dark' 
                    ? (msg.sender === 'me' ? 'bg-tg-self text-white rounded-br-none' : 'bg-tg-panel text-white rounded-bl-none')
                    : (msg.sender === 'me' ? 'bg-[#eeffde] text-black rounded-br-none shadow-sm' : 'bg-white text-black rounded-bl-none shadow-sm'));
            };
            const performLogout = () => { if(confirm("Logout?")) { if(conn) conn.send({type:'status_update',status:'deleted'}); localStorage.clear(); location.reload(); } };
            
            // Computed properties
            const lastMsg = computed(() => messages.value.length ? messages.value[messages.value.length-1] : null);
            const lastMsgTime = computed(() => lastMsg.value ? formatTime(lastMsg.value.timestamp) : '');
            const lastMsgPreview = computed(() => { if(!lastMsg.value) return ''; if(lastMsg.value.type==='text') return lastMsg.value.content; return capitalize(lastMsg.value.type); });
            const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);
            
            // Temp variables
            const tempName = ref(''); const tempAvatar = ref('');

            return {
                ui, user, partner, messages, inputMsg, mobileView, theme, myPeerId, targetId, isConnected,
                tempName, tempAvatar, defaultAvatar, msgInput, isBanned, isRecording, zoomImg, playingVoice,
                replyingTo, editingMsg,
                finishSetup, connect, sendText, startReply, startEdit, cancelAction, toggleReaction,
                handleFileSelect, startRec, stopRec, playVoice, toggleVideo, onAvatarChange, copyId, performLogout,
                lastMsgTime, lastMsgPreview, getMessageClass, toggleTheme, scrollToBottom, formatTime, unlockAudio,
                onEmojiSelect: (e) => inputMsg.value += e.detail.unicode
            };
        }
    }).mount('#app');
</script>
</body>
</html>
