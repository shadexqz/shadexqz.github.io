<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tweeyer | Connect</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Core Libs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { DEFAULT: '#2563EB', dark: '#1d4ed8', soft: '#eff6ff' },
                        dark: { bg: '#121212', surf: '#1e1e1e', border: '#2e2e2e' }
                    }
                }
            }
        };
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Audio Player Styling */
        audio { height: 32px; border-radius: 20px; outline: none; }
        audio::-webkit-media-controls-panel { background-color: #f1f5f9; }
        .dark audio::-webkit-media-controls-panel { background-color: #334155; }
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-white dark:bg-dark-bg text-slate-800 dark:text-slate-200 h-[100dvh] w-screen overflow-hidden selection:bg-brand selection:text-white">

<div id="app" class="h-full flex flex-col md:flex-row relative">

    <!-- ==================== SETUP SCREEN (New Design) ==================== -->
    <div v-if="!user.setupComplete" class="absolute inset-0 z-[60] bg-white dark:bg-dark-bg flex items-center justify-center p-6">
        <div class="w-full max-w-sm">
            <div class="text-center mb-10">
                <div class="w-20 h-20 bg-gradient-to-tr from-brand to-cyan-400 rounded-2xl mx-auto mb-6 flex items-center justify-center shadow-xl shadow-brand/20 text-white text-4xl font-bold">
                    T
                </div>
                <h1 class="text-2xl font-bold mb-2">Tweeyer ID</h1>
                <p class="text-slate-500 text-sm">Приватный мессенджер без серверов</p>
            </div>
            
            <div class="space-y-6">
                <div class="flex justify-center">
                    <div class="relative w-24 h-24 cursor-pointer group" @click="$refs.avaInput.click()">
                        <img :src="tempAvatar || defaultAvatar" class="w-full h-full rounded-full object-cover border-4 border-slate-50 dark:border-dark-surf shadow-sm">
                        <div class="absolute bottom-0 right-0 bg-slate-900 text-white p-2 rounded-full text-xs border-2 border-white dark:border-dark-bg">
                            <i class="fa-solid fa-camera"></i>
                        </div>
                    </div>
                </div>
                <input type="file" ref="avaInput" @change="handleAvatar" accept="image/*" class="hidden">

                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1 uppercase ml-1">Как вас зовут?</label>
                    <input v-model="tempName" class="w-full px-4 py-3 bg-slate-100 dark:bg-dark-surf rounded-xl font-medium focus:outline-none focus:ring-2 focus:ring-brand transition dark:text-white" placeholder="Например: Artem">
                </div>

                <button @click="finishSetup" :disabled="!tempName.trim()" class="w-full py-3.5 bg-brand hover:bg-brand-dark text-white rounded-xl font-semibold shadow-lg shadow-brand/25 transition transform active:scale-95 disabled:opacity-50 disabled:scale-100">
                    Создать профиль
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== SIDEBAR ==================== -->
    <aside class="w-full md:w-80 bg-slate-50 dark:bg-dark-surf border-r border-slate-200 dark:border-dark-border flex flex-col z-20 absolute md:relative h-full transition-transform duration-300"
           :class="mobileView === 'chat' ? '-translate-x-full md:translate-x-0' : 'translate-x-0'">
        
        <!-- My Profile Header -->
        <div class="p-4 border-b border-slate-200 dark:border-dark-border flex items-center justify-between bg-white dark:bg-dark-surf">
            <div class="flex items-center gap-3">
                <img :src="user.avatar || defaultAvatar" class="w-10 h-10 rounded-full object-cover bg-slate-200">
                <div class="leading-tight">
                    <h3 class="font-bold text-sm">{{ user.name }}</h3>
                    <div class="flex items-center gap-1.5 mt-0.5">
                        <div class="w-2 h-2 rounded-full" :class="status === 'ready' ? 'bg-green-500' : 'bg-red-500 animate-pulse'"></div>
                        <span class="text-[10px] font-mono uppercase text-slate-400">{{ status === 'ready' ? 'Online' : 'Connecting' }}</span>
                    </div>
                </div>
            </div>
            <button @click="toggleTheme" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-white/5 flex items-center justify-center hover:bg-slate-200 transition">
                <i class="fa-solid" :class="theme === 'dark' ? 'fa-sun' : 'fa-moon'"></i>
            </button>
        </div>

        <!-- Connect Form -->
        <div class="p-4 flex-1 overflow-y-auto">
            <div class="bg-white dark:bg-dark-bg p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-dark-border mb-6">
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">Ваш ID (Скиньте другу)</label>
                <div class="flex items-center gap-2 bg-slate-50 dark:bg-dark-surf p-2.5 rounded-xl border border-slate-200 dark:border-dark-border mb-4">
                    <span class="flex-1 font-mono text-xs truncate select-all text-brand font-medium">{{ myPeerId || 'Генерация...' }}</span>
                    <button @click="copyId" class="text-slate-400 hover:text-brand px-1"><i class="fa-regular fa-copy"></i></button>
                </div>

                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">Подключиться к другу</label>
                <div class="flex gap-2">
                    <input v-model="targetId" placeholder="Вставьте ID друга" class="flex-1 bg-slate-50 dark:bg-dark-surf px-3 py-2 rounded-xl text-sm outline-none border border-slate-200 dark:border-dark-border focus:border-brand transition">
                    <button @click="connect" :disabled="status !== 'ready' || !targetId" class="bg-slate-900 dark:bg-white text-white dark:text-black w-10 h-10 rounded-xl flex items-center justify-center hover:scale-105 transition disabled:opacity-50 disabled:scale-100">
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Active Chat Item -->
            <div v-if="isConnected" @click="mobileView = 'chat'" class="bg-white dark:bg-dark-bg p-3 rounded-2xl border border-brand/30 shadow-sm cursor-pointer hover:bg-brand-soft dark:hover:bg-white/5 transition group">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <img :src="partner.avatar || defaultAvatar" class="w-12 h-12 rounded-full object-cover">
                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-dark-bg rounded-full"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="font-bold text-sm truncate">{{ partner.name || 'Собеседник' }}</h4>
                            <span class="text-[10px] text-green-600 font-bold bg-green-100 dark:bg-green-900/30 px-1.5 py-0.5 rounded">В СЕТИ</span>
                        </div>
                        <p class="text-xs text-slate-500 truncate group-hover:text-brand transition">Нажмите, чтобы открыть чат</p>
                    </div>
                </div>
            </div>
            
            <div v-else class="text-center py-10 opacity-40">
                <i class="fa-regular fa-comments text-4xl mb-3 text-slate-300"></i>
                <p class="text-xs">Введите ID друга выше,<br>чтобы начать общение</p>
            </div>
            
            <!-- Error Display -->
            <div v-if="errorMsg" class="mt-4 p-3 bg-red-50 dark:bg-red-900/20 text-red-600 text-xs rounded-xl flex gap-2 items-start">
                <i class="fa-solid fa-circle-exclamation mt-0.5"></i>
                <span>{{ errorMsg }}</span>
            </div>
        </div>
        
        <div class="p-4 text-[10px] text-center text-slate-400 border-t border-slate-100 dark:border-dark-border">
            Tweeyer v3.0 Stable • <button @click="resetAll" class="underline hover:text-red-500">Сброс данных</button>
        </div>
    </aside>

    <!-- ==================== CHAT AREA ==================== -->
    <main class="flex-1 flex flex-col h-full bg-[#f0f2f5] dark:bg-[#000000] relative w-full"
          :class="mobileView === 'sidebar' ? 'translate-x-full md:translate-x-0 hidden md:flex' : 'translate-x-0'">
        
        <!-- Header -->
        <header class="h-16 bg-white dark:bg-dark-surf border-b border-slate-200 dark:border-dark-border flex items-center justify-between px-4 z-10 shadow-sm">
            <div class="flex items-center gap-3">
                <button @click="mobileView = 'sidebar'" class="md:hidden w-8 h-8 flex items-center justify-center -ml-2 text-slate-500">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                
                <div class="flex items-center gap-3" v-if="isConnected">
                    <img :src="partner.avatar || defaultAvatar" class="w-10 h-10 rounded-full object-cover border border-slate-100 dark:border-slate-700">
                    <div>
                        <h2 class="font-bold text-sm text-slate-800 dark:text-white leading-tight">{{ partner.name }}</h2>
                        <p class="text-xs text-brand font-medium">Online</p>
                    </div>
                </div>
                <div v-else class="flex items-center gap-3 opacity-50">
                    <div class="w-10 h-10 rounded-full bg-slate-200 dark:bg-white/10 animate-pulse"></div>
                    <div class="h-4 w-24 bg-slate-200 dark:bg-white/10 rounded animate-pulse"></div>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button v-if="isConnected" @click="startCall" class="w-10 h-10 rounded-full text-brand hover:bg-brand-soft dark:hover:bg-white/10 flex items-center justify-center transition" title="Позвонить">
                    <i class="fa-solid fa-phone"></i>
                </button>
            </div>
        </header>

        <!-- Messages List -->
        <div ref="chatBox" class="flex-1 overflow-y-auto p-4 space-y-3 bg-opacity-50 bg-[url('https://site-assets.fontawesome.com/releases/v6.4.0/svgs/regular/message-lines.svg')]">
            <div v-for="msg in messages" :key="msg.id" class="flex flex-col" :class="msg.sender === 'me' ? 'items-end' : 'items-start'">
                
                <div class="max-w-[80%] md:max-w-[65%] rounded-2xl px-4 py-2 shadow-sm text-sm relative group transition-all"
                     :class="msg.sender === 'me' 
                        ? 'bg-brand text-white rounded-br-none' 
                        : 'bg-white dark:bg-dark-surf text-slate-800 dark:text-slate-200 rounded-bl-none border border-slate-100 dark:border-dark-border'">
                    
                    <!-- Text -->
                    <p v-if="msg.type === 'text'" class="whitespace-pre-wrap leading-relaxed">{{ msg.content }}</p>

                    <!-- Image -->
                    <div v-if="msg.type === 'image'" class="rounded-lg overflow-hidden my-1">
                        <img :src="msg.content" class="max-w-full max-h-72 object-cover cursor-zoom-in" @click="zoomedImg = msg.content">
                    </div>

                    <!-- Voice -->
                    <div v-if="msg.type === 'voice'" class="flex items-center gap-2 py-1 min-w-[200px]">
                        <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center flex-shrink-0">
                            <i class="fa-solid fa-microphone text-xs"></i>
                        </div>
                        <audio controls :src="msg.content" class="h-8 w-full opacity-90"></audio>
                    </div>

                    <!-- Meta & Status -->
                    <div class="flex items-center justify-end gap-1 mt-1 opacity-70 select-none text-[10px]">
                        <span>{{ formatTime(msg.timestamp) }}</span>
                        <span v-if="msg.sender === 'me'" class="ml-1">
                            <i class="fa-solid fa-check" v-if="msg.status === 'sent'"></i>
                            <i class="fa-solid fa-check-double text-blue-200" v-if="msg.status === 'read'"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <footer class="bg-white dark:bg-dark-surf p-3 flex items-end gap-2 border-t border-slate-100 dark:border-dark-border z-20">
            <!-- Attachments -->
            <div class="relative">
                <button @click="showAttach = !showAttach" class="w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-white/10 text-slate-500 transition">
                    <i class="fa-solid fa-paperclip transform rotate-45"></i>
                </button>
                <div v-if="showAttach" class="absolute bottom-14 left-0 bg-white dark:bg-dark-bg shadow-xl border dark:border-dark-border rounded-xl p-2 w-40 flex flex-col gap-1 overflow-hidden animate-fade-in-up">
                    <button @click="$refs.imgInput.click(); showAttach=false" class="flex items-center gap-3 px-3 py-2.5 hover:bg-slate-50 dark:hover:bg-white/5 rounded-lg text-sm text-left transition">
                        <div class="w-6 h-6 rounded bg-blue-100 text-blue-600 flex items-center justify-center text-xs"><i class="fa-regular fa-image"></i></div>
                        Фото
                    </button>
                    <!-- More can be added here -->
                </div>
                <input type="file" ref="imgInput" class="hidden" accept="image/*" @change="sendImage">
            </div>

            <!-- Text Input -->
            <textarea 
                v-model="inputMsg" 
                @keydown.enter.prevent="sendText"
                rows="1"
                placeholder="Сообщение..." 
                class="flex-1 bg-slate-100 dark:bg-black/30 rounded-2xl px-4 py-3 text-sm outline-none resize-none max-h-32 focus:ring-1 focus:ring-brand transition dark:text-white"
            ></textarea>

            <!-- Send / Mic -->
            <div class="w-10 h-10 flex items-center justify-center">
                <button v-if="inputMsg.trim()" @click="sendText" class="w-10 h-10 rounded-full bg-brand text-white shadow-lg shadow-brand/30 hover:scale-110 transition flex items-center justify-center">
                    <i class="fa-solid fa-paper-plane text-sm translate-x-px translate-y-px"></i>
                </button>
                
                <button v-else 
                    @mousedown="startRec" 
                    @mouseup="stopRec" 
                    @touchstart.prevent="startRec" 
                    @touchend.prevent="stopRec"
                    class="w-10 h-10 rounded-full flex items-center justify-center transition"
                    :class="isRecording ? 'bg-red-500 text-white scale-110 shadow-lg shadow-red-500/40 animate-pulse' : 'bg-slate-100 dark:bg-white/10 text-slate-500 hover:text-slate-700'"
                >
                    <i class="fa-solid" :class="isRecording ? 'fa-square' : 'fa-microphone'"></i>
                </button>
            </div>
        </footer>

        <!-- Recording Overlay -->
        <div v-if="isRecording" class="absolute bottom-24 left-1/2 -translate-x-1/2 bg-black/80 backdrop-blur text-white px-6 py-2 rounded-full flex items-center gap-3 shadow-xl z-30">
            <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
            <span class="text-sm font-mono font-bold">Recording...</span>
        </div>

        <!-- Call Overlay -->
        <div v-if="call.active || call.incoming" class="fixed inset-0 z-[100] bg-slate-900/95 backdrop-blur-md flex flex-col items-center justify-center text-white">
            <div class="relative w-32 h-32 mb-8">
                <div class="absolute inset-0 bg-brand rounded-full animate-ping opacity-20" v-if="call.incoming || call.isCalling"></div>
                <img :src="partner.avatar || defaultAvatar" class="w-full h-full rounded-full object-cover border-4 border-white/10 relative z-10 bg-slate-800">
            </div>
            
            <h2 class="text-3xl font-bold mb-2">{{ partner.name }}</h2>
            <p class="text-white/60 mb-12 font-medium tracking-wide">
                {{ call.incoming ? 'Входящий звонок...' : (call.active && !call.isCalling ? 'Разговор ' + callTimeFormatted : 'Вызов...') }}
            </p>

            <div class="flex items-center gap-10">
                <!-- Answer -->
                <button v-if="call.incoming" @click="answerCall" class="w-20 h-20 rounded-full bg-green-500 hover:bg-green-400 text-3xl shadow-xl shadow-green-500/30 flex items-center justify-center transition transform hover:scale-110">
                    <i class="fa-solid fa-phone"></i>
                </button>
                
                <!-- Decline/Hangup -->
                <button @click="endCall" class="w-20 h-20 rounded-full bg-red-500 hover:bg-red-400 text-3xl shadow-xl shadow-red-500/30 flex items-center justify-center transition transform hover:scale-110">
                    <i class="fa-solid fa-phone-slash"></i>
                </button>
            </div>
            
            <!-- Hidden Audio Stream -->
            <audio ref="remoteAudio" autoplay class="hidden"></audio>
        </div>
    </main>

    <!-- Zoom Modal -->
    <transition name="fade">
        <div v-if="zoomedImg" @click="zoomedImg = null" class="fixed inset-0 z-[200] bg-black/95 flex items-center justify-center p-4 cursor-zoom-out">
            <img :src="zoomedImg" class="max-w-full max-h-full rounded shadow-2xl">
        </div>
    </transition>

</div>

<script>
    const { createApp, ref, reactive, onMounted, computed, watch, nextTick } = Vue;

    createApp({
        setup() {
            // --- State ---
            const myPeerId = ref('');
            const targetId = ref('');
            const status = ref('init'); // init, ready, error
            const errorMsg = ref('');
            const isConnected = ref(false);
            const mobileView = ref('sidebar');
            const showAttach = ref(false);
            const theme = ref('light');
            
            // User Data
            const user = reactive({ name: '', avatar: '', setupComplete: false });
            const partner = reactive({ name: '', avatar: '' });
            const messages = ref([]);
            const inputMsg = ref('');
            
            // Setup Temp
            const tempName = ref('');
            const tempAvatar = ref('');
            const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/1144/1144760.png";
            
            // Audio/Call
            const isRecording = ref(false);
            const call = reactive({ incoming: false, active: false, isCalling: false, stream: null, conn: null });
            const callTime = ref(0);
            let callTimer = null;
            let mediaRecorder = null;
            let chunks = [];
            
            // Refs
            const chatBox = ref(null);
            const zoomedImg = ref(null);
            const remoteAudio = ref(null);

            // Objects
            let peer = null;
            let conn = null;

            // --- Lifecycle ---
            onMounted(() => {
                const u = localStorage.getItem('tw_user_v3');
                if (u) Object.assign(user, JSON.parse(u));
                
                const msgs = localStorage.getItem('tw_msgs_v3');
                if (msgs) messages.value = JSON.parse(msgs);

                const t = localStorage.getItem('tw_theme');
                if (t) setTheme(t);

                if (user.setupComplete) initPeer();
            });

            watch(messages, (val) => {
                localStorage.setItem('tw_msgs_v3', JSON.stringify(val));
            }, { deep: true });

            // --- Setup & Profile ---
            const handleAvatar = (e) => {
                const f = e.target.files[0];
                if (!f) return;
                const r = new FileReader();
                r.onload = (ev) => {
                    if(!user.setupComplete) tempAvatar.value = ev.target.result;
                    else {
                        user.avatar = ev.target.result;
                        saveUser();
                        sendData({ type: 'profile_update', payload: { name: user.name, avatar: user.avatar } });
                    }
                };
                r.readAsDataURL(f);
            };

            const finishSetup = () => {
                user.name = tempName.value;
                user.avatar = tempAvatar.value;
                user.setupComplete = true;
                saveUser();
                initPeer();
            };

            const saveUser = () => localStorage.setItem('tw_user_v3', JSON.stringify(user));

            // --- PeerJS Logic ---
            const initPeer = () => {
                status.value = 'init';
                // Public Google STUN servers for better connectivity
                peer = new Peer(null, {
                    debug: 1,
                    config: { iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] }
                });

                peer.on('open', (id) => {
                    myPeerId.value = id;
                    status.value = 'ready';
                });

                peer.on('connection', (c) => handleConnection(c));
                
                peer.on('call', (c) => {
                    call.incoming = true;
                    call.conn = c;
                    // Auto-answer logic is bad practice, waiting for user input
                });

                peer.on('error', (err) => {
                    console.error(err);
                    errorMsg.value = "Ошибка сети или ID. " + err.type;
                    status.value = 'error';
                });
            };

            const connect = () => {
                if (!targetId.value) return;
                const c = peer.connect(targetId.value.trim());
                handleConnection(c);
            };

            const handleConnection = (c) => {
                conn = c;
                
                conn.on('open', () => {
                    errorMsg.value = '';
                    isConnected.value = true;
                    mobileView.value = 'chat';
                    
                    // 1. Send my profile immediately
                    sendData({ type: 'handshake', payload: { name: user.name, avatar: user.avatar } });
                    
                    // 2. Mark pending messages as read
                    messages.value.forEach(m => {
                        if (m.sender === 'partner' && m.status !== 'read') {
                            sendReadReceipt(m.id);
                            m.status = 'read';
                        }
                    });
                });

                conn.on('data', (data) => {
                    if (data.type === 'handshake' || data.type === 'profile_update') {
                        partner.name = data.payload.name;
                        partner.avatar = data.payload.avatar;
                    } 
                    else if (data.type === 'read_receipt') {
                        // Update status of my message
                        const m = messages.value.find(x => x.id === data.msgId);
                        if (m) m.status = 'read';
                    }
                    else {
                        // Received Message
                        const newMsg = {
                            id: data.id,
                            type: data.type,
                            content: data.payload,
                            timestamp: data.timestamp,
                            sender: 'partner',
                            status: 'read' // I see it now
                        };
                        messages.value.push(newMsg);
                        sendReadReceipt(newMsg.id);
                        playNotif();
                        scrollToBottom();
                    }
                });

                conn.on('close', () => {
                    isConnected.value = false;
                    errorMsg.value = "Собеседник отключился";
                });
            };

            const sendData = (data) => {
                if (conn && conn.open) conn.send(data);
            };

            const sendReadReceipt = (msgId) => {
                sendData({ type: 'read_receipt', msgId });
            };

            // --- Messaging ---
            const sendText = () => {
                if (!inputMsg.value.trim() || !isConnected.value) return;
                const msgId = Date.now() + Math.random().toString(36).substr(2, 9);
                const msg = {
                    id: msgId,
                    type: 'text',
                    payload: inputMsg.value,
                    timestamp: Date.now()
                };
                
                sendData(msg);
                messages.value.push({ ...msg, content: msg.payload, sender: 'me', status: 'sent' });
                inputMsg.value = '';
                scrollToBottom();
            };

            const sendImage = (e) => {
                const f = e.target.files[0];
                if (!f || !isConnected.value) return;
                const r = new FileReader();
                r.onload = (ev) => {
                    const msgId = Date.now() + Math.random().toString(36).substr(2, 9);
                    const msg = {
                        id: msgId,
                        type: 'image',
                        payload: ev.target.result,
                        timestamp: Date.now()
                    };
                    sendData(msg);
                    messages.value.push({ ...msg, content: msg.payload, sender: 'me', status: 'sent' });
                    scrollToBottom();
                };
                r.readAsDataURL(f);
            };

            // --- Voice Messages ---
            const startRec = async () => {
                if (!isConnected.value) return;
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream); // Browser defaults (usually webm/opus)
                    chunks = [];
                    isRecording.value = true;
                    
                    mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => {
                            const msgId = Date.now() + Math.random().toString(36).substr(2, 9);
                            const msg = {
                                id: msgId,
                                type: 'voice',
                                payload: reader.result, // Base64
                                timestamp: Date.now()
                            };
                            sendData(msg);
                            messages.value.push({ ...msg, content: reader.result, sender: 'me', status: 'sent' });
                            scrollToBottom();
                        };
                        stream.getTracks().forEach(t => t.stop());
                    };
                    mediaRecorder.start();
                } catch (e) {
                    alert("Нужен доступ к микрофону! Убедитесь что сайт на HTTPS.");
                }
            };

            const stopRec = () => {
                if (mediaRecorder && isRecording.value) {
                    mediaRecorder.stop();
                    isRecording.value = false;
                }
            };

            // --- Calls ---
            const startCall = async () => {
                if (!isConnected.value) return;
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    call.stream = stream;
                    call.isCalling = true;
                    call.active = true;
                    
                    const c = peer.call(conn.peer, stream);
                    call.conn = c;
                    
                    c.on('stream', (remoteStream) => {
                        handleRemoteStream(remoteStream);
                    });
                    c.on('close', endCall);
                    c.on('error', endCall);
                } catch (e) { alert("Ошибка микрофона: " + e); }
            };

            const answerCall = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    call.stream = stream;
                    call.conn.answer(stream);
                    
                    call.incoming = false;
                    call.active = true;
                    startCallTimer();
                    
                    call.conn.on('stream', (remoteStream) => {
                        handleRemoteStream(remoteStream);
                    });
                    call.conn.on('close', endCall);
                } catch (e) { alert("Ошибка ответа: " + e); endCall(); }
            };

            const handleRemoteStream = (stream) => {
                call.isCalling = false; // Connected
                startCallTimer();
                nextTick(() => {
                    const audio = document.querySelector('audio.hidden'); // Quick Hack due to Vue refs inside conditional
                    if(audio) {
                        audio.srcObject = stream;
                        audio.play().catch(e => console.log("Autoplay blocked:", e));
                    }
                });
            };

            const endCall = () => {
                if (call.conn) call.conn.close();
                if (call.stream) call.stream.getTracks().forEach(t => t.stop());
                call.active = false;
                call.incoming = false;
                call.isCalling = false;
                call.stream = null;
                call.conn = null;
                clearInterval(callTimer);
                callTime.value = 0;
            };

            const startCallTimer = () => {
                if (callTimer) clearInterval(callTimer);
                callTimer = setInterval(() => callTime.value++, 1000);
            };

            const callTimeFormatted = computed(() => {
                const m = Math.floor(callTime.value / 60).toString().padStart(2,'0');
                const s = (callTime.value % 60).toString().padStart(2,'0');
                return `${m}:${s}`;
            });

            // --- Utils ---
            const scrollToBottom = () => nextTick(() => {
                if (chatBox.value) chatBox.value.scrollTop = chatBox.value.scrollHeight;
            });
            
            const formatTime = (ts) => new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            
            const playNotif = () => {
                // Short beep
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.frequency.value = 800;
                g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.1);
                o.start(); o.stop(ctx.currentTime + 0.1);
            };

            const copyId = () => navigator.clipboard.writeText(myPeerId.value);
            
            const toggleTheme = () => {
                setTheme(theme.value === 'dark' ? 'light' : 'dark');
            };
            
            const setTheme = (t) => {
                theme.value = t;
                localStorage.setItem('tw_theme', t);
                if (t === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            };

            const resetAll = () => {
                if(confirm("Удалить профиль и все переписки?")) {
                    localStorage.clear();
                    location.reload();
                }
            };

            return {
                user, partner, messages, inputMsg, myPeerId, targetId, status, errorMsg,
                isConnected, mobileView, showAttach, theme,
                tempName, tempAvatar, defaultAvatar,
                isRecording, call, callTimeFormatted, zoomedImg,
                finishSetup, handleAvatar, copyId, toggleTheme,
                connect, sendText, sendImage, startRec, stopRec,
                startCall, answerCall, endCall, resetAll,
                chatBox, formatTime
            };
        }
    }).mount('#app');
</script>
</body>
</html>
