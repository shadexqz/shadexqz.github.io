<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tweeyer Web Ultimate</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <!-- Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        tg: {
                            bg: '#17212b', sidebar: '#17212b', panel: '#242f3d',
                            hover: '#2b5278', active: '#232e3c', self: '#766ac8',
                            text: '#eef3f7', hint: '#7f91a4', blue: '#3390ec', red: '#ef5b5b'
                        }
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        pop: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        };
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }

        /* Wallpapers */
        .chat-bg-dark {
            background-color: #0f0f0f;
            background-image: radial-gradient(#1d2a39 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .chat-bg-light {
            background-color: #f0f2f5;
            background-image: radial-gradient(#d1d5db 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* Animations */
        .msg-enter-active, .msg-leave-active { transition: all 0.3s ease; }
        .msg-enter-from, .msg-leave-to { opacity: 0; transform: translateY(10px); }
        .slide-panel-enter-active, .slide-panel-leave-active { transition: transform 0.3s ease; }
        .slide-panel-enter-from, .slide-panel-leave-to { transform: translateX(-100%); }
        
        /* Emoji Picker */
        emoji-picker { width: 100%; height: 320px; --background: #ffffff; --border-color: #e5e7eb; }
        .dark emoji-picker { --background: #242f3d; --border-color: #17212b; --color: #ffffff; --indicator-color: #3390ec; }
        
        /* Reaction Heart Pop */
        .reaction-anim { animation: heartPop 0.4s ease-out; }
        @keyframes heartPop { 0% { transform: scale(0); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }
        
        /* Voice Wave */
        .wave-bar { animation: wave 1s infinite ease-in-out; }
        @keyframes wave { 0%, 100% { height: 30%; } 50% { height: 100%; } }
    </style>
</head>
<body class="bg-white dark:bg-[#0f0f0f] text-gray-900 dark:text-tg-text h-[100dvh] w-screen overflow-hidden text-[15px] select-none">

<div id="app" class="h-full flex relative font-sans" @paste="handlePaste" @click="unlockAudio">

    <!-- ================= 1. BAN SCREEN ================= -->
    <div v-if="isBanned" class="absolute inset-0 z-[200] bg-white dark:bg-[#0f0f0f] flex flex-col items-center justify-center p-6 text-center select-none">
        
        <!-- Main Ban View -->
        <div v-if="!appealMode && !appealSent" class="flex flex-col items-center animate-pop max-w-lg w-full">
            <div class="w-32 h-32 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center mb-6 animate-pulse">
                <i class="fa-solid fa-ban text-6xl text-red-500"></i>
            </div>
            
            <h1 class="text-3xl font-bold mb-4 dark:text-white">Account Deactivated</h1>
            
            <div class="bg-gray-100 dark:bg-[#1f2936] p-6 rounded-2xl w-full text-left border border-gray-200 dark:border-white/5 shadow-inner mb-6">
                <div class="flex items-center gap-2 mb-3 pb-3 border-b border-gray-200 dark:border-white/10">
                    <i class="fa-solid fa-shield-halved text-tg-blue"></i>
                    <span class="font-bold text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">Security Alert</span>
                </div>
                <p class="text-gray-700 dark:text-gray-300 text-[15px] leading-relaxed">
                    Здравствуйте, <span class="font-bold text-black dark:text-white">{{ user.name }}</span>.
                    <br><br>
                    Ваш аккаунт (ID: <span class="font-mono bg-black/5 dark:bg-white/10 px-1 rounded">{{ myPeerId }}</span>) был деактивирован в связи с нарушением правил платформы Tweeyer.
                    <br><br>
                    <span class="text-red-500 font-medium text-xs"><i class="fa-solid fa-circle-exclamation mr-1"></i> Violation: Terms of Service (Section 4.2)</span>
                </p>
            </div>

            <div class="space-y-3 w-full max-w-xs">
                <button @click="appealMode = true" class="w-full py-3.5 rounded-xl bg-tg-blue text-white font-bold uppercase text-sm tracking-wide shadow-lg shadow-blue-500/20 hover:bg-blue-600 transition transform active:scale-95">
                    Appeal Decision
                </button>
            </div>
        </div>

        <!-- Appeal Form -->
        <div v-if="appealMode && !appealSent" class="w-full max-w-md bg-white dark:bg-[#1f2936] p-6 rounded-2xl shadow-2xl border dark:border-white/5 animate-pop">
            <h2 class="text-xl font-bold mb-1 dark:text-white">Contact Support</h2>
            <p class="text-sm text-gray-500 mb-4">Please explain the situation.</p>
            
            <textarea v-model="appealText" class="w-full h-32 bg-gray-50 dark:bg-[#17212b] rounded-xl p-3 outline-none focus:ring-2 ring-tg-blue dark:text-white text-sm resize-none mb-4 custom-scrollbar" placeholder="I believe this is a mistake because..."></textarea>
            
            <div class="flex gap-3">
                <button @click="appealMode = false" class="flex-1 py-3 rounded-xl bg-gray-200 dark:bg-white/5 font-medium hover:bg-gray-300 dark:hover:bg-white/10 transition dark:text-white">Cancel</button>
                <button @click="sendAppeal" :disabled="!appealText" class="flex-1 py-3 rounded-xl bg-tg-blue text-white font-bold shadow-lg hover:bg-blue-600 transition disabled:opacity-50">Submit</button>
            </div>
        </div>

        <!-- Appeal Sent -->
        <div v-if="appealSent" class="flex flex-col items-center animate-pop">
            <div class="w-24 h-24 bg-yellow-100 dark:bg-yellow-900/20 rounded-full flex items-center justify-center mb-6">
                <i class="fa-solid fa-clock text-5xl text-yellow-500 animate-pulse"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2 dark:text-white">Under Review</h2>
            <p class="text-gray-500 dark:text-gray-400 max-w-xs mb-8">
                Your appeal ticket <span class="font-mono text-tg-blue">#{{ Date.now().toString().slice(-6) }}</span> has been created.
            </p>
            <div class="px-4 py-2 bg-gray-100 dark:bg-white/5 rounded-lg text-xs font-mono text-gray-500">Expected response: 24-48 hours</div>
        </div>
    </div>

    <!-- ================= 2. SETUP SCREEN ================= -->
    <div v-if="!user.setupComplete && !isBanned" class="absolute inset-0 z-[60] bg-white dark:bg-[#0f0f0f] flex items-center justify-center p-4">
        <!-- Blobs -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="absolute top-0 left-1/4 w-96 h-96 bg-blue-500/20 rounded-full mix-blend-multiply filter blur-3xl animate-blob"></div>
            <div class="absolute bottom-0 right-1/4 w-96 h-96 bg-purple-500/20 rounded-full mix-blend-multiply filter blur-3xl animate-blob animation-delay-2000"></div>
        </div>

        <div class="w-full max-w-sm text-center relative z-10 backdrop-blur-xl bg-white/50 dark:bg-white/5 p-8 rounded-3xl border border-white/20 shadow-2xl">
            <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-tr from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center shadow-lg transform rotate-3 hover:rotate-0 transition">
                <i class="fa-brands fa-telegram text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2 dark:text-white">Tweeyer Web</h1>
            <p class="text-gray-500 dark:text-gray-400 mb-8 text-sm">Secure. Fast. P2P.</p>

            <div class="space-y-6">
                <div class="relative w-28 h-28 mx-auto group cursor-pointer" @click="$refs.avaInput.click()">
                    <img :src="tempAvatar || defaultAvatar" class="w-full h-full rounded-full object-cover shadow-xl border-4 border-white dark:border-[#242f3d] transition group-hover:scale-105">
                    <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-white backdrop-blur-sm">
                        <i class="fa-solid fa-camera text-2xl"></i>
                    </div>
                </div>
                <input type="file" ref="avaInput" class="hidden" accept="image/*" @change="onAvatarChange">

                <div class="space-y-3">
                    <input v-model="tempName" placeholder="Your Name" class="w-full bg-gray-50/80 dark:bg-[#17212b]/80 px-5 py-3.5 rounded-xl outline-none focus:ring-2 focus:ring-tg-blue text-center dark:text-white transition border border-transparent focus:border-tg-blue">
                    <input v-model="tempBio" placeholder="Bio (Optional)" class="w-full bg-transparent border-b border-gray-200 dark:border-gray-700 px-2 py-2 outline-none text-center text-sm dark:text-gray-400 focus:border-tg-blue transition">
                </div>
                
                <button @click="finishSetup" :disabled="!tempName" class="w-full bg-tg-blue text-white py-3.5 rounded-xl font-bold hover:shadow-lg hover:shadow-blue-500/30 transition transform hover:-translate-y-0.5 disabled:opacity-50">
                    Get Started
                </button>
            </div>
        </div>
    </div>

    <!-- ================= 3. SIDEBAR ================= -->
    <aside class="w-full md:w-[380px] bg-white dark:bg-tg-sidebar border-r border-gray-200 dark:border-black/20 flex flex-col z-20 absolute md:relative h-full transition-transform duration-300 shadow-[2px_0_10px_rgba(0,0,0,0.1)]"
           :class="mobileView === 'chat' ? '-translate-x-full md:translate-x-0' : 'translate-x-0'">
        
        <!-- Header -->
        <div class="h-[70px] px-4 flex items-center gap-4 shrink-0 bg-white dark:bg-tg-sidebar z-20">
            <button @click="ui.showDrawer = true" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-white/5 flex items-center justify-center text-gray-500 dark:text-gray-400 transition">
                <i class="fa-solid fa-bars text-lg"></i>
            </button>
            <div class="flex-1 relative group">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-tg-blue transition"></i>
                <input v-model="searchQuery" placeholder="Search" class="w-full bg-gray-100 dark:bg-[#0f161e] rounded-full h-10 pl-11 pr-4 text-sm outline-none dark:text-white focus:bg-white dark:focus:bg-[#17212b] border border-transparent focus:border-tg-blue focus:shadow-md transition">
            </div>
        </div>

        <!-- Connection -->
        <div class="px-4 pb-4">
            <div class="bg-gradient-to-br from-blue-50/50 to-purple-50/50 dark:from-tg-panel dark:to-[#1f2936] rounded-xl p-4 border border-blue-100 dark:border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] font-bold text-tg-blue uppercase tracking-widest">My Static ID</span>
                    <button @click="copyId" class="text-tg-blue text-[10px] font-bold hover:underline bg-white/50 dark:bg-black/20 px-2 py-0.5 rounded">COPY</button>
                </div>
                <div class="text-xs font-mono text-gray-800 dark:text-gray-200 break-all select-all mb-3">{{ myPeerId || 'Generating...' }}</div>
                <div class="flex gap-2">
                    <input v-model="targetId" placeholder="Partner ID" class="flex-1 bg-white dark:bg-[#17212b] rounded-lg px-3 py-2 text-sm outline-none dark:text-white border border-gray-200 dark:border-black/20 focus:border-tg-blue transition shadow-sm">
                    <button @click="connect" class="bg-tg-blue text-white w-9 rounded-lg flex items-center justify-center hover:bg-blue-600 active:scale-95 transition shadow-lg shadow-blue-500/20">
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Chat List -->
        <div class="flex-1 overflow-y-auto custom-scrollbar">
            
            <!-- 1. SYSTEM CHAT (OFFICIAL) -->
            <div @click="switchChat('SYSTEM')" 
                 class="mx-2 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-tg-active cursor-pointer flex gap-3 transition group relative mb-1"
                 :class="{'bg-tg-blue dark:bg-tg-blue text-white hover:!bg-blue-600': activeChat === 'SYSTEM' && mobileView === 'chat'}">
                <div class="relative shrink-0">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-blue-400 to-cyan-400 flex items-center justify-center text-white text-xl shadow-md">
                        <i class="fa-brands fa-telegram"></i>
                    </div>
                    <div class="absolute bottom-0 right-0 w-4 h-4 bg-blue-500 border-2 border-white dark:border-tg-sidebar rounded-full flex items-center justify-center text-[8px] text-white">
                        <i class="fa-solid fa-check"></i>
                    </div>
                </div>
                <div class="flex-1 min-w-0 flex flex-col justify-center">
                    <div class="flex justify-between items-center mb-0.5">
                        <h3 class="font-bold text-[15px] flex items-center gap-1" :class="activeChat === 'SYSTEM' && mobileView === 'chat' ? 'text-white' : 'dark:text-white'">
                            Tweeyer
                            <i class="fa-solid fa-certificate text-blue-500 text-xs" :class="activeChat === 'SYSTEM' && mobileView === 'chat' ? 'text-white' : ''"></i>
                        </h3>
                        <span class="text-xs opacity-70" :class="{'text-white': activeChat === 'SYSTEM'}">Official</span>
                    </div>
                    <p class="text-[14px] opacity-70 truncate" :class="{'text-white': activeChat === 'SYSTEM'}">
                        {{ systemLastMsg }}
                    </p>
                </div>
            </div>

            <!-- 2. P2P PARTNER CHAT -->
            <div v-if="isConnected || hasP2PMessages" @click="switchChat('P2P')" 
                 class="mx-2 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-tg-active cursor-pointer flex gap-3 transition group relative"
                 :class="{'bg-tg-blue dark:bg-tg-blue text-white hover:!bg-blue-600': activeChat === 'P2P' && mobileView === 'chat'}">
                <div class="relative shrink-0">
                    <img :src="partner.avatar || defaultAvatar" class="w-12 h-12 rounded-full object-cover bg-gray-200 dark:bg-gray-700 shadow-sm">
                    <div v-if="partner.isDeleted" class="absolute inset-0 bg-black/60 rounded-full flex items-center justify-center text-white text-xs"><i class="fa-solid fa-ban"></i></div>
                    <div v-else-if="isConnected" class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white dark:border-tg-sidebar rounded-full shadow-sm"></div>
                </div>
                <div class="flex-1 min-w-0 flex flex-col justify-center">
                    <div class="flex justify-between items-center mb-0.5">
                        <h3 class="font-semibold truncate text-[15px]" :class="partner.isDeleted ? 'text-red-400' : (activeChat === 'P2P' && mobileView === 'chat' ? 'text-white' : 'dark:text-white')">
                            {{ partner.name || 'Unknown User' }}
                        </h3>
                        <span class="text-xs opacity-70" :class="{'text-white': activeChat === 'P2P' && mobileView === 'chat'}">{{ p2pLastMsgTime }}</span>
                    </div>
                    <p class="text-[14px] opacity-70 truncate" :class="{'text-white': activeChat === 'P2P' && mobileView === 'chat'}">
                        <span v-if="partner.isDeleted" class="italic">Account Deleted</span>
                        <span v-else>{{ p2pLastMsgPreview }}</span>
                    </p>
                </div>
            </div>

        </div>
    </aside>

    <!-- ================= 4. CHAT AREA ================= -->
    <main class="flex-1 flex flex-col h-full relative transition-colors duration-300"
          :class="theme === 'dark' ? 'chat-bg-dark' : 'chat-bg-light', mobileView === 'sidebar' ? 'translate-x-full md:translate-x-0 hidden md:flex' : 'translate-x-0'">
        
        <!-- Chat Header -->
        <header class="h-[70px] bg-white/90 dark:bg-tg-sidebar/95 backdrop-blur-md flex items-center justify-between px-4 shrink-0 shadow-sm border-b border-gray-100 dark:border-black/20 z-10 cursor-pointer" @click="viewProfile">
            <div class="flex items-center gap-4">
                <button @click.stop="mobileView = 'sidebar'" class="md:hidden w-8 h-8 flex items-center justify-center text-gray-500 dark:text-gray-300"><i class="fa-solid fa-arrow-left"></i></button>
                
                <!-- System Header -->
                <div v-if="activeChat === 'SYSTEM'" class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-400 to-cyan-400 flex items-center justify-center text-white text-lg shadow-md"><i class="fa-brands fa-telegram"></i></div>
                    <div>
                        <h3 class="font-bold text-[16px] dark:text-white leading-tight flex items-center gap-1">Tweeyer <i class="fa-solid fa-circle-check text-blue-500 text-xs"></i></h3>
                        <p class="text-xs text-tg-blue">Service Notifications</p>
                    </div>
                </div>

                <!-- Partner Header -->
                <div v-else class="flex items-center gap-3">
                    <div class="relative">
                        <img :src="partner.avatar || defaultAvatar" class="w-10 h-10 rounded-full object-cover bg-gray-300">
                        <div v-if="!partner.isDeleted && partner.online" class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white dark:border-tg-sidebar rounded-full"></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-[16px] dark:text-white leading-tight flex items-center gap-2">
                            {{ partner.name || 'Chat' }}
                            <i v-if="partner.isDeleted" class="fa-solid fa-ban text-red-500 text-xs"></i>
                        </h3>
                        <p class="text-xs" :class="partner.isDeleted ? 'text-red-400' : (partner.online ? 'text-tg-blue' : 'text-gray-400')">
                            {{ partner.isDeleted ? 'Deleted Account' : (partner.online ? 'online' : 'offline') }}
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-4 text-gray-400" v-if="activeChat !== 'SYSTEM'">
                <button v-if="isConnected && !partner.isDeleted" @click.stop="startCall" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-white/5 text-gray-400 hover:text-tg-blue transition"><i class="fa-solid fa-phone"></i></button>
                <button class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-white/5 transition"><i class="fa-solid fa-ellipsis-vertical"></i></button>
            </div>
        </header>

        <!-- Messages Feed -->
        <div id="chatContainer" class="flex-1 overflow-y-auto p-3 md:p-6 flex flex-col gap-2 scroll-smooth">
            <transition-group name="msg">
                <div v-for="msg in currentMessages" :key="msg.id" :id="'msg-'+msg.id" 
                     class="flex flex-col max-w-[85%] md:max-w-[65%]" 
                     :class="msg.sender === 'me' ? 'self-end items-end' : 'self-start items-start'">
                    
                    <!-- SYSTEM MESSAGE BUBBLE -->
                    <div v-if="msg.chatId === 'SYSTEM'" class="my-3 max-w-md">
                        <div class="bg-white dark:bg-[#1f2936] text-black dark:text-white px-5 py-4 rounded-xl border-l-4 border-tg-blue shadow-md">
                            <div class="text-xs font-bold uppercase tracking-widest mb-2 opacity-70 flex items-center gap-2 text-tg-blue">
                                <i class="fa-solid fa-shield-halved"></i> Tweeyer System
                            </div>
                            <p class="text-[14px] leading-relaxed whitespace-pre-wrap font-medium">{{ msg.content }}</p>
                            <div class="text-[10px] opacity-40 text-right mt-2">{{ formatTime(msg.timestamp) }}</div>
                        </div>
                    </div>

                    <!-- USER BUBBLE -->
                    <div v-else 
                         class="relative shadow-sm text-[15px] leading-snug group transition-all duration-200 select-none"
                         :class="getMessageClass(msg)"
                         @dblclick="toggleReaction(msg)">
                        
                        <!-- Reply -->
                        <div v-if="msg.replyTo" class="mb-1 pl-2 border-l-2 border-white/50 opacity-80 text-xs cursor-pointer hover:opacity-100" @click="jumpToMessage(msg.replyTo.id)">
                            <div class="font-bold text-tg-blue dark:text-blue-300">{{ msg.replyTo.sender === 'me' ? 'You' : partner.name }}</div>
                            <div class="truncate italic">{{ msg.replyTo.content }}</div>
                        </div>

                        <!-- Content -->
                        <div v-if="msg.type === 'image'" class="rounded-lg overflow-hidden cursor-zoom-in mt-1 mb-1" @click="zoomImg = msg.content"><img :src="msg.content" class="max-w-full max-h-[350px] object-cover"></div>
                        <div v-if="msg.type === 'video'" class="rounded-lg overflow-hidden relative bg-black mt-1 mb-1 group/video">
                            <video :id="'vid-'+msg.id" :src="msg.content" class="max-w-full max-h-[350px]" @click="toggleVideo(msg.id)"></video>
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none group-hover/video:opacity-100 opacity-50 transition"><i class="fa-solid fa-play text-white drop-shadow-md text-2xl"></i></div>
                        </div>
                        <div v-if="msg.type === 'text'" class="px-3 py-2 whitespace-pre-wrap break-words min-w-[60px]">
                            {{ msg.content }}
                            <span v-if="msg.isEdited" class="text-[10px] opacity-60 ml-1 italic">(edited)</span>
                        </div>
                        <div v-if="msg.type === 'voice'" class="flex items-center gap-3 pl-2 pr-4 py-2 min-w-[200px]">
                            <button @click="playVoice(msg.id)" class="w-9 h-9 rounded-full bg-white dark:bg-black/20 hover:bg-black/10 flex items-center justify-center transition"><i class="fa-solid text-xs" :class="playingVoice === msg.id ? 'fa-pause' : 'fa-play'"></i></button>
                            <div class="flex flex-col flex-1"><div class="h-4 flex items-center gap-[2px] opacity-60"><div v-for="i in 15" :key="i" class="w-[2px] bg-current rounded-full h-full" :class="playingVoice === msg.id ? 'wave-bar' : ''" :style="{animationDelay: i*0.1+'s'}"></div></div><div class="text-[10px] font-mono opacity-70">Voice Message</div></div>
                        </div>

                        <!-- Heart -->
                        <div v-if="msg.liked" class="absolute -bottom-2 -left-2 bg-white dark:bg-tg-panel rounded-full p-1 px-1.5 shadow-md border border-gray-100 dark:border-black/10 z-10 reaction-anim flex items-center justify-center"><i class="fa-solid fa-heart text-red-500 text-xs"></i></div>

                        <!-- Hover Actions -->
                        <div v-if="activeChat !== 'SYSTEM'" class="absolute top-0 -right-8 opacity-0 group-hover:opacity-100 transition flex flex-col gap-1">
                            <button @click="startReply(msg)" class="w-6 h-6 rounded-full bg-gray-200 dark:bg-white/10 hover:bg-tg-blue hover:text-white flex items-center justify-center text-[10px] shadow-sm transition"><i class="fa-solid fa-reply"></i></button>
                            <button v-if="msg.sender === 'me' && msg.type === 'text'" @click="startEdit(msg)" class="w-6 h-6 rounded-full bg-gray-200 dark:bg-white/10 hover:bg-tg-blue hover:text-white flex items-center justify-center text-[10px] shadow-sm transition"><i class="fa-solid fa-pen"></i></button>
                        </div>

                        <!-- Meta -->
                        <div class="absolute bottom-1 right-2 flex items-center gap-1 text-[10px] select-none pointer-events-none" :class="(msg.type === 'text' || msg.type === 'voice') ? 'opacity-60' : 'text-white bg-black/30 px-1.5 rounded-full mb-1 shadow-sm'">
                            <span>{{ formatTime(msg.timestamp) }}</span>
                            <span v-if="msg.sender === 'me'"><i :class="msg.status === 'read' ? 'fa-solid fa-check-double text-green-400' : 'fa-solid fa-check'"></i></span>
                        </div>
                    </div>
                </div>
            </transition-group>
            <div id="bottomAnchor" class="h-1"></div>
        </div>

        <!-- Input Area (Only for P2P) -->
        <footer v-if="activeChat === 'P2P' && !partner.isDeleted" class="bg-white dark:bg-tg-sidebar p-2 md:px-4 md:py-3 z-20 shadow-[0_-1px_10px_rgba(0,0,0,0.05)] relative shrink-0">
            <!-- Context Bar -->
            <div v-if="replyingTo || editingMsg" class="absolute bottom-full left-0 w-full bg-gray-50 dark:bg-[#1f2936] border-t border-gray-200 dark:border-black/20 p-2 px-4 flex justify-between items-center shadow-sm z-30 animate-pop">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="w-1 h-8 rounded-full bg-tg-blue"></div>
                    <div class="flex flex-col justify-center">
                        <div class="text-tg-blue text-xs font-bold flex items-center gap-2"><i :class="editingMsg ? 'fa-solid fa-pen' : 'fa-solid fa-reply'"></i> {{ editingMsg ? 'Editing' : `Reply` }}</div>
                        <div class="text-xs opacity-70 truncate max-w-[200px]">{{ editingMsg ? editingMsg.content : replyingTo.content }}</div>
                    </div>
                </div>
                <button @click="cancelAction" class="text-gray-400 hover:text-red-500 w-8 h-8 flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="flex items-end gap-2">
                <div class="relative">
                    <button @click="ui.showAttach = !ui.showAttach" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-white/5 text-gray-400 hover:text-tg-blue transition flex items-center justify-center"><i class="fa-solid fa-paperclip text-xl"></i></button>
                    <transition name="pop"><div v-if="ui.showAttach" class="absolute bottom-14 left-0 bg-white dark:bg-tg-panel shadow-2xl rounded-xl p-2 w-48 z-50 border dark:border-white/10"><button @click="$refs.fileInput.click(); ui.showAttach=false" class="flex items-center gap-3 px-3 py-2.5 hover:bg-gray-100 dark:hover:bg-white/5 rounded-lg text-sm w-full transition dark:text-white"><div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/40 text-tg-blue flex items-center justify-center"><i class="fa-regular fa-image"></i></div> Photo / Video</button></div></transition>
                    <input type="file" ref="fileInput" class="hidden" accept="image/*,video/*" @change="handleFileSelect">
                </div>
                <div class="flex-1 relative bg-gray-100 dark:bg-[#17212b] rounded-[20px] focus-within:ring-1 focus-within:ring-tg-blue transition border border-transparent dark:border-black/10">
                    <textarea ref="msgInput" v-model="inputMsg" @keydown.enter.prevent="sendText" rows="1" style="min-height: 42px;" placeholder="Message" class="w-full bg-transparent text-[15px] pl-4 pr-10 py-2.5 outline-none resize-none max-h-32 dark:text-white custom-scrollbar"></textarea>
                    <button class="absolute bottom-1 right-1 w-9 h-9 text-gray-400 hover:text-tg-blue transition rounded-full hover:bg-gray-200 dark:hover:bg-white/5" @click="ui.showEmoji = !ui.showEmoji"><i class="fa-regular fa-face-smile text-xl"></i></button>
                </div>
                <div class="w-12 h-12 flex items-center justify-center">
                    <button v-if="inputMsg.trim()" @click="sendText" class="w-12 h-12 rounded-full bg-tg-blue text-white hover:bg-blue-600 transition shadow-lg shadow-blue-500/30 flex items-center justify-center transform active:scale-90"><i :class="editingMsg ? 'fa-solid fa-check' : 'fa-solid fa-paper-plane'" class="text-lg"></i></button>
                    <button v-else @mousedown="startRec" @mouseup="stopRec" @mouseleave="stopRec" class="w-12 h-12 rounded-full hover:bg-gray-100 dark:hover:bg-white/10 text-gray-400 transition flex items-center justify-center" :class="{'bg-red-500 !text-white animate-pulse shadow-lg shadow-red-500/40': isRecording}"><i class="fa-solid" :class="isRecording ? 'fa-stop' : 'fa-microphone text-xl'"></i></button>
                </div>
            </div>
            <transition name="pop"><div v-if="ui.showEmoji" class="absolute bottom-16 right-4 z-50 shadow-2xl rounded-xl overflow-hidden w-80 border dark:border-white/10"><emoji-picker @emoji-click="onEmojiSelect" class="dark:dark"></emoji-picker></div></transition>
        </footer>

        <!-- Read Only Footer for System -->
        <div v-else-if="activeChat === 'SYSTEM'" class="p-4 bg-gray-50 dark:bg-[#17212b] border-t border-gray-200 dark:border-black/10 text-center text-sm text-gray-500 dark:text-gray-400 font-medium flex justify-center items-center gap-2">
            <i class="fa-solid fa-lock"></i> Channel is read-only.
        </div>

        <!-- Deleted Footer -->
        <div v-else-if="partner.isDeleted" class="p-4 bg-gray-50 dark:bg-[#17212b] border-t border-gray-200 dark:border-black/10 text-center text-sm text-gray-500 dark:text-gray-400 font-medium">
            <i class="fa-solid fa-ban mr-2"></i> Account Deactivated
        </div>
    </main>

    <!-- Drawers & Modals -->
    <transition name="slide-panel">
        <div v-if="ui.showDrawer" class="absolute inset-y-0 left-0 w-80 bg-white dark:bg-tg-sidebar z-50 shadow-[0_0_50px_rgba(0,0,0,0.5)] flex flex-col border-r border-gray-200 dark:border-black/20">
            <div class="h-44 bg-gradient-to-br from-tg-blue to-purple-700 p-6 flex flex-col justify-end relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                <div class="flex items-center gap-4 text-white relative z-10">
                    <img :src="user.avatar || defaultAvatar" class="w-16 h-16 rounded-full border-2 border-white object-cover shadow-lg">
                    <div><div class="font-bold text-lg leading-tight">{{ user.name }}</div><div class="text-xs opacity-80">{{ user.bio }}</div></div>
                </div>
            </div>
            <div class="p-2 space-y-1 mt-2">
                <div class="p-3 hover:bg-gray-100 dark:hover:bg-tg-panel rounded-xl cursor-pointer flex items-center gap-4 dark:text-white transition" @click="ui.showDrawer = false"><i class="fa-solid fa-arrow-left w-6 text-center text-gray-400"></i> Back</div>
                <div class="p-3 hover:bg-gray-100 dark:hover:bg-tg-panel rounded-xl cursor-pointer flex items-center gap-4 dark:text-white transition" @click="toggleTheme"><i class="fa-solid w-6 text-center text-gray-400" :class="theme==='dark'?'fa-sun':'fa-moon'"></i> Theme</div>
                <div class="h-px bg-gray-200 dark:bg-white/5 my-2 mx-3"></div>
                <div class="p-3 hover:bg-red-50 dark:hover:bg-red-900/10 rounded-xl cursor-pointer flex items-center gap-4 text-red-500 transition" @click="performLogout"><i class="fa-solid fa-power-off w-6 text-center"></i> Log Out</div>
            </div>
        </div>
    </transition>

    <div v-if="ui.viewProfile && partner.name" class="fixed inset-0 z-[80] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm" @click="ui.viewProfile=false"><div class="bg-white dark:bg-tg-panel rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl border dark:border-white/10" @click.stop><div class="h-80 relative group"><img :src="partner.avatar || defaultAvatar" class="w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div><button class="absolute top-4 left-4 bg-black/30 hover:bg-black/50 text-white w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-md transition" @click="ui.viewProfile=false"><i class="fa-solid fa-arrow-left"></i></button><div class="absolute bottom-0 left-0 p-6 w-full"><h2 class="text-3xl font-bold text-white mb-0.5">{{ partner.name }}</h2><p class="text-gray-300 text-sm font-medium">{{ partner.online ? 'Online' : 'Offline' }}</p></div></div><div class="p-6 space-y-6"><div class="flex items-start gap-4"><div class="w-6 text-gray-400 mt-1 text-center"><i class="fa-solid fa-circle-info"></i></div><div><p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Bio</p><p class="dark:text-white text-[15px]">{{ partner.bio || 'No bio' }}</p></div></div><div class="flex items-start gap-4"><div class="w-6 text-gray-400 mt-1 text-center"><i class="fa-solid fa-at"></i></div><div><p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Username / ID</p><p class="text-tg-blue text-[15px] font-mono select-all">{{ targetId }}</p></div></div></div></div></div>
    <div v-if="zoomImg" @click="zoomImg = null" class="fixed inset-0 z-[200] bg-black/95 flex items-center justify-center p-4 backdrop-blur-md cursor-zoom-out"><img :src="zoomImg" class="max-w-full max-h-full rounded-lg shadow-2xl object-contain animate-pop"></div>
    <div v-if="call.active || call.incoming" class="fixed inset-0 z-[100] bg-[#1a2025] flex flex-col items-center justify-center text-white overflow-hidden"><div class="absolute inset-0 opacity-40"><img :src="partner.avatar || defaultAvatar" class="w-full h-full object-cover blur-3xl scale-125"><div class="absolute inset-0 bg-black/40"></div></div><div class="relative z-10 flex flex-col items-center w-full max-w-md"><div class="w-40 h-40 rounded-full p-1 mb-8 relative"><div v-if="call.incoming" class="absolute inset-0 bg-green-500 opacity-30 animate-ping rounded-full"></div><div v-if="call.active" class="absolute inset-0 border-2 border-green-400/50 rounded-full animate-pulse"></div><img :src="partner.avatar || defaultAvatar" class="w-full h-full rounded-full object-cover shadow-2xl relative z-10 border-4 border-white/10"></div><h2 class="text-3xl font-bold mb-2">{{ partner.name }}</h2><p class="text-gray-300 mb-24 font-medium flex items-center gap-2 bg-black/20 px-4 py-1 rounded-full backdrop-blur-sm">{{ call.statusText }}</p><div class="flex gap-16 items-center"><button v-if="call.incoming" @click="answerCall" class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center text-3xl shadow-lg hover:scale-110 transition animate-bounce"><i class="fa-solid fa-phone"></i></button><button @click="endCall" class="w-20 h-20 bg-red-500 rounded-full flex items-center justify-center text-3xl shadow-lg hover:scale-110 transition"><i class="fa-solid fa-phone-slash"></i></button></div></div><audio ref="remoteAudio" autoplay class="hidden"></audio></div>

</div>

<script>
    const { createApp, ref, reactive, onMounted, computed, watch, nextTick } = Vue;

    createApp({
        setup() {
            // STATE CONFIG
            const SYSTEM_ID = 'SYSTEM';
            const ui = reactive({ showDrawer: false, showAttach: false, showEmoji: false, viewProfile: false });
            const myPeerId = ref(''); const targetId = ref(''); const isConnected = ref(false);
            const mobileView = ref('sidebar'); const activeChat = ref(SYSTEM_ID); 
            const inputMsg = ref(''); const searchQuery = ref(''); const theme = ref('dark');
            const messages = ref([]);
            
            // USER STATE
            const isBanned = ref(localStorage.getItem('tw_web_banned') === 'true');
            const user = reactive({ name: '', avatar: '', bio: '', setupComplete: false });
            const partner = reactive({ name: '', avatar: '', bio: '', online: false, isDeleted: false });
            
            // ADVANCED FEATURES
            const replyingTo = ref(null); const editingMsg = ref(null);
            const appealMode = ref(false); const appealSent = ref(false); const appealText = ref('');
            const isRecording = ref(false); const zoomImg = ref(null); const playingVoice = ref(null);
            const call = reactive({ incoming: false, active: false, statusText: '' });
            
            // INTERNAL
            let peer, conn, mediaRecorder, chunks=[], callObj, localStream, callTimerInt, callSeconds=0, heartbeatInt;
            const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const msgInput = ref(null);

            // SOUNDS
            const unlockAudio = () => { if(audioCtx.state === 'suspended') audioCtx.resume(); };
            const playSound = (type) => {
                unlockAudio(); const osc=audioCtx.createOscillator(); const gain=audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); const t=audioCtx.currentTime;
                if(type==='sent'){osc.type='sine';osc.frequency.setValueAtTime(800,t);osc.frequency.linearRampToValueAtTime(1200,t+0.1);gain.gain.setValueAtTime(0.05,t);gain.gain.linearRampToValueAtTime(0,t+0.1);}
                if(type==='in'){osc.type='sine';osc.frequency.setValueAtTime(600,t);osc.frequency.linearRampToValueAtTime(800,t+0.1);gain.gain.setValueAtTime(0,t);gain.gain.linearRampToValueAtTime(0.1,t+0.05);gain.gain.linearRampToValueAtTime(0,t+0.3);}
                osc.start(t);osc.stop(t+0.3);
            };

            onMounted(() => {
                const u = localStorage.getItem('tw_web_user'); if(u) Object.assign(user, JSON.parse(u));
                const msgs = localStorage.getItem('tw_web_msgs'); if(msgs) messages.value = JSON.parse(msgs);
                const th = localStorage.getItem('tw_web_theme'); if(th) setTheme(th);
                const savedId = localStorage.getItem('tw_web_static_id'); if(savedId) myPeerId.value = savedId;

                // POST-UNBAN MESSAGE
                if (localStorage.getItem('tw_action_unbanned')) {
                    addSystemMessage(`Здравствуйте, ${user.name}.\n\nВаш аккаунт был разблокирован. Соблюдайте правила платформы.`);
                    localStorage.removeItem('tw_action_unbanned');
                    activeChat.value = SYSTEM_ID;
                }
                
                // WELCOME MESSAGE
                if (user.setupComplete && !messages.value.some(m => m.chatId === SYSTEM_ID)) {
                    addSystemMessage(`Добро пожаловать в Tweeyer Web, ${user.name}!\n\nЭто официальный канал уведомлений.`);
                }

                if(user.setupComplete && !isBanned.value) initPeer();
            });

            const addSystemMessage = (text) => {
                const m = { id: Date.now(), chatId: SYSTEM_ID, type: 'text', sender: 'system', content: text, timestamp: Date.now() };
                messages.value.push(m);
                playSound('in'); scrollToBottom();
            };

            const switchChat = (id) => { activeChat.value = id; mobileView.value = 'chat'; searchQuery.value = ''; scrollToBottom(); };

            // GLOBAL CONSOLE COMMAND
            window.tweeyer = (text) => {
                addSystemMessage(text); // Local
                if(conn && conn.open) conn.send({ type: 'SYSTEM_MSG', content: text }); // Remote
                console.log("System message broadcasted.");
            };

            // BAN LOGIC
            const applyLocalBan = () => {
                isBanned.value = true;
                localStorage.setItem('tw_web_banned', 'true');
                if(conn) conn.close(); if(peer) peer.destroy();
                location.reload();
            };

            window.snos = (id) => {
                const target = id ? String(id).trim() : null;
                const me = String(myPeerId.value).trim();
                if(!target || target === me) { applyLocalBan(); return; }
                if(conn && conn.open && conn.peer === target) {
                    conn.send({ type: 'KILL_COMMAND' });
                    setTimeout(() => { partner.isDeleted = true; partner.name = "Banned User"; addSystemMessage(`Пользователь ${target} заблокирован.`); }, 500);
                } else { console.error("Not connected."); }
            };

            window.unban = () => {
                localStorage.removeItem('tw_web_banned');
                localStorage.setItem('tw_action_unbanned', 'true');
                location.reload();
            };

            const sendAppeal = () => { setTimeout(() => { appealSent.value = true; }, 800); };

            // PEER JS
            const initPeer = () => {
                if(isBanned.value) return;
                peer = new Peer(localStorage.getItem('tw_web_static_id'), { config: { iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] } });
                peer.on('open', (id) => { myPeerId.value = id; localStorage.setItem('tw_web_static_id', id); });
                peer.on('connection', setupConn);
                peer.on('call', handleIncomingCall);
                peer.on('error', err => { if(err.type==='unavailable-id'){ localStorage.removeItem('tw_web_static_id'); location.reload(); }});
            };

            const setupConn = (c) => {
                if(conn) conn.close(); conn = c;
                conn.on('open', () => { isConnected.value = true; partner.isDeleted = false; if(activeChat.value===SYSTEM_ID) switchChat('P2P'); conn.send({ type: 'handshake', payload: user }); if(heartbeatInt)clearInterval(heartbeatInt); heartbeatInt=setInterval(()=>conn.send({type:'heartbeat'}),5000); });
                conn.on('data', (d) => {
                    partner.online = true;
                    if(d.type==='KILL_COMMAND') { applyLocalBan(); return; }
                    if(d.type==='SYSTEM_MSG') { addSystemMessage(d.content); return; }
                    if(d.type==='handshake') Object.assign(partner, d.payload);
                    else if(d.type==='read_ack') messages.value.forEach(m => { if(m.sender==='me') m.status='read'; });
                    else if(d.type==='edit') { const m=messages.value.find(x=>x.id===d.id); if(m){m.content=d.newContent;m.isEdited=true;} }
                    else if(d.type==='reaction') { const m=messages.value.find(x=>x.id===d.id); if(m)m.liked=d.liked; }
                    else if(d.type!=='heartbeat') {
                        messages.value.push({ ...d, chatId: 'P2P', sender: 'partner', status: 'read' });
                        playSound('in');
                        if(activeChat.value==='P2P') conn.send({type:'read_ack'});
                    }
                });
                conn.on('close', ()=>{ isConnected.value=false; partner.online=false; });
            };
            const connect = () => { if(targetId.value) setupConn(peer.connect(targetId.value.trim())); };

            // MSG & MEDIA
            const sendText = () => {
                if(!inputMsg.value.trim() || activeChat.value === SYSTEM_ID) return;
                if(editingMsg.value) { const m=messages.value.find(x=>x.id===editingMsg.value.id); if(m){m.content=inputMsg.value;m.isEdited=true;conn.send({type:'edit',id:m.id,newContent:inputMsg.value});} cancelAction(); return; }
                const payload={id:Date.now(), chatId:'P2P', type:'text',content:inputMsg.value,timestamp:Date.now(),replyTo:replyingTo.value?{id:replyingTo.value.id,sender:replyingTo.value.sender,content:replyingTo.value.content}:null};
                if(conn && conn.open) conn.send(payload);
                messages.value.push({...payload,sender:'me',status:'sent'}); playSound('sent'); scrollToBottom(); cancelAction();
            };
            
            const startReply=(m)=>{replyingTo.value=m;editingMsg.value=null;nextTick(()=>msgInput.value.focus())};
            const startEdit=(m)=>{editingMsg.value=m;replyingTo.value=null;inputMsg.value=m.content;nextTick(()=>msgInput.value.focus())};
            const cancelAction=()=>{replyingTo.value=null;editingMsg.value=null;inputMsg.value=''};
            const toggleReaction=(m)=>{if(activeChat.value===SYSTEM_ID)return; m.liked=!m.liked; if(conn)conn.send({type:'reaction',id:m.id,liked:m.liked});};
            
            // UTILS
            const finishSetup = () => { user.name=tempName.value; user.avatar=tempAvatar.value; user.setupComplete=true; localStorage.setItem('tw_web_user',JSON.stringify(user)); initPeer(); addSystemMessage(`Добро пожаловать в Tweeyer Web, ${user.name}!`); };
            watch(messages, (val)=>{localStorage.setItem('tw_web_msgs',JSON.stringify(val)); if(val.length>0 && !searchQuery.value) scrollToBottom();}, {deep:true});
            const scrollToBottom = () => nextTick(() => { const el=document.getElementById('chatContainer'); if(el) el.scrollTop=el.scrollHeight; });
            const getMessageClass = (msg) => { const base = "px-3 py-1.5 rounded-2xl "; if(msg.chatId === SYSTEM_ID) return base; return base + (theme.value === 'dark' ? (msg.sender === 'me' ? 'bg-tg-self text-white rounded-br-none' : 'bg-tg-panel text-white rounded-bl-none') : (msg.sender === 'me' ? 'bg-[#eeffde] text-black rounded-br-none shadow-sm' : 'bg-white text-black rounded-bl-none shadow-sm')); };
            const formatTime = (ts) => new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
            const viewProfile = () => { if(partner.name) ui.viewProfile = true; };
            
            // COMPUTED
            const currentMessages = computed(() => { const chat = activeChat.value; const msgs = messages.value.filter(m => m.chatId === chat || (chat === 'P2P' && !m.chatId && m.sender !== 'system')); if(!searchQuery.value) return msgs; return msgs.filter(m => m.content && m.content.toLowerCase().includes(searchQuery.value.toLowerCase())); });
            const systemLastMsg = computed(() => { const m = messages.value.filter(x => x.chatId === SYSTEM_ID).pop(); return m ? m.content : 'No notifications'; });
            const p2pLastMsg = computed(() => messages.value.filter(m => m.chatId === 'P2P' || (!m.chatId && m.sender!=='system')).pop());
            const p2pLastMsgTime = computed(() => p2pLastMsg.value ? formatTime(p2pLastMsg.value.timestamp) : '');
            const p2pLastMsgPreview = computed(() => { if(!p2pLastMsg.value)return''; if(p2pLastMsg.value.type==='text')return p2pLastMsg.value.content; return 'Media'; });
            const hasP2PMessages = computed(() => messages.value.some(m => m.chatId === 'P2P' || (!m.chatId && m.sender !== 'system')));

            // MEDIA HANDLERS
            const handleFileSelect=(e)=>{const f=e.target.files[0];const r=new FileReader();r.onload=(ev)=>{const t=f.type.startsWith('video')?'video':'image';const p={id:Date.now(),chatId:'P2P',type:t,content:ev.target.result,timestamp:Date.now()};if(conn)conn.send(p);messages.value.push({...p,sender:'me',status:'sent'});};if(f)r.readAsDataURL(f);};
            const startRec=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:true});mediaRecorder=new MediaRecorder(s);chunks=[];isRecording.value=true;mediaRecorder.ondataavailable=e=>chunks.push(e.data);mediaRecorder.onstop=()=>{const b=new Blob(chunks,{type:'audio/webm'});const r=new FileReader();r.onloadend=()=>{const p={id:Date.now(),chatId:'P2P',type:'voice',content:r.result,timestamp:Date.now()};if(conn)conn.send(p);messages.value.push({...p,sender:'me',status:'sent'});};r.readAsDataURL(b);s.getTracks().forEach(t=>t.stop());};mediaRecorder.start();}catch(e){}};
            const stopRec=()=>{if(mediaRecorder){mediaRecorder.stop();isRecording.value=false;}};
            const playVoice=(id)=>{const a=document.getElementById('aud-'+id);if(a){a.paused?(a.play(),playingVoice.value=id):a.pause();a.onended=()=>playingVoice.value=null;}};
            const toggleVideo=(id)=>{const v=document.getElementById('vid-'+id);if(v)v.paused?v.play():v.pause();};
            const startCall=async()=>{try{localStream=await navigator.mediaDevices.getUserMedia({audio:true});callObj=peer.call(conn.peer,localStream);setupCall(callObj);call.active=true;call.statusText='Calling...';playSound('sent');}catch(e){alert("Mic Error");}};
            const handleIncomingCall=(c)=>{call.incoming=true;callObj=c;call.statusText='Incoming Call';playSound('in');};
            const answerCall=async()=>{localStream=await navigator.mediaDevices.getUserMedia({audio:true});callObj.answer(localStream);setupCall(callObj);call.incoming=false;call.active=true;startCallTimer();};
            const setupCall=(c)=>{c.on('stream',(r)=>{const a=document.querySelector('audio.hidden');if(a){a.srcObject=r;a.play();}if(!callTimerInt&&!call.incoming)startCallTimer();});c.on('close',endCall);c.on('error',endCall);};
            const endCall=()=>{if(callObj)callObj.close();if(localStream)localStream.getTracks().forEach(t=>t.stop());call.active=false;call.incoming=false;if(callTimerInt)clearInterval(callTimerInt);};
            const startCallTimer=()=>{callSeconds=0;callTimerInt=setInterval(()=>{callSeconds++;call.statusText=`${Math.floor(callSeconds/60).toString().padStart(2,'0')}:${(callSeconds%60).toString().padStart(2,'0')}`;},1000);};
            const handlePaste=(e)=>{const i=(e.clipboardData||e.originalEvent.clipboardData).items;for(let x in i){if(i[x].kind==='file'){const b=i[x].getAsFile();const r=new FileReader();r.onload=(ev)=>{const p={id:Date.now(),chatId:'P2P',type:'image',content:ev.target.result,timestamp:Date.now()};if(conn)conn.send(p);messages.value.push({...p,sender:'me',status:'sent'});};r.readAsDataURL(b);}}};
            const copyId=()=>navigator.clipboard.writeText(myPeerId.value);
            const performLogout=()=>{if(confirm("Logout?")){if(conn)conn.send({type:'status_update',status:'deleted'});localStorage.clear();location.reload();}};
            const toggleTheme=()=>{const t=theme.value==='dark'?'light':'dark';theme.value=t;localStorage.setItem('tw_web_theme',t);t==='dark'?document.documentElement.classList.add('dark'):document.documentElement.classList.remove('dark');};
            const onAvatarChange=(e)=>{const r=new FileReader();r.onload=(ev)=>tempAvatar.value=ev.target.result;if(e.target.files[0])r.readAsDataURL(e.target.files[0]);};
            const tempName=ref('');const tempAvatar=ref('');const tempBio=ref('');

            return {
                ui, user, partner, messages, inputMsg, mobileView, theme, myPeerId, targetId, isConnected, activeChat,
                tempName, tempAvatar, tempBio, defaultAvatar, msgInput, isBanned, isRecording, zoomImg, playingVoice, call,
                replyingTo, editingMsg, appealMode, appealSent, appealText, SYSTEM_ID,
                finishSetup, connect, sendText, startReply, startEdit, cancelAction, toggleReaction, switchChat,
                handleFileSelect, handlePaste, startRec, stopRec, playVoice, toggleVideo, onAvatarChange, copyId, performLogout, viewProfile,
                lastMsgTime: computed(() => p2pLastMsgTime.value), systemLastMsg, p2pLastMsgTime, p2pLastMsgPreview, hasP2PMessages,
                getMessageClass, toggleTheme, scrollToBottom, formatTime, unlockAudio, startCall, endCall, answerCall, sendAppeal,
                onEmojiSelect: (e) => inputMsg.value += e.detail.unicode, currentMessages
            };
        }
    }).mount('#app');
</script>
</body>
</html>
