<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Audio Cloud Admin | Sync Radio</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root { --bg: #0a0a0c; --card: #141417; --accent: #3b82f6; --text: #e2e8f0; --border: #2d2d35; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; display: flex; justify-content: center; padding: 20px; }
        .container { width: 100%; max-width: 600px; background: var(--card); padding: 30px; border-radius: 12px; border: 1px solid var(--border); }
        input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid var(--border); background: #0a0a0c; color: #fff; box-sizing: border-box; }
        button { background: var(--accent); cursor: pointer; font-weight: bold; border: none; }
        .song-item { padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; font-size: 13px; }
        .radio-link { background: #1e293b; padding: 10px; border-radius: 5px; color: #4ade80; font-family: monospace; font-size: 12px; word-break: break-all; }
    </style>
</head>
<body>

<div class="container">
    <h2>Radio Admin Panel</h2>
    <p style="color: #94a3b8; font-size: 12px;">Загружай музыку, и она будет играть в синхронном эфире.</p>
    
    <input type="text" id="token" placeholder="GitHub Access Token" onchange="saveToken()">
    <input type="file" id="audioFile" accept="audio/*">
    <button id="uploadBtn" onclick="handleUpload()">Загрузить в эфир</button>

    <div id="status"></div>

    <h3>Ваша ссылка на радио (для CEF/браузера):</h3>
    <div class="radio-link" id="radioLink">Загрузите токен...</div>

    <div class="library-section">
        <h3>Список песен в эфире:</h3>
        <div id="songList"></div>
    </div>
</div>

<script>
    const USER = 'shadexqz'; // ТВОЙ НИК ГИТХАБ
    const REPO = 'shadexqz.github.io'; // ТВОЙ РЕПОЗИТОРИЙ
    const FOLDER = 'Music';

    document.getElementById('token').value = localStorage.getItem('gh_token') || '';
    document.getElementById('radioLink').innerText = `https://${USER}.github.io/radio.html`;

    function saveToken() { localStorage.setItem('gh_token', document.getElementById('token').value); }

    const getDuration = (file) => new Promise((resolve) => {
        const audio = new Audio();
        audio.src = URL.createObjectURL(file);
        audio.onloadedmetadata = () => resolve(Math.round(audio.duration));
    });

    async function handleUpload() {
        const token = document.getElementById('token').value;
        const fileInput = document.getElementById('audioFile');
        if (!token || !fileInput.files[0]) return alert('Нужен токен и файл!');

        const file = fileInput.files[0];
        const btn = document.getElementById('uploadBtn');
        const status = document.getElementById('status');
        btn.disabled = true;
        status.innerText = "Измеряем длину и загружаем...";

        try {
            const duration = await getDuration(file);
            const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
            const path = `${FOLDER}/${fileName}`;

            // 1. Загрузка MP3
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const content = reader.result.split(',')[1];
                await axios.put(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`, {
                    message: "Add song to radio",
                    content: content
                }, { headers: { Authorization: `token ${token}` } });

                // 2. Обновление плейлиста
                await updatePlaylist(token, { name: file.name, url: fileName, duration });
                alert('Готово! Песня в эфире.');
                location.reload();
            };
        } catch (err) {
            alert('Ошибка: ' + err.message);
        } finally { btn.disabled = false; }
    }

    async function updatePlaylist(token, newSong) {
        const path = 'playlist.json';
        let sha = '';
        let songs = [];
        try {
            const res = await axios.get(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`, {
                headers: { Authorization: `token ${token}` }
            });
            sha = res.data.sha;
            songs = JSON.parse(atob(res.data.content));
        } catch (e) {}

        songs.push(newSong);
        await axios.put(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`, {
            message: "Update radio playlist",
            content: btoa(JSON.stringify(songs)),
            sha: sha
        }, { headers: { Authorization: `token ${token}` } });
    }

    async function loadSongs() {
        try {
            const res = await axios.get(`https://raw.githubusercontent.com/${USER}/${REPO}/main/playlist.json?t=` + Date.now());
            document.getElementById('songList').innerHTML = res.data.map(s => `
                <div class="song-item"><span>${s.name}</span> <b>${s.duration} сек.</b></div>
            `).join('');
        } catch (e) {}
    }
    loadSongs();
</script>
</body>
</html>
