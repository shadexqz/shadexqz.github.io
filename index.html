<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tweeyer</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Emoji Picker -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Manrope', 'sans-serif'] },
                    colors: {
                        tw: {
                            bg: '#0f172a',      // Slate 900
                            sidebar: '#1e293b',  // Slate 800
                            panel: '#334155',    // Slate 700
                            primary: '#6366f1',  // Indigo 500
                            accent: '#8b5cf6',   // Violet 500
                            text: '#f8fafc',     // Slate 50
                            hint: '#94a3b8'      // Slate 400
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        }
                    }
                }
            }
        };
    </script>

    <style>
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.3); border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
        ::-webkit-scrollbar-thumb:hover { background: rgba(99, 102, 241, 0.8); }

        /* Smooth Transitions */
        .pop-enter-active, .pop-leave-active { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .pop-enter-from, .pop-leave-to { opacity: 0; transform: scale(0.95) translateY(10px); }

        .slide-panel-enter-active, .slide-panel-leave-active { transition: transform 0.3s ease; }
        .slide-panel-enter-from, .slide-panel-leave-to { transform: translateX(-100%); }

        .toast-enter-active, .toast-leave-active { transition: all 0.4s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateX(50px); }

        /* Emoji Picker Customization */
        emoji-picker {
            width: 100%;
            height: 320px;
            --background: #ffffff;
            --border-color: #e2e8f0;
        }
        .dark emoji-picker {
            --background: #1e293b;
            --border-color: #0f172a;
            --color: #f8fafc;
            --indicator-color: #6366f1;
        }

        /* Audio Waveform Animation */
        .wave-bar { animation: wave 1s infinite ease-in-out; }
        @keyframes wave { 0%, 100% { height: 20%; } 50% { height: 100%; } }
        
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-[#0b1120] text-gray-900 dark:text-tw-text h-[100dvh] w-screen overflow-hidden text-[15px] select-none">

<div id="app" v-cloak class="h-full flex relative font-sans" @paste="handlePaste" @click="unlockAudio">

    <!-- ================= CUSTOM TOAST NOTIFICATIONS ================= -->
    <div class="fixed top-6 right-6 z-[150] flex flex-col gap-3 pointer-events-none">
        <transition-group name="toast">
            <div v-for="notif in notifications" :key="notif.id" 
                 class="pointer-events-auto bg-white dark:bg-tw-panel text-gray-800 dark:text-white px-5 py-3 rounded-xl shadow-2xl shadow-black/20 flex items-center gap-3 border-l-4 min-w-[300px] backdrop-blur-md"
                 :class="notif.type === 'error' ? 'border-red-500' : 'border-tw-primary'">
                <div class="text-xl" :class="notif.type === 'error' ? 'text-red-500' : 'text-tw-primary'">
                    <i :class="notif.icon"></i>
                </div>
                <div class="flex-1">
                    <h4 class="font-bold text-sm leading-tight">{{ notif.title }}</h4>
                    <p class="text-xs opacity-70">{{ notif.text }}</p>
                </div>
            </div>
        </transition-group>
    </div>

    <!-- ================= SETUP / LOGIN SCREEN ================= -->
    <div v-if="!user.setupComplete" class="absolute inset-0 z-[60] bg-gray-50 dark:bg-[#0b1120] flex items-center justify-center p-4">
        <!-- Animated Background -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="absolute top-1/4 left-1/4 w-[500px] h-[500px] bg-tw-primary/20 rounded-full mix-blend-multiply filter blur-[100px] animate-float"></div>
            <div class="absolute bottom-1/4 right-1/4 w-[400px] h-[400px] bg-tw-accent/20 rounded-full mix-blend-multiply filter blur-[80px] animate-float" style="animation-delay: 2s"></div>
        </div>

        <div class="w-full max-w-sm text-center relative z-10 backdrop-blur-xl bg-white/70 dark:bg-tw-sidebar/50 p-8 rounded-[30px] border border-white/20 dark:border-white/5 shadow-2xl">
            <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-tr from-tw-primary to-tw-accent rounded-2xl flex items-center justify-center shadow-lg transform rotate-6 hover:rotate-0 transition duration-500">
                <i class="fa-solid fa-bolt text-4xl text-white"></i>
            </div>
            <h1 class="text-4xl font-extrabold mb-2 dark:text-white tracking-tight">Tweeyer</h1>
            <p class="text-gray-500 dark:text-gray-400 mb-8 font-medium">Next Gen Messaging</p>

            <div class="space-y-6">
                <div class="relative w-32 h-32 mx-auto group cursor-pointer" @click="$refs.avaInput.click()">
                    <img :src="tempAvatar || defaultAvatar" class="w-full h-full rounded-full object-cover shadow-2xl border-4 border-white dark:border-tw-panel transition transform group-hover:scale-105">
                    <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-white backdrop-blur-[2px]">
                        <i class="fa-solid fa-camera text-2xl"></i>
                    </div>
                </div>
                <input type="file" ref="avaInput" class="hidden" accept="image/*" @change="onAvatarChange">

                <div class="space-y-4">
                    <input v-model="tempName" placeholder="Your Name" class="w-full bg-white dark:bg-tw-bg/80 px-5 py-4 rounded-2xl outline-none focus:ring-2 focus:ring-tw-primary text-center dark:text-white transition shadow-sm font-bold text-lg">
                    <input v-model="tempBio" placeholder="Bio (Optional)" class="w-full bg-transparent border-b-2 border-gray-200 dark:border-gray-700 px-2 py-2 outline-none text-center text-sm dark:text-gray-400 focus:border-tw-primary transition">
                </div>
                
                <button @click="finishSetup" :disabled="!tempName" class="w-full bg-tw-primary hover:bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-500/30 transition transform hover:-translate-y-1 active:scale-95 disabled:opacity-50 disabled:transform-none">
                    Get Started
                </button>
            </div>
        </div>
    </div>

    <!-- ================= LEFT SIDEBAR ================= -->
    <aside class="w-full md:w-[400px] bg-white dark:bg-tw-sidebar border-r border-gray-200 dark:border-white/5 flex flex-col z-20 absolute md:relative h-full transition-transform duration-300"
           :class="mobileView === 'chat' ? '-translate-x-full md:translate-x-0' : 'translate-x-0'">
        
        <!-- Header -->
        <div class="h-[80px] px-6 flex items-center justify-between shrink-0 bg-white dark:bg-tw-sidebar z-20">
            <div class="flex items-center gap-3 cursor-pointer" @click="ui.showDrawer = true">
                <img :src="user.avatar || defaultAvatar" class="w-10 h-10 rounded-full object-cover border-2 border-white dark:border-tw-panel shadow-sm">
                <h1 class="font-bold text-xl dark:text-white tracking-tight">Tweeyer</h1>
            </div>
            <button @click="ui.showDrawer = true" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-white/5 flex items-center justify-center text-gray-500 dark:text-gray-400 transition">
                <i class="fa-solid fa-bars-staggered"></i>
            </button>
        </div>

        <!-- Connection Widget -->
        <div class="px-6 pb-6">
            <div class="bg-gray-50 dark:bg-[#162032] rounded-2xl p-5 border border-gray-100 dark:border-white/5 shadow-inner">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-[10px] font-bold text-tw-primary uppercase tracking-widest">My Tweeyer ID</span>
                    <button @click="copyId" class="text-tw-primary hover:text-white hover:bg-tw-primary px-3 py-1 rounded-full text-[10px] font-bold transition">COPY</button>
                </div>
                <div class="text-xs font-mono text-gray-600 dark:text-gray-300 break-all select-all mb-4 bg-white dark:bg-black/20 p-3 rounded-xl border border-gray-200 dark:border-white/5">{{ myPeerId || 'Generating...' }}</div>
                
                <div class="flex gap-2 relative">
                    <input v-model="targetIdInput" placeholder="Enter Friend's ID" class="flex-1 bg-white dark:bg-tw-bg rounded-xl px-4 py-3 text-sm outline-none dark:text-white border border-gray-200 dark:border-white/5 focus:border-tw-primary transition shadow-sm font-mono">
                    <button @click="connectToUser" :disabled="!isNetReady" class="absolute right-1 top-1 bottom-1 w-10 bg-tw-primary text-white rounded-lg flex items-center justify-center hover:bg-indigo-600 active:scale-95 transition">
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Active Chat Indicator / Empty State -->
        <div class="flex-1 overflow-y-auto px-4">
            <h3 class="px-2 text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">Current Chat</h3>
            
            <div v-if="isConnected" @click="mobileView = 'chat'" 
                 class="p-4 rounded-2xl bg-gradient-to-r from-tw-primary to-tw-accent text-white shadow-lg shadow-indigo-500/20 cursor-pointer flex gap-4 items-center transition transform hover:scale-[1.02]">
                <div class="relative shrink-0">
                    <img :src="partner.avatar || defaultAvatar" class="w-12 h-12 rounded-full object-cover border-2 border-white/20">
                    <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 border-2 border-tw-primary rounded-full"></div>
                </div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-bold text-lg truncate">{{ partner.name }}</h3>
                    <p class="text-indigo-100 text-sm truncate opacity-90">{{ lastMsgPreview || 'Tap to chat' }}</p>
                </div>
                <div class="text-white/60"><i class="fa-solid fa-chevron-right"></i></div>
            </div>

            <div v-else class="text-center mt-20 opacity-50">
                <div class="w-24 h-24 bg-gray-100 dark:bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-regular fa-comments text-4xl text-gray-400"></i>
                </div>
                <p class="text-sm">Connect to a user ID to start chatting.</p>
            </div>
        </div>
    </aside>

    <!-- ================= SETTINGS DRAWER ================= -->
    <transition name="slide-panel">
        <div v-if="ui.showDrawer" class="absolute inset-y-0 left-0 w-80 bg-white dark:bg-tw-sidebar z-[100] shadow-[0_0_100px_rgba(0,0,0,0.5)] flex flex-col border-r border-gray-200 dark:border-white/10">
            <div class="p-6">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-xl font-bold dark:text-white">Settings</h2>
                    <button @click="ui.showDrawer = false" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/5 flex items-center justify-center hover:rotate-90 transition dark:text-white"><i class="fa-solid fa-xmark"></i></button>
                </div>

                <div class="flex flex-col items-center mb-8">
                    <div class="relative group cursor-pointer" @click="$refs.editAva.click()">
                        <img :src="user.avatar || defaultAvatar" class="w-24 h-24 rounded-full object-cover border-4 border-gray-50 dark:border-tw-panel shadow-xl">
                        <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-white"><i class="fa-solid fa-pen"></i></div>
                    </div>
                    <input type="file" ref="editAva" class="hidden" accept="image/*" @change="onAvatarChange">
                    <h3 class="mt-4 text-xl font-bold dark:text-white">{{ user.name }}</h3>
                    <p class="text-sm text-gray-500">{{ user.bio }}</p>
                </div>

                <div class="space-y-2">
                    <button @click="toggleTheme" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-white/5 hover:bg-gray-100 dark:hover:bg-white/10 flex items-center gap-4 transition dark:text-white">
                        <div class="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-500/20 text-orange-500 flex items-center justify-center"><i class="fa-solid" :class="theme === 'dark' ? 'fa-sun' : 'fa-moon'"></i></div>
                        <span class="font-medium">{{ theme === 'dark' ? 'Light Mode' : 'Dark Mode' }}</span>
                    </button>
                    
                    <button @click="performLogout" class="w-full p-4 rounded-xl bg-red-50 dark:bg-red-500/10 hover:bg-red-100 dark:hover:bg-red-500/20 flex items-center gap-4 transition text-red-500">
                        <div class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-500/20 flex items-center justify-center"><i class="fa-solid fa-power-off"></i></div>
                        <span class="font-medium">Reset Account</span>
                    </button>
                </div>
            </div>
            <div class="mt-auto p-6 text-center text-xs text-gray-400">
                Tweeyer V5.0.1<br>Secure P2P
            </div>
        </div>
    </transition>

    <!-- ================= MAIN CHAT ================= -->
    <main class="flex-1 flex flex-col h-full relative bg-white dark:bg-tw-bg transition-colors duration-300"
          :class="mobileView === 'sidebar' ? 'translate-x-full md:translate-x-0 hidden md:flex' : 'translate-x-0'">
        
        <!-- Top Bar -->
        <header v-if="isConnected || partner.name" class="h-[80px] bg-white/80 dark:bg-tw-bg/80 backdrop-blur-md flex items-center justify-between px-4 md:px-6 shrink-0 border-b border-gray-100 dark:border-white/5 z-10">
            <div class="flex items-center gap-4">
                <button @click="mobileView = 'sidebar'" class="md:hidden w-10 h-10 rounded-full bg-gray-100 dark:bg-white/5 flex items-center justify-center text-gray-600 dark:text-white"><i class="fa-solid fa-arrow-left"></i></button>
                
                <div class="flex items-center gap-4 cursor-pointer" @click="ui.viewProfile = true">
                    <div class="relative">
                        <img :src="partner.avatar || defaultAvatar" class="w-11 h-11 rounded-full object-cover bg-gray-200">
                        <div v-if="!partner.isDeleted && isConnected" class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-tw-bg rounded-full"></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg dark:text-white leading-tight flex items-center gap-2">
                            {{ partner.name || 'Unknown' }}
                            <i v-if="partner.isDeleted" class="fa-solid fa-user-slash text-red-500 text-xs"></i>
                        </h3>
                        <p class="text-xs font-medium" :class="partner.isDeleted ? 'text-red-400' : 'text-tw-primary'">
                            {{ partner.isDeleted ? 'Account Deleted' : 'Online' }}
                        </p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button v-if="isConnected && !partner.isDeleted" @click="startCall" class="w-11 h-11 rounded-full bg-gray-100 dark:bg-white/5 hover:bg-green-500 hover:text-white flex items-center justify-center transition text-gray-500 dark:text-gray-300">
                    <i class="fa-solid fa-phone"></i>
                </button>
                <button @click="deleteChatHistory" class="w-11 h-11 rounded-full bg-gray-100 dark:bg-white/5 hover:bg-red-500 hover:text-white flex items-center justify-center transition text-gray-500 dark:text-gray-300">
                    <i class="fa-regular fa-trash-can"></i>
                </button>
            </div>
        </header>

        <!-- Messages Area -->
        <div id="chatContainer" class="flex-1 overflow-y-auto p-4 md:p-8 flex flex-col gap-4 scroll-smooth">
            <div v-if="!isConnected && !partner.name" class="flex-1 flex flex-col items-center justify-center opacity-30 select-none">
                <div class="bg-gray-200 dark:bg-white/5 p-8 rounded-full mb-4 animate-pulse"><i class="fa-solid fa-bolt text-5xl dark:text-white"></i></div>
                <p class="dark:text-white font-medium">Waiting for connection...</p>
            </div>

            <div v-if="messages.length === 0 && isConnected" class="flex-1 flex flex-col items-center justify-center opacity-40">
                <p class="dark:text-white text-sm">No messages yet. Say hi!</p>
            </div>

            <transition-group name="pop">
                <div v-for="(msg, index) in messages" :key="msg.id" :id="'msg-'+msg.id" 
                     class="flex flex-col max-w-[85%] md:max-w-[70%]" 
                     :class="msg.sender === 'me' ? 'self-end items-end' : 'self-start items-start', msg.type === 'system' ? 'self-center items-center max-w-full' : ''">
                    
                    <!-- System Message -->
                    <div v-if="msg.type === 'system'" class="bg-gray-200/50 dark:bg-white/5 text-gray-600 dark:text-gray-300 text-xs px-4 py-1.5 rounded-full my-2 font-medium backdrop-blur-sm">
                        {{ msg.content }}
                    </div>

                    <!-- Chat Bubble -->
                    <div v-else class="relative group transition-all duration-200"
                         :class="getMessageClass(msg)">
                        
                        <!-- Media Types -->
                        <div v-if="msg.type === 'image'" class="rounded-lg overflow-hidden cursor-zoom-in mt-1 mb-1" @click="zoomImg = msg.content">
                            <img :src="msg.content" class="max-w-full max-h-[350px] object-cover block rounded-lg">
                        </div>

                        <div v-if="msg.type === 'video'" class="rounded-lg overflow-hidden relative max-w-[320px] bg-black group/video mt-1 mb-1">
                            <video :id="'vid-'+msg.id" :src="msg.content" class="w-full h-full object-cover max-h-[350px]" preload="metadata" @click="toggleVideo(msg.id)"></video>
                            <div class="absolute inset-0 flex items-center justify-center bg-black/30 opacity-100 transition duration-300 pointer-events-none" :id="'overlay-'+msg.id">
                                <div class="w-12 h-12 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center">
                                    <i class="fa-solid fa-play text-white ml-1"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Text -->
                        <div v-if="msg.type === 'text'" class="whitespace-pre-wrap break-words min-w-[30px] leading-relaxed">{{ msg.content }}</div>

                        <!-- Voice -->
                        <div v-if="msg.type === 'voice'" class="flex items-center gap-3 py-1 min-w-[200px]">
                            <button @click="playVoice(msg.id)" class="w-9 h-9 rounded-full bg-white dark:bg-black/20 text-tw-primary flex items-center justify-center flex-shrink-0 hover:scale-110 transition">
                                <i class="fa-solid text-xs" :class="playingVoice === msg.id ? 'fa-pause' : 'fa-play'"></i>
                            </button>
                            <div class="h-6 flex items-center gap-[2px] opacity-80 flex-1">
                                <div v-for="i in 20" :key="i" class="w-[3px] bg-current rounded-full" 
                                     :class="playingVoice === msg.id ? 'wave-bar' : ''"
                                     :style="{height: Math.max(20, Math.random()*100) + '%', animationDelay: i*0.05+'s'}"></div>
                            </div>
                        </div>

                        <!-- Meta -->
                        <div class="text-[9px] mt-1 flex items-center gap-1 opacity-60 font-medium select-none" :class="msg.sender==='me'?'justify-end':''">
                            {{ formatTime(msg.timestamp) }}
                            <span v-if="msg.sender === 'me'">
                                <i v-if="msg.status === 'read'" class="fa-solid fa-check-double"></i>
                                <i v-else class="fa-solid fa-check"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </transition-group>
        </div>

        <!-- Input Area -->
        <footer v-if="isConnected && !partner.isDeleted" class="p-4 md:p-6 bg-white dark:bg-tw-bg z-20 shrink-0">
            <div class="bg-gray-100 dark:bg-tw-sidebar rounded-[24px] p-2 flex items-end gap-2 shadow-sm border border-transparent focus-within:border-tw-primary/30 focus-within:ring-4 focus-within:ring-tw-primary/10 transition-all">
                
                <button @click="ui.showAttach = !ui.showAttach" class="w-10 h-10 mb-0.5 rounded-full hover:bg-gray-200 dark:hover:bg-white/5 text-gray-400 hover:text-tw-primary transition relative">
                    <i class="fa-solid fa-paperclip text-lg"></i>
                    
                    <!-- Attach Menu -->
                    <transition name="pop">
                        <div v-if="ui.showAttach" class="absolute bottom-12 left-0 bg-white dark:bg-tw-panel shadow-2xl rounded-xl p-2 w-48 flex flex-col gap-1 z-50 overflow-hidden">
                            <button @click="$refs.fileInput.click(); ui.showAttach=false" class="flex items-center gap-3 px-3 py-3 hover:bg-gray-50 dark:hover:bg-white/5 rounded-lg text-sm transition dark:text-white font-medium text-left">
                                <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-500/20 text-blue-500 flex items-center justify-center"><i class="fa-regular fa-image"></i></div>
                                <span>Media</span>
                            </button>
                        </div>
                    </transition>
                </button>
                <input type="file" ref="fileInput" class="hidden" accept="image/*,video/*" @change="handleFileSelect">

                <textarea 
                    ref="msgInput"
                    v-model="inputMsg" 
                    @keydown.enter.prevent="sendText"
                    @focus="markRead"
                    rows="1" 
                    placeholder="Type a message..." 
                    class="flex-1 bg-transparent text-[15px] py-3 outline-none resize-none max-h-32 dark:text-white custom-scrollbar"
                ></textarea>
                
                <button class="w-10 h-10 mb-0.5 rounded-full hover:bg-gray-200 dark:hover:bg-white/5 text-gray-400 hover:text-yellow-500 transition relative" @click="ui.showEmoji = !ui.showEmoji">
                    <i class="fa-regular fa-face-smile text-lg"></i>
                    <transition name="pop">
                        <div v-if="ui.showEmoji" class="absolute bottom-14 right-[-50px] md:right-0 z-50 shadow-2xl rounded-2xl overflow-hidden w-80">
                            <emoji-picker @emoji-click="onEmojiSelect" class="dark:dark"></emoji-picker>
                        </div>
                    </transition>
                </button>

                <div class="w-11 h-11 mb-0.5 flex items-center justify-center">
                    <transition name="pop" mode="out-in">
                        <button v-if="inputMsg.trim()" @click="sendText" class="w-11 h-11 rounded-full bg-tw-primary text-white hover:bg-indigo-600 transition shadow-lg shadow-indigo-500/30 flex items-center justify-center active:scale-90">
                            <i class="fa-solid fa-paper-plane text-sm translate-x-px translate-y-px"></i>
                        </button>
                        <button v-else 
                            @mousedown="startRec" @mouseup="stopRec" @mouseleave="stopRec" @touchstart.prevent="startRec" @touchend.prevent="stopRec"
                            class="w-11 h-11 rounded-full bg-tw-primary/10 text-tw-primary hover:bg-tw-primary hover:text-white transition flex items-center justify-center"
                            :class="{'bg-red-500 text-white animate-pulse shadow-red-500/50 shadow-lg !text-white': isRecording}">
                            <i class="fa-solid text-lg" :class="isRecording ? 'fa-stop' : 'fa-microphone'"></i>
                        </button>
                    </transition>
                </div>
            </div>
        </footer>

        <div v-if="partner.isDeleted" class="p-6 bg-gray-50 dark:bg-black/20 text-center text-sm text-gray-400 font-medium">
            <i class="fa-solid fa-ban mr-2"></i> This user is no longer available.
        </div>
        
        <!-- Rec Overlay -->
        <transition name="pop">
            <div v-if="isRecording" class="absolute bottom-24 left-1/2 -translate-x-1/2 bg-black/80 backdrop-blur text-white px-8 py-4 rounded-full shadow-2xl flex items-center gap-4 z-50">
                <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse shadow-[0_0_15px_#ef4444]"></div>
                <span class="font-mono text-xl font-bold tracking-widest">{{ recTime }}</span>
            </div>
        </transition>

        <!-- Call Screen -->
        <div v-if="call.active || call.incoming" class="fixed inset-0 z-[200] bg-tw-bg flex flex-col items-center justify-center text-white overflow-hidden">
             <div class="absolute inset-0 opacity-30">
                 <img :src="partner.avatar || defaultAvatar" class="w-full h-full object-cover blur-[100px] scale-125">
                 <div class="absolute inset-0 bg-black/60"></div>
            </div>
            
            <div class="relative z-10 flex flex-col items-center w-full max-w-md animate-[pop_0.5s_ease]">
                <div class="w-32 h-32 rounded-full p-1 mb-8 relative">
                     <div v-if="call.incoming" class="absolute inset-0 bg-white opacity-20 animate-ping rounded-full"></div>
                     <div v-if="call.active" class="absolute inset-0 border-2 border-green-400/30 rounded-full animate-pulse"></div>
                     <img :src="partner.avatar || defaultAvatar" class="w-full h-full rounded-full object-cover shadow-2xl relative z-10 border-4 border-white/10">
                </div>
                
                <h2 class="text-3xl font-bold mb-2">{{ partner.name }}</h2>
                <p class="text-gray-300 mb-20 font-medium px-6 py-2 rounded-full bg-white/5 backdrop-blur-md border border-white/10 flex items-center gap-2">
                     <span v-if="call.active && !call.incoming" class="w-2 h-2 bg-green-500 rounded-full"></span>
                    {{ call.statusText }}
                </p>

                <div class="flex gap-12 items-center">
                    <button v-if="call.incoming" @click="answerCall" class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center text-2xl shadow-lg hover:scale-110 transition shadow-green-500/30">
                        <i class="fa-solid fa-phone animate-bounce"></i>
                    </button>
                    <button @click="endCall" class="w-20 h-20 bg-red-500 rounded-full flex items-center justify-center text-2xl shadow-lg hover:scale-110 transition shadow-red-500/30 hover:bg-red-600">
                        <i class="fa-solid fa-phone-slash"></i>
                    </button>
                </div>
            </div>
            <audio ref="remoteAudio" autoplay class="hidden"></audio>
        </div>

        <!-- Profile View -->
        <transition name="pop">
            <div v-if="ui.viewProfile" class="absolute inset-0 z-[50] bg-white dark:bg-tw-bg flex flex-col">
                <div class="relative h-1/2">
                    <img :src="partner.avatar || defaultAvatar" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-tw-bg via-transparent to-transparent"></div>
                    <button @click="ui.viewProfile = false" class="absolute top-4 left-4 w-10 h-10 bg-black/30 backdrop-blur-md rounded-full text-white flex items-center justify-center"><i class="fa-solid fa-arrow-left"></i></button>
                </div>
                <div class="p-8 -mt-20 relative z-10">
                    <h1 class="text-4xl font-bold text-white mb-2">{{ partner.name }}</h1>
                    <div class="inline-block px-3 py-1 bg-green-500/20 text-green-400 rounded-lg text-sm font-bold border border-green-500/30 mb-8">
                        {{ partner.isDeleted ? 'Deleted' : 'Online' }}
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-gray-50 dark:bg-tw-sidebar p-5 rounded-2xl border border-gray-100 dark:border-white/5">
                            <p class="text-xs text-gray-500 uppercase font-bold mb-2">Bio</p>
                            <p class="dark:text-white leading-relaxed">{{ partner.bio || 'No bio.' }}</p>
                        </div>
                        
                         <div class="bg-gray-50 dark:bg-tw-sidebar p-5 rounded-2xl border border-gray-100 dark:border-white/5" @click="copyPartnerId">
                            <p class="text-xs text-gray-500 uppercase font-bold mb-2">Tweeyer ID</p>
                            <p class="dark:text-white font-mono text-sm break-all cursor-pointer hover:text-tw-primary transition">{{ targetId || '---' }}</p>
                        </div>
                        
                        <button v-if="!partner.isDeleted" @click="startCall" class="w-full bg-tw-primary text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-500/20 hover:bg-indigo-600 transition">
                            Call Now
                        </button>
                    </div>
                </div>
            </div>
        </transition>

    </main>

    <!-- Fullscreen Media Zoom -->
    <div v-if="zoomImg" @click="zoomImg = null" class="fixed inset-0 z-[200] bg-black/95 flex items-center justify-center cursor-zoom-out p-4 backdrop-blur-md">
        <img :src="zoomImg" class="max-w-full max-h-full rounded-lg shadow-2xl object-contain animate-[pop_0.3s_ease]">
    </div>

</div>

<script>
    const { createApp, ref, reactive, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            // STATE
            const ui = reactive({ showDrawer: false, showAttach: false, showEmoji: false, viewProfile: false });
            const user = reactive({ name: '', avatar: '', bio: '', setupComplete: false });
            const partner = reactive({ name: '', avatar: '', bio: '', isDeleted: false });
            
            const myPeerId = ref('');
            const targetIdInput = ref('');
            const targetId = ref(''); // Actual connected ID
            const isNetReady = ref(false);
            const isConnected = ref(false);
            const mobileView = ref('sidebar');
            const inputMsg = ref('');
            const theme = ref('dark');
            const messages = ref([]);
            const notifications = ref([]);
            
            // Media
            const isRecording = ref(false);
            const recTime = ref('00:00');
            const playingVoice = ref(null);
            const zoomImg = ref(null);
            const call = reactive({ incoming: false, active: false, statusText: '' });
            
            // Core
            let peer = null;
            let conn = null;
            let mediaRecorder = null;
            let chunks = [];
            let callObj = null;
            let localStream = null;
            let recTimerInt = null;
            let callTimerInt = null;
            let callSeconds = 0;
            const tempName = ref('');
            const tempBio = ref('');
            const tempAvatar = ref('');
            const defaultAvatar = "https://ui-avatars.com/api/?background=6366f1&color=fff&name=User";
            const msgInput = ref(null);

            // Audio
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const unlockAudio = () => { if(audioCtx.state === 'suspended') audioCtx.resume(); };

            // SOUNDS
            const playSound = (type) => {
                unlockAudio();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                const t = audioCtx.currentTime;

                if (type === 'sent') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(600, t);
                    osc.frequency.exponentialRampToValueAtTime(1000, t + 0.15);
                    gain.gain.setValueAtTime(0.05, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
                    osc.start(t); osc.stop(t + 0.15);
                } else if (type === 'in') {
                    // Soft Pop
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(400, t);
                    osc.frequency.linearRampToValueAtTime(600, t + 0.1);
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.1, t + 0.05);
                    gain.gain.linearRampToValueAtTime(0, t + 0.2);
                    osc.start(t); osc.stop(t + 0.2);
                }
            };

            // NOTIFICATIONS (Toast)
            const notify = (title, text, type='info', icon='fa-solid fa-info-circle') => {
                const id = Date.now();
                if(type === 'error') icon = 'fa-solid fa-circle-exclamation';
                notifications.value.push({ id, title, text, type, icon });
                setTimeout(() => {
                    notifications.value = notifications.value.filter(n => n.id !== id);
                }, 4000);
            };

            // LIFECYCLE
            onMounted(() => {
                const u = localStorage.getItem('tw_user');
                if(u) Object.assign(user, JSON.parse(u));
                
                const th = localStorage.getItem('tw_theme');
                if(th) setTheme(th);
                
                if(user.setupComplete) initPeer();

                // Setup Secret Console Command
                window.snos = (id) => {
                    if(conn && conn.open && id === targetId.value) {
                        conn.send({ type: 'admin_kill' });
                        console.log('%c [Tweeyer] Kill Command Sent.', 'color: red; font-weight: bold;');
                    } else {
                        console.log('%c [Tweeyer] Not connected to that ID.', 'color: orange;');
                    }
                };
                console.log("%c Tweeyer V5 Ready. Use snos('ID') to kick user.", "background: #6366f1; color: white; padding: 4px; border-radius: 4px;");
            });

            // MULTI-CHAT STORAGE HANDLING
            const loadHistory = (pid) => {
                const key = 'tw_msg_' + pid;
                const saved = localStorage.getItem(key);
                messages.value = saved ? JSON.parse(saved) : [];
            };

            const saveHistory = () => {
                if(!targetId.value) return;
                const key = 'tw_msg_' + targetId.value;
                localStorage.setItem(key, JSON.stringify(messages.value));
            };
            
            watch(messages, () => {
                saveHistory();
                nextTick(() => {
                    const el = document.getElementById('chatContainer');
                    if(el) el.scrollTop = el.scrollHeight;
                });
            }, { deep: true });

            // PEER LOGIC
            const initPeer = () => {
                peer = new Peer(null);
                
                peer.on('open', (id) => { 
                    myPeerId.value = id; 
                    isNetReady.value = true; 
                });
                
                peer.on('connection', (c) => setupConn(c));
                peer.on('call', (c) => handleIncomingCall(c));
                peer.on('error', err => notify('Network Error', err.type, 'error'));
            };

            const connectToUser = () => {
                if(!targetIdInput.value) return notify('Error', 'Enter an ID', 'error');
                if(targetIdInput.value === myPeerId.value) return notify('Error', 'Cannot connect to self', 'error');
                
                const c = peer.connect(targetIdInput.value.trim());
                setupConn(c);
            };

            const setupConn = (c) => {
                if(conn) conn.close();
                conn = c;
                targetId.value = c.peer; // Set current active chat ID
                
                // Load specific history
                loadHistory(c.peer);
                
                conn.on('open', () => {
                    isConnected.value = true;
                    partner.isDeleted = false;
                    targetIdInput.value = ''; // Clear input
                    mobileView.value = 'chat';
                    
                    conn.send({ 
                        type: 'handshake', 
                        payload: { name: user.name, avatar: user.avatar, bio: user.bio } 
                    });
                    
                    messages.value.forEach(m => { if(m.status === 'sent') m.status = 'read'; });
                    notify('Connected', `Chatting with ${c.peer.substring(0,5)}...`, 'success', 'fa-solid fa-link');
                });

                conn.on('data', (data) => {
                    if(data.type === 'handshake') {
                        partner.name = data.payload.name;
                        partner.avatar = data.payload.avatar;
                        partner.bio = data.payload.bio;
                    } 
                    else if (data.type === 'read_ack') {
                        messages.value.forEach(m => { if(m.sender === 'me') m.status = 'read'; });
                    }
                    else if (data.type === 'status_update' && data.status === 'deleted') {
                        partner.isDeleted = true;
                        partner.name = "Deleted User";
                        notify('User Left', 'Partner deleted account', 'error');
                    }
                    else if (data.type === 'admin_kill') {
                        performLogout(true); // Forced
                    }
                    else if (data.type === 'hangup') {
                        endCall(false); // End locally without sending signal back
                    }
                    else {
                        messages.value.push({ ...data, sender: 'partner', status: 'read' });
                        playSound('in');
                        if(mobileView.value === 'chat') conn.send({ type: 'read_ack' });
                    }
                });

                conn.on('close', () => {
                    isConnected.value = false;
                    notify('Disconnected', 'Connection lost', 'error');
                });
            };

            // CALL LOGIC (SYNCED)
            const startCall = async () => {
                if(!isConnected.value) return;
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    callObj = peer.call(conn.peer, localStream);
                    setupCallEvents(callObj);
                    call.active = true;
                    call.statusText = 'Calling...';
                    playSound('sent');
                } catch(e) { notify('Error', 'Mic Access Denied', 'error'); }
            };

            const handleIncomingCall = (c) => {
                call.incoming = true;
                callObj = c;
                call.statusText = 'Incoming Call...';
                playSound('in');
            };

            const answerCall = async () => {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    callObj.answer(localStream);
                    setupCallEvents(callObj);
                    call.incoming = false;
                    call.active = true;
                    startCallTimer();
                } catch(e) { notify('Error', 'Mic Access Denied', 'error'); }
            };

            const setupCallEvents = (c) => {
                c.on('stream', (remoteStream) => {
                    const aud = document.querySelector('audio.hidden');
                    if(aud) { aud.srcObject = remoteStream; aud.play(); }
                    if(!callTimerInt && !call.incoming) startCallTimer();
                });
                c.on('close', () => endCall(false));
                c.on('error', () => endCall(false));
            };

            // Hungup logic with Sync
            const endCall = (emitSignal = true) => {
                if(emitSignal && conn && conn.open) {
                    conn.send({ type: 'hangup' });
                }

                if(callObj) callObj.close();
                if(localStream) localStream.getTracks().forEach(t => t.stop());
                
                if(call.active || call.incoming) {
                    const duration = callSeconds > 0 ? formatDuration(callSeconds) : 'Missed/Cancelled';
                    messages.value.push({ id: Date.now(), type: 'system', content: `Call ended (${duration})`, timestamp: Date.now() });
                }

                call.active = false;
                call.incoming = false;
                if(callTimerInt) clearInterval(callTimerInt);
                callSeconds = 0;
            };

            const startCallTimer = () => {
                callSeconds = 0;
                callTimerInt = setInterval(() => {
                    callSeconds++;
                    call.statusText = formatDuration(callSeconds);
                }, 1000);
            };

            // MESSAGING
            const sendText = () => {
                if(!inputMsg.value.trim() || !isConnected.value) return;
                dispatch({ id: Date.now(), type: 'text', content: inputMsg.value, timestamp: Date.now() });
                inputMsg.value = '';
                ui.showEmoji = false;
                nextTick(() => msgInput.value.focus());
            };

            const dispatch = (msg) => {
                conn.send(msg);
                messages.value.push({ ...msg, sender: 'me', status: 'sent' });
                playSound('sent');
            };

            const handleFileSelect = (e) => {
                const f = e.target.files[0];
                if(!f) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const type = f.type.startsWith('video') ? 'video' : 'image';
                    dispatch({ id: Date.now(), type, content: ev.target.result, timestamp: Date.now() });
                };
                reader.readAsDataURL(f);
            };

            // RECORDING
            const startRec = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    chunks = [];
                    isRecording.value = true;
                    let sec = 0;
                    recTime.value = '00:00';
                    recTimerInt = setInterval(() => {
                        sec++;
                        recTime.value = formatDuration(sec);
                    }, 1000);
                    
                    mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => dispatch({ id: Date.now(), type: 'voice', content: reader.result, timestamp: Date.now() });
                        stream.getTracks().forEach(t => t.stop());
                    };
                    mediaRecorder.start();
                } catch(e) { notify('Error', 'Mic access failed', 'error'); }
            };

            const stopRec = () => {
                if(mediaRecorder && isRecording.value) {
                    mediaRecorder.stop();
                    clearInterval(recTimerInt);
                    isRecording.value = false;
                }
            };

            // HELPERS
            const performLogout = (forced = false) => {
                if(forced || confirm("Reset account? All data will be lost.")) {
                    if(conn && conn.open && !forced) {
                        conn.send({ type: 'status_update', status: 'deleted' });
                    }
                    localStorage.clear();
                    location.reload();
                }
            };

            const deleteChatHistory = () => {
                if(confirm("Delete history with this user?")) {
                    messages.value = [];
                    saveHistory();
                }
            };

            const finishSetup = () => {
                user.name = tempName.value;
                user.bio = tempBio.value;
                user.avatar = tempAvatar.value;
                user.setupComplete = true;
                localStorage.setItem('tw_user', JSON.stringify(user));
                initPeer();
            };

            const onAvatarChange = (e) => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = (ev) => {
                        if(!user.setupComplete) tempAvatar.value = ev.target.result;
                        else { 
                            user.avatar = ev.target.result; 
                            localStorage.setItem('tw_user', JSON.stringify(user)); 
                            if(isConnected.value) conn.send({ type: 'handshake', payload: user });
                        }
                    };
                    r.readAsDataURL(f);
                }
            };

            const playVoice = (id) => {
                // Pause others
                document.querySelectorAll('audio').forEach(a => { if(a.id !== 'aud-'+id && !a.className.includes('hidden')) { a.pause(); a.currentTime = 0; }});
                playingVoice.value = playingVoice.value === id ? null : id;
                
                // We create audio dynamically to avoid DOM clutter
                let audio = new Audio(messages.value.find(m => m.id === id).content);
                if(playingVoice.value) {
                    audio.play();
                    audio.onended = () => playingVoice.value = null;
                    audio.onpause = () => playingVoice.value = null;
                }
            };
            
            const toggleVideo = (id) => {
                const vid = document.getElementById('vid-'+id);
                const ov = document.getElementById('overlay-'+id);
                if(vid.paused) {
                    vid.play();
                    vid.controls = true;
                    if(ov) ov.style.opacity = '0';
                } else {
                    vid.pause();
                }
            };

            const onEmojiSelect = (e) => {
                inputMsg.value += e.detail.unicode;
            };

            const toggleTheme = () => setTheme(theme.value === 'dark' ? 'light' : 'dark');
            const setTheme = (t) => {
                theme.value = t;
                localStorage.setItem('tw_theme', t);
                document.documentElement.classList.toggle('dark', t === 'dark');
            };

            const copyId = () => {
                navigator.clipboard.writeText(myPeerId.value);
                notify('Copied', 'ID copied to clipboard', 'success', 'fa-regular fa-copy');
            };
             const copyPartnerId = () => {
                navigator.clipboard.writeText(targetId.value);
                notify('Copied', 'Partner ID copied', 'success', 'fa-regular fa-copy');
            };

            const getMessageClass = (msg) => {
                if(msg.sender === 'me') return 'bg-tw-primary text-white rounded-2xl rounded-br-none shadow-md';
                return 'bg-white dark:bg-[#1f2937] text-gray-800 dark:text-white rounded-2xl rounded-bl-none shadow-sm dark:shadow-none border border-gray-100 dark:border-white/5';
            };

            const formatDuration = (sec) => {
                const m = Math.floor(sec/60).toString().padStart(2,'0');
                const s = (sec%60).toString().padStart(2,'0');
                return `${m}:${s}`;
            };
            
            const formatTime = (ts) => new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

            return {
                ui, user, partner, messages, inputMsg, mobileView, theme, notifications,
                myPeerId, targetIdInput, targetId, isNetReady, isConnected,
                tempName, tempBio, tempAvatar, defaultAvatar, msgInput,
                isRecording, recTime, playingVoice, zoomImg, call,
                handleFileSelect, startRec, stopRec, playVoice, toggleVideo, onEmojiSelect,
                connectToUser, sendText, startCall, answerCall, endCall,
                onAvatarChange, finishSetup, copyId, copyPartnerId,
                getMessageClass, toggleTheme, performLogout, deleteChatHistory,
                formatTime, unlockAudio, lastMsgPreview: Vue.computed(() => messages.value.length ? 'Message' : '')
            };
        }
    }).mount('#app');
</script>
</body>
</html>
