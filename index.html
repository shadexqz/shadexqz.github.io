<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tweeyer K</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Emoji Picker -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

    <!-- Libs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        tg: {
                            bg: '#17212b',
                            sidebar: '#17212b',
                            panel: '#242f3d',
                            hover: '#202b36',
                            active: '#2b5278',
                            self: '#766ac8',
                            in: '#182533',
                            text: '#f5f5f5',
                            meta: '#8da2b5',
                            blue: '#3390ec',
                            green: '#4ade80'
                        }
                    }
                }
            }
        };
    </script>

    <style>
        /* Telegram Pattern */
        .chat-bg {
            background-color: #0f0f0f;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 20.5V18H0v-2h20v-2H0v-2h20v-2H0V8h20V6H0V4h20V2H0V0h22v20h2V0h2v20h2V0h2v20h2V0h2v20h2V0h2v20h2V0h2v20h2v2H22v-2h-2z' fill='%23151e27' fill-opacity='0.5' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Animations */
        .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease; }
        .slide-enter-from, .slide-leave-to { transform: translateX(100%); }

        /* Emoji Picker Styling */
        emoji-picker {
            width: 100%;
            height: 320px;
            --background: #242f3d;
            --border-color: #17212b;
            --color: #ffffff;
        }

        /* Message Layout Fixes */
        .msg-bubble {
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            position: relative;
        }
        .msg-meta {
            float: right;
            padding-left: 10px;
            padding-top: 6px;
            position: relative;
            top: 2px;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }
    </style>
</head>
<body class="bg-[#0f0f0f] text-tg-text h-[100dvh] w-screen overflow-hidden text-[15px] antialiased">

<div id="app" class="h-full flex relative font-sans" @click="unlockAudio">

    <!-- ================= SETUP ================= -->
    <div v-if="!user.setupComplete" class="fixed inset-0 z-[999] bg-[#17212b] flex items-center justify-center p-4">
        <div class="w-full max-w-sm text-center">
            <div class="w-28 h-28 mx-auto mb-6 bg-tg-blue rounded-full flex items-center justify-center shadow-2xl">
                <i class="fa-brands fa-telegram text-5xl text-white"></i>
            </div>
            <h1 class="text-2xl font-bold mb-2">Tweeyer Web</h1>
            <p class="text-gray-400 mb-8 text-sm">Create Account</p>
            
            <div class="space-y-4">
                <div class="relative w-24 h-24 mx-auto cursor-pointer group" @click="$refs.avaInput.click()">
                    <img :src="tempAvatar || defaultAvatar" class="w-full h-full rounded-full object-cover border-2 border-tg-blue">
                    <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-white">
                        <i class="fa-solid fa-camera"></i>
                    </div>
                </div>
                <input type="file" ref="avaInput" class="hidden" accept="image/*" @change="onAvatarChange">
                <input v-model="tempName" placeholder="Your Name" class="w-full bg-[#242f3d] px-4 py-3 rounded-xl outline-none text-center text-white focus:ring-1 focus:ring-tg-blue transition">
                <input v-model="tempBio" placeholder="Bio (Optional)" class="w-full bg-transparent border-b border-white/10 px-2 py-2 outline-none text-center text-sm text-gray-400">
                <button @click="finishSetup" :disabled="!tempName" class="w-full bg-tg-blue text-white py-3 rounded-xl font-bold hover:bg-[#2b83d6] transition disabled:opacity-50">START</button>
            </div>
        </div>
    </div>

    <!-- ================= LEFT SIDEBAR ================= -->
    <aside class="w-full md:w-[400px] bg-tg-sidebar border-r border-black/20 flex flex-col z-20 absolute md:relative h-full transition-transform duration-300"
           :class="mobileView === 'chat' ? '-translate-x-full md:translate-x-0' : 'translate-x-0'">
        
        <!-- Header -->
        <div class="h-14 px-4 flex items-center gap-3 shrink-0">
            <button class="w-10 h-10 rounded-full hover:bg-white/5 flex items-center justify-center text-gray-400"><i class="fa-solid fa-bars"></i></button>
            <div class="flex-1 relative">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm"></i>
                <input placeholder="Search" class="w-full bg-[#242f3d] rounded-full h-9 pl-9 pr-4 text-sm outline-none text-white focus:bg-[#17212b] border border-transparent focus:border-tg-blue transition">
            </div>
        </div>

        <!-- My ID Widget -->
        <div class="px-2 pb-2">
             <div class="bg-[#242f3d] rounded-lg p-2 flex items-center justify-between border-l-2 border-tg-blue">
                <div class="overflow-hidden">
                    <div class="text-[10px] uppercase text-tg-blue font-bold">My ID</div>
                    <div class="text-xs font-mono text-gray-300 truncate cursor-pointer hover:text-white select-all" @click="copyId">{{ myPeerId || '...' }}</div>
                </div>
                <div class="w-2 h-2 rounded-full" :class="isNetReady ? 'bg-green-500' : 'bg-red-500 animate-pulse'"></div>
            </div>
        </div>

        <!-- Chat List -->
        <div class="flex-1 overflow-y-auto">
            <!-- New Chat Buttons -->
            <div class="flex gap-2 px-2 mb-2">
                <button @click="ui.modal = 'add_contact'" class="flex-1 bg-[#242f3d] py-1.5 rounded text-xs text-tg-blue hover:bg-[#2b3949]">Add User</button>
                <button @click="ui.modal = 'create_group'" class="flex-1 bg-[#242f3d] py-1.5 rounded text-xs text-tg-blue hover:bg-[#2b3949]">New Group</button>
            </div>

            <div v-for="chat in chats" :key="chat.id" 
                 class="px-3 py-2.5 hover:bg-[#202b36] cursor-pointer flex gap-3 group"
                 :class="{'bg-tg-active hover:bg-tg-active': activeChatId === chat.id}"
                 @click="openChat(chat.id)">
                <div class="relative">
                    <img :src="chat.avatar || defaultAvatar" class="w-12 h-12 rounded-full object-cover bg-[#242f3d]">
                    <div v-if="chat.online" class="absolute bottom-0 right-0 w-3 h-3 bg-tg-green border-2 border-tg-sidebar rounded-full"></div>
                </div>
                <div class="flex-1 min-w-0 border-b border-black/10 pb-2 group-hover:border-transparent">
                    <div class="flex justify-between items-center mb-0.5">
                        <h3 class="font-semibold text-[15px] truncate text-white" :class="{'text-white': activeChatId === chat.id}">{{ chat.name }}</h3>
                        <span class="text-xs text-gray-500" :class="{'text-gray-300': activeChatId === chat.id}">{{ formatTime(chat.lastTimestamp) }}</span>
                    </div>
                    <p class="text-sm text-gray-400 truncate flex items-center gap-1" :class="{'text-gray-200': activeChatId === chat.id}">
                        <span v-if="chat.lastSender === 'me'" class="text-tg-self">You:</span>
                        {{ chat.lastMessage || 'No messages' }}
                    </p>
                </div>
            </div>
        </div>
    </aside>

    <!-- ================= MAIN CHAT ================= -->
    <main class="flex-1 flex flex-col h-full relative chat-bg transition-transform duration-300"
          :class="mobileView === 'sidebar' ? 'translate-x-full md:translate-x-0 hidden md:flex' : 'translate-x-0'">
        
        <template v-if="activeChatId">
            <!-- Header -->
            <header class="h-14 bg-tg-sidebar flex items-center justify-between px-4 shrink-0 shadow-sm z-20 cursor-pointer border-b border-black/20" @click="ui.rightSidebar = activeChatId">
                <div class="flex items-center gap-4">
                    <button @click.stop="mobileView = 'sidebar'" class="md:hidden text-gray-400"><i class="fa-solid fa-arrow-left"></i></button>
                    <div class="flex items-center gap-3">
                        <img :src="activeChat.avatar || defaultAvatar" class="w-9 h-9 rounded-full object-cover">
                        <div>
                            <h3 class="font-bold text-[15px] text-white leading-tight">{{ activeChat.name }}</h3>
                            <p class="text-xs text-tg-blue">{{ activeChat.type === 'group' ? 'Group' : (activeChat.online ? 'Online' : 'Offline') }}</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-6 text-gray-400">
                    <button v-if="activeChat.type !== 'group'" @click.stop="startCall" class="hover:text-tg-blue"><i class="fa-solid fa-phone"></i></button>
                    <button class="hover:text-tg-blue"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                </div>
            </header>

            <!-- Messages -->
            <div ref="chatBox" class="flex-1 overflow-y-auto p-2 md:p-4 flex flex-col gap-1">
                <div v-for="msg in activeMessages" :key="msg.id" 
                     class="flex flex-col max-w-[85%] md:max-w-[65%]" 
                     :class="msg.sender === 'me' ? 'self-end items-end' : 'self-start items-start', msg.type === 'system' ? 'self-center items-center max-w-full' : ''">
                    
                    <div v-if="msg.type === 'system'" class="bg-[#1c242d]/80 text-white text-xs px-3 py-1 rounded-full my-2 font-medium">{{ msg.content }}</div>

                    <div v-else class="msg-bubble px-3 py-1.5 rounded-2xl text-[15px] leading-snug min-w-[60px]"
                         :class="msg.sender === 'me' ? 'bg-tg-self text-white rounded-br-none' : 'bg-tg-in text-white rounded-bl-none'">
                        
                        <!-- Name in group -->
                        <div v-if="activeChat.type === 'group' && msg.sender !== 'me'" class="text-[11px] font-bold text-[#e0a931] mb-0.5">{{ msg.senderName }}</div>

                        <!-- Media -->
                        <div v-if="msg.type === 'image'" class="mb-1 rounded-lg overflow-hidden cursor-zoom-in mt-1">
                            <img :src="msg.content" class="block max-w-full max-h-[300px] object-cover" @click="ui.zoomed = msg.content">
                        </div>
                        <div v-if="msg.type === 'video'" class="mb-1 rounded-lg overflow-hidden mt-1">
                            <video :src="msg.content" controls class="block max-w-full max-h-[300px]"></video>
                        </div>

                        <!-- Text -->
                        <span v-if="msg.type === 'text'" class="whitespace-pre-wrap break-words">{{ msg.content }}</span>

                        <!-- Voice -->
                        <div v-if="msg.type === 'voice'" class="flex items-center gap-3 pr-2 py-1 min-w-[200px]">
                            <button @click="playVoice(msg.id)" class="w-9 h-9 rounded-full bg-black/20 flex items-center justify-center hover:bg-black/30"><i class="fa-solid text-xs" :class="playingVoice === msg.id ? 'fa-pause' : 'fa-play'"></i></button>
                            <span class="text-xs opacity-80">Voice Message</span>
                             <audio :id="'aud-'+msg.id" :src="msg.content" @ended="playingVoice = null"></audio>
                        </div>

                        <!-- Meta (Time + Status) -->
                        <div class="msg-meta text-[11px] opacity-60" :class="{'text-green-200': msg.sender === 'me'}">
                            <span>{{ formatTime(msg.timestamp) }}</span>
                            <span v-if="msg.sender === 'me'">
                                <i v-if="msg.status === 'read'" class="fa-solid fa-check-double text-[#4ade80]"></i>
                                <i v-else class="fa-solid fa-check"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input -->
            <footer class="bg-tg-sidebar px-4 py-2 flex items-end gap-3 shrink-0 z-20">
                <div class="relative">
                    <button @click="ui.showAttach = !ui.showAttach" class="w-10 h-10 text-gray-500 hover:text-tg-blue hover:bg-[#242f3d] rounded-full transition"><i class="fa-solid fa-paperclip text-xl"></i></button>
                    <div v-if="ui.showAttach" class="absolute bottom-14 left-0 bg-[#242f3d] shadow-xl rounded-xl p-2 w-48 border border-white/10">
                        <button @click="$refs.fileInput.click(); ui.showAttach=false" class="flex items-center gap-3 px-3 py-2 hover:bg-[#17212b] rounded-lg text-sm text-white w-full text-left">
                            <i class="fa-regular fa-image text-tg-blue"></i> Photo / Video
                        </button>
                    </div>
                    <input type="file" ref="fileInput" class="hidden" @change="handleFile">
                </div>

                <div class="flex-1 bg-[#242f3d] rounded-[20px] flex items-end relative">
                    <textarea v-model="inputMsg" @keydown.enter.prevent="sendMsg" rows="1" placeholder="Message" class="w-full bg-transparent text-white text-[15px] px-4 py-2.5 outline-none resize-none max-h-32 placeholder-gray-500"></textarea>
                    <button class="w-10 h-10 text-gray-500 hover:text-yellow-400" @click="ui.showEmoji = !ui.showEmoji"><i class="fa-regular fa-face-smile text-xl mb-1 block"></i></button>
                    <div v-if="ui.showEmoji" class="absolute bottom-12 right-0 z-50 shadow-2xl rounded-xl overflow-hidden border border-black/20 w-80">
                        <emoji-picker @emoji-click="onEmoji" class="dark"></emoji-picker>
                    </div>
                </div>

                <div class="w-12 h-12 flex items-center justify-center">
                    <button v-if="inputMsg.trim()" @click="sendMsg" class="w-12 h-12 rounded-full bg-tg-self text-white hover:bg-[#6458ad] shadow-lg flex items-center justify-center transform hover:scale-105 active:scale-95"><i class="fa-solid fa-paper-plane text-lg"></i></button>
                    <button v-else @mousedown="startRec" @mouseup="stopRec" class="w-12 h-12 rounded-full hover:bg-[#242f3d] text-gray-400 hover:text-white flex items-center justify-center" :class="{'bg-red-500 text-white animate-pulse': isRecording}"><i class="fa-solid text-xl" :class="isRecording ? 'fa-stop' : 'fa-microphone'"></i></button>
                </div>
            </footer>
        </template>
        <div v-else class="flex items-center justify-center h-full text-gray-500 text-sm select-none">Select a chat to start messaging</div>
    </main>

    <!-- ================= RIGHT SIDEBAR (PROFILE) ================= -->
    <transition name="slide">
        <div v-if="ui.rightSidebar" class="absolute right-0 top-0 bottom-0 w-80 bg-tg-sidebar border-l border-black/20 z-30 shadow-xl flex flex-col">
            <div class="h-14 flex items-center px-4 gap-4 bg-[#242f3d]">
                <button @click="ui.rightSidebar = null" class="text-gray-400"><i class="fa-solid fa-times"></i></button>
                <span class="text-white font-bold">Profile</span>
            </div>
            <div class="p-6 flex flex-col items-center border-b border-black/10">
                <img :src="activeChat.avatar || defaultAvatar" class="w-24 h-24 rounded-full object-cover mb-4 shadow-lg cursor-zoom-in" @click="ui.zoomed = activeChat.avatar">
                <h2 class="text-xl font-bold text-white">{{ activeChat.name }}</h2>
                <p class="text-sm text-gray-400">{{ activeChat.online ? 'Online' : 'Offline' }}</p>
            </div>
            <div class="p-4 space-y-4">
                <div class="flex items-center gap-4 text-gray-300">
                    <i class="fa-solid fa-circle-info w-6 text-gray-500"></i>
                    <div>
                        <div class="text-[15px]">{{ activeChat.bio || 'No bio available' }}</div>
                        <div class="text-[13px] text-gray-500">Bio</div>
                    </div>
                </div>
                <div class="flex items-center gap-4 text-gray-300">
                    <i class="fa-solid fa-fingerprint w-6 text-gray-500"></i>
                    <div>
                        <div class="text-[13px] font-mono select-all">{{ activeChat.id }}</div>
                        <div class="text-[13px] text-gray-500">User ID</div>
                    </div>
                </div>
                 <!-- Actions -->
                <div class="pt-4 border-t border-black/10">
                    <button @click="deleteChat" class="w-full text-left flex items-center gap-4 text-red-500 p-2 hover:bg-[#242f3d] rounded">
                        <i class="fa-solid fa-trash w-6"></i> Delete Chat
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <!-- ================= MODALS ================= -->
    <!-- Zoom Image -->
    <div v-if="ui.zoomed" class="fixed inset-0 z-[100] bg-black/90 flex items-center justify-center p-4" @click="ui.zoomed = null">
        <img :src="ui.zoomed" class="max-w-full max-h-full rounded shadow-2xl">
    </div>

    <!-- Add Contact / Group (Generic Modal) -->
    <div v-if="ui.modal" class="fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4" @click.self="ui.modal = null">
        <div class="bg-[#17212b] rounded-xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-white text-lg font-bold mb-4">{{ ui.modal === 'add_contact' ? 'Add User' : 'New Group' }}</h3>
            
            <div v-if="ui.modal === 'add_contact'">
                <input v-model="inputs.contactId" placeholder="Paste ID" class="w-full bg-[#242f3d] p-3 rounded-lg text-white outline-none mb-4 font-mono text-sm">
                <button @click="addContact" class="bg-tg-blue text-white w-full py-2 rounded-lg font-bold">Add</button>
            </div>

            <div v-if="ui.modal === 'create_group'">
                <input v-model="inputs.groupName" placeholder="Group Name" class="w-full bg-[#242f3d] p-3 rounded-lg text-white outline-none mb-2">
                <textarea v-model="inputs.groupMembers" placeholder="IDs (comma separated)" class="w-full bg-[#242f3d] p-3 rounded-lg text-white outline-none mb-4 font-mono text-sm h-20"></textarea>
                <button @click="createGroup" class="bg-tg-blue text-white w-full py-2 rounded-lg font-bold">Create</button>
            </div>
        </div>
    </div>
    
    <!-- Call Overlay -->
    <div v-if="call.active || call.incoming" class="fixed inset-0 z-[100] bg-[#1a2025] flex flex-col items-center justify-center text-white">
        <div class="absolute inset-0 overflow-hidden opacity-30 blur-3xl"><img :src="activeChat?.avatar || defaultAvatar" class="w-full h-full object-cover"></div>
        <div class="relative z-10 flex flex-col items-center">
            <div class="w-32 h-32 rounded-full overflow-hidden mb-4 border-4 border-white/5 relative">
                <div v-if="call.incoming" class="absolute inset-0 bg-green-500 opacity-30 animate-ping"></div>
                <img :src="activeChat?.avatar || defaultAvatar" class="w-full h-full object-cover relative z-10">
            </div>
            <h2 class="text-2xl font-bold mb-1">{{ activeChat?.name }}</h2>
            <p class="text-gray-400 mb-12">{{ call.status }}</p>
            <div class="flex gap-10">
                <button v-if="call.incoming" @click="answerCall" class="w-16 h-16 bg-green-500 rounded-full text-2xl"><i class="fa-solid fa-phone"></i></button>
                <button @click="endCall" class="w-16 h-16 bg-red-500 rounded-full text-2xl rotate-[135deg]"><i class="fa-solid fa-phone"></i></button>
            </div>
        </div>
        <audio ref="remoteAudio" autoplay class="hidden"></audio>
    </div>

</div>

<script>
    const { createApp, ref, reactive, onMounted, computed, watch, nextTick } = Vue;
    
    const app = createApp({
        setup() {
            // STATE
            const ui = reactive({ modal: null, showAttach: false, showEmoji: false, rightSidebar: null, zoomed: null });
            const inputs = reactive({ contactId: '', groupName: '', groupMembers: '' });
            const myPeerId = ref('');
            const isNetReady = ref(false);
            const mobileView = ref('sidebar');
            const inputMsg = ref('');
            const activeChatId = ref(null);
            
            const user = reactive({ name: '', avatar: '', bio: '', setupComplete: false });
            const chats = ref([]);
            
            // Media
            const isRecording = ref(false);
            const playingVoice = ref(null);
            const call = reactive({ incoming: false, active: false, status: '', conn: null });
            
            // Core
            let peer = null;
            let connections = {};
            let callObj = null;
            let localStream = null;
            
            const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
            
            // --- AUDIO ---
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const unlockAudio = () => { if(audioCtx.state === 'suspended') audioCtx.resume(); };
            const playSound = (type) => {
                const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
                osc.connect(g); g.connect(audioCtx.destination);
                osc.frequency.value = type === 'sent' ? 800 : 600;
                g.gain.value = 0.05;
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            };

            // --- SETUP ---
            onMounted(() => {
                const u = localStorage.getItem('tw7_user'); if(u) Object.assign(user, JSON.parse(u));
                const c = localStorage.getItem('tw7_chats'); if(c) chats.value = JSON.parse(c);
                if(user.setupComplete) initPeer();
            });
            watch(chats, (val) => localStorage.setItem('tw7_chats', JSON.stringify(val)), { deep: true });

            const onAvatarChange = (e) => {
                const f = e.target.files[0]; if(!f) return;
                const r = new FileReader(); r.onload = (ev) => user.avatar = ev.target.result; r.readAsDataURL(f);
            };
            const finishSetup = () => {
                user.name = tempName.value; user.bio = tempBio.value; user.avatar = tempAvatar.value; user.setupComplete = true;
                localStorage.setItem('tw7_user', JSON.stringify(user)); initPeer();
            };
            const tempName = ref(''); const tempBio = ref(''); const tempAvatar = ref('');

            // --- PEER ---
            const initPeer = () => {
                peer = new Peer(null, { config: { iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] }, debug: 1 });
                peer.on('open', (id) => { myPeerId.value = id; isNetReady.value = true; });
                peer.on('connection', c => setupConn(c));
                peer.on('call', c => { call.incoming = true; callObj = c; call.status = 'Incoming...'; });
            };
            
            const connect = (id) => {
                if(!connections[id]) {
                    const c = peer.connect(id, { serialization: 'json' }); // Critical for emoji
                    setupConn(c);
                }
            };

            const setupConn = (c) => {
                connections[c.peer] = c;
                c.on('open', () => {
                    c.send({ type: 'handshake', payload: { name: user.name, avatar: user.avatar, bio: user.bio } });
                    const chat = chats.value.find(x => x.id === c.peer); if(chat) chat.online = true;
                });
                c.on('data', d => handleData(c.peer, d));
                c.on('close', () => { delete connections[c.peer]; const ch = chats.value.find(x=>x.id===c.peer); if(ch) ch.online = false; });
            };

            const handleData = (id, d) => {
                if(d.type === 'handshake') {
                    let chat = chats.value.find(x => x.id === id);
                    if(!chat) {
                        chats.value.unshift({ id, name: d.payload.name, avatar: d.payload.avatar, bio: d.payload.bio, messages: [], online: true, type: 'private', lastTimestamp: Date.now() });
                    } else { chat.name = d.payload.name; chat.avatar = d.payload.avatar; chat.bio = d.payload.bio; chat.online = true; }
                } 
                else if(d.type === 'msg') {
                    const tid = d.groupId || id;
                    const chat = chats.value.find(x => x.id === tid);
                    if(chat) {
                        chat.messages.push({ ...d, sender: 'partner', status: 'read' });
                        chat.lastMessage = d.type === 'text' ? d.content : 'Media';
                        chat.lastSender = 'partner'; chat.lastTimestamp = Date.now();
                        if(activeChatId.value === tid) scrollToBottom();
                        playSound('in');
                    }
                }
                else if(d.type === 'hangup') endCall(false);
            };

            // --- ACTIONS ---
            const addContact = () => {
                connect(inputs.contactId);
                if(!chats.value.find(x => x.id === inputs.contactId)) {
                    chats.value.unshift({ id: inputs.contactId, name: inputs.contactId.substr(0,5), avatar: defaultAvatar, type: 'private', messages: [], online: false, lastTimestamp: Date.now() });
                }
                ui.modal = null; inputs.contactId = '';
            };
            
            const createGroup = () => {
                const gid = 'g_' + Date.now();
                const mems = inputs.groupMembers.split(',').map(x=>x.trim()).filter(x=>x);
                mems.forEach(mid => connect(mid));
                chats.value.unshift({ id: gid, name: inputs.groupName, avatar: defaultAvatar, type: 'group', members: mems, messages: [], lastTimestamp: Date.now() });
                ui.modal = null;
            };

            const sendMsg = () => {
                if(!inputMsg.value.trim() || !activeChatId.value) return;
                const msg = { id: Date.now(), type: 'text', content: inputMsg.value, timestamp: Date.now(), senderName: user.name };
                dispatch(msg); inputMsg.value = ''; ui.showEmoji = false;
            };
            
            const dispatch = (msg) => {
                const chat = activeChat.value;
                if(chat.type === 'private') {
                    const c = connections[chat.id]; if(c && c.open) c.send({...msg, type:'msg'}); else connect(chat.id);
                } else {
                    chat.members.forEach(m => { const c = connections[m]; if(c && c.open) c.send({...msg, type:'msg', groupId: chat.id}); });
                }
                chat.messages.push({...msg, sender:'me', status:'sent'});
                chat.lastMessage = msg.type==='text' ? msg.content : 'Media'; chat.lastSender='me'; chat.lastTimestamp=Date.now();
                playSound('sent'); scrollToBottom();
            };

            const handleFile = (e) => {
                const f = e.target.files[0]; if(!f) return;
                const r = new FileReader();
                r.onload = (ev) => dispatch({ id: Date.now(), type: f.type.startsWith('video')?'video':'image', content: ev.target.result, timestamp: Date.now(), senderName: user.name });
                r.readAsDataURL(f);
            };

            const startRec = async () => {
                try {
                    const s = await navigator.mediaDevices.getUserMedia({audio:true});
                    let mr = new MediaRecorder(s); let ch = []; isRecording.value = true;
                    mr.ondataavailable = e => ch.push(e.data);
                    mr.onstop = () => {
                        const b = new Blob(ch, {type:'audio/webm'}); const r = new FileReader();
                        r.onload = () => dispatch({id:Date.now(), type:'voice', content:r.result, timestamp:Date.now(), senderName:user.name});
                        r.readAsDataURL(b); s.getTracks().forEach(t=>t.stop());
                    };
                    mr.start(); window.mr = mr;
                } catch(e) { alert("Mic Error"); }
            };
            const stopRec = () => { if(window.mr) { window.mr.stop(); isRecording.value = false; } };

            const playVoice = (id) => {
                const a = document.getElementById('aud-'+id);
                if(playingVoice.value === id) { a.pause(); playingVoice.value = null; }
                else { document.querySelectorAll('audio').forEach(x=>x.pause()); a.play(); playingVoice.value = id; }
            };

            // --- CALLS ---
            const startCall = async () => {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({audio:true});
                    callObj = peer.call(activeChatId.value, localStream);
                    call.active = true; call.status = 'Calling...';
                    callObj.on('stream', s => document.querySelector('audio.hidden').srcObject = s);
                    callObj.on('close', () => endCall(false));
                } catch(e){ alert("Call Err"); }
            };
            const answerCall = async () => {
                localStream = await navigator.mediaDevices.getUserMedia({audio:true});
                callObj.answer(localStream); call.incoming = false; call.active = true; call.status = 'Connected';
                callObj.on('stream', s => document.querySelector('audio.hidden').srcObject = s);
            };
            const endCall = (sig=true) => {
                if(sig && connections[activeChatId.value]) connections[activeChatId.value].send({type:'hangup'});
                if(callObj) callObj.close(); if(localStream) localStream.getTracks().forEach(t=>t.stop());
                call.active = false; call.incoming = false;
            };

            // --- HELPERS ---
            const onEmoji = (e) => inputMsg.value += e.detail.unicode;
            const copyId = () => navigator.clipboard.writeText(myPeerId.value);
            const formatTime = (ts) => new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const scrollToBottom = () => nextTick(() => { const el = document.querySelector('div[class*="overflow-y-auto"]'); if(el) el.scrollTop = el.scrollHeight; });
            const activeChat = computed(() => chats.value.find(c => c.id === activeChatId.value) || {});
            const activeMessages = computed(() => activeChat.value.messages || []);
            const openChat = (id) => { activeChatId.value = id; mobileView.value = 'chat'; scrollToBottom(); };
            const deleteChat = () => { 
                chats.value = chats.value.filter(c => c.id !== activeChatId.value); 
                activeChatId.value = null; ui.rightSidebar = null; mobileView.value = 'sidebar';
            };

            return {
                ui, inputs, user, chats, activeChatId, activeChat, activeMessages,
                myPeerId, isNetReady, mobileView, inputMsg,
                tempName, tempBio, tempAvatar, defaultAvatar,
                isRecording, playingVoice, call,
                onAvatarChange, finishSetup, addContact, createGroup,
                handleFile, startRec, stopRec, playVoice,
                sendMsg, startCall, answerCall, endCall,
                onEmoji, copyId, formatTime, openChat, unlockAudio, deleteChat
            };
        }
    });

    // Fix for emoji-picker custom element error
    app.config.compilerOptions.isCustomElement = tag => tag === 'emoji-picker';
    app.mount('#app');
</script>
</body>
</html>
