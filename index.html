<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tweeyer Web K</title>
    
    <!-- Fonts (Inter & Icons) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind & Vue & PeerJS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        tg: {
                            bg: '#17212b',         // Main Dark BG
                            sidebar: '#17212b',    // Sidebar Dark
                            hover: '#202b36',      // Hover Item
                            active: '#2b5278',     // Active Item
                            bubbleSelf: '#8774e1', // Purple self message
                            bubbleIn: '#182533',   // Incoming message
                            text: '#f5f5f5',
                            meta: '#8da2b5',
                            lightBg: '#ffffff',
                            lightSidebar: '#ffffff',
                            lightBubbleSelf: '#eeffde',
                            lightBubbleIn: '#ffffff'
                        }
                    }
                }
            }
        };
    </script>
    <style>
        /* Telegram Pattern Background */
        .chat-bg-dark {
            background-color: #0f0f0f;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239ca3af' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        .chat-bg-light {
            background-color: #8da6bd;
            background-image: url("https://web.telegram.org/img/bg_0.png"); 
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }

        /* Animations */
        .msg-enter-active, .msg-leave-active { transition: all 0.2s ease; }
        .msg-enter-from { opacity: 0; transform: translateY(10px); }
        .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease; }
        .slide-enter-from, .slide-leave-to { transform: translateX(-100%); }
    </style>
</head>
<body class="bg-white dark:bg-tg-bg text-gray-900 dark:text-tg-text h-[100dvh] w-screen overflow-hidden">

<div id="app" class="h-full flex relative font-sans" @paste="handlePaste">

    <!-- ================= SETUP SCREEN ================= -->
    <div v-if="!user.setupComplete" class="absolute inset-0 z-[60] bg-white dark:bg-[#1c242d] flex items-center justify-center p-4">
        <div class="max-w-xs w-full text-center">
            <div class="w-32 h-32 mx-auto mb-6 bg-[#8774e1] rounded-full flex items-center justify-center text-5xl text-white shadow-2xl">
                <i class="fa-regular fa-paper-plane"></i>
            </div>
            <h1 class="text-2xl font-bold mb-2">Tweeyer Web</h1>
            <p class="text-gray-500 mb-8 text-sm">Welcome to the free P2P network.</p>

            <div class="space-y-4">
                <div class="relative w-24 h-24 mx-auto group cursor-pointer" @click="$refs.avaInput.click()">
                    <img :src="tempAvatar || defaultAvatar" class="w-full h-full rounded-full object-cover shadow-md border-2 border-[#8774e1]">
                    <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-white">
                        <i class="fa-solid fa-camera"></i>
                    </div>
                </div>
                <input type="file" ref="avaInput" class="hidden" accept="image/*" @change="onAvatarChange">

                <input v-model="tempName" placeholder="Your Name" class="w-full bg-gray-100 dark:bg-[#242f3d] px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-[#8774e1] text-center dark:text-white transition">
                
                <button @click="finishSetup" :disabled="!tempName" class="w-full bg-[#8774e1] text-white py-3 rounded-xl font-bold hover:bg-[#6f5ec0] transition disabled:opacity-50">
                    Start Messaging
                </button>
            </div>
        </div>
    </div>

    <!-- ================= LEFT SIDEBAR (CHATS) ================= -->
    <aside class="w-full md:w-96 bg-gray-50 dark:bg-tg-sidebar border-r border-gray-200 dark:border-gray-800 flex flex-col z-20 absolute md:relative h-full transition-transform duration-300"
           :class="mobileView === 'chat' ? '-translate-x-full md:translate-x-0' : 'translate-x-0'">
        
        <!-- Header / Search -->
        <div class="h-14 px-3 flex items-center gap-3 shrink-0">
            <button @click="ui.showProfile = true" class="w-10 h-10 rounded-full hover:bg-gray-200 dark:hover:bg-white/10 flex items-center justify-center text-gray-500 dark:text-gray-400">
                <i class="fa-solid fa-bars"></i>
            </button>
            <div class="flex-1 bg-gray-200 dark:bg-[#242f3d] rounded-full h-9 flex items-center px-4 text-sm text-gray-500">
                <i class="fa-solid fa-magnifying-glass mr-3"></i>
                <span>Search</span>
            </div>
        </div>

        <!-- Connection Panel (Top of list) -->
        <div class="px-2 pb-2">
            <div class="bg-white dark:bg-[#242f3d] rounded-lg p-3 shadow-sm mb-2">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-bold text-[#8774e1] uppercase">My ID</span>
                    <button @click="copyId" class="text-xs text-gray-400 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                </div>
                <div class="text-xs font-mono break-all text-gray-600 dark:text-gray-300 select-all cursor-pointer" @click="copyId">
                    {{ myPeerId || 'Connecting...' }}
                </div>
            </div>
            
            <div class="flex gap-2">
                <input v-model="targetId" placeholder="Paste Friend's ID" class="flex-1 bg-white dark:bg-[#242f3d] rounded-lg px-3 py-2 text-sm outline-none dark:text-white border border-transparent focus:border-[#8774e1]">
                <button @click="connect" :disabled="!isNetReady" class="bg-[#8774e1] text-white w-10 rounded-lg flex items-center justify-center hover:bg-[#6f5ec0] disabled:opacity-50">
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Chat List -->
        <div class="flex-1 overflow-y-auto">
            <!-- Active Chat Item -->
            <div v-if="isConnected || savedChats.length > 0" 
                 class="px-2 py-2 hover:bg-gray-100 dark:hover:bg-[#2b5278]/20 cursor-pointer transition flex items-center gap-3"
                 :class="{'bg-[#3390ec] dark:bg-[#2b5278] text-white': isConnected}"
                 @click="mobileView = 'chat'">
                
                <div class="relative">
                    <img :src="partner.avatar || defaultAvatar" class="w-12 h-12 rounded-full object-cover bg-[#242f3d]">
                    <div v-if="isConnected" class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-[#242f3d] rounded-full"></div>
                </div>
                
                <div class="flex-1 min-w-0 border-b border-transparent pb-1">
                    <div class="flex justify-between items-center">
                        <h3 class="font-semibold text-sm truncate">{{ partner.name || 'Saved Messages' }}</h3>
                        <span class="text-xs opacity-60">{{ lastMsgTime }}</span>
                    </div>
                    <p class="text-sm opacity-60 truncate flex items-center gap-1">
                        <span v-if="lastMsg && lastMsg.sender === 'me'" class="text-[#8774e1] dark:text-[#a290fc]">You:</span>
                        {{ lastMsgPreview }}
                    </p>
                </div>
            </div>
            
            <!-- Empty State -->
            <div v-if="!isConnected && savedChats.length === 0" class="text-center mt-10 text-gray-400 text-xs">
                Enter an ID above to start chatting.
            </div>
        </div>
    </aside>

    <!-- ================= PROFILE DRAWER (Slide over) ================= -->
    <transition name="slide">
        <div v-if="ui.showProfile" class="absolute inset-y-0 left-0 w-80 bg-white dark:bg-[#17212b] z-50 shadow-2xl flex flex-col">
            <div class="h-14 flex items-center px-4 gap-4 border-b dark:border-black/20">
                <button @click="ui.showProfile = false" class="text-gray-500"><i class="fa-solid fa-arrow-left"></i></button>
                <span class="font-semibold">Profile</span>
            </div>
            <div class="p-6 text-center">
                <div class="relative w-28 h-28 mx-auto mb-4 group cursor-pointer" @click="$refs.editAva.click()">
                    <img :src="user.avatar || defaultAvatar" class="w-full h-full rounded-full object-cover">
                    <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 text-white transition">
                        <i class="fa-solid fa-pen"></i>
                    </div>
                </div>
                <input type="file" ref="editAva" class="hidden" accept="image/*" @change="onAvatarChange">
                
                <input v-model="user.name" @blur="saveUser" class="text-xl font-bold text-center bg-transparent outline-none border-b border-transparent focus:border-[#8774e1] w-full mb-1 dark:text-white" placeholder="Name">
                <input v-model="user.bio" @blur="saveUser" class="text-sm text-gray-500 text-center bg-transparent outline-none w-full" placeholder="Add a bio...">
            </div>

            <div class="mt-4 px-2 space-y-1">
                <div class="p-3 hover:bg-gray-100 dark:hover:bg-white/5 rounded-lg flex items-center gap-4 cursor-pointer" @click="toggleTheme">
                    <i class="fa-solid fa-moon text-gray-400 w-6"></i>
                    <span>Dark Mode</span>
                    <div class="ml-auto w-8 h-4 bg-gray-300 rounded-full relative" :class="{'bg-[#8774e1]': theme==='dark'}">
                        <div class="w-4 h-4 bg-white rounded-full shadow transition-all" :class="{'translate-x-4': theme==='dark'}"></div>
                    </div>
                </div>
                <div @click="clearData" class="p-3 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg flex items-center gap-4 cursor-pointer text-red-500">
                    <i class="fa-solid fa-trash w-6"></i>
                    <span>Log Out</span>
                </div>
            </div>
            
            <div class="mt-auto p-4 text-center text-xs text-gray-500">
                Tweeyer for Web <br> v4.0.1
            </div>
        </div>
    </transition>

    <!-- ================= MAIN CHAT AREA ================= -->
    <main class="flex-1 flex flex-col h-full relative" 
          :class="theme === 'dark' ? 'chat-bg-dark' : 'chat-bg-light', mobileView === 'sidebar' ? 'translate-x-full md:translate-x-0 hidden md:flex' : 'translate-x-0'">
        
        <!-- Header -->
        <header class="h-14 bg-white dark:bg-[#17212b] flex items-center justify-between px-4 shrink-0 shadow-sm cursor-pointer border-b dark:border-black/10 z-10">
            <div class="flex items-center gap-4" @click="mobileView = 'sidebar'">
                <button class="md:hidden text-gray-500"><i class="fa-solid fa-arrow-left"></i></button>
                <div class="flex items-center gap-3">
                    <img :src="partner.avatar || defaultAvatar" class="w-9 h-9 rounded-full object-cover bg-gray-300">
                    <div>
                        <h3 class="font-bold text-sm leading-tight dark:text-white">{{ partner.name || 'Chat' }}</h3>
                        <p class="text-xs text-[#8774e1]">{{ isConnected ? 'online' : 'last seen recently' }}</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4 text-gray-500">
                <button v-if="isConnected" @click="startCall" class="hover:text-[#8774e1] transition"><i class="fa-solid fa-phone"></i></button>
                <button class="hover:text-[#8774e1] transition"><i class="fa-solid fa-ellipsis-vertical"></i></button>
            </div>
        </header>

        <!-- Messages -->
        <div ref="chatBox" class="flex-1 overflow-y-auto p-2 md:p-4 flex flex-col gap-2">
            <transition-group name="msg">
                <div v-for="msg in messages" :key="msg.id" class="flex flex-col max-w-[85%] md:max-w-[65%]" :class="msg.sender === 'me' ? 'self-end items-end' : 'self-start items-start'">
                    
                    <div class="relative px-3 py-2 rounded-2xl shadow-sm text-[15px] leading-snug group"
                         :class="getMessageClass(msg)">
                        
                        <!-- Image/Video -->
                        <div v-if="msg.type === 'image'" class="mb-1 rounded-lg overflow-hidden cursor-zoom-in" @click="zoomImg = msg.content">
                            <img :src="msg.content" class="max-w-full max-h-[350px] object-cover">
                        </div>
                        <div v-if="msg.type === 'video'" class="mb-1 rounded-lg overflow-hidden">
                            <video :src="msg.content" controls class="max-w-full max-h-[350px]"></video>
                        </div>

                        <!-- Sticker -->
                        <div v-if="msg.type === 'sticker'" class="bg-transparent shadow-none p-0">
                            <img :src="msg.content" class="w-32 h-32 object-contain">
                        </div>
                        
                        <!-- Text -->
                        <div v-if="msg.type === 'text'" class="whitespace-pre-wrap break-words min-w-[20px]">{{ msg.content }}</div>

                        <!-- Voice -->
                        <div v-if="msg.type === 'voice'" class="flex items-center gap-2 min-w-[180px]">
                            <button @click="playVoice(msg.id)" class="w-8 h-8 rounded-full bg-black/10 dark:bg-white/20 flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid text-xs" :class="playingVoice === msg.id ? 'fa-pause' : 'fa-play'"></i>
                            </button>
                            <div class="flex flex-col flex-1">
                                <div class="h-1 bg-black/10 dark:bg-white/20 rounded-full w-full mb-1">
                                    <div class="h-full bg-white/80 rounded-full" :style="{width: playingVoice === msg.id ? '60%' : '0%'}"></div>
                                </div>
                                <span class="text-[10px] opacity-70">Voice Message</span>
                            </div>
                            <audio :id="'aud-'+msg.id" :src="msg.content" @ended="playingVoice = null"></audio>
                        </div>

                        <!-- Metadata -->
                        <div class="float-right ml-3 mt-1 flex items-center gap-1 text-[11px] opacity-60 select-none align-bottom h-full pt-1" :class="{'text-white': msg.sender === 'me' && theme === 'dark'}">
                            <span>{{ formatTime(msg.timestamp) }}</span>
                            <span v-if="msg.sender === 'me'">
                                <i v-if="msg.status === 'read'" class="fa-solid fa-check-double text-[#4ade80]"></i> <!-- Green/Blue ticks -->
                                <i v-else class="fa-solid fa-check"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </transition-group>
        </div>

        <!-- Input Area -->
        <footer class="bg-white dark:bg-[#17212b] p-2 md:px-4 md:py-3 flex items-end gap-2 shrink-0 z-20">
            <!-- Attach Menu -->
            <div class="relative">
                <button @click="ui.showAttach = !ui.showAttach" class="w-10 h-10 text-gray-400 hover:text-[#8774e1] transition"><i class="fa-solid fa-paperclip text-xl"></i></button>
                <div v-if="ui.showAttach" class="absolute bottom-14 left-0 bg-white dark:bg-[#242f3d] shadow-xl rounded-xl p-2 w-48 flex flex-col gap-1 border dark:border-black/20 animate-fade-in-up">
                    <button @click="$refs.fileInput.click(); ui.showAttach=false" class="flex items-center gap-3 px-3 py-2 hover:bg-gray-100 dark:hover:bg-black/20 rounded-lg text-sm transition">
                        <i class="fa-regular fa-image text-blue-500 w-5"></i> Photo/Video
                    </button>
                    <button @click="sendSticker('https://cdn-icons-png.flaticon.com/512/742/742751.png'); ui.showAttach=false" class="flex items-center gap-3 px-3 py-2 hover:bg-gray-100 dark:hover:bg-black/20 rounded-lg text-sm transition">
                        <i class="fa-solid fa-face-smile text-yellow-500 w-5"></i> Send Duck Sticker
                    </button>
                </div>
                <input type="file" ref="fileInput" class="hidden" @change="handleFileSelect">
            </div>

            <!-- Input -->
            <textarea 
                v-model="inputMsg" 
                @keydown.enter.prevent="sendText"
                @focus="markRead"
                rows="1" 
                placeholder="Write a message..." 
                class="flex-1 bg-white dark:bg-[#17212b] text-base px-2 py-2 outline-none resize-none max-h-40 placeholder-gray-400 dark:text-white"
            ></textarea>

            <!-- Emoji Btn -->
            <button class="w-10 h-10 text-gray-400 hover:text-yellow-500 transition" @click="inputMsg += 'ðŸ˜‚'"><i class="fa-regular fa-face-smile text-xl"></i></button>

            <!-- Mic / Send -->
            <div class="w-12 h-12 flex items-center justify-center">
                <transition name="fade" mode="out-in">
                    <button v-if="inputMsg.trim()" @click="sendText" class="w-10 h-10 rounded-full bg-[#8774e1] text-white hover:scale-110 transition shadow-lg flex items-center justify-center">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                    <button v-else 
                        @mousedown="startRec" @mouseup="stopRec" @touchstart.prevent="startRec" @touchend.prevent="stopRec"
                        class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-white/10 text-gray-500 transition flex items-center justify-center"
                        :class="{'bg-red-500 text-white animate-pulse': isRecording}">
                        <i class="fa-solid" :class="isRecording ? 'fa-square' : 'fa-microphone'"></i>
                    </button>
                </transition>
            </div>
        </footer>

        <!-- RECORDING OVERLAY -->
        <div v-if="isRecording" class="absolute bottom-24 left-1/2 -translate-x-1/2 bg-[#17212b] text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-4 z-30 border border-white/10">
            <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
            <span class="font-mono">{{ recTime }}</span>
            <span class="text-sm opacity-50">Release to send</span>
        </div>

        <!-- CALL OVERLAY -->
        <div v-if="call.active || call.incoming" class="fixed inset-0 z-[100] bg-[#0f0f0f]/90 backdrop-blur-xl flex flex-col items-center justify-center text-white">
            <div class="w-32 h-32 rounded-full overflow-hidden mb-6 border-4 border-white/10 shadow-2xl relative">
                 <div v-if="call.incoming" class="absolute inset-0 bg-[#8774e1] opacity-50 animate-ping"></div>
                 <img :src="partner.avatar || defaultAvatar" class="w-full h-full object-cover relative z-10">
            </div>
            <h2 class="text-3xl font-bold mb-2">{{ partner.name }}</h2>
            <p class="text-[#8774e1] mb-12 animate-pulse">{{ call.statusText }}</p>

            <div class="flex gap-10">
                <button v-if="call.incoming" @click="answerCall" class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center text-3xl shadow-lg hover:scale-110 transition">
                    <i class="fa-solid fa-phone"></i>
                </button>
                <button @click="endCall" class="w-20 h-20 bg-red-500 rounded-full flex items-center justify-center text-3xl shadow-lg hover:scale-110 transition">
                    <i class="fa-solid fa-phone-slash"></i>
                </button>
            </div>
            <audio ref="remoteAudio" autoplay class="hidden"></audio>
        </div>
    </main>

    <!-- ZOOM -->
    <div v-if="zoomImg" @click="zoomImg = null" class="fixed inset-0 z-[200] bg-black/95 flex items-center justify-center cursor-zoom-out p-4">
        <img :src="zoomImg" class="max-w-full max-h-full rounded-lg shadow-2xl">
    </div>

</div>

<script>
    const { createApp, ref, reactive, onMounted, computed, watch, nextTick } = Vue;

    createApp({
        setup() {
            // STATE
            const ui = reactive({ showProfile: false, showAttach: false });
            const myPeerId = ref('');
            const targetId = ref('');
            const isNetReady = ref(false);
            const isConnected = ref(false);
            const mobileView = ref('sidebar');
            const inputMsg = ref('');
            const theme = ref('dark');
            const messages = ref([]);
            const savedChats = ref([]); // Simple array for persistence visualization
            
            const user = reactive({ name: '', avatar: '', bio: '', setupComplete: false });
            const partner = reactive({ name: '', avatar: '' });
            
            // Media
            const isRecording = ref(false);
            const recTime = ref('00:00');
            const playingVoice = ref(null);
            const zoomImg = ref(null);
            const call = reactive({ incoming: false, active: false, statusText: '' });
            
            // Core
            let peer = null;
            let conn = null;
            let mediaRecorder = null;
            let chunks = [];
            let callObj = null;
            let localStream = null;
            let recTimerInt = null;

            // Defaults
            const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";

            // --- Lifecycle ---
            onMounted(() => {
                const u = localStorage.getItem('tw_k_user');
                if(u) Object.assign(user, JSON.parse(u));
                
                const msgs = localStorage.getItem('tw_k_msgs');
                if(msgs) messages.value = JSON.parse(msgs);
                
                const th = localStorage.getItem('tw_k_theme');
                if(th) setTheme(th);
                else setTheme('dark');

                if(user.setupComplete) initPeer();
            });

            watch(messages, (val) => {
                localStorage.setItem('tw_k_msgs', JSON.stringify(val));
                if(val.length > 0) scrollToBottom();
            }, { deep: true });

            // --- Paste Handler ---
            const handlePaste = (e) => {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let index in items) {
                    const item = items[index];
                    if (item.kind === 'file') {
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = (ev) => sendMedia('image', ev.target.result);
                        reader.readAsDataURL(blob);
                    }
                }
            };

            // --- PeerJS ---
            const initPeer = () => {
                peer = new Peer(null, { config: { iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] } });
                
                peer.on('open', (id) => {
                    myPeerId.value = id;
                    isNetReady.value = true;
                });

                peer.on('connection', (c) => setupConn(c));
                peer.on('call', (c) => handleIncomingCall(c));
            };

            const connect = () => {
                if(!targetId.value) return;
                const c = peer.connect(targetId.value.trim());
                setupConn(c);
            };

            const setupConn = (c) => {
                conn = c;
                conn.on('open', () => {
                    isConnected.value = true;
                    mobileView.value = 'chat';
                    conn.send({ type: 'handshake', payload: { name: user.name, avatar: user.avatar } });
                    // Mark sent messages as read if partner connects
                    messages.value.forEach(m => { if(m.status === 'sent') m.status = 'read'; });
                });
                
                conn.on('data', (data) => {
                    if(data.type === 'handshake') {
                        partner.name = data.payload.name;
                        partner.avatar = data.payload.avatar;
                    } else if(data.type === 'read_ack') {
                        messages.value.forEach(m => { if(m.sender === 'me') m.status = 'read'; });
                    } else {
                        // Receive Message
                        messages.value.push({ ...data, sender: 'partner', status: 'read' });
                        playSound('pop');
                        // Auto Ack
                        if(mobileView.value === 'chat') conn.send({ type: 'read_ack' });
                    }
                });

                conn.on('close', () => isConnected.value = false);
            };

            // --- Messaging ---
            const sendText = () => {
                if(!inputMsg.value.trim() || !isConnected.value) return;
                const msg = { id: Date.now(), type: 'text', content: inputMsg.value, timestamp: Date.now() };
                dispatch(msg);
                inputMsg.value = '';
            };

            const sendMedia = (type, content) => {
                if(!isConnected.value) return;
                const msg = { id: Date.now(), type, content, timestamp: Date.now() };
                dispatch(msg);
            };

            const sendSticker = (url) => sendMedia('sticker', url);

            const handleFileSelect = (e) => {
                const f = e.target.files[0];
                if(!f) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const type = f.type.startsWith('video') ? 'video' : 'image';
                    sendMedia(type, ev.target.result);
                };
                reader.readAsDataURL(f);
            };

            const dispatch = (msg) => {
                conn.send(msg);
                messages.value.push({ ...msg, sender: 'me', status: 'sent' });
                playSound('sent');
            };

            // --- Voice ---
            const startRec = async () => {
                if(!isConnected.value) return;
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    chunks = [];
                    isRecording.value = true;
                    let sec = 0;
                    recTimerInt = setInterval(() => {
                        sec++;
                        const m = Math.floor(sec/60).toString().padStart(2,'0');
                        const s = (sec%60).toString().padStart(2,'0');
                        recTime.value = `${m}:${s}`;
                    }, 1000);

                    mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => sendMedia('voice', reader.result);
                        stream.getTracks().forEach(t => t.stop());
                    };
                    mediaRecorder.start();
                } catch(e) { alert("Mic Error"); }
            };

            const stopRec = () => {
                if(mediaRecorder && isRecording.value) {
                    mediaRecorder.stop();
                    clearInterval(recTimerInt);
                    isRecording.value = false;
                    recTime.value = '00:00';
                }
            };

            const playVoice = (id) => {
                const aud = document.getElementById('aud-'+id);
                if(aud) {
                    if(playingVoice.value === id) { aud.pause(); playingVoice.value = null; }
                    else { 
                        // stop others
                        document.querySelectorAll('audio').forEach(a => a.pause());
                        aud.play(); 
                        playingVoice.value = id; 
                    }
                }
            };

            // --- Calls ---
            const startCall = async () => {
                if(!isConnected.value) return;
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    callObj = peer.call(conn.peer, localStream);
                    setupCallEvents(callObj);
                    call.active = true;
                    call.statusText = 'Calling...';
                } catch(e) { alert("Call Error"); }
            };

            const handleIncomingCall = (c) => {
                call.incoming = true;
                callObj = c;
                call.statusText = 'Incoming Call...';
            };

            const answerCall = async () => {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                callObj.answer(localStream);
                setupCallEvents(callObj);
                call.incoming = false;
                call.active = true;
            };

            const setupCallEvents = (c) => {
                c.on('stream', (remoteStream) => {
                    call.statusText = 'Connected';
                    const aud = document.querySelector('audio.hidden'); // refs work weird in if blocks
                    if(aud) { aud.srcObject = remoteStream; aud.play(); }
                });
                c.on('close', endCall);
            };

            const endCall = () => {
                if(callObj) callObj.close();
                if(localStream) localStream.getTracks().forEach(t => t.stop());
                call.active = false;
                call.incoming = false;
            };

            // --- Utilities ---
            const markRead = () => {
                if(isConnected.value) conn.send({ type: 'read_ack' });
            };
            
            const copyId = () => navigator.clipboard.writeText(myPeerId.value);
            
            const formatTime = (ts) => new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            
            const scrollToBottom = () => nextTick(() => { 
                const el = document.querySelector('div[class*="overflow-y-auto"]'); 
                if(el) el.scrollTop = el.scrollHeight; 
            });

            const playSound = (type) => {
                const ctx = new (window.AudioContext||window.webkitAudioContext)();
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                if(type === 'sent') { o.frequency.value = 600; o.start(); o.stop(ctx.currentTime+0.1); }
                else { o.frequency.value = 400; o.start(); o.stop(ctx.currentTime+0.1); }
            };

            const getMessageClass = (msg) => {
                if(msg.type === 'sticker') return 'bg-transparent shadow-none';
                if(theme.value === 'dark') {
                    return msg.sender === 'me' ? 'bg-tg-bubbleSelf text-white rounded-br-none' : 'bg-tg-bubbleIn text-white rounded-bl-none';
                } else {
                    return msg.sender === 'me' ? 'bg-tg-lightBubbleSelf text-black rounded-br-none' : 'bg-tg-lightBubbleIn text-black rounded-bl-none';
                }
            };

            // Profile & Setup
            const onAvatarChange = (e) => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = (ev) => {
                        if(!user.setupComplete) tempAvatar.value = ev.target.result;
                        else { user.avatar = ev.target.result; saveUser(); }
                    };
                    r.readAsDataURL(f);
                }
            };
            const finishSetup = () => {
                user.name = tempName.value;
                user.avatar = tempAvatar.value;
                user.setupComplete = true;
                saveUser();
                initPeer();
            };
            const saveUser = () => localStorage.setItem('tw_k_user', JSON.stringify(user));
            const clearData = () => { localStorage.clear(); location.reload(); };
            const tempAvatar = ref('');
            const tempName = ref('');

            // Computed
            const lastMsg = computed(() => messages.value[messages.value.length-1]);
            const lastMsgTime = computed(() => lastMsg.value ? formatTime(lastMsg.value.timestamp) : '');
            const lastMsgPreview = computed(() => {
                if(!lastMsg.value) return '';
                if(lastMsg.value.type === 'image') return 'Photo';
                if(lastMsg.value.type === 'voice') return 'Voice Message';
                if(lastMsg.value.type === 'sticker') return 'Sticker';
                return lastMsg.value.content;
            });
            const toggleTheme = () => setTheme(theme.value === 'dark' ? 'light' : 'dark');
            const setTheme = (t) => {
                theme.value = t;
                localStorage.setItem('tw_k_theme', t);
                if(t==='dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            };

            return {
                ui, user, partner, messages, inputMsg, mobileView, theme,
                myPeerId, targetId, isNetReady, isConnected, savedChats,
                tempName, tempAvatar, defaultAvatar,
                isRecording, recTime, playingVoice, zoomImg, call,
                handlePaste, handleFileSelect, startRec, stopRec, playVoice,
                connect, sendText, sendSticker, startCall, answerCall, endCall,
                onAvatarChange, finishSetup, saveUser, clearData, copyId, formatTime, markRead,
                getMessageClass, toggleTheme, lastMsg, lastMsgTime, lastMsgPreview
            };
        }
    }).mount('#app');
</script>
</body>
</html>
